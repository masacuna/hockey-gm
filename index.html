<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hockey GM Simulator</title>
    <!-- External CSS -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div id="root"></div>
    
    <!-- React & ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Main application (all JS inlined for simplicity, CSS externalized) -->
    <script type="text/babel">
        const { useState, useMemo, useCallback } = React;

        const TEAMS = [
            { id: 1, city: 'Anaheim', name: 'Waves', abbreviation: 'ANA', conference: 'West', division: 'Pacific' },
            { id: 2, city: 'Arizona', name: 'Scorpions', abbreviation: 'ARI', conference: 'West', division: 'Pacific' },
            { id: 3, city: 'Boston', name: 'Blades', abbreviation: 'BOS', conference: 'East', division: 'Atlantic' },
            { id: 4, city: 'Buffalo', name: 'Storm', abbreviation: 'BUF', conference: 'East', division: 'Atlantic' },
            { id: 5, city: 'Calgary', name: 'Inferno', abbreviation: 'CGY', conference: 'West', division: 'Pacific' },
            { id: 6, city: 'Carolina', name: 'Tempest', abbreviation: 'CAR', conference: 'East', division: 'Metropolitan' },
            { id: 7, city: 'Chicago', name: 'Cyclones', abbreviation: 'CHI', conference: 'West', division: 'Central' },
            { id: 8, city: 'Colorado', name: 'Summit', abbreviation: 'COL', conference: 'West', division: 'Central' },
            { id: 9, city: 'Columbus', name: 'Commanders', abbreviation: 'CBJ', conference: 'East', division: 'Metropolitan' },
            { id: 10, city: 'Dallas', name: 'Outlaws', abbreviation: 'DAL', conference: 'West', division: 'Central' },
            { id: 11, city: 'Detroit', name: 'Motors', abbreviation: 'DET', conference: 'East', division: 'Atlantic' },
            { id: 12, city: 'Edmonton', name: 'Express', abbreviation: 'EDM', conference: 'West', division: 'Pacific' },
            { id: 13, city: 'Florida', name: 'Surge', abbreviation: 'FLA', conference: 'East', division: 'Atlantic' },
            { id: 14, city: 'Los Angeles', name: 'Knights', abbreviation: 'LAK', conference: 'West', division: 'Pacific' },
            { id: 15, city: 'Minnesota', name: 'Timberwolves', abbreviation: 'MIN', conference: 'West', division: 'Central' },
            { id: 16, city: 'Montreal', name: 'Metros', abbreviation: 'MTL', conference: 'East', division: 'Atlantic' },
            { id: 17, city: 'Nashville', name: 'Strikers', abbreviation: 'NSH', conference: 'West', division: 'Central' },
            { id: 18, city: 'New Jersey', name: 'Vipers', abbreviation: 'NJD', conference: 'East', division: 'Metropolitan' },
            { id: 19, city: 'New York', name: 'Mariners', abbreviation: 'NYI', conference: 'East', division: 'Metropolitan' },
            { id: 20, city: 'New York', name: 'Rockets', abbreviation: 'NYR', conference: 'East', division: 'Metropolitan' },
            { id: 21, city: 'Ottawa', name: 'Capitals', abbreviation: 'OTT', conference: 'East', division: 'Atlantic' },
            { id: 22, city: 'Philadelphia', name: 'Phoenix', abbreviation: 'PHI', conference: 'East', division: 'Metropolitan' },
            { id: 23, city: 'Pittsburgh', name: 'Steel', abbreviation: 'PIT', conference: 'East', division: 'Metropolitan' },
            { id: 24, city: 'San Jose', name: 'Barracudas', abbreviation: 'SJS', conference: 'West', division: 'Pacific' },
            { id: 25, city: 'Seattle', name: 'Storm', abbreviation: 'SEA', conference: 'West', division: 'Pacific' },
            { id: 26, city: 'St. Louis', name: 'Archers', abbreviation: 'STL', conference: 'West', division: 'Central' },
            { id: 27, city: 'Tampa Bay', name: 'Thunder', abbreviation: 'TBL', conference: 'East', division: 'Atlantic' },
            { id: 28, city: 'Toronto', name: 'Titans', abbreviation: 'TOR', conference: 'East', division: 'Atlantic' },
            { id: 29, city: 'Vancouver', name: 'Orcas', abbreviation: 'VAN', conference: 'West', division: 'Pacific' },
            { id: 30, city: 'Vegas', name: 'Vipers', abbreviation: 'VGK', conference: 'West', division: 'Pacific' },
            { id: 31, city: 'Washington', name: 'Sentinels', abbreviation: 'WSH', conference: 'East', division: 'Metropolitan' },
            { id: 32, city: 'Winnipeg', name: 'Blizzard', abbreviation: 'WPG', conference: 'West', division: 'Central' },
        ];
        
        // Farm teams (AHL-equivalent) - affiliated with NHL teams
        const FARM_TEAMS = [
            { id: 101, nhlAffiliation: 1, city: 'San Diego', name: 'Gulls', abbreviation: 'SDG' },
            { id: 102, nhlAffiliation: 2, city: 'Tucson', name: 'Roadrunners', abbreviation: 'TUC' },
            { id: 103, nhlAffiliation: 3, city: 'Providence', name: 'Bruins', abbreviation: 'PRO' },
            { id: 104, nhlAffiliation: 4, city: 'Rochester', name: 'Americans', abbreviation: 'ROC' },
            { id: 105, nhlAffiliation: 5, city: 'Abbotsford', name: 'Heat', abbreviation: 'ABB' },
            { id: 106, nhlAffiliation: 6, city: 'Springfield', name: 'Thunderbirds', abbreviation: 'SPR' },
            { id: 107, nhlAffiliation: 7, city: 'Rockford', name: 'IceHogs', abbreviation: 'RFD' },
            { id: 108, nhlAffiliation: 8, city: 'Loveland', name: 'Eagles', abbreviation: 'LOV' },
            { id: 109, nhlAffiliation: 9, city: 'Cleveland', name: 'Monsters', abbreviation: 'CLE' },
            { id: 110, nhlAffiliation: 10, city: 'Cedar Park', name: 'Stars', abbreviation: 'TEX' },
            { id: 111, nhlAffiliation: 11, city: 'Grand Rapids', name: 'Griffins', abbreviation: 'GRG' },
            { id: 112, nhlAffiliation: 12, city: 'Bakersfield', name: 'Condors', abbreviation: 'BAK' },
            { id: 113, nhlAffiliation: 13, city: 'Charlotte', name: 'Checkers', abbreviation: 'CHR' },
            { id: 114, nhlAffiliation: 14, city: 'Ontario', name: 'Reign', abbreviation: 'ONT' },
            { id: 115, nhlAffiliation: 15, city: 'Iowa', name: 'Wild', abbreviation: 'IOW' },
            { id: 116, nhlAffiliation: 16, city: 'Laval', name: 'Rocket', abbreviation: 'LAV' },
            { id: 117, nhlAffiliation: 17, city: 'Milwaukee', name: 'Admirals', abbreviation: 'MIL' },
            { id: 118, nhlAffiliation: 18, city: 'Utica', name: 'Comets', abbreviation: 'UTI' },
            { id: 119, nhlAffiliation: 19, city: 'Bridgeport', name: 'Islanders', abbreviation: 'BRI' },
            { id: 120, nhlAffiliation: 20, city: 'Hartford', name: 'Wolf Pack', abbreviation: 'HAR' },
            { id: 121, nhlAffiliation: 21, city: 'Belleville', name: 'Senators', abbreviation: 'BEL' },
            { id: 122, nhlAffiliation: 22, city: 'Lehigh Valley', name: 'Phantoms', abbreviation: 'LHV' },
            { id: 123, nhlAffiliation: 23, city: 'Wilkes-Barre', name: 'Penguins', abbreviation: 'WBS' },
            { id: 124, nhlAffiliation: 24, city: 'San Jose', name: 'Barracuda', abbreviation: 'SJB' },
            { id: 125, nhlAffiliation: 25, city: 'Coachella Valley', name: 'Firebirds', abbreviation: 'CV' },
            { id: 126, nhlAffiliation: 26, city: 'Springfield', name: 'Thunderbirds', abbreviation: 'SPT' },
            { id: 127, nhlAffiliation: 27, city: 'Syracuse', name: 'Crunch', abbreviation: 'SYR' },
            { id: 128, nhlAffiliation: 28, city: 'Toronto', name: 'Marlies', abbreviation: 'TML' },
            { id: 129, nhlAffiliation: 29, city: 'Abbotsford', name: 'Canucks', abbreviation: 'ABB' },
            { id: 130, nhlAffiliation: 30, city: 'Henderson', name: 'Silver Knights', abbreviation: 'HEN' },
            { id: 131, nhlAffiliation: 31, city: 'Hershey', name: 'Bears', abbreviation: 'HER' },
            { id: 132, nhlAffiliation: 32, city: 'Manitoba', name: 'Moose', abbreviation: 'MAN' },
        ];

        const FIRST_NAMES = ['Connor', 'Nathan', 'Alex', 'Ryan', 'Tyler', 'Jake', 'Marcus', 'Dylan', 
            'Ethan', 'Jack', 'Owen', 'Liam', 'Noah', 'Mason', 'Logan', 'Lucas', 'Elijah', 'Oliver',
            'James', 'William', 'Benjamin', 'Henry', 'Samuel', 'David', 'Joseph', 'Carter', 'Wyatt',
            'John', 'Sebastian', 'Matthew'];
        const LAST_NAMES = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Miller', 'Davis', 'Wilson',
            'Anderson', 'Taylor', 'Thomas', 'Moore', 'Jackson', 'Martin', 'Lee', 'Thompson', 'White',
            'Harris', 'Clark', 'Lewis', 'Robinson', 'Walker', 'Young', 'Hall', 'Allen', 'King', 'Wright',
            'Lopez', 'Hill', 'Scott'];

        const generatePlayer = (position, teamId, lineNumber = 1, isFarm = false) => {
            // Farm players have lower base ratings
            const baseRating = isFarm ? 
                (45 + Math.random() * 25) : // Farm: 45-70 OVR
                (60 + Math.random() * 30);  // NHL: 60-90 OVR
            const potential = baseRating + Math.random() * 20 - 5;
            
            const baseStats = {
                gamesPlayed: 0, 
                goals: 0, 
                assists: 0, 
                points: 0,
                plusMinus: 0,
                pim: 0,
                shots: 0,
                timeOnIce: 0
            };
            
            // Add goalie-specific stats
            if (position === 'G') {
                baseStats.wins = 0;
                baseStats.losses = 0;
                baseStats.shutouts = 0;
                baseStats.shotsAgainst = 0;
                baseStats.saves = 0;
                baseStats.goalsAgainst = 0;
                baseStats.savePercentage = 0;
                baseStats.gaa = 0;
            }
            
            // Create separate playoff stats (starts at 0 when playoffs begin)
            const playoffStats = JSON.parse(JSON.stringify(baseStats)); // Deep copy
            
            // Determine preferred position
            let preferredPosition = position;
            if (position === 'F') {
                const positions = ['C', 'LW', 'RW'];
                preferredPosition = positions[Math.floor(Math.random() * positions.length)];
            } else if (position === 'D') {
                preferredPosition = Math.random() > 0.5 ? 'LD' : 'RD';
            }
            
            return {
                id: `${teamId}-${position}-${Math.random()}`,
                firstName: FIRST_NAMES[Math.floor(Math.random() * FIRST_NAMES.length)],
                lastName: LAST_NAMES[Math.floor(Math.random() * LAST_NAMES.length)],
                position,
                preferredPosition, // C, LW, RW for forwards; LD, RD for defense
                age: 20 + Math.floor(Math.random() * 15),
                teamId,
                nhlAffiliation: teamId <= 32 ? teamId : FARM_TEAMS.find(t => t.id === teamId)?.nhlAffiliation, // NHL team they belong to
                roster: teamId <= 32 ? 'nhl' : 'farm', // 'nhl' or 'farm'
                lineNumber,
                linePosition: null, // Specific slot: 'C', 'LW', 'RW', 'LD', 'RD'
                ppUnit: 0, // 0 = none, 1 = PP1, 2 = PP2
                pkUnit: 0, // 0 = none, 1 = PK1, 2 = PK2
                ppPosition: null, // Position on PP unit
                pkPosition: null, // Position on PK unit
                dressed: position === 'G' ? (lineNumber <= 2) : true, // Goalies: only 2 dress
                // Track original position before injury call-up
                originalLineNumber: null,
                originalLinePosition: null,
                originalDressed: null,
                isInjuryReplacement: false, // True if called up to replace injured player
                ratings: { 
                    overall: Math.round(baseRating),
                    potential: Math.round(potential)
                },
                stats: { ...baseStats },
                playoffStats: { ...playoffStats }, // Separate playoff stats
                milestones: [], // Track career achievements
                achievements: [], // Track awards, all-stars, league leaders
                injury: {
                    injured: false,
                    type: null,
                    severity: null,
                    gamesOut: 0,
                    daysUntilReturn: 0,
                    isCareerEnding: false
                },
                careerStats: [],
                currentSeasonStats: {
                    season: 1,
                    ...baseStats
                }
            };
        };

        const generateRoster = (teamId) => {
            const roster = [];
            
            // Forwards: 13 total (12 active + 1 scratch)
            // Generate 13 forwards, we'll auto-assign best 12 to lines
            const forwardPositions = ['C', 'LW', 'RW'];
            for (let i = 0; i < 13; i++) {
                const player = generatePlayer('F', teamId, 0); // Start all at line 0 (unassigned)
                roster.push(player);
            }
            
            // Defense: 7 total (6 active + 1 scratch)
            // Generate 7 defensemen, we'll auto-assign best 6 to pairs
            for (let i = 0; i < 7; i++) {
                const player = generatePlayer('D', teamId, 0); // Start all at line 0 (unassigned)
                roster.push(player);
            }
            
            // Goalies: 3 total (2 dress + 1 scratch)
            for (let i = 0; i < 3; i++) {
                const goalie = generatePlayer('G', teamId, i + 1);
                goalie.dressed = i < 2; // Only first 2 goalies dress
                roster.push(goalie);
            }
            
            // Sort by overall rating within position (best first)
            roster.sort((a, b) => {
                if (a.position !== b.position) {
                    const order = { 'F': 1, 'D': 2, 'G': 3 };
                    return order[a.position] - order[b.position];
                }
                return b.ratings.overall - a.ratings.overall;
            });
            
            // Auto-assign best lineup
            autoSetLineup(roster);
            
            return roster;
        };
        
        // Auto-assign best players to lines based on OVR and position preference
        const autoSetLineup = (roster) => {
            // Forwards: Assign best 12 to lines
            const forwards = roster.filter(p => p.position === 'F').sort((a, b) => b.ratings.overall - a.ratings.overall);
            const forwardPositions = ['C', 'LW', 'RW'];
            
            // Try to match preferred positions first, then fill gaps
            const assigned = new Set();
            const lineAssignments = Array(4).fill(null).map(() => ({ C: null, LW: null, RW: null }));
            
            // First pass: Assign players to their preferred positions (best players first)
            for (let line = 0; line < 4; line++) {
                for (let pos of forwardPositions) {
                    const candidate = forwards.find(p => 
                        !assigned.has(p.id) && 
                        p.preferredPosition === pos
                    );
                    if (candidate) {
                        lineAssignments[line][pos] = candidate;
                        candidate.lineNumber = line + 1;
                        candidate.linePosition = pos;
                        assigned.add(candidate.id);
                    }
                }
            }
            
            // Second pass: Fill remaining slots with best available players
            for (let line = 0; line < 4; line++) {
                for (let pos of forwardPositions) {
                    if (!lineAssignments[line][pos]) {
                        const candidate = forwards.find(p => !assigned.has(p.id));
                        if (candidate) {
                            lineAssignments[line][pos] = candidate;
                            candidate.lineNumber = line + 1;
                            candidate.linePosition = pos;
                            assigned.add(candidate.id);
                        }
                    }
                }
            }
            
            // 13th forward becomes healthy scratch (lineNumber = 0)
            forwards.forEach(f => {
                if (!assigned.has(f.id)) {
                    f.lineNumber = 0;
                    f.linePosition = null;
                }
            });
            
            // Defense: Assign best 6 to pairs
            const defensemen = roster.filter(p => p.position === 'D').sort((a, b) => b.ratings.overall - a.ratings.overall);
            const defensePositions = ['LD', 'RD'];
            const dAssigned = new Set();
            const pairAssignments = Array(3).fill(null).map(() => ({ LD: null, RD: null }));
            
            // First pass: Assign to preferred sides
            for (let pair = 0; pair < 3; pair++) {
                for (let pos of defensePositions) {
                    const candidate = defensemen.find(p => 
                        !dAssigned.has(p.id) && 
                        p.preferredPosition === pos
                    );
                    if (candidate) {
                        pairAssignments[pair][pos] = candidate;
                        candidate.lineNumber = pair + 1;
                        candidate.linePosition = pos;
                        dAssigned.add(candidate.id);
                    }
                }
            }
            
            // Second pass: Fill remaining slots
            for (let pair = 0; pair < 3; pair++) {
                for (let pos of defensePositions) {
                    if (!pairAssignments[pair][pos]) {
                        const candidate = defensemen.find(p => !dAssigned.has(p.id));
                        if (candidate) {
                            pairAssignments[pair][pos] = candidate;
                            candidate.lineNumber = pair + 1;
                            candidate.linePosition = pos;
                            dAssigned.add(candidate.id);
                        }
                    }
                }
            }
            
            // 7th defenseman becomes healthy scratch
            defensemen.forEach(d => {
                if (!dAssigned.has(d.id)) {
                    d.lineNumber = 0;
                    d.linePosition = null;
                }
            });
            
            // Goalies: Dress best 2 goalies
            const goalies = roster.filter(p => p.position === 'G').sort((a, b) => b.ratings.overall - a.ratings.overall);
            goalies.forEach((g, idx) => {
                g.dressed = idx < 2; // Top 2 goalies dressed, rest undressed
            });
        };

        const generateSchedule = () => {
            const schedule = [];
            
            // Round-robin: each team plays all others
            const teamGames = {};
            TEAMS.forEach(t => teamGames[t.id] = []);
            
            for (let round = 0; round < 82; round++) {
                for (let i = 0; i < TEAMS.length / 2; i++) {
                    let home, away;
                    
                    if (i === 0) {
                        home = 0;
                        away = (TEAMS.length - 1) - round % (TEAMS.length - 1);
                    } else {
                        home = (i + round) % (TEAMS.length - 1) + 1;
                        away = (TEAMS.length - i + round - 1) % (TEAMS.length - 1) + 1;
                    }
                    
                    if (home >= TEAMS.length || away >= TEAMS.length) continue;
                    
                    const homeTeam = TEAMS[home];
                    const awayTeam = TEAMS[away];
                    
                    // Check if either team already has 82 games
                    if (teamGames[homeTeam.id].length >= 82 || teamGames[awayTeam.id].length >= 82) {
                        continue;
                    }
                    
                    const game = {
                        homeTeam: homeTeam.id,
                        awayTeam: awayTeam.id,
                        played: false,
                        homeScore: 0,
                        awayScore: 0,
                        date: null,
                        homeStats: null,
                        awayStats: null,
                        periodScoring: null
                    };
                    
                    schedule.push(game);
                    teamGames[homeTeam.id].push(game);
                    teamGames[awayTeam.id].push(game);
                }
            }
            
            // Fill in any teams that don't have 82 games yet
            TEAMS.forEach(team => {
                while (teamGames[team.id].length < 82) {
                    // Find another team that also needs games
                    const opponent = TEAMS.find(t => 
                        t.id !== team.id && 
                        teamGames[t.id].length < 82
                    );
                    
                    if (!opponent) {
                        // No teams need games, but this team does - pair with any team
                        const anyOpponent = TEAMS.find(t => t.id !== team.id);
                        
                        const game = {
                            homeTeam: team.id,
                            awayTeam: anyOpponent.id,
                            played: false,
                            homeScore: 0,
                            awayScore: 0,
                            date: null,
                            homeStats: null,
                            awayStats: null,
                            periodScoring: null
                        };
                        
                        schedule.push(game);
                        teamGames[team.id].push(game);
                        teamGames[anyOpponent.id].push(game);
                        break;
                    }
                    
                    const game = {
                        homeTeam: team.id,
                        awayTeam: opponent.id,
                        played: false,
                        homeScore: 0,
                        awayScore: 0,
                        date: null,
                        homeStats: null,
                        awayStats: null,
                        periodScoring: null
                    };
                    
                    schedule.push(game);
                    teamGames[team.id].push(game);
                    teamGames[opponent.id].push(game);
                }
            });
            
            // Verify
            console.log('Schedule verification:');
            TEAMS.forEach(t => {
                const count = teamGames[t.id].length;
                console.log(`${t.city}: ${count} games`);
                if (count !== 82) {
                    console.error(`ERROR: ${t.city} has ${count} games instead of 82!`);
                }
            });
            
            return schedule;
        };

        const getIceTime = (player) => {
            if (player.position === 'G') return 60;
            
            if (player.position === 'D') {
                if (player.lineNumber === 1) return 24 + Math.random() * 2; // 24-26 min
                if (player.lineNumber === 2) return 20 + Math.random() * 2; // 20-22 min
                return 16 + Math.random() * 2; // 16-18 min
            }
            
            // Forwards
            if (player.lineNumber === 1) return 19 + Math.random() * 3; // 19-22 min
            if (player.lineNumber === 2) return 16 + Math.random() * 2; // 16-18 min
            if (player.lineNumber === 3) return 13 + Math.random() * 2; // 13-15 min
            return 10 + Math.random() * 2; // 10-12 min
        };

        // NHL Penalty System
        // Based on NHL data: ~6-8 penalties per game total, ~12-16 PIM per team per game
        const PENALTY_TYPES = {
            // Minor penalties (2 minutes) - 85% of all penalties
            'Tripping': { minutes: 2, weight: 20, description: 'Tripping' },
            'Hooking': { minutes: 2, weight: 18, description: 'Hooking' },
            'Slashing': { minutes: 2, weight: 15, description: 'Slashing' },
            'Interference': { minutes: 2, weight: 12, description: 'Interference' },
            'High-Sticking': { minutes: 2, weight: 10, description: 'High-Sticking' },
            'Holding': { minutes: 2, weight: 8, description: 'Holding' },
            'Roughing': { minutes: 2, weight: 7, description: 'Roughing' },
            'Delay of Game': { minutes: 2, weight: 5, description: 'Delay of Game' },
            
            // Double minors (4 minutes) - 8% of penalties
            'High-Stick (Blood)': { minutes: 4, weight: 5, description: 'High-Sticking (double minor)' },
            'Roughing (Double)': { minutes: 4, weight: 3, description: 'Roughing (double minor)' },
            
            // Major penalties (5 minutes) - 5% of penalties
            'Fighting': { minutes: 5, weight: 3, description: 'Fighting' },
            'Boarding': { minutes: 5, weight: 1, description: 'Boarding (major)' },
            'Charging': { minutes: 5, weight: 0.5, description: 'Charging (major)' },
            
            // Misconduct (10 minutes, doesn't create PP) - 1.5% of penalties
            'Misconduct': { minutes: 10, weight: 1, description: 'Misconduct', noAdvantage: true },
            
            // Game Misconduct (ejection + 10 min) - 0.5% of penalties
            'Game Misconduct': { minutes: 10, weight: 0.3, description: 'Game Misconduct', ejection: true, noAdvantage: true }
        };

        const assignPenalties = (players) => {
            // NHL average: 3-4 penalties per team per game
            const numPenalties = Math.random() < 0.3 ? 2 : Math.random() < 0.7 ? 3 : 4;
            
            const penalties = [];
            
            for (let i = 0; i < numPenalties; i++) {
                // Select penalty type by weight
                const totalWeight = Object.values(PENALTY_TYPES).reduce((sum, p) => sum + p.weight, 0);
                let rand = Math.random() * totalWeight;
                let selectedPenalty = null;
                
                for (const [name, data] of Object.entries(PENALTY_TYPES)) {
                    rand -= data.weight;
                    if (rand <= 0) {
                        selectedPenalty = { name, ...data };
                        break;
                    }
                }
                
                if (!selectedPenalty) selectedPenalty = { name: 'Tripping', ...PENALTY_TYPES['Tripping'] };
                
                // Assign to a random player (weighted by position and rating)
                // Forwards get more penalties, lower rated players slightly more
                const eligiblePlayers = players.filter(p => p.position !== 'G');
                const weights = eligiblePlayers.map(p => {
                    const positionFactor = p.position === 'F' ? 1.2 : 1.0; // Forwards 20% more likely
                    const ratingFactor = 1.1 - (p.ratings.overall / 100) * 0.3; // Lower OVR = slightly more penalties
                    const toiFactor = getIceTime(p) / 15; // More TOI = more penalty chances
                    return positionFactor * ratingFactor * toiFactor;
                });
                
                const totalPlayerWeight = weights.reduce((sum, w) => sum + w, 0);
                rand = Math.random() * totalPlayerWeight;
                let culprit = eligiblePlayers[0];
                let cumulative = 0;
                
                for (let j = 0; j < eligiblePlayers.length; j++) {
                    cumulative += weights[j];
                    if (rand <= cumulative) {
                        culprit = eligiblePlayers[j];
                        break;
                    }
                }
                
                penalties.push({
                    player: culprit,
                    penalty: selectedPenalty
                });
            }
            
            return penalties;
        };
        // Based on NHL data: ~400 injuries per season across 32 teams = ~12.5 per team per season
        // ~0.15 injuries per game (1 injury every ~7 games)
        const INJURY_TYPES = {
            'Lower Body': { weight: 35, avgDays: 14 }, // Leg, knee, ankle, groin
            'Upper Body': { weight: 30, avgDays: 10 }, // Shoulder, arm, hand, wrist
            'Concussion': { weight: 15, avgDays: 21 }, // Head injuries
            'Core': { weight: 10, avgDays: 12 }, // Back, abdomen
            'Illness': { weight: 8, avgDays: 3 }, // Flu, COVID, etc.
            'Facial': { weight: 2, avgDays: 7 } // Broken nose, jaw, dental
        };

        const checkForInjury = (player, toi) => {
            // Base injury chance: ~3% per game (realistic NHL rates)
            // Expected: ~50-75 injuries per team per 82-game season
            // NHL average: 400-500 man-games lost per team = 5-6 players missing significant time
            const baseChance = 0.03; // 3% per game base
            
            // Position multiplier
            const positionMultiplier = player.position === 'G' ? 0.4 : player.position === 'F' ? 1.2 : 1.0;
            
            // TOI multiplier - scales with ice time (more ice time = more injury risk)
            const toiMultiplier = toi / 15;
            
            // Age factor - older players more injury-prone
            const ageFactor = player.age < 24 ? 0.8 : player.age > 32 ? 1.4 : 1.0;
            
            const injuryChance = baseChance * positionMultiplier * toiMultiplier * ageFactor;
            
            const roll = Math.random();
            if (roll < injuryChance) {
                // Injury occurred
                return generateInjury();
            }
            
            return null;
        };

        const generateInjury = () => {
            // Select injury type weighted by frequency
            const totalWeight = Object.values(INJURY_TYPES).reduce((sum, t) => sum + t.weight, 0);
            let rand = Math.random() * totalWeight;
            let injuryType = 'Lower Body';
            
            for (const [type, data] of Object.entries(INJURY_TYPES)) {
                rand -= data.weight;
                if (rand <= 0) {
                    injuryType = type;
                    break;
                }
            }
            
            const baseAvgDays = INJURY_TYPES[injuryType].avgDays;
            
            // Severity distribution: 60% DTD/Week, 25% Month, 10% Season, 4.9% rare, 0.1% career-ending
            const severityRoll = Math.random();
            
            let severity, daysOut;
            
            if (severityRoll < 0.60) {
                severity = Math.random() < 0.5 ? 'Day-to-Day' : 'Week-to-Week';
                daysOut = Math.floor(1 + Math.random() * 14);
            } else if (severityRoll < 0.85) {
                severity = 'Month-to-Month';
                daysOut = Math.floor(15 + Math.random() * 46);
            } else if (severityRoll < 0.999) {
                severity = 'Season-Ending';
                daysOut = 999;
            } else {
                severity = 'Career-Ending';
                daysOut = 9999;
            }
            
            return {
                injured: true,
                type: injuryType,
                severity: severity,
                gamesOut: 0,
                daysUntilReturn: daysOut,
                isCareerEnding: severity === 'Career-Ending'
            };
        };

        const updateInjuries = (players) => {
            players.forEach(player => {
                if (player.injury.injured && !player.injury.isCareerEnding) {
                    player.injury.daysUntilReturn--;
                    
                    if (player.injury.daysUntilReturn <= 0) {
                        // Player has healed - clear injury
                        player.injury = {
                            injured: false,
                            type: null,
                            severity: null,
                            gamesOut: 0,
                            daysUntilReturn: 0,
                            isCareerEnding: false
                        };
                        
                        // Return player to their original position
                        if (player.originalLineNumber !== null) {
                            // Find who's currently in their spot
                            const currentOccupant = players.find(p =>
                                p.nhlAffiliation === player.nhlAffiliation &&
                                p.roster === 'nhl' &&
                                p.position === player.position &&
                                p.lineNumber === player.originalLineNumber &&
                                p.linePosition === player.originalLinePosition &&
                                p.id !== player.id
                            );
                            
                            // Return healed player to original spot
                            if (player.position === 'G') {
                                player.dressed = player.originalDressed;
                            } else {
                                player.lineNumber = player.originalLineNumber;
                                player.linePosition = player.originalLinePosition;
                            }
                            
                            // If occupant was injury replacement from farm, send them back
                            if (currentOccupant && currentOccupant.isInjuryReplacement && currentOccupant.originalRoster === 'farm') {
                                const farmTeam = FARM_TEAMS.find(t => t.nhlAffiliation === currentOccupant.nhlAffiliation);
                                if (farmTeam) {
                                    currentOccupant.roster = 'farm';
                                    currentOccupant.teamId = farmTeam.id;
                                    currentOccupant.lineNumber = 0;
                                    currentOccupant.linePosition = null;
                                    currentOccupant.dressed = false;
                                    currentOccupant.isInjuryReplacement = false;
                                    currentOccupant.originalRoster = null;
                                }
                            } else if (currentOccupant) {
                                // If NHL player, just scratch them
                                if (currentOccupant.position === 'G') {
                                    currentOccupant.dressed = false;
                                } else {
                                    currentOccupant.lineNumber = 0;
                                    currentOccupant.linePosition = null;
                                }
                            }
                            
                            // Clear original position tracking
                            player.originalLineNumber = null;
                            player.originalLinePosition = null;
                            player.originalDressed = null;
                        }
                    }
                }
            });
        };

        const getPlayerStatus = (player) => {
            if (!player.injury.injured) return 'Active';
            if (player.injury.isCareerEnding) return 'Retired';
            if (player.injury.severity === 'Season-Ending') return 'Out';
            if (player.injury.severity === 'Month-to-Month') return 'IR';
            if (player.injury.severity === 'Week-to-Week') return 'Out';
            return 'DTD';
        };
        
        // Call up player from farm to NHL
        const callUpPlayer = (playerId) => {
            if (!gameState) return;
            
            const newPlayers = [...gameState.players];
            const player = newPlayers.find(p => p.id === playerId);
            
            if (player && player.roster === 'farm') {
                const nhlTeam = player.nhlAffiliation;
                player.roster = 'nhl';
                player.teamId = nhlTeam;
                player.lineNumber = 0; // Scratched until assigned
                player.linePosition = null;
                if (player.position === 'G') player.dressed = false;
                setGameState({ ...gameState, players: newPlayers });
            }
        };
        
        // Send down player from NHL to farm
        const sendDownPlayer = (playerId) => {
            if (!gameState) return;
            
            const newPlayers = [...gameState.players];
            const player = newPlayers.find(p => p.id === playerId);
            
            if (player && player.roster === 'nhl' && !player.injury.injured) {
                const farmTeam = FARM_TEAMS.find(t => t.nhlAffiliation === player.nhlAffiliation);
                if (farmTeam) {
                    player.roster = 'farm';
                    player.teamId = farmTeam.id;
                    player.lineNumber = 0;
                    player.linePosition = null;
                    if (player.position === 'G') player.dressed = false;
                    setGameState({ ...gameState, players: newPlayers });
                }
            }
        };
        
        // Auto-call-up replacement when player gets injured
        const autoCallUpReplacement = (allPlayers, injuredPlayer) => {
            const nhlTeamId = injuredPlayer.nhlAffiliation || injuredPlayer.teamId;
            const position = injuredPlayer.position;
            
            // Store injured player's original position
            if (!injuredPlayer.originalLineNumber) {
                injuredPlayer.originalLineNumber = injuredPlayer.lineNumber;
                injuredPlayer.originalLinePosition = injuredPlayer.linePosition;
                injuredPlayer.originalDressed = injuredPlayer.dressed;
            }
            
            // First: Try to find scratched NHL player
            let replacement = allPlayers
                .filter(p => 
                    p.nhlAffiliation === nhlTeamId &&
                    p.roster === 'nhl' &&
                    p.position === position && 
                    !p.injury.injured &&
                    (position === 'G' ? !p.dressed : p.lineNumber === 0)
                )
                .sort((a, b) => b.ratings.overall - a.ratings.overall)[0];
            
            // Second: If no NHL scratches, call up from farm
            if (!replacement) {
                replacement = allPlayers
                    .filter(p => 
                        p.nhlAffiliation === nhlTeamId &&
                        p.roster === 'farm' &&
                        p.position === position &&
                        !p.injury.injured
                    )
                    .sort((a, b) => b.ratings.overall - a.ratings.overall)[0];
                
                // If calling from farm, move them to NHL roster
                if (replacement) {
                    replacement.roster = 'nhl';
                    replacement.teamId = nhlTeamId;
                    replacement.isInjuryReplacement = true;
                    // Store their original farm status
                    replacement.originalLineNumber = 0; // Will return to farm
                    replacement.originalRoster = 'farm';
                }
            }
            
            if (replacement) {
                // Take injured player's spot in lineup
                if (position === 'G') {
                    replacement.dressed = true;
                } else {
                    replacement.lineNumber = injuredPlayer.lineNumber;
                    replacement.linePosition = injuredPlayer.linePosition;
                }
                
                // DON'T scratch injured player - leave them in roster but marked injured
                // They keep their line assignment so we know where to put them back
            }
        };

        const simulateGameResult = (homePlayers, awayPlayers) => {
            // Filter out injured players - they can't play
            const homeInjured = homePlayers.filter(p => p.injury.injured);
            const awayInjured = awayPlayers.filter(p => p.injury.injured);
            
            let homeAvailable = homePlayers.filter(p => !p.injury.injured);
            let awayAvailable = awayPlayers.filter(p => !p.injury.injured);
            
            // Load Management / Healthy Scratches
            const homeScratched = [];
            const awayScratched = [];
            
            homeAvailable = homeAvailable.filter(p => {
                if (p.position === 'G') return true; // Goalies use different system
                
                let scratchChance = 0.01;
                if (p.age > 35) scratchChance += 0.05;
                else if (p.age > 32) scratchChance += 0.02;
                if (p.ratings.overall >= 85) scratchChance *= 0.3;
                
                const scratched = Math.random() <= scratchChance;
                if (scratched) homeScratched.push(p);
                return !scratched;
            });
            
            awayAvailable = awayAvailable.filter(p => {
                if (p.position === 'G') return true;
                let scratchChance = 0.01;
                if (p.age > 35) scratchChance += 0.05;
                else if (p.age > 32) scratchChance += 0.02;
                if (p.ratings.overall >= 85) scratchChance *= 0.3;
                
                const scratched = Math.random() <= scratchChance;
                if (scratched) awayScratched.push(p);
                return !scratched;
            });
            
            const homeForwards = homeAvailable.filter(p => p.position === 'F').sort((a, b) => b.ratings.overall - a.ratings.overall);
            const homeDefense = homeAvailable.filter(p => p.position === 'D').sort((a, b) => b.ratings.overall - a.ratings.overall);
            const homeGoalies = homeAvailable.filter(p => p.position === 'G').sort((a, b) => b.ratings.overall - a.ratings.overall);
            const awayForwards = awayAvailable.filter(p => p.position === 'F').sort((a, b) => b.ratings.overall - a.ratings.overall);
            const awayDefense = awayAvailable.filter(p => p.position === 'D').sort((a, b) => b.ratings.overall - a.ratings.overall);
            const awayGoalies = awayAvailable.filter(p => p.position === 'G').sort((a, b) => b.ratings.overall - a.ratings.overall);
            
            // Players who dressed for this game - use ALL available players (already filtered by lineup)
            const homeDressed = [...homeForwards, ...homeDefense, ...homeGoalies];
            const awayDressed = [...awayForwards, ...awayDefense, ...awayGoalies];
            
            // Calculate team ratings using available players
            const homeRating = [...homeForwards, ...homeDefense].reduce((sum, p) => sum + p.ratings.overall, 0) / (homeForwards.length + homeDefense.length || 1);
            const awayRating = [...awayForwards, ...awayDefense].reduce((sum, p) => sum + p.ratings.overall, 0) / (awayForwards.length + awayDefense.length || 1);
            
            const homeAdvantage = 3;
            const adjustedHomeRating = homeRating + homeAdvantage;
            
            // Determine total goals
            const scoringRoll = Math.random();
            let totalGoals;
            
            if (scoringRoll < 0.15) {
                totalGoals = Math.floor(Math.random() * 5);
            } else if (scoringRoll < 0.70) {
                totalGoals = 5 + Math.floor(Math.random() * 4);
            } else {
                totalGoals = 9 + Math.floor(Math.random() * 5);
            }
            
            totalGoals += Math.random() < 0.3 ? 1 : 0;
            
            // Distribute goals
            const homeChance = adjustedHomeRating / (adjustedHomeRating + awayRating);
            
            let homeGoals = 0;
            let awayGoals = 0;
            
            for (let i = 0; i < totalGoals; i++) {
                if (Math.random() < homeChance) {
                    homeGoals++;
                } else {
                    awayGoals++;
                }
            }
            
            if (homeGoals === awayGoals) {
                if (Math.random() < homeChance) {
                    homeGoals++;
                } else {
                    awayGoals++;
                }
            }
            
            const winner = homeGoals > awayGoals ? 'home' : 'away';
            
            // Initialize per-game stats for all dressed players
            const homePlayerStats = {};
            const awayPlayerStats = {};
            
            homeDressed.forEach(p => {
                homePlayerStats[p.id] = {
                    player: p,
                    goals: 0,
                    assists: 0,
                    points: 0,
                    plusMinus: 0,
                    pim: 0,
                    shots: 0,
                    toi: getIceTime(p),
                    // Goalie specific
                    saves: 0,
                    goalsAgainst: 0,
                    shotsAgainst: 0
                };
            });
            
            awayDressed.forEach(p => {
                awayPlayerStats[p.id] = {
                    player: p,
                    goals: 0,
                    assists: 0,
                    points: 0,
                    plusMinus: 0,
                    pim: 0,
                    shots: 0,
                    toi: getIceTime(p),
                    saves: 0,
                    goalsAgainst: 0,
                    shotsAgainst: 0
                };
            });
            
            // Assign goals and assists to HOME team and build scoring summary
            const homeSkaters = homeDressed.filter(p => p.position !== 'G');
            const homeGoalEvents = []; // Track each goal for period summary
            
            for (let i = 0; i < homeGoals; i++) {
                const goalWeights = homeSkaters.map(p => ({
                    player: p,
                    weight: Math.pow(p.ratings.overall / 100, 2.5) * 
                           (p.lineNumber === 1 ? 1.3 : p.lineNumber === 2 ? 0.95 : 0.7) *
                           (p.ratings.overall >= 90 ? 1.2 : 1.0) *
                           (p.position === 'D' ? 0.2 : 1.0)
                }));
                
                const totalWeight = goalWeights.reduce((sum, w) => sum + w.weight, 0);
                let rand = Math.random() * totalWeight;
                let scorer = goalWeights[0].player;
                
                for (const w of goalWeights) {
                    rand -= w.weight;
                    if (rand <= 0) {
                        scorer = w.player;
                        break;
                    }
                }
                
                homePlayerStats[scorer.id].goals++;
                homePlayerStats[scorer.id].shots += 1 + Math.floor(Math.random() * 2);
                
                // Assign assists
                const numAssists = Math.random() < 0.03 ? 0 : Math.random() < 0.15 ? 1 : 2;
                const eligibleAssisters = homeSkaters.filter(p => p.id !== scorer.id);
                const assisters = [];
                
                for (let a = 0; a < numAssists && assisters.length < 2; a++) {
                    const assistWeights = eligibleAssisters.filter(p => !assisters.includes(p)).map(p => ({
                        player: p,
                        weight: Math.pow(p.ratings.overall / 100, 2.5) *
                               (p.lineNumber === 1 ? 1.3 : p.lineNumber === 2 ? 0.95 : 0.7) *
                               (p.position === 'D' ? 1.1 : 1.0)
                    }));
                    
                    if (assistWeights.length > 0) {
                        const totalAssistWeight = assistWeights.reduce((sum, w) => sum + w.weight, 0);
                        let assistRand = Math.random() * totalAssistWeight;
                        
                        for (const w of assistWeights) {
                            assistRand -= w.weight;
                            if (assistRand <= 0) {
                                assisters.push(w.player);
                                homePlayerStats[w.player.id].assists++;
                                break;
                            }
                        }
                    }
                }
                
                // Store goal event for period summary
                homeGoalEvents.push({
                    scorer: scorer,
                    assisters: assisters,
                    goalNumber: i + 1
                });
            }
            
            // Assign goals and assists to AWAY team and build scoring summary
            const awaySkaters = awayDressed.filter(p => p.position !== 'G');
            const awayGoalEvents = []; // Track each goal for period summary
            
            for (let i = 0; i < awayGoals; i++) {
                const goalWeights = awaySkaters.map(p => ({
                    player: p,
                    weight: Math.pow(p.ratings.overall / 100, 2.5) * 
                           (p.lineNumber === 1 ? 1.3 : p.lineNumber === 2 ? 0.95 : 0.7) *
                           (p.ratings.overall >= 90 ? 1.2 : 1.0) *
                           (p.position === 'D' ? 0.2 : 1.0)
                }));
                
                const totalWeight = goalWeights.reduce((sum, w) => sum + w.weight, 0);
                let rand = Math.random() * totalWeight;
                let scorer = goalWeights[0].player;
                
                for (const w of goalWeights) {
                    rand -= w.weight;
                    if (rand <= 0) {
                        scorer = w.player;
                        break;
                    }
                }
                
                awayPlayerStats[scorer.id].goals++;
                awayPlayerStats[scorer.id].shots += 1 + Math.floor(Math.random() * 2);
                
                const numAssists = Math.random() < 0.03 ? 0 : Math.random() < 0.15 ? 1 : 2;
                const eligibleAssisters = awaySkaters.filter(p => p.id !== scorer.id);
                const assisters = [];
                
                for (let a = 0; a < numAssists && assisters.length < 2; a++) {
                    const assistWeights = eligibleAssisters.filter(p => !assisters.includes(p)).map(p => ({
                        player: p,
                        weight: Math.pow(p.ratings.overall / 100, 2.5) *
                               (p.lineNumber === 1 ? 1.3 : p.lineNumber === 2 ? 0.95 : 0.7) *
                               (p.position === 'D' ? 1.1 : 1.0)
                    }));
                    
                    if (assistWeights.length > 0) {
                        const totalAssistWeight = assistWeights.reduce((sum, w) => sum + w.weight, 0);
                        let assistRand = Math.random() * totalAssistWeight;
                        
                        for (const w of assistWeights) {
                            assistRand -= w.weight;
                            if (assistRand <= 0) {
                                assisters.push(w.player);
                                awayPlayerStats[w.player.id].assists++;
                                break;
                            }
                        }
                    }
                }
                
                // Store goal event for period summary
                awayGoalEvents.push({
                    scorer: scorer,
                    assisters: assisters,
                    goalNumber: i + 1
                });
            }
            
            // Calculate points and add random shots for skaters
            Object.values(homePlayerStats).forEach(stats => {
                if (stats.player.position !== 'G') {
                    stats.points = stats.goals + stats.assists;
                    stats.shots += Math.floor(Math.random() * 3);
                    stats.plusMinus = winner === 'home' ? (Math.random() < 0.3 ? 1 : 0) : (Math.random() < 0.3 ? -1 : 0);
                }
            });
            
            Object.values(awayPlayerStats).forEach(stats => {
                if (stats.player.position !== 'G') {
                    stats.points = stats.goals + stats.assists;
                    stats.shots += Math.floor(Math.random() * 3);
                    stats.plusMinus = winner === 'away' ? (Math.random() < 0.3 ? 1 : 0) : (Math.random() < 0.3 ? -1 : 0);
                }
            });
            
            // Goalie stats
            if (homeGoalies.length > 0) {
                const homeGoalie = homeGoalies[0];
                homePlayerStats[homeGoalie.id].goalsAgainst = awayGoals;
                homePlayerStats[homeGoalie.id].shotsAgainst = Math.floor(25 + Math.random() * 10);
                homePlayerStats[homeGoalie.id].saves = homePlayerStats[homeGoalie.id].shotsAgainst - awayGoals;
            }
            
            if (awayGoalies.length > 0) {
                const awayGoalie = awayGoalies[0];
                awayPlayerStats[awayGoalie.id].goalsAgainst = homeGoals;
                awayPlayerStats[awayGoalie.id].shotsAgainst = Math.floor(25 + Math.random() * 10);
                awayPlayerStats[awayGoalie.id].saves = awayPlayerStats[awayGoalie.id].shotsAgainst - homeGoals;
            }
            
            // Generate period-by-period scoring summary
            // Distribute goals across 3 periods realistically
            const allGoals = [];
            homeGoalEvents.forEach(g => allGoals.push({ ...g, team: 'home' }));
            awayGoalEvents.forEach(g => allGoals.push({ ...g, team: 'away' }));
            
            // Shuffle goals to randomize order
            for (let i = allGoals.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allGoals[i], allGoals[j]] = [allGoals[j], allGoals[i]];
            }
            
            // Assign to periods (weighted: 33% per period, slight variance)
            const totalGoalsInGame = homeGoals + awayGoals;
            const periods = [
                { period: 1, goals: [] },
                { period: 2, goals: [] },
                { period: 3, goals: [] }
            ];
            
            allGoals.forEach((goal, idx) => {
                const periodRoll = Math.random();
                let period;
                if (periodRoll < 0.33) period = 0;
                else if (periodRoll < 0.66) period = 1;
                else period = 2;
                
                // Ensure last period has at least one goal if game has goals
                if (idx === allGoals.length - 1 && periods[2].goals.length === 0 && totalGoalsInGame > 1) {
                    period = 2;
                }
                
                periods[period].goals.push(goal);
            });
            
            // Generate scoring summary with running season totals
            // Note: We need to pass in pre-game stats to calculate running totals
            const scoringSummary = periods.map(p => ({
                period: p.period,
                goals: p.goals.map(g => ({
                    team: g.team,
                    scorer: {
                        id: g.scorer.id,
                        name: `${g.scorer.firstName} ${g.scorer.lastName}`,
                        // Season totals will be calculated when displaying
                    },
                    assists: g.assisters.map((a, idx) => ({
                        id: a.id,
                        name: `${a.firstName} ${a.lastName}`,
                        isPrimary: idx === 0
                    }))
                }))
            }));
            
            // Calculate team stats for this game
            const homeShots = Object.values(homePlayerStats).reduce((sum, p) => sum + (p.shots || 0), 0);
            const awayShots = Object.values(awayPlayerStats).reduce((sum, p) => sum + (p.shots || 0), 0);
            
            // Estimate PP/PK opportunities (roughly 3-4 power plays per team per game)
            const homePPOpportunities = Math.floor(Math.random() * 2) + 3; // 3-4
            const awayPPOpportunities = Math.floor(Math.random() * 2) + 3; // 3-4
            
            // PP success rate roughly 20% in NHL
            const homePPGoals = Math.floor(homePPOpportunities * (Math.random() * 0.15 + 0.10)); // 10-25%
            const awayPPGoals = Math.floor(awayPPOpportunities * (Math.random() * 0.15 + 0.10));
            
            return { 
                winner, 
                homeGoals, 
                awayGoals,
                homePlayers: homeForwards.slice(0, 15),
                awayPlayers: awayForwards.slice(0, 15),
                homeDefense: homeDefense.slice(0, 6),
                awayDefense: awayDefense.slice(0, 6),
                // NEW: Per-game stats
                homePlayerStats: Object.values(homePlayerStats),
                awayPlayerStats: Object.values(awayPlayerStats),
                homeInjured,
                awayInjured,
                homeScratched,
                awayScratched,
                // NEW: Period-by-period scoring summary
                scoringSummary: scoringSummary,
                // NEW: Team stats for this game
                teamStats: {
                    homeShots,
                    awayShots,
                    homePPOpportunities,
                    awayPPOpportunities,
                    homePPGoals,
                    awayPPGoals
                }
            };
        };

        const updatePlayerStats = (player, isWinner, goals) => {
            const toi = getIceTime(player);
            player.stats.timeOnIce += toi;
            player.stats.gamesPlayed++;
            
            if (player.position === 'G') return;
            
            // Target scoring rates for 82 game season:
            // Elite (90+ OVR, 1st line): ~1.4 pts/game = 115 pts/season (50G, 65A)
            // Star (85+ OVR, 1st line): ~1.0 pts/game = 82 pts/season (35G, 47A)
            // Good (80-84 OVR, 1st/2nd line): ~0.85 pts/game = 70 pts/season (28G, 42A)
            // Average (70-79 OVR, 2nd/3rd line): ~0.5 pts/game = 41 pts/season (15G, 26A)
            // Below avg (60-69 OVR, 3rd/4th line): ~0.25 pts/game = 20 pts/season (7G, 13A)
            
            const ratingFactor = Math.pow(player.ratings.overall / 100, 2.5);
            const toiFactor = toi / 18;
            const lineMultiplier = player.lineNumber === 1 ? 1.3 : player.lineNumber === 2 ? 0.95 : player.lineNumber === 3 ? 0.7 : 0.5;
            
            // Elite bonus for 90+ rated players
            const eliteBonus = player.ratings.overall >= 90 ? 1.2 : 1.0;
            
            // Defense have much lower scoring rates
            const positionMultiplier = player.position === 'D' ? 0.25 : 1.0;
            
            // MUCH higher goal and assist chances to match NHL scoring
            const baseGoalChance = ratingFactor * toiFactor * lineMultiplier * positionMultiplier * eliteBonus * 0.55;
            const baseAssistChance = ratingFactor * toiFactor * lineMultiplier * eliteBonus * 0.85;
            
            // Goals
            if (Math.random() < baseGoalChance) {
                player.stats.goals++;
            }
            
            // Assists (can get assist even if scored)
            if (Math.random() < baseAssistChance) {
                player.stats.assists++;
            }
            
            // Multi-point games for good players
            if (player.ratings.overall >= 85) {
                // Top players get multi-point games ~20% of the time
                if (Math.random() < 0.20) {
                    if (Math.random() < 0.4 && player.position === 'F') {
                        player.stats.goals++;
                    } else {
                        player.stats.assists++;
                    }
                }
            } else if (player.ratings.overall >= 75) {
                // Good players get multi-point games ~10% of the time
                if (Math.random() < 0.10) {
                    if (Math.random() < 0.4 && player.position === 'F') {
                        player.stats.goals++;
                    } else {
                        player.stats.assists++;
                    }
                }
            }
            
            // Points = Goals + Assists
            player.stats.points = player.stats.goals + player.stats.assists;
            
            // Shots on goal - 2-4 per game
            const shotChance = toiFactor * 0.25;
            const shotsThisGame = Math.floor(Math.random() * 3) + (Math.random() < shotChance ? 2 : 1);
            player.stats.shots += player.position === 'D' ? Math.floor(shotsThisGame * 0.7) : shotsThisGame;
            
            // Plus/minus
            const pmBase = isWinner ? 1 : -1;
            if (Math.random() < 0.3) {
                player.stats.plusMinus += pmBase;
            }
            
            // Penalty minutes
            if (Math.random() < 0.08) {
                player.stats.pim += 2;
            }
        };

        // Bracket View Component
        function BracketView({ playoffState, TEAMS }) {
            // Build history object that shows ALL rounds including current round's LIVE scores
            const history = {
                eastRound1: playoffState.history?.eastRound1 || (playoffState.round === 1 ? playoffState.eastMatchups : []),
                westRound1: playoffState.history?.westRound1 || (playoffState.round === 1 ? playoffState.westMatchups : []),
                eastRound2: playoffState.history?.eastRound2 || (playoffState.round === 2 ? playoffState.eastMatchups : []),
                westRound2: playoffState.history?.westRound2 || (playoffState.round === 2 ? playoffState.westMatchups : []),
                eastRound3: playoffState.history?.eastRound3 || (playoffState.round === 3 ? playoffState.eastMatchups : []),
                westRound3: playoffState.history?.westRound3 || (playoffState.round === 3 ? playoffState.westMatchups : []),
                final: playoffState.history?.final || (playoffState.round === 4 ? playoffState.finalMatchup : null)
            };
            
            // Override history with CURRENT round's live data to show real-time updates
            if (playoffState.round === 1) {
                history.eastRound1 = playoffState.eastMatchups;
                history.westRound1 = playoffState.westMatchups;
            } else if (playoffState.round === 2) {
                history.eastRound2 = playoffState.eastMatchups;
                history.westRound2 = playoffState.westMatchups;
            } else if (playoffState.round === 3) {
                history.eastRound3 = playoffState.eastMatchups;
                history.westRound3 = playoffState.westMatchups;
            } else if (playoffState.round === 4) {
                history.final = playoffState.finalMatchup;
            }
            
            const getWinner = (matchup) => {
                if (!matchup) return null;
                if (matchup.homeWins >= 4) return matchup.home;
                if (matchup.awayWins >= 4) return matchup.away;
                return null;
            };
            
            const renderMatchup = (matchup, isGrayedOut = false) => {
                if (!matchup) {
                    if (isGrayedOut) {
                        return (
                            <div style={{ 
                                padding: '0.75rem', 
                                background: 'rgba(30, 58, 138, 0.1)', 
                                borderRadius: '0.375rem',
                                border: '1px dashed rgba(100, 116, 139, 0.3)',
                                marginBottom: '0.5rem'
                            }}>
                                <div style={{ color: '#64748b', fontSize: '0.875rem', textAlign: 'center' }}>TBD</div>
                            </div>
                        );
                    }
                    return null;
                }
                
                const homeTeam = TEAMS.find(t => t.id === matchup.home);
                const awayTeam = TEAMS.find(t => t.id === matchup.away);
                const winner = getWinner(matchup);
                const isComplete = winner !== null;
                
                return (
                    <div style={{ 
                        padding: '0.75rem', 
                        background: isComplete ? 'rgba(34, 211, 238, 0.1)' : 'rgba(30, 58, 138, 0.2)', 
                        borderRadius: '0.375rem',
                        border: isComplete ? '2px solid #22c55e' : '1px solid rgba(59, 130, 246, 0.3)',
                        marginBottom: '0.5rem'
                    }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.25rem' }}>
                            <span style={{ 
                                fontSize: '0.875rem',
                                fontWeight: winner === matchup.home ? 'bold' : 'normal',
                                color: winner === matchup.home ? '#22c55e' : '#fff'
                            }}>
                                {homeTeam.city}
                            </span>
                            <span style={{ fontSize: '1rem', fontWeight: 'bold' }}>{matchup.homeWins}</span>
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <span style={{ 
                                fontSize: '0.875rem',
                                fontWeight: winner === matchup.away ? 'bold' : 'normal',
                                color: winner === matchup.away ? '#22c55e' : '#fff'
                            }}>
                                {awayTeam.city}
                            </span>
                            <span style={{ fontSize: '1rem', fontWeight: 'bold' }}>{matchup.awayWins}</span>
                        </div>
                    </div>
                );
            };
            
            return (
                <div style={{ overflowX: 'auto' }}>
                    <div style={{ minWidth: '1200px', padding: '1rem' }}>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '1rem' }}>
                            {/* EASTERN CONFERENCE - Round 1 */}
                            <div>
                                <h4 style={{ color: '#3b82f6', textAlign: 'center', marginBottom: '0.75rem', fontSize: '0.9rem' }}>
                                    EAST R1
                                </h4>
                                {history.eastRound1.length > 0 ? history.eastRound1.map((m, i) => (
                                    <div key={i}>{renderMatchup(m)}</div>
                                )) : (
                                    <>
                                        {renderMatchup(null, true)}
                                        {renderMatchup(null, true)}
                                        {renderMatchup(null, true)}
                                        {renderMatchup(null, true)}
                                    </>
                                )}
                            </div>
                            
                            {/* EASTERN CONFERENCE - Round 2 */}
                            <div>
                                <h4 style={{ color: '#3b82f6', textAlign: 'center', marginBottom: '0.75rem', fontSize: '0.9rem' }}>
                                    EAST R2
                                </h4>
                                <div style={{ marginTop: '3rem' }}>
                                    {history.eastRound2.length > 0 ? history.eastRound2.map((m, i) => (
                                        <div key={i}>{renderMatchup(m)}</div>
                                    )) : (
                                        <>
                                            {renderMatchup(null, true)}
                                            {renderMatchup(null, true)}
                                        </>
                                    )}
                                </div>
                            </div>
                            
                            {/* EASTERN CONFERENCE - Conference Finals */}
                            <div>
                                <h4 style={{ color: '#3b82f6', textAlign: 'center', marginBottom: '0.75rem', fontSize: '0.9rem' }}>
                                    EAST FINAL
                                </h4>
                                <div style={{ marginTop: '6rem' }}>
                                    {history.eastRound3.length > 0 ? renderMatchup(history.eastRound3[0]) : renderMatchup(null, true)}
                                </div>
                            </div>
                            
                            {/* STANLEY CUP FINALS */}
                            <div>
                                <h4 style={{ color: '#fbbf24', textAlign: 'center', marginBottom: '0.75rem', fontSize: '1rem', fontWeight: 'bold' }}>
                                     CUP 
                                </h4>
                                <div style={{ marginTop: '9rem' }}>
                                    {history.final ? (
                                        <div style={{
                                            padding: '1rem',
                                            background: 'rgba(251, 191, 36, 0.15)',
                                            borderRadius: '0.5rem',
                                            border: '3px solid #fbbf24'
                                        }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                                                <span style={{ 
                                                    fontWeight: history.final.homeWins >= 4 ? 'bold' : 'normal',
                                                    color: history.final.homeWins >= 4 ? '#fbbf24' : '#fff'
                                                }}>
                                                    {TEAMS.find(t => t.id === history.final.home)?.city}
                                                </span>
                                                <span style={{ fontSize: '1.2rem', fontWeight: 'bold' }}>{history.final.homeWins}</span>
                                            </div>
                                            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                                <span style={{ 
                                                    fontWeight: history.final.awayWins >= 4 ? 'bold' : 'normal',
                                                    color: history.final.awayWins >= 4 ? '#fbbf24' : '#fff'
                                                }}>
                                                    {TEAMS.find(t => t.id === history.final.away)?.city}
                                                </span>
                                                <span style={{ fontSize: '1.2rem', fontWeight: 'bold' }}>{history.final.awayWins}</span>
                                            </div>
                                            {(history.final.homeWins >= 4 || history.final.awayWins >= 4) && (
                                                <div style={{ 
                                                    marginTop: '0.75rem', 
                                                    padding: '0.5rem',
                                                    background: '#fbbf24',
                                                    borderRadius: '0.25rem',
                                                    textAlign: 'center',
                                                    color: '#0f172a',
                                                    fontWeight: 'bold'
                                                }}>
                                                    CHAMPION!
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        renderMatchup(null, true)
                                    )}
                                </div>
                            </div>
                            
                            {/* WESTERN CONFERENCE - Conference Finals */}
                            <div>
                                <h4 style={{ color: '#ef4444', textAlign: 'center', marginBottom: '0.75rem', fontSize: '0.9rem' }}>
                                    WEST FINAL
                                </h4>
                                <div style={{ marginTop: '6rem' }}>
                                    {history.westRound3.length > 0 ? renderMatchup(history.westRound3[0]) : renderMatchup(null, true)}
                                </div>
                            </div>
                            
                            {/* WESTERN CONFERENCE - Round 2 */}
                            <div>
                                <h4 style={{ color: '#ef4444', textAlign: 'center', marginBottom: '0.75rem', fontSize: '0.9rem' }}>
                                    WEST R2
                                </h4>
                                <div style={{ marginTop: '3rem' }}>
                                    {history.westRound2.length > 0 ? history.westRound2.map((m, i) => (
                                        <div key={i}>{renderMatchup(m)}</div>
                                    )) : (
                                        <>
                                            {renderMatchup(null, true)}
                                            {renderMatchup(null, true)}
                                        </>
                                    )}
                                </div>
                            </div>
                            
                            {/* WESTERN CONFERENCE - Round 1 */}
                            <div>
                                <h4 style={{ color: '#ef4444', textAlign: 'center', marginBottom: '0.75rem', fontSize: '0.9rem' }}>
                                    WEST R1
                                </h4>
                                {history.westRound1.length > 0 ? history.westRound1.map((m, i) => (
                                    <div key={i}>{renderMatchup(m)}</div>
                                )) : (
                                    <>
                                        {renderMatchup(null, true)}
                                        {renderMatchup(null, true)}
                                        {renderMatchup(null, true)}
                                        {renderMatchup(null, true)}
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function HockeyGM() {
            const [gameState, setGameState] = useState(null);
            const [playoffState, setPlayoffState] = useState(null);
            const [seasonAwards, setSeasonAwards] = useState(null);
            const [playoffMVP, setPlayoffMVP] = useState(null);
            const [userTeamId, setUserTeamId] = useState(null);
            const [savedLineups, setSavedLineups] = useState([]); // Store saved line combinations
            const [currentView, setCurrentView] = useState('standings');
            const [selectedPlayoffGame, setSelectedPlayoffGame] = useState(null);
            const [seasonMode, setSeasonMode] = useState('regular'); // 'regular' or 'playoffs'
            const [playerStatMode, setPlayerStatMode] = useState('regular'); // For individual player profile
            const [standingsView, setStandingsView] = useState('division');
            const [selectedPlayer, setSelectedPlayer] = useState(null);
            const [selectedTeam, setSelectedTeam] = useState(null);
            const [viewStack, setViewStack] = useState([]);
            const [selectedPlayerProfile, setSelectedPlayerProfile] = useState(null);
            const [selectedTeamProfile, setSelectedTeamProfile] = useState(null);
            const [selectedGame, setSelectedGame] = useState(null);
            const [selectedDate, setSelectedDate] = useState(null);
            const [gameDetailTeamTab, setGameDetailTeamTab] = useState('away'); // 'away' or 'home'
            const [teamProfileSort, setTeamProfileSort] = useState({ key: 'stats.points', direction: 'desc' });
            const [sortConfig, setSortConfig] = useState({ key: 'stats.points', direction: 'desc' });
            const [standingsSortConfig, setStandingsSortConfig] = useState({ key: 'points', direction: 'desc' });
            const [leadersSortConfig, setLeadersSortConfig] = useState({ key: 'stats.points', direction: 'desc' });
            const [injuriesSortConfig, setInjuriesSortConfig] = useState({ key: 'injury.severity', direction: 'desc' });

            // Trade view state
            const [mySelectedPlayers, setMySelectedPlayers] = useState([]);
            const [theirSelectedPlayers, setTheirSelectedPlayers] = useState([]);
            const [tradePartnerTeamId, setTradePartnerTeamId] = useState(null);
            const [tradeSortConfig, setTradeSortConfig] = useState({ key: 'ratings.overall', direction: 'desc' });
            const [tradeMessage, setTradeMessage] = useState(null);

            // PERFORMANCE OPTIMIZATION: Create lookup maps for O(1) access
            const teamsMap = useMemo(() => {
                const map = new Map();
                TEAMS.forEach(team => map.set(team.id, team));
                return map;
            }, []); // TEAMS array never changes

            const farmTeamsMap = useMemo(() => {
                const map = new Map();
                FARM_TEAMS.forEach(team => map.set(team.id, team));
                return map;
            }, []); // FARM_TEAMS array never changes

            // PERFORMANCE OPTIMIZATION: Memoize filtered player lists
            const nhlPlayers = useMemo(() => {
                if (!gameState?.players) return [];
                return gameState.players.filter(p => p.roster === 'nhl');
            }, [gameState?.players]);

            const farmPlayers = useMemo(() => {
                if (!gameState?.players) return [];
                return gameState.players.filter(p => p.roster === 'farm');
            }, [gameState?.players]);

            const userRoster = useMemo(() => {
                if (!gameState?.players || !userTeamId) return [];
                return gameState.players.filter(p => p.teamId === userTeamId && p.roster === 'nhl');
            }, [gameState?.players, userTeamId]);

            const injuredPlayers = useMemo(() => {
                if (!gameState?.players) return [];
                return gameState.players.filter(p => p.injury.injured && p.roster === 'nhl');
            }, [gameState?.players]);

            // Helper function for fast team lookup
            const getTeam = useCallback((teamId) => {
                return teamsMap.get(teamId);
            }, [teamsMap]);

            const getFarmTeam = useCallback((teamId) => {
                return farmTeamsMap.get(teamId);
            }, [farmTeamsMap]);

            const handleSort = (key) => {
                const direction = sortConfig.key === key && sortConfig.direction === 'desc' ? 'asc' : 'desc';
                setSortConfig({ key, direction });
            };

            const sortData = (data, key, direction) => {
                return [...data].sort((a, b) => {
                    let aVal = a;
                    let bVal = b;
                    
                    // Handle nested properties like stats.points
                    const keys = key.split('.');
                    for (const k of keys) {
                        aVal = aVal?.[k];
                        bVal = bVal?.[k];
                    }
                    
                    if (typeof aVal === 'number' && typeof bVal === 'number') {
                        return direction === 'desc' ? bVal - aVal : aVal - bVal;
                    }
                    
                    if (typeof aVal === 'string' && typeof bVal === 'string') {
                        return direction === 'desc' ? bVal.localeCompare(aVal) : aVal.localeCompare(bVal);
                    }
                    
                    return 0;
                });
            };

            // Helper to create sortable header
            const SortableHeader = ({ label, sortKey, currentSort, onSort, className = "text-center" }) => {
                const isActive = currentSort.key === sortKey;
                return (
                    <th 
                        className={className}
                        style={{ cursor: 'pointer', userSelect: 'none' }}
                        onClick={() => {
                            const dir = isActive && currentSort.direction === 'desc' ? 'asc' : 'desc';
                            onSort({ key: sortKey, direction: dir });
                        }}
                    >
                        {label} {isActive && (currentSort.direction === 'desc' ? '' : '')}
                    </th>
                );
            };

            const navigateTo = (view, data = null) => {
                setViewStack([...viewStack, { view: currentView, data: { selectedPlayerProfile, selectedTeamProfile, selectedGame } }]);
                setCurrentView(view);
                if (view === 'playerProfile') setSelectedPlayerProfile(data);
                if (view === 'teamProfile') setSelectedTeamProfile(data);
                if (view === 'gameDetail') setSelectedGame(data);
            };

            const goBack = () => {
                if (viewStack.length === 0) return;
                const previous = viewStack[viewStack.length - 1];
                setViewStack(viewStack.slice(0, -1));
                setCurrentView(previous.view);
                setSelectedPlayerProfile(previous.data.selectedPlayerProfile);
                setSelectedTeamProfile(previous.data.selectedTeamProfile);
                setSelectedGame(previous.data.selectedGame);
            };

            const initGame = (teamId) => {
                const allPlayers = [];
                // Generate NHL rosters
                TEAMS.forEach(team => {
                    allPlayers.push(...generateRoster(team.id));
                });
                
                // Generate farm team rosters (23 players each, lower ratings)
                FARM_TEAMS.forEach(farmTeam => {
                    const farmRoster = [];
                    // 13 Forwards
                    for (let i = 0; i < 13; i++) {
                        farmRoster.push(generatePlayer('F', farmTeam.id, 0, true)); // isFarm = true
                    }
                    // 7 Defense
                    for (let i = 0; i < 7; i++) {
                        farmRoster.push(generatePlayer('D', farmTeam.id, 0, true));
                    }
                    // 3 Goalies
                    for (let i = 0; i < 3; i++) {
                        const goalie = generatePlayer('G', farmTeam.id, i + 1, true);
                        goalie.dressed = false; // Farm goalies don't have "dressed" status
                        farmRoster.push(goalie);
                    }
                    allPlayers.push(...farmRoster);
                });

                const schedule = generateSchedule();
                
                // Season runs October to April (regular season), then playoffs to June
                const currentYear = new Date().getFullYear();
                const seasonStartDate = new Date(currentYear, 9, 10); // October 10

                const newGameState = {
                    players: allPlayers,
                    standings: TEAMS.map(t => ({ 
                        teamId: t.id, 
                        wins: 0, 
                        losses: 0, 
                        otLosses: 0,
                        points: 0,
                        goalsFor: 0,
                        goalsAgainst: 0,
                        home: { wins: 0, losses: 0 },
                        away: { wins: 0, losses: 0 },
                        // Team stats for analytics
                        teamStats: {
                            gamesPlayed: 0,
                            shots: 0,
                            shotsAgainst: 0,
                            ppOpportunities: 0,
                            ppGoals: 0,
                            pkOpportunities: 0, 
                            pkGoalsAgainst: 0
                        }
                    })),
                    // Head-to-head records: { "1vs2": { team1Wins: 0, team2Wins: 0, ties: 0 }, ... }
                    headToHead: {},
                    schedule: schedule,
                    currentGame: 0,
                    season: 1,
                    year: currentYear, // Track actual year (e.g., 2025)
                    currentDate: new Date(seasonStartDate),
                    seasonStartDate: new Date(seasonStartDate),
                    lastGameDay: null,
                    lastGameTeams: []
                };
                
                setGameState(newGameState);
                setUserTeamId(teamId);
                setPlayoffState(null);
                setSeasonMode('regular');
                
                // Auto-save to localStorage
                saveGameToLocalStorage(newGameState, teamId, null, 'regular');
            };
            
            // Save game to localStorage
            const saveGameToLocalStorage = (gameStateToSave, userTeam, playoffStateToSave, mode) => {
                try {
                    const saveData = {
                        gameState: {
                            ...gameStateToSave,
                            // Convert dates to ISO strings for storage
                            currentDate: gameStateToSave.currentDate.toISOString(),
                            seasonStartDate: gameStateToSave.seasonStartDate.toISOString(),
                            lastGameDay: gameStateToSave.lastGameDay ? gameStateToSave.lastGameDay.toISOString() : null,
                            schedule: gameStateToSave.schedule.map(g => ({
                                ...g,
                                date: g.date ? g.date.toISOString() : null
                            }))
                        },
                        userTeamId: userTeam,
                        playoffState: playoffStateToSave,
                        seasonMode: mode,
                        savedAt: new Date().toISOString()
                    };
                    localStorage.setItem('hockeyGmSave', JSON.stringify(saveData));
                    console.log('Game saved to localStorage');
                } catch (error) {
                    console.error('Failed to save game:', error);
                }
            };
            
            // Load game from localStorage
            const loadGameFromLocalStorage = () => {
                try {
                    const savedData = localStorage.getItem('hockeyGmSave');
                    if (!savedData) return false;
                    
                    const saveData = JSON.parse(savedData);
                    
                    // Restore dates from ISO strings
                    const restoredGameState = {
                        ...saveData.gameState,
                        currentDate: new Date(saveData.gameState.currentDate),
                        seasonStartDate: new Date(saveData.gameState.seasonStartDate),
                        lastGameDay: saveData.gameState.lastGameDay ? new Date(saveData.gameState.lastGameDay) : null,
                        schedule: saveData.gameState.schedule.map(g => ({
                            ...g,
                            date: g.date ? new Date(g.date) : null
                        }))
                    };
                    
                    setGameState(restoredGameState);
                    setUserTeamId(saveData.userTeamId);
                    setPlayoffState(saveData.playoffState);
                    setSeasonMode(saveData.seasonMode || 'regular');
                    
                    console.log('Game loaded from localStorage');
                    return true;
                } catch (error) {
                    console.error('Failed to load game:', error);
                    return false;
                }
            };
            
            // Delete save
            const deleteSave = () => {
                if (confirm('Are you sure you want to delete your saved game? This cannot be undone.')) {
                    localStorage.removeItem('hockeyGmSave');
                    setGameState(null);
                    setUserTeamId(null);
                    setPlayoffState(null);
                    setSeasonMode('regular');
                    alert('Save deleted. Start a new game to continue.');
                }
            };
            
            // Auto-load on component mount
            React.useEffect(() => {
                const loaded = loadGameFromLocalStorage();
                if (loaded) {
                    console.log('Previous game loaded automatically');
                }
            }, []);
            
            // Auto-save whenever game state changes
            React.useEffect(() => {
                if (gameState && userTeamId) {
                    saveGameToLocalStorage(gameState, userTeamId, playoffState, seasonMode);
                }
            }, [gameState, playoffState, seasonMode]);

            // Calculate team overall rating (weighted by ice time and role)
            const calculateTeamOverall = useCallback((teamId, players) => {
                if (!players) return 0;
                
                const teamPlayers = players.filter(p => 
                    p.teamId === teamId && 
                    p.roster === 'nhl' && 
                    !p.injury.injured
                );
                
                if (teamPlayers.length === 0) return 0;
                
                let totalWeight = 0;
                let weightedSum = 0;
                
                // Process forwards (weight by line)
                const forwards = teamPlayers.filter(p => p.position === 'F' && p.lineNumber > 0);
                forwards.forEach(p => {
                    let weight = 0;
                    if (p.lineNumber === 1) weight = 1.5;      // Top line: 1.5x
                    else if (p.lineNumber === 2) weight = 1.0; // 2nd line: 1.0x
                    else if (p.lineNumber === 3) weight = 0.7; // 3rd line: 0.7x
                    else if (p.lineNumber === 4) weight = 0.4; // 4th line: 0.4x
                    
                    // Bonus for PP/PK specialists
                    if (p.ppUnit) weight += 0.15;  // PP adds 0.15x
                    if (p.pkUnit) weight += 0.10;  // PK adds 0.10x
                    
                    totalWeight += weight;
                    weightedSum += p.ratings.overall * weight;
                });
                
                // Process defensemen (weight by pair)
                const defense = teamPlayers.filter(p => p.position === 'D' && p.lineNumber > 0);
                defense.forEach(p => {
                    let weight = 0;
                    if (p.lineNumber === 1) weight = 1.4;      // Top pair: 1.4x
                    else if (p.lineNumber === 2) weight = 0.9; // 2nd pair: 0.9x
                    else if (p.lineNumber === 3) weight = 0.5; // 3rd pair: 0.5x
                    
                    // Bonus for PP/PK specialists
                    if (p.ppUnit) weight += 0.15;
                    if (p.pkUnit) weight += 0.10;
                    
                    totalWeight += weight;
                    weightedSum += p.ratings.overall * weight;
                });
                
                // Process goalies (dressed goalies only)
                const goalies = teamPlayers.filter(p => p.position === 'G' && p.dressed);
                goalies.forEach((p, idx) => {
                    const weight = idx === 0 ? 1.2 : 0.8; // Starter: 1.2x, Backup: 0.8x
                    totalWeight += weight;
                    weightedSum += p.ratings.overall * weight;
                });
                
                return totalWeight > 0 ? Math.round(weightedSum / totalWeight) : 0;
            }, []);

            // Calculate all team overalls and rankings (memoized for performance)
            const teamOveralls = useMemo(() => {
                if (!gameState?.players) return [];
                
                const overalls = TEAMS.map(team => ({
                    teamId: team.id,
                    overall: calculateTeamOverall(team.id, gameState.players)
                }));
                
                // Sort by overall (highest first) to determine rank
                const sorted = [...overalls].sort((a, b) => b.overall - a.overall);
                
                // Add rank to each team
                return overalls.map(team => {
                    const rank = sorted.findIndex(t => t.teamId === team.teamId) + 1;
                    return { ...team, rank };
                });
            }, [gameState?.players, calculateTeamOverall]);

            // Helper to get team overall and rank
            const getTeamOverall = useCallback((teamId) => {
                return teamOveralls.find(t => t.teamId === teamId);
            }, [teamOveralls]);

            // Auto-assign all lines for a team
            const autoSetAllLines = (players, teamId) => {
                const teamPlayers = players.filter(p => p.teamId === teamId && p.roster === 'nhl' && !p.injury.injured);
                
                // Sort by overall
                const forwards = teamPlayers.filter(p => p.position === 'F').sort((a, b) => b.ratings.overall - a.ratings.overall);
                const defense = teamPlayers.filter(p => p.position === 'D').sort((a, b) => b.ratings.overall - a.ratings.overall);
                const goalies = teamPlayers.filter(p => p.position === 'G').sort((a, b) => b.ratings.overall - a.ratings.overall);
                
                // Assign forwards to lines (top 12)
                forwards.forEach((p, idx) => {
                    if (idx < 12) {
                        p.lineNumber = Math.floor(idx / 3) + 1; // Lines 1-4
                    } else {
                        p.lineNumber = 0; // Scratch
                    }
                    p.linePosition = null; // Reset specific position
                });
                
                // Assign defense to pairs (top 6)
                defense.forEach((p, idx) => {
                    if (idx < 6) {
                        p.lineNumber = Math.floor(idx / 2) + 1; // Pairs 1-3
                    } else {
                        p.lineNumber = 0; // Scratch
                    }
                    p.linePosition = null;
                });
                
                // Assign goalies (top 2 dressed)
                goalies.forEach((p, idx) => {
                    p.dressed = idx < 2;
                });
            };

            // Call up player from farm
            const callUpPlayer = (playerId) => {
                if (!gameState) return;
                
                const newPlayers = [...gameState.players];
                const player = newPlayers.find(p => p.id === playerId);
                
                if (player && player.roster === 'farm') {
                    // Find player's NHL team
                    const farmTeam = FARM_TEAMS.find(t => t.id === player.teamId);
                    if (farmTeam) {
                        player.teamId = farmTeam.nhlAffiliation;
                        player.roster = 'nhl';
                        player.lineNumber = 0; // Start as scratch
                        player.linePosition = null;
                        player.ppUnit = null;
                        player.pkUnit = null;
                        if (player.position === 'G') player.dressed = false;
                        
                        setGameState({ ...gameState, players: newPlayers });
                        saveGameToLocalStorage({ ...gameState, players: newPlayers }, userTeamId, playoffState, seasonMode);
                    }
                }
            };

            // Send down player to farm
            const sendDownPlayer = (playerId) => {
                if (!gameState) return;
                
                const newPlayers = [...gameState.players];
                const player = newPlayers.find(p => p.id === playerId);
                
                if (player && player.roster === 'nhl' && !player.injury.injured) {
                    // Find team's farm affiliate
                    const farmTeam = FARM_TEAMS.find(t => t.nhlAffiliation === player.teamId);
                    if (farmTeam) {
                        player.teamId = farmTeam.id;
                        player.roster = 'farm';
                        player.lineNumber = 0;
                        player.linePosition = null;
                        player.ppUnit = null;
                        player.pkUnit = null;
                        if (player.position === 'G') player.dressed = false;
                        
                        setGameState({ ...gameState, players: newPlayers });
                        saveGameToLocalStorage({ ...gameState, players: newPlayers }, userTeamId, playoffState, seasonMode);
                    }
                }
            };

            // Calculate end-of-season awards
            const calculateAwards = (players, standings) => {
                const awards = {
                    league: {},
                    divisions: {
                        Atlantic: {},
                        Metropolitan: {},
                        Central: {},
                        Pacific: {}
                    },
                    allStars: {
                        firstTeam: {},
                        secondTeam: {},
                        thirdTeam: {},
                        divisions: {
                            Atlantic: {},
                            Metropolitan: {},
                            Central: {},
                            Pacific: {}
                        }
                    }
                };

                // Filter skaters and goalies
                const skaters = players.filter(p => p.position !== 'G' && p.stats.gamesPlayed >= 20);
                const goalies = players.filter(p => p.position === 'G' && p.stats.gamesPlayed >= 15);
                const forwards = players.filter(p => p.position === 'F' && p.stats.gamesPlayed >= 20);
                const defensemen = players.filter(p => p.position === 'D' && p.stats.gamesPlayed >= 20);

                // LEAGUE AWARDS
                
                // League MVP (Best overall player - points, +/-, performance)
                const mvpCandidates = skaters.map(p => ({
                    player: p,
                    score: (p.stats.points * 2) + (p.stats.plusMinus * 0.5) + (p.stats.gamesPlayed * 0.1)
                })).sort((a, b) => b.score - a.score);
                awards.league.mvp = mvpCandidates[0]?.player;

                // Best Goaltender (Save %, GAA, Wins)
                const goalieCandidates = goalies.map(p => ({
                    player: p,
                    score: (p.stats.savePercentage * 100) + ((3.0 - p.stats.gaa) * 10) + (p.stats.wins * 0.5)
                })).sort((a, b) => b.score - a.score);
                awards.league.bestGoalie = goalieCandidates[0]?.player;

                // Best Defenseman (Points, +/-, TOI for defensemen)
                const defensemanCandidates = defensemen.map(p => ({
                    player: p,
                    score: (p.stats.points * 2) + (p.stats.plusMinus * 1) + ((p.stats.timeOnIce / p.stats.gamesPlayed) * 0.01)
                })).sort((a, b) => b.score - a.score);
                awards.league.bestDefenseman = defensemanCandidates[0]?.player;

                // Rookie of the Year (Best first-year player - age <= 22, high points)
                const rookies = skaters.filter(p => p.age <= 22);
                const rookieCandidates = rookies.map(p => ({
                    player: p,
                    score: (p.stats.points * 2) + (p.stats.plusMinus * 0.5)
                })).sort((a, b) => b.score - a.score);
                awards.league.rookieOfYear = rookieCandidates[0]?.player;

                // Top Goal Scorer (Most goals)
                const topScorer = skaters.sort((a, b) => b.stats.goals - a.stats.goals)[0];
                awards.league.topGoalScorer = topScorer;

                // Top Point Scorer (Most points)
                const topPoints = skaters.sort((a, b) => b.stats.points - a.stats.points)[0];
                awards.league.topPointScorer = topPoints;

                // Best Defensive Forward (Best +/-, low PIM for forwards)
                const defensiveForwardCandidates = forwards.map(p => ({
                    player: p,
                    score: (p.stats.plusMinus * 2) - (p.stats.pim * 0.1) + (p.stats.gamesPlayed * 0.1)
                })).sort((a, b) => b.score - a.score);
                awards.league.bestDefensiveForward = defensiveForwardCandidates[0]?.player;

                // Sportsmanship Award (High points, low PIM)
                const sportsmanshipCandidates = skaters.map(p => ({
                    player: p,
                    score: (p.stats.points * 1.5) - (p.stats.pim * 0.5)
                })).sort((a, b) => b.score - a.score);
                awards.league.sportsmanship = sportsmanshipCandidates[0]?.player;

                // DIVISION AWARDS
                ['Atlantic', 'Metropolitan', 'Central', 'Pacific'].forEach(division => {
                    const divPlayers = players.filter(p => {
                        const team = TEAMS.find(t => t.id === p.teamId);
                        return team?.division === division;
                    });
                    
                    const divSkaters = divPlayers.filter(p => p.position !== 'G' && p.stats.gamesPlayed >= 20);
                    const divGoalies = divPlayers.filter(p => p.position === 'G' && p.stats.gamesPlayed >= 15);
                    const divDefensemen = divPlayers.filter(p => p.position === 'D' && p.stats.gamesPlayed >= 20);
                    const divRookies = divSkaters.filter(p => p.age <= 22);

                    // Division MVP
                    const divMvp = divSkaters.map(p => ({
                        player: p,
                        score: (p.stats.points * 2) + (p.stats.plusMinus * 0.5)
                    })).sort((a, b) => b.score - a.score)[0];
                    awards.divisions[division].mvp = divMvp?.player;

                    // Division Best Goalie
                    const divGoalie = divGoalies.map(p => ({
                        player: p,
                        score: (p.stats.savePercentage * 100) + ((3.0 - p.stats.gaa) * 10)
                    })).sort((a, b) => b.score - a.score)[0];
                    awards.divisions[division].bestGoalie = divGoalie?.player;

                    // Division Best Defenseman
                    const divDef = divDefensemen.map(p => ({
                        player: p,
                        score: (p.stats.points * 2) + (p.stats.plusMinus * 1)
                    })).sort((a, b) => b.score - a.score)[0];
                    awards.divisions[division].bestDefenseman = divDef?.player;

                    // Division Rookie
                    const divRookie = divRookies.map(p => ({
                        player: p,
                        score: (p.stats.points * 2) + (p.stats.plusMinus * 0.5)
                    })).sort((a, b) => b.score - a.score)[0];
                    awards.divisions[division].rookieOfYear = divRookie?.player;

                    // Division Top Scorer
                    const divTopScorer = divSkaters.sort((a, b) => b.stats.points - a.stats.points)[0];
                    awards.divisions[division].topScorer = divTopScorer;
                });

                // ALL-STAR TEAMS (League)
                
                // Goalies (top 3)
                const topGoalies = goalies.sort((a, b) => {
                    const scoreA = (a.stats.savePercentage * 100) + ((3.0 - a.stats.gaa) * 10);
                    const scoreB = (b.stats.savePercentage * 100) + ((3.0 - b.stats.gaa) * 10);
                    return scoreB - scoreA;
                });
                awards.allStars.firstTeam.goalie = topGoalies[0];
                awards.allStars.secondTeam.goalie = topGoalies[1];
                awards.allStars.thirdTeam.goalie = topGoalies[2];

                // Defensemen (top 6 - 2 per team)
                const topDefensemen = defensemen.sort((a, b) => {
                    const scoreA = (a.stats.points * 2) + (a.stats.plusMinus * 1);
                    const scoreB = (b.stats.points * 2) + (b.stats.plusMinus * 1);
                    return scoreB - scoreA;
                });
                awards.allStars.firstTeam.leftDefense = topDefensemen[0];
                awards.allStars.firstTeam.rightDefense = topDefensemen[1];
                awards.allStars.secondTeam.leftDefense = topDefensemen[2];
                awards.allStars.secondTeam.rightDefense = topDefensemen[3];
                awards.allStars.thirdTeam.leftDefense = topDefensemen[4];
                awards.allStars.thirdTeam.rightDefense = topDefensemen[5];

                // Forwards (top 9 - C, LW, RW per team)
                const topForwards = forwards.sort((a, b) => b.stats.points - a.stats.points);
                awards.allStars.firstTeam.center = topForwards[0];
                awards.allStars.firstTeam.leftWing = topForwards[1];
                awards.allStars.firstTeam.rightWing = topForwards[2];
                awards.allStars.secondTeam.center = topForwards[3];
                awards.allStars.secondTeam.leftWing = topForwards[4];
                awards.allStars.secondTeam.rightWing = topForwards[5];
                awards.allStars.thirdTeam.center = topForwards[6];
                awards.allStars.thirdTeam.leftWing = topForwards[7];
                awards.allStars.thirdTeam.rightWing = topForwards[8];

                // DIVISION ALL-STARS (top 6 per division)
                ['Atlantic', 'Metropolitan', 'Central', 'Pacific'].forEach(division => {
                    const divPlayers = players.filter(p => {
                        const team = TEAMS.find(t => t.id === p.teamId);
                        return team?.division === division;
                    });
                    
                    const divSkaters = divPlayers.filter(p => p.position !== 'G' && p.stats.gamesPlayed >= 20);
                    const divGoalies = divPlayers.filter(p => p.position === 'G' && p.stats.gamesPlayed >= 15);
                    const divDefensemen = divPlayers.filter(p => p.position === 'D' && p.stats.gamesPlayed >= 20);
                    const divForwards = divPlayers.filter(p => p.position === 'F' && p.stats.gamesPlayed >= 20);

                    // Top goalie
                    const divTopGoalie = divGoalies.sort((a, b) => {
                        const scoreA = (a.stats.savePercentage * 100) + ((3.0 - a.stats.gaa) * 10);
                        const scoreB = (b.stats.savePercentage * 100) + ((3.0 - b.stats.gaa) * 10);
                        return scoreB - scoreA;
                    })[0];
                    awards.allStars.divisions[division].goalie = divTopGoalie;

                    // Top 2 defensemen
                    const divTopDef = divDefensemen.sort((a, b) => {
                        const scoreA = (a.stats.points * 2) + (a.stats.plusMinus * 1);
                        const scoreB = (b.stats.points * 2) + (b.stats.plusMinus * 1);
                        return scoreB - scoreA;
                    });
                    awards.allStars.divisions[division].leftDefense = divTopDef[0];
                    awards.allStars.divisions[division].rightDefense = divTopDef[1];

                    // Top 3 forwards
                    const divTopForwards = divForwards.sort((a, b) => b.stats.points - a.stats.points);
                    awards.allStars.divisions[division].center = divTopForwards[0];
                    awards.allStars.divisions[division].leftWing = divTopForwards[1];
                    awards.allStars.divisions[division].rightWing = divTopForwards[2];
                });

                // AWARD ACHIEVEMENTS TO PLAYERS
                const currentYear = new Date(gameState.currentDate).getFullYear();
                
                // Award trophies
                if (awards.league.mvp && awards.league.mvp.achievements) {
                    awards.league.mvp.achievements.push({
                        type: 'award',
                        award: 'Hart Trophy',
                        year: currentYear,
                        icon: ''
                    });
                }
                if (awards.league.bestGoalie && awards.league.bestGoalie.achievements) {
                    awards.league.bestGoalie.achievements.push({
                        type: 'award',
                        award: 'Vezina Trophy',
                        year: currentYear,
                        icon: ''
                    });
                }
                if (awards.league.bestDefenseman && awards.league.bestDefenseman.achievements) {
                    awards.league.bestDefenseman.achievements.push({
                        type: 'award',
                        award: 'Norris Trophy',
                        year: currentYear,
                        icon: ''
                    });
                }
                if (awards.league.rookieOfTheYear && awards.league.rookieOfTheYear.achievements) {
                    awards.league.rookieOfTheYear.achievements.push({
                        type: 'award',
                        award: 'Calder Trophy',
                        year: currentYear,
                        icon: ''
                    });
                }
                if (awards.league.topScorer && awards.league.topScorer.achievements) {
                    awards.league.topScorer.achievements.push({
                        type: 'award',
                        award: 'Art Ross Trophy',
                        year: currentYear,
                        icon: ''
                    });
                }
                if (awards.league.topGoalScorer && awards.league.topGoalScorer.achievements) {
                    awards.league.topGoalScorer.achievements.push({
                        type: 'award',
                        award: 'Maurice Richard Trophy',
                        year: currentYear,
                        icon: ''
                    });
                }
                
                // Award All-Star selections (NHL-style: 12F, 6D, 2G per conference)
                // Eastern Conference All-Stars
                const eastPlayers = players.filter(p => {
                    const team = TEAMS.find(t => t.id === p.teamId);
                    return team && team.conference === 'East' && p.roster === 'nhl';
                });
                const eastForwards = eastPlayers.filter(p => p.position === 'F' && p.stats.gamesPlayed >= 20)
                    .sort((a, b) => b.stats.points - a.stats.points).slice(0, 12);
                const eastDefense = eastPlayers.filter(p => p.position === 'D' && p.stats.gamesPlayed >= 20)
                    .sort((a, b) => b.stats.points - a.stats.points).slice(0, 6);
                const eastGoalies = eastPlayers.filter(p => p.position === 'G' && p.stats.gamesPlayed >= 20)
                    .sort((a, b) => (b.stats.savePercentage || 0) - (a.stats.savePercentage || 0)).slice(0, 2);
                
                [...eastForwards, ...eastDefense, ...eastGoalies].forEach(p => {
                    if (p.achievements) {
                        p.achievements.push({
                            type: 'allstar',
                            conference: 'Eastern',
                            year: currentYear,
                            icon: ''
                        });
                    }
                });
                
                // Western Conference All-Stars
                const westPlayers = players.filter(p => {
                    const team = TEAMS.find(t => t.id === p.teamId);
                    return team && team.conference === 'West' && p.roster === 'nhl';
                });
                const westForwards = westPlayers.filter(p => p.position === 'F' && p.stats.gamesPlayed >= 20)
                    .sort((a, b) => b.stats.points - a.stats.points).slice(0, 12);
                const westDefense = westPlayers.filter(p => p.position === 'D' && p.stats.gamesPlayed >= 20)
                    .sort((a, b) => b.stats.points - a.stats.points).slice(0, 6);
                const westGoalies = westPlayers.filter(p => p.position === 'G' && p.stats.gamesPlayed >= 20)
                    .sort((a, b) => (b.stats.savePercentage || 0) - (a.stats.savePercentage || 0)).slice(0, 2);
                
                [...westForwards, ...westDefense, ...westGoalies].forEach(p => {
                    if (p.achievements) {
                        p.achievements.push({
                            type: 'allstar',
                            conference: 'Western',
                            year: currentYear,
                            icon: ''
                        });
                    }
                });
                
                // Award League Leaders
                const nhlPlayers = players.filter(p => p.roster === 'nhl' && p.stats.gamesPlayed > 0);
                const nhlSkaters = nhlPlayers.filter(p => p.position !== 'G');
                const nhlGoalies = nhlPlayers.filter(p => p.position === 'G' && p.stats.gamesPlayed >= 27);
                
                // Points leader
                const pointsLeader = [...nhlSkaters].sort((a, b) => b.stats.points - a.stats.points)[0];
                if (pointsLeader && pointsLeader.achievements) {
                    pointsLeader.achievements.push({
                        type: 'leagueLeader',
                        stat: 'Points',
                        value: pointsLeader.stats.points,
                        year: currentYear,
                        icon: ''
                    });
                }
                
                // Goals leader
                const goalsLeader = [...nhlSkaters].sort((a, b) => b.stats.goals - a.stats.goals)[0];
                if (goalsLeader && goalsLeader.achievements) {
                    goalsLeader.achievements.push({
                        type: 'leagueLeader',
                        stat: 'Goals',
                        value: goalsLeader.stats.goals,
                        year: currentYear,
                        icon: ''
                    });
                }
                
                // Assists leader
                const assistsLeader = [...nhlSkaters].sort((a, b) => b.stats.assists - a.stats.assists)[0];
                if (assistsLeader && assistsLeader.achievements) {
                    assistsLeader.achievements.push({
                        type: 'leagueLeader',
                        stat: 'Assists',
                        value: assistsLeader.stats.assists,
                        year: currentYear,
                        icon: ''
                    });
                }
                
                // Plus/Minus leader
                const plusMinusLeader = [...nhlSkaters].sort((a, b) => b.stats.plusMinus - a.stats.plusMinus)[0];
                if (plusMinusLeader && plusMinusLeader.achievements && plusMinusLeader.stats.plusMinus > 0) {
                    plusMinusLeader.achievements.push({
                        type: 'leagueLeader',
                        stat: 'Plus/Minus',
                        value: plusMinusLeader.stats.plusMinus,
                        year: currentYear,
                        icon: ''
                    });
                }
                
                // PIM leader
                const pimLeader = [...nhlSkaters].sort((a, b) => b.stats.pim - a.stats.pim)[0];
                if (pimLeader && pimLeader.achievements && pimLeader.stats.pim > 0) {
                    pimLeader.achievements.push({
                        type: 'leagueLeader',
                        stat: 'Penalty Minutes',
                        value: pimLeader.stats.pim,
                        year: currentYear,
                        icon: ''
                    });
                }
                
                // Goalie: Wins leader
                const winsLeader = [...nhlGoalies].sort((a, b) => (b.stats.wins || 0) - (a.stats.wins || 0))[0];
                if (winsLeader && winsLeader.achievements) {
                    winsLeader.achievements.push({
                        type: 'leagueLeader',
                        stat: 'Wins',
                        value: winsLeader.stats.wins,
                        year: currentYear,
                        icon: ''
                    });
                }
                
                // Goalie: Save % leader
                const savePercentageLeader = [...nhlGoalies].sort((a, b) => (b.stats.savePercentage || 0) - (a.stats.savePercentage || 0))[0];
                if (savePercentageLeader && savePercentageLeader.achievements) {
                    savePercentageLeader.achievements.push({
                        type: 'leagueLeader',
                        stat: 'Save Percentage',
                        value: savePercentageLeader.stats.savePercentage.toFixed(3),
                        year: currentYear,
                        icon: ''
                    });
                }
                
                // Goalie: GAA leader (lowest)
                const gaaLeader = [...nhlGoalies].sort((a, b) => (a.stats.gaa || 99) - (b.stats.gaa || 99))[0];
                if (gaaLeader && gaaLeader.achievements) {
                    gaaLeader.achievements.push({
                        type: 'leagueLeader',
                        stat: 'Goals Against Average',
                        value: gaaLeader.stats.gaa.toFixed(2),
                        year: currentYear,
                        icon: ''
                    });
                }

                return awards;
            };

            // Calculate playoff MVP (Conn Smythe equivalent)
            const calculatePlayoffMVP = (players) => {
                if (!players || players.length === 0) return null;
                
                const playoffSkaters = players.filter(p => p.position !== 'G' && p.playoffStats.gamesPlayed >= 4);
                const playoffGoalies = players.filter(p => p.position === 'G' && p.playoffStats.gamesPlayed >= 4);
                
                const allCandidates = [];
                
                // Score skaters
                playoffSkaters.forEach(p => {
                    const score = (p.playoffStats.points * 3) + 
                                 (p.playoffStats.plusMinus * 1) + 
                                 (p.playoffStats.gamesPlayed * 0.5);
                    allCandidates.push({ player: p, score });
                });
                
                // Score goalies
                playoffGoalies.forEach(p => {
                    const score = (p.playoffStats.savePercentage * 150) + 
                                 ((3.0 - p.playoffStats.gaa) * 15) + 
                                 (p.playoffStats.wins * 2);
                    allCandidates.push({ player: p, score });
                });
                
                allCandidates.sort((a, b) => b.score - a.score);
                return allCandidates[0]?.player;
            };

            // Line Management Functions
            const saveCurrentLineup = (lineupName) => {
                if (!gameState || !userTeamId) return;
                
                const roster = gameState.players.filter(p => p.teamId === userTeamId);
                const lineupData = roster.map(p => ({
                    playerId: p.id,
                    lineNumber: p.lineNumber,
                    position: p.position
                }));
                
                const newLineup = {
                    id: Date.now(),
                    name: lineupName,
                    date: new Date(),
                    data: lineupData
                };
                
                setSavedLineups([...savedLineups, newLineup]);
                alert(`Lineup "${lineupName}" saved successfully!`);
            };
            
            const loadLineup = (lineup) => {
                if (!gameState || !userTeamId) return;
                
                const newPlayers = [...gameState.players];
                
                lineup.data.forEach(savedPlayer => {
                    const player = newPlayers.find(p => p.id === savedPlayer.playerId);
                    if (player) {
                        player.lineNumber = savedPlayer.lineNumber;
                    }
                });
                
                setGameState({ ...gameState, players: newPlayers });
                alert(`Lineup "${lineup.name}" loaded successfully!`);
            };
            
            const deleteLineup = (lineupId) => {
                if (confirm('Are you sure you want to delete this saved lineup?')) {
                    setSavedLineups(savedLineups.filter(l => l.id !== lineupId));
                }
            };
            
            const changePlayerLine = (playerId, newLine) => {
                if (!gameState) return;
                
                const newPlayers = [...gameState.players];
                const player = newPlayers.find(p => p.id === playerId);
                if (player) {
                    player.lineNumber = newLine;
                    setGameState({ ...gameState, players: newPlayers });
                }
            };
            
            const toggleHealthyScratch = (playerId) => {
                if (!gameState) return;
                
                const newPlayers = [...gameState.players];
                const player = newPlayers.find(p => p.id === playerId);
                if (player) {
                    // Toggle between line 0 (scratched) and line 4 (playing)
                    player.lineNumber = player.lineNumber === 0 ? 4 : 0;
                    setGameState({ ...gameState, players: newPlayers });
                }
            };
            
            // Assign player to specific line and position
            const assignPlayerToLine = (playerId, lineNum, position) => {
                if (!gameState) return;
                
                const newPlayers = [...gameState.players];
                const player = newPlayers.find(p => p.id === playerId);
                if (player) {
                    player.lineNumber = lineNum;
                    player.linePosition = position;
                    setGameState({ ...gameState, players: newPlayers });
                }
            };
            
            // Assign player to special teams
            const assignToSpecialTeams = (playerId, unit, unitNumber, position) => {
                if (!gameState) return;
                
                const newPlayers = [...gameState.players];
                const player = newPlayers.find(p => p.id === playerId);
                if (player) {
                    if (unit === 'pp') {
                        player.ppUnit = unitNumber;
                        player.ppPosition = position;
                    } else if (unit === 'pk') {
                        player.pkUnit = unitNumber;
                        player.pkPosition = position;
                    }
                    setGameState({ ...gameState, players: newPlayers });
                }
            };
            
            // Toggle goalie dressed status
            const toggleGoalieDressed = (playerId) => {
                if (!gameState) return;
                
                const newPlayers = [...gameState.players];
                const player = newPlayers.find(p => p.id === playerId);
                if (player && player.position === 'G') {
                    player.dressed = !player.dressed;
                    setGameState({ ...gameState, players: newPlayers });
                }
            };

            // Calculate effective overall rating (reduced if out of position)
            const getEffectiveOverall = (player) => {
                if (!player.linePosition || !player.preferredPosition) return player.ratings.overall;
                
                // Goalies always play their position
                if (player.position === 'G') return player.ratings.overall;
                
                // In preferred position = full rating
                if (player.linePosition === player.preferredPosition) return player.ratings.overall;
                
                // Out of position penalty
                if (player.position === 'F') {
                    // Forwards: -3 OVR when out of position
                    return Math.max(50, player.ratings.overall - 3);
                } else if (player.position === 'D') {
                    // Defense: -5 OVR when playing wrong side
                    return Math.max(50, player.ratings.overall - 5);
                }
                
                return player.ratings.overall;
            };

            // Check and award milestones
            const checkMilestones = (player, gameState) => {
                if (!player.milestones) player.milestones = [];
                
                const milestones = [];
                const stats = player.stats;
                const existingMilestones = player.milestones.map(m => m.type);
                
                // Career milestones
                if (stats.goals >= 1 && !existingMilestones.includes('first_goal')) {
                    milestones.push({ type: 'first_goal', date: new Date(gameState.currentDate), description: 'First Career Goal' });
                }
                if (stats.goals >= 50 && !existingMilestones.includes('50_goals')) {
                    milestones.push({ type: '50_goals', date: new Date(gameState.currentDate), description: '50 Career Goals' });
                }
                if (stats.goals >= 100 && !existingMilestones.includes('100_goals')) {
                    milestones.push({ type: '100_goals', date: new Date(gameState.currentDate), description: '100 Career Goals' });
                }
                if (stats.goals >= 200 && !existingMilestones.includes('200_goals')) {
                    milestones.push({ type: '200_goals', date: new Date(gameState.currentDate), description: '200 Career Goals' });
                }
                if (stats.goals >= 300 && !existingMilestones.includes('300_goals')) {
                    milestones.push({ type: '300_goals', date: new Date(gameState.currentDate), description: '300 Career Goals' });
                }
                if (stats.goals >= 400 && !existingMilestones.includes('400_goals')) {
                    milestones.push({ type: '400_goals', date: new Date(gameState.currentDate), description: '400 Career Goals' });
                }
                if (stats.goals >= 500 && !existingMilestones.includes('500_goals')) {
                    milestones.push({ type: '500_goals', date: new Date(gameState.currentDate), description: '500 Career Goals' });
                }
                
                // Points milestones
                if (stats.points >= 1 && !existingMilestones.includes('first_point')) {
                    milestones.push({ type: 'first_point', date: new Date(gameState.currentDate), description: 'First Career Point' });
                }
                if (stats.points >= 100 && !existingMilestones.includes('100_points')) {
                    milestones.push({ type: '100_points', date: new Date(gameState.currentDate), description: '100 Career Points' });
                }
                if (stats.points >= 500 && !existingMilestones.includes('500_points')) {
                    milestones.push({ type: '500_points', date: new Date(gameState.currentDate), description: '500 Career Points' });
                }
                if (stats.points >= 1000 && !existingMilestones.includes('1000_points')) {
                    milestones.push({ type: '1000_points', date: new Date(gameState.currentDate), description: '1000 Career Points' });
                }
                
                // Games played milestones
                if (stats.gamesPlayed >= 100 && !existingMilestones.includes('100_games')) {
                    milestones.push({ type: '100_games', date: new Date(gameState.currentDate), description: '100 Games Played' });
                }
                if (stats.gamesPlayed >= 500 && !existingMilestones.includes('500_games')) {
                    milestones.push({ type: '500_games', date: new Date(gameState.currentDate), description: '500 Games Played' });
                }
                if (stats.gamesPlayed >= 1000 && !existingMilestones.includes('1000_games')) {
                    milestones.push({ type: '1000_games', date: new Date(gameState.currentDate), description: '1000 Games Played' });
                }
                
                // Goalie-specific milestones
                if (player.position === 'G') {
                    if (stats.wins >= 1 && !existingMilestones.includes('first_win')) {
                        milestones.push({ type: 'first_win', date: new Date(gameState.currentDate), description: 'First Career Win' });
                    }
                    if (stats.shutouts >= 1 && !existingMilestones.includes('first_shutout')) {
                        milestones.push({ type: 'first_shutout', date: new Date(gameState.currentDate), description: 'First Career Shutout' });
                    }
                    if (stats.wins >= 100 && !existingMilestones.includes('100_wins')) {
                        milestones.push({ type: '100_wins', date: new Date(gameState.currentDate), description: '100 Career Wins' });
                    }
                    if (stats.wins >= 200 && !existingMilestones.includes('200_wins')) {
                        milestones.push({ type: '200_wins', date: new Date(gameState.currentDate), description: '200 Career Wins' });
                    }
                    if (stats.wins >= 300 && !existingMilestones.includes('300_wins')) {
                        milestones.push({ type: '300_wins', date: new Date(gameState.currentDate), description: '300 Career Wins' });
                    }
                    if (stats.shutouts >= 10 && !existingMilestones.includes('10_shutouts')) {
                        milestones.push({ type: '10_shutouts', date: new Date(gameState.currentDate), description: '10 Career Shutouts' });
                    }
                    if (stats.shutouts >= 50 && !existingMilestones.includes('50_shutouts')) {
                        milestones.push({ type: '50_shutouts', date: new Date(gameState.currentDate), description: '50 Career Shutouts' });
                    }
                }
                
                // Add all new milestones
                player.milestones.push(...milestones);
                
                return milestones;
            };

            // AI TRADE SYSTEM
            const processAITrades = (currentGameState) => {
                console.log('[AI TRADES] processAITrades called');
                
                // Initialize trade history if it doesn't exist
                if (!currentGameState.tradeHistory) {
                    currentGameState.tradeHistory = [];
                }
                if (!currentGameState.teamTradeCount) {
                    currentGameState.teamTradeCount = {};
                    TEAMS.forEach(t => currentGameState.teamTradeCount[t.id] = 0);
                }
                
                // Calculate average games played per team
                const teamGamesPlayed = {};
                TEAMS.forEach(t => teamGamesPlayed[t.id] = 0);
                currentGameState.schedule.filter(g => g.played).forEach(g => {
                    teamGamesPlayed[g.homeTeam]++;
                    teamGamesPlayed[g.awayTeam]++;
                });
                const avgGamesPlayed = Object.values(teamGamesPlayed).reduce((a, b) => a + b, 0) / TEAMS.length;
                const gameNumber = Math.floor(avgGamesPlayed);
                
                console.log(`[AI TRADES] Game ${gameNumber} of 82`);
                
                // Trade deadline is game 60
                const isTradeDeadline = gameNumber >= 55 && gameNumber <= 65;
                
                // Base trade probability per day
                let tradeProbability = 0.15; // 15% base chance
                
                if (isTradeDeadline) {
                    tradeProbability = 0.50; // 50% during deadline week
                } else if (gameNumber < 20) {
                    tradeProbability = 0.20; // 20% early season
                } else if (gameNumber > 75) {
                    tradeProbability = 0.08; // 8% near season end
                }
                
                console.log(`[AI TRADES] Trade probability: ${(tradeProbability * 100).toFixed(0)}%${isTradeDeadline ? ' (DEADLINE)' : ''}`);
                
                // Random chance for trade today
                if (Math.random() > tradeProbability) {
                    console.log('[AI TRADES] Random roll failed, no trade today');
                    return null; // No trade today
                }
                
                console.log(`[AI TRADES] Trade attempt at game ${gameNumber}, probability: ${tradeProbability * 100}%`);
                
                // Select two random teams that haven't hit their trade limit (3 per season)
                const eligibleTeams = TEAMS.filter(t => 
                    (currentGameState.teamTradeCount[t.id] || 0) < 3
                );
                
                if (eligibleTeams.length < 2) {
                    return null; // Not enough eligible teams
                }
                
                // Pick two random teams
                const team1 = eligibleTeams[Math.floor(Math.random() * eligibleTeams.length)];
                const team2Candidates = eligibleTeams.filter(t => {
                    // Same division trades are 50% less likely
                    if (t.id === team1.id) return false;
                    if (t.division === team1.division) {
                        return Math.random() > 0.5; // Reduced from 0.7
                    }
                    return true;
                });
                
                console.log(`[AI TRADES] Team1: ${team1.city}, Team2 candidates: ${team2Candidates.length}`);
                
                if (team2Candidates.length === 0) {
                    console.log(`[AI TRADES] No valid team2 candidates`);
                    return null;
                }
                
                const team2 = team2Candidates[Math.floor(Math.random() * team2Candidates.length)];
                console.log(`[AI TRADES] Attempting trade: ${team1.city} <-> ${team2.city}`);
                
                // Get team standings to determine if competing or rebuilding
                const team1Standing = currentGameState.standings.find(s => s.teamId === team1.id);
                const team2Standing = currentGameState.standings.find(s => s.teamId === team2.id);
                
                const team1Games = team1Standing.wins + team1Standing.losses + team1Standing.otLosses;
                const team2Games = team2Standing.wins + team2Standing.losses + team2Standing.otLosses;
                
                const team1WinPct = team1Games > 0 ? team1Standing.wins / team1Games : 0.5;
                const team2WinPct = team2Games > 0 ? team2Standing.wins / team2Games : 0.5;
                
                const team1Competing = team1WinPct > 0.55;
                const team1Rebuilding = team1WinPct < 0.40;
                const team2Competing = team2WinPct > 0.55;
                const team2Rebuilding = team2WinPct < 0.40;
                
                // Get rosters (exclude recently traded players)
                const getEligiblePlayers = (teamId) => {
                    return currentGameState.players.filter(p => {
                        if (p.teamId !== teamId || p.roster !== 'nhl') return false;
                        if (p.injury.injured) return false; // Can't trade injured
                        
                        // For first implementation, allow recently traded players
                        // (Can add cooldown logic later if needed)
                        
                        return true;
                    });
                };
                
                const team1Players = getEligiblePlayers(team1.id);
                const team2Players = getEligiblePlayers(team2.id);
                
                console.log(`[AI TRADES] ${team1.city} has ${team1Players.length} eligible, ${team2.city} has ${team2Players.length} eligible`);
                
                if (team1Players.length < 5 || team2Players.length < 5) {
                    console.log(`[AI TRADES] Not enough players to trade`);
                    return null; // Not enough players to trade
                }
                
                // Determine trade size (80% are 1-for-1 or 2-for-2)
                const tradeTypeRoll = Math.random();
                let team1TradeSize, team2TradeSize;
                
                if (tradeTypeRoll < 0.50) {
                    // 50%: 1-for-1
                    team1TradeSize = 1;
                    team2TradeSize = 1;
                } else if (tradeTypeRoll < 0.80) {
                    // 30%: 2-for-2
                    team1TradeSize = 2;
                    team2TradeSize = 2;
                } else if (tradeTypeRoll < 0.95) {
                    // 15%: Uneven trades (2-for-1 or 1-for-2)
                    team1TradeSize = Math.random() < 0.5 ? 1 : 2;
                    team2TradeSize = team1TradeSize === 1 ? 2 : 1;
                } else {
                    // 5%: Bigger trades (3-for-2, 2-for-3, etc)
                    team1TradeSize = Math.random() < 0.5 ? 2 : 3;
                    team2TradeSize = Math.random() < 0.5 ? 2 : 3;
                }
                
                // Select players based on team strategy
                const selectTradeCandidates = (players, count, isCompeting, isRebuilding) => {
                    const candidates = [...players];
                    const selected = [];
                    
                    for (let i = 0; i < count && candidates.length > 0; i++) {
                        let weights = candidates.map(p => {
                            let weight = 1;
                            
                            if (isCompeting) {
                                // Competing teams more likely to trade older players and prospects
                                if (p.age > 30) weight *= 2;
                                if (p.ratings.overall < 75) weight *= 1.5;
                            } else if (isRebuilding) {
                                // Rebuilding teams more likely to trade veterans
                                if (p.age > 28) weight *= 3;
                                if (p.ratings.overall > 80) weight *= 2;
                            }
                            
                            return weight;
                        });
                        
                        // Weighted random selection
                        const totalWeight = weights.reduce((sum, w) => sum + w, 0);
                        let random = Math.random() * totalWeight;
                        let selectedIndex = 0;
                        
                        for (let j = 0; j < weights.length; j++) {
                            random -= weights[j];
                            if (random <= 0) {
                                selectedIndex = j;
                                break;
                            }
                        }
                        
                        selected.push(candidates[selectedIndex]);
                        candidates.splice(selectedIndex, 1);
                    }
                    
                    return selected;
                };
                
                const team1Trades = selectTradeCandidates(team1Players, team1TradeSize, team1Competing, team1Rebuilding);
                const team2Trades = selectTradeCandidates(team2Players, team2TradeSize, team2Competing, team2Rebuilding);
                
                // Calculate trade value
                const team1Value = team1Trades.reduce((sum, p) => sum + p.ratings.overall, 0);
                const team2Value = team2Trades.reduce((sum, p) => sum + p.ratings.overall, 0);
                
                const valueDiff = Math.abs(team1Value - team2Value);
                const valuePercent = (valueDiff / Math.max(team1Value, team2Value)) * 100;
                
                console.log(`[AI TRADES] Trade values: ${team1Value} vs ${team2Value}, diff: ${valuePercent.toFixed(1)}%`);
                
                // Trade must be reasonably balanced (within 15%)
                if (valuePercent > 15) {
                    console.log(`[AI TRADES] Trade rejected - too lopsided`);
                    return null; // Too lopsided
                }
                
                console.log(`[AI TRADES]  TRADE ACCEPTED: ${team1.city} <-> ${team2.city}`);
                
                // Execute the trade
                return {
                    team1: team1.id,
                    team2: team2.id,
                    team1Gives: team1Trades,
                    team2Gives: team2Trades
                };
            };

            const simulateDay = () => {
                if (!gameState) return;
                
                // Check if season is complete - ALL teams must have played EXACTLY 82 games
                const teamGames = {};
                TEAMS.forEach(t => teamGames[t.id] = 0);
                
                gameState.schedule.filter(g => g.played).forEach(g => {
                    teamGames[g.homeTeam]++;
                    teamGames[g.awayTeam]++;
                });
                
                const minGames = Math.min(...Object.values(teamGames));
                const maxGames = Math.max(...Object.values(teamGames));
                
                // Check if ALL teams have 82 games
                if (minGames >= 82) {
                    // Calculate end-of-season awards
                    const awards = calculateAwards(gameState.players, gameState.standings);
                    setSeasonAwards(awards);
                    setCurrentView('awards');
                    return;
                }
                
                // Check if in playoffs
                if (gameState.playoffPhase) {
                    alert('Playoff simulation coming soon! For now, start a new season.');
                    return;
                }
                
                // Simulate one day
                // NHL schedule: Teams play ~3-4 games per week (not every day)
                // On average: 6-8 games per night across the league, with some off-days
                
                const teamsPlayedToday = new Set();
                let gamesSimulated = 0;
                
                // Determine if today is a "game day" and how many games
                // NHL pattern: ~60% of days have games, with varying density
                const dayOfWeek = gameState.currentDate.getDay(); // 0=Sun, 6=Sat
                
                let maxGamesPerDay;
                const gameChance = Math.random();
                
                // Weekend has more games
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    // Weekend: 80% chance of games, 8-12 games
                    if (gameChance < 0.80) {
                        maxGamesPerDay = 8 + Math.floor(Math.random() * 5); // 8-12 games
                    } else {
                        maxGamesPerDay = 0; // Off day
                    }
                } else {
                    // Weekday: 60% chance of games, 4-8 games
                    if (gameChance < 0.60) {
                        maxGamesPerDay = 4 + Math.floor(Math.random() * 5); // 4-8 games
                    } else {
                        maxGamesPerDay = 0; // Off day
                    }
                }
                
                // Track which teams played recently (back-to-back limiter)
                // NHL teams rarely play on consecutive days
                const recentlyPlayed = new Set();
                if (gameState.lastGameDay) {
                    const daysSinceLastGame = Math.floor((gameState.currentDate - gameState.lastGameDay) / (1000 * 60 * 60 * 24));
                    if (daysSinceLastGame === 1) {
                        // Yesterday was a game day, some teams just played
                        gameState.lastGameTeams?.forEach(t => recentlyPlayed.add(t));
                    }
                }
                
                const newStandings = [...gameState.standings];
                const newPlayers = [...gameState.players];
                const newSchedule = [...gameState.schedule];
                
                while (teamsPlayedToday.size < 30 && gamesSimulated < maxGamesPerDay) {
                    // Find next game where both teams haven't reached 82 games yet
                    const nextGameIndex = newSchedule.findIndex(g => {
                        if (g.played) return false;
                        
                        // Check if both teams are under 82 games
                        const homeGames = newSchedule.filter(sg => sg.played && (sg.homeTeam === g.homeTeam || sg.awayTeam === g.homeTeam)).length;
                        const awayGames = newSchedule.filter(sg => sg.played && (sg.homeTeam === g.awayTeam || sg.awayTeam === g.awayTeam)).length;
                        
                        // Avoid back-to-backs (teams that played yesterday)
                        // Allow 20% chance for back-to-back games (they happen sometimes in NHL)
                        const homeBackToBack = recentlyPlayed.has(g.homeTeam);
                        const awayBackToBack = recentlyPlayed.has(g.awayTeam);
                        const allowBackToBack = Math.random() < 0.20;
                        
                        return homeGames < 82 && awayGames < 82 && 
                               !teamsPlayedToday.has(g.homeTeam) && 
                               !teamsPlayedToday.has(g.awayTeam) &&
                               (allowBackToBack || (!homeBackToBack && !awayBackToBack));
                    });
                    
                    if (nextGameIndex === -1) {
                        // No more valid games for today
                        break;
                    }
                    
                    const game = newSchedule[nextGameIndex];
                    
                    // Check if both teams are available today
                    if (teamsPlayedToday.has(game.homeTeam) || teamsPlayedToday.has(game.awayTeam)) {
                        // Skip this game for today if teams already played
                        break;
                    }
                    
                    // Only include active (non-scratched) and non-injured NHL players
                    const homePlayers = newPlayers.filter(p => 
                        p.teamId === game.homeTeam &&
                        p.roster === 'nhl' &&
                        !p.injury.injured &&
                        (p.position === 'G' ? p.dressed : p.lineNumber > 0)
                    );
                    const awayPlayers = newPlayers.filter(p => 
                        p.teamId === game.awayTeam &&
                        p.roster === 'nhl' &&
                        !p.injury.injured &&
                        (p.position === 'G' ? p.dressed : p.lineNumber > 0)
                    );
                    
                    const result = simulateGameResult(homePlayers, awayPlayers);
                    
                    // Store comprehensive game details including per-player stats
                    const gameDetails = {
                        homeGoals: result.homeGoals,
                        awayGoals: result.awayGoals,
                        winner: result.winner,
                        homeTeam: game.homeTeam,
                        awayTeam: game.awayTeam,
                        // Per-game player stats
                        homePlayerStats: result.homePlayerStats,
                        awayPlayerStats: result.awayPlayerStats,
                        // DNP (Did Not Play) players - only healthy scratches
                        // Note: Pre-existing injuries are not shown here, only scratches for this game
                        homeScratched: result.homeScratched.map(p => ({ id: p.id, name: `${p.firstName} ${p.lastName}`, reason: 'Healthy Scratch' })),
                        awayScratched: result.awayScratched.map(p => ({ id: p.id, name: `${p.firstName} ${p.lastName}`, reason: 'Healthy Scratch' })),
                        // Injuries that occurred during THIS game (not implemented yet)
                        homeNewInjuries: [],
                        awayNewInjuries: [],
                        // Period-by-period scoring summary
                        scoringSummary: result.scoringSummary
                    };
                    
                    const homeStanding = newStandings.find(s => s.teamId === game.homeTeam);
                    const awayStanding = newStandings.find(s => s.teamId === game.awayTeam);
                    
                    homeStanding.goalsFor += result.homeGoals;
                    homeStanding.goalsAgainst += result.awayGoals;
                    awayStanding.goalsFor += result.awayGoals;
                    awayStanding.goalsAgainst += result.homeGoals;
                    
                    // Update team stats
                    if (result.teamStats) {
                        homeStanding.teamStats.gamesPlayed++;
                        awayStanding.teamStats.gamesPlayed++;
                        
                        homeStanding.teamStats.shots += result.teamStats.homeShots;
                        homeStanding.teamStats.shotsAgainst += result.teamStats.awayShots;
                        awayStanding.teamStats.shots += result.teamStats.awayShots;
                        awayStanding.teamStats.shotsAgainst += result.teamStats.homeShots;
                        
                        homeStanding.teamStats.ppOpportunities += result.teamStats.homePPOpportunities;
                        homeStanding.teamStats.ppGoals += result.teamStats.homePPGoals;
                        awayStanding.teamStats.ppOpportunities += result.teamStats.awayPPOpportunities;
                        awayStanding.teamStats.ppGoals += result.teamStats.awayPPGoals;
                        
                        // PK: When opponent has PP, you're on PK
                        homeStanding.teamStats.pkOpportunities += result.teamStats.awayPPOpportunities;
                        homeStanding.teamStats.pkGoalsAgainst += result.teamStats.awayPPGoals;
                        awayStanding.teamStats.pkOpportunities += result.teamStats.homePPOpportunities;
                        awayStanding.teamStats.pkGoalsAgainst += result.teamStats.homePPGoals;
                    }
                    
                    // Update head-to-head record
                    const h2hKey = game.homeTeam < game.awayTeam ? 
                        `${game.homeTeam}vs${game.awayTeam}` : 
                        `${game.awayTeam}vs${game.homeTeam}`;
                    
                    if (!gameState.headToHead[h2hKey]) {
                        const team1 = game.homeTeam < game.awayTeam ? game.homeTeam : game.awayTeam;
                        const team2 = game.homeTeam < game.awayTeam ? game.awayTeam : game.homeTeam;
                        gameState.headToHead[h2hKey] = {
                            team1: team1,
                            team2: team2,
                            team1Wins: 0,
                            team2Wins: 0,
                            ties: 0
                        };
                    }
                    
                    if (result.winner === 'home') {
                        if (game.homeTeam === gameState.headToHead[h2hKey].team1) {
                            gameState.headToHead[h2hKey].team1Wins++;
                        } else {
                            gameState.headToHead[h2hKey].team2Wins++;
                        }
                    } else {
                        if (game.awayTeam === gameState.headToHead[h2hKey].team1) {
                            gameState.headToHead[h2hKey].team1Wins++;
                        } else {
                            gameState.headToHead[h2hKey].team2Wins++;
                        }
                    }
                    
                    if (result.winner === 'home') {
                        homeStanding.wins++;
                        homeStanding.home.wins++;
                        homeStanding.points += 2;
                        awayStanding.losses++;
                        awayStanding.away.losses++;
                    } else {
                        awayStanding.wins++;
                        awayStanding.away.wins++;
                        awayStanding.points += 2;
                        homeStanding.losses++;
                        homeStanding.home.losses++;
                    }
                    newSchedule[nextGameIndex].played = true;
                    newSchedule[nextGameIndex].homeScore = result.homeGoals;
                    newSchedule[nextGameIndex].awayScore = result.awayGoals;
                    newSchedule[nextGameIndex].date = new Date(gameState.currentDate);
                    newSchedule[nextGameIndex].details = gameDetails;
                    
                    // Update player season stats from per-game stats
                    result.homePlayerStats.forEach(playerGameStats => {
                        const player = newPlayers.find(p => p.id === playerGameStats.player.id);
                        if (player) {
                            // For goalies, only count GP if they actually played (shotsAgainst > 0)
                            if (player.position === 'G') {
                                if (playerGameStats.shotsAgainst > 0) {
                                    player.stats.gamesPlayed++;
                                    player.stats.timeOnIce += playerGameStats.toi;
                                    player.stats.saves = (player.stats.saves || 0) + playerGameStats.saves;
                                    player.stats.goalsAgainst = (player.stats.goalsAgainst || 0) + playerGameStats.goalsAgainst;
                                    player.stats.shotsAgainst = (player.stats.shotsAgainst || 0) + playerGameStats.shotsAgainst;
                                    
                                    if (result.winner === 'home') {
                                        player.stats.wins = (player.stats.wins || 0) + 1;
                                    } else {
                                        player.stats.losses = (player.stats.losses || 0) + 1;
                                    }
                                    
                                    if (playerGameStats.goalsAgainst === 0) {
                                        player.stats.shutouts = (player.stats.shutouts || 0) + 1;
                                    }
                                    
                                    // Recalculate goalie averages
                                    player.stats.savePercentage = player.stats.saves / (player.stats.shotsAgainst || 1);
                                    player.stats.gaa = (player.stats.goalsAgainst / (player.stats.gamesPlayed || 1)) * 1.0;
                                }
                            } else {
                                // Skaters always count
                                player.stats.gamesPlayed++;
                                player.stats.goals += playerGameStats.goals;
                                player.stats.assists += playerGameStats.assists;
                                player.stats.points += playerGameStats.points;
                                player.stats.plusMinus += playerGameStats.plusMinus;
                                player.stats.pim += playerGameStats.pim;
                                player.stats.shots += playerGameStats.shots;
                                player.stats.timeOnIce += playerGameStats.toi;
                            }
                            
                            // Check for injury
                            const injury = checkForInjury(player, playerGameStats.toi);
                            if (injury) {
                                player.injury = injury;
                                autoCallUpReplacement(newPlayers, player);
                            }
                            
                            // Check for milestones after stat update
                            checkMilestones(player, gameState);
                        }
                    });
                    
                    result.awayPlayerStats.forEach(playerGameStats => {
                        const player = newPlayers.find(p => p.id === playerGameStats.player.id);
                        if (player) {
                            // For goalies, only count GP if they actually played (shotsAgainst > 0)
                            if (player.position === 'G') {
                                if (playerGameStats.shotsAgainst > 0) {
                                    player.stats.gamesPlayed++;
                                    player.stats.timeOnIce += playerGameStats.toi;
                                    player.stats.saves = (player.stats.saves || 0) + playerGameStats.saves;
                                    player.stats.goalsAgainst = (player.stats.goalsAgainst || 0) + playerGameStats.goalsAgainst;
                                    player.stats.shotsAgainst = (player.stats.shotsAgainst || 0) + playerGameStats.shotsAgainst;
                                    
                                    if (result.winner === 'away') {
                                        player.stats.wins = (player.stats.wins || 0) + 1;
                                    } else {
                                        player.stats.losses = (player.stats.losses || 0) + 1;
                                    }
                                    
                                    if (playerGameStats.goalsAgainst === 0) {
                                        player.stats.shutouts = (player.stats.shutouts || 0) + 1;
                                    }
                                    
                                    // Recalculate goalie averages
                                    player.stats.savePercentage = player.stats.saves / (player.stats.shotsAgainst || 1);
                                    player.stats.gaa = (player.stats.goalsAgainst / (player.stats.gamesPlayed || 1)) * 1.0;
                                }
                            } else {
                                // Skaters always count
                                player.stats.gamesPlayed++;
                                player.stats.goals += playerGameStats.goals;
                                player.stats.assists += playerGameStats.assists;
                                player.stats.points += playerGameStats.points;
                                player.stats.plusMinus += playerGameStats.plusMinus;
                                player.stats.pim += playerGameStats.pim;
                                player.stats.shots += playerGameStats.shots;
                                player.stats.timeOnIce += playerGameStats.toi;
                            }
                            
                            // Check for injury
                            const injury = checkForInjury(player, playerGameStats.toi);
                            if (injury) {
                                player.injury = injury;
                                autoCallUpReplacement(newPlayers, player);
                            }
                            
                            // Check for milestones after stat update
                            checkMilestones(player, gameState);
                        }
                    });
                    
                    teamsPlayedToday.add(game.awayTeam);
                    gamesSimulated++;
                }
                
                // Advance date by 1 day
                const newDate = new Date(gameState.currentDate);
                newDate.setDate(newDate.getDate() + 1);
                
                // Update injuries for all players (heal over time)
                updateInjuries(newPlayers);
                
                // Process AI trades
                const aiTrade = processAITrades({...gameState, players: newPlayers, schedule: newSchedule, standings: newStandings});
                
                if (aiTrade) {
                    console.log(`[AI TRADES] Executing trade between teams ${aiTrade.team1} and ${aiTrade.team2}`);
                    // Execute the AI trade
                    aiTrade.team1Gives.forEach(player => {
                        const p = newPlayers.find(np => np.id === player.id);
                        p.teamId = aiTrade.team2;
                        p.lineNumber = 0;
                        p.linePosition = null;
                        p.ppUnit = null;
                        p.pkUnit = null;
                        if (p.position === 'G') p.dressed = false;
                        
                        if (!p.tradeHistory) p.tradeHistory = [];
                        p.tradeHistory.push({
                            date: new Date(gameState.currentDate),
                            from: aiTrade.team1,
                            to: aiTrade.team2,
                            year: gameState.year,
                            tradedWith: aiTrade.team1Gives.filter(tp => tp.id !== p.id).map(tp => ({ 
                                id: tp.id, 
                                name: `${tp.firstName} ${tp.lastName}`, 
                                position: tp.position 
                            })),
                            tradedFor: aiTrade.team2Gives.map(tp => ({ 
                                id: tp.id, 
                                name: `${tp.firstName} ${tp.lastName}`, 
                                position: tp.position 
                            }))
                        });
                    });
                    
                    aiTrade.team2Gives.forEach(player => {
                        const p = newPlayers.find(np => np.id === player.id);
                        p.teamId = aiTrade.team1;
                        p.lineNumber = 0;
                        p.linePosition = null;
                        p.ppUnit = null;
                        p.pkUnit = null;
                        if (p.position === 'G') p.dressed = false;
                        
                        if (!p.tradeHistory) p.tradeHistory = [];
                        p.tradeHistory.push({
                            date: new Date(gameState.currentDate),
                            from: aiTrade.team2,
                            to: aiTrade.team1,
                            year: gameState.year,
                            tradedWith: aiTrade.team2Gives.filter(tp => tp.id !== p.id).map(tp => ({ 
                                id: tp.id, 
                                name: `${tp.firstName} ${tp.lastName}`, 
                                position: tp.position 
                            })),
                            tradedFor: aiTrade.team1Gives.map(tp => ({ 
                                id: tp.id, 
                                name: `${tp.firstName} ${tp.lastName}`, 
                                position: tp.position 
                            }))
                        });
                    });
                    
                    // Update global trade history
                    if (!gameState.tradeHistory) gameState.tradeHistory = [];
                    gameState.tradeHistory.push({
                        date: new Date(gameState.currentDate),
                        year: gameState.year,
                        team1: aiTrade.team1,
                        team2: aiTrade.team2,
                        team1Gives: aiTrade.team1Gives.map(p => ({ 
                            id: p.id, 
                            name: `${p.firstName} ${p.lastName}`, 
                            position: p.position, 
                            ovr: p.ratings.overall 
                        })),
                        team2Gives: aiTrade.team2Gives.map(p => ({ 
                            id: p.id, 
                            name: `${p.firstName} ${p.lastName}`, 
                            position: p.position, 
                            ovr: p.ratings.overall 
                        })),
                        isAITrade: true
                    });
                    
                    // Update team trade counts
                    if (!gameState.teamTradeCount) gameState.teamTradeCount = {};
                    gameState.teamTradeCount[aiTrade.team1] = (gameState.teamTradeCount[aiTrade.team1] || 0) + 1;
                    gameState.teamTradeCount[aiTrade.team2] = (gameState.teamTradeCount[aiTrade.team2] || 0) + 1;
                    
                    // Auto-assign lines for both teams
                    autoSetAllLines(newPlayers, aiTrade.team1);
                    autoSetAllLines(newPlayers, aiTrade.team2);
                }

                setGameState({
                    ...gameState,
                    standings: newStandings,
                    players: newPlayers,
                    schedule: newSchedule,
                    currentGame: gameState.currentGame + gamesSimulated,
                    currentDate: newDate,
                    lastGameDay: gamesSimulated > 0 ? new Date(gameState.currentDate) : gameState.lastGameDay,
                    lastGameTeams: gamesSimulated > 0 ? Array.from(teamsPlayedToday) : gameState.lastGameTeams,
                    tradeHistory: aiTrade ? gameState.tradeHistory : (gameState.tradeHistory || []),
                    teamTradeCount: aiTrade ? gameState.teamTradeCount : (gameState.teamTradeCount || {})
                });
            };

            const startPlayoffs = () => {
                if (!gameState) return;
                
                // Sort standings by points
                const sorted = [...gameState.standings].sort((a, b) => b.points - a.points);
                
                // Get top 16 teams for playoffs (top 8 per conference)
                const eastTeams = sorted.filter(s => {
                    const team = TEAMS.find(t => t.id === s.teamId);
                    return team.conference === 'East';
                }).slice(0, 8);
                
                const westTeams = sorted.filter(s => {
                    const team = TEAMS.find(t => t.id === s.teamId);
                    return team.conference === 'West';
                }).slice(0, 8);
                
                // Create first round matchups (1v8, 2v7, 3v6, 4v5)
                const createMatchups = (teams) => {
                    return [
                        { home: teams[0].teamId, away: teams[7].teamId, homeWins: 0, awayWins: 0, games: [] },
                        { home: teams[1].teamId, away: teams[6].teamId, homeWins: 0, awayWins: 0, games: [] },
                        { home: teams[2].teamId, away: teams[5].teamId, homeWins: 0, awayWins: 0, games: [] },
                        { home: teams[3].teamId, away: teams[4].teamId, homeWins: 0, awayWins: 0, games: [] }
                    ];
                };
                
                setPlayoffState({
                    round: 1, // 1=First Round, 2=Conference Semis, 3=Conference Finals, 4=Stanley Cup
                    eastMatchups: createMatchups(eastTeams),
                    westMatchups: createMatchups(westTeams),
                    completed: false,
                    lastDaySummary: {
                        title: ' Stanley Cup Playoffs Begin! ',
                        message: 'Round 1 (First Round) matchups are set. Click "Sim Playoff Day" to begin!',
                        conference: 'Playoffs Start'
                    },
                    history: {
                        eastRound1: createMatchups(eastTeams),
                        westRound1: createMatchups(westTeams),
                        eastRound2: [],
                        westRound2: [],
                        eastRound3: [],
                        westRound3: [],
                        final: null
                    }
                });
                
                setCurrentView('bracket');
            };
            
            const calculateThreeStars = (homeTeam, awayTeam, homePlayers, awayPlayers, homeGoals, awayGoals) => {
                // Calculate star points: G=3pts, A=2pts, W(goalie)=5pts
                const allPlayers = [];
                
                // Get stats for all players in this game
                homePlayers.concat(awayPlayers).forEach(player => {
                    let points = 0;
                    const team = homePlayers.includes(player) ? homeTeam : awayTeam;
                    const goals = player.playoffStats.goals || 0;
                    const assists = player.playoffStats.assists || 0;
                    
                    if (player.position === 'G') {
                        // Goalie: points for win and shutout
                        const isWinner = (team.id === homeTeam.id && homeGoals > awayGoals) || 
                                        (team.id === awayTeam.id && awayGoals > homeGoals);
                        const isShutout = (team.id === homeTeam.id && awayGoals === 0) || 
                                         (team.id === awayTeam.id && homeGoals === 0);
                        if (isWinner) points += 5;
                        if (isShutout) points += 3;
                    } else {
                        // Skaters: goals and assists
                        points = (goals * 3) + (assists * 2);
                    }
                    
                    if (points > 0) {
                        allPlayers.push({ player, team, points, goals, assists });
                    }
                });
                
                // Sort by points and return top 3
                return allPlayers.sort((a, b) => b.points - a.points).slice(0, 3);
            };

            const simulatePlayoffGame = (matchup, isHomeGame) => {
                // Only include active (non-scratched) and non-injured NHL players
                const homePlayers = gameState.players.filter(p => 
                    p.teamId === (isHomeGame ? matchup.home : matchup.away) &&
                    p.roster === 'nhl' &&
                    !p.injury.injured &&
                    (p.position === 'G' ? p.dressed : p.lineNumber > 0)
                );
                const awayPlayers = gameState.players.filter(p => 
                    p.teamId === (isHomeGame ? matchup.away : matchup.home) &&
                    p.roster === 'nhl' &&
                    !p.injury.injured &&
                    (p.position === 'G' ? p.dressed : p.lineNumber > 0)
                );
                
                const result = simulateGameResult(homePlayers, awayPlayers);
                
                // Store comprehensive game details including per-player stats
                const gameDetails = {
                    homeGoals: result.homeGoals,
                    awayGoals: result.awayGoals,
                    winner: result.winner,
                    homeTeam: isHomeGame ? matchup.home : matchup.away,
                    awayTeam: isHomeGame ? matchup.away : matchup.home,
                    homePlayerStats: result.homePlayerStats,
                    awayPlayerStats: result.awayPlayerStats,
                    homeScratched: result.homeScratched.map(p => ({ id: p.id, name: `${p.firstName} ${p.lastName}`, reason: 'Healthy Scratch' })),
                    awayScratched: result.awayScratched.map(p => ({ id: p.id, name: `${p.firstName} ${p.lastName}`, reason: 'Healthy Scratch' })),
                    homeNewInjuries: [],
                    awayNewInjuries: [],
                    scoringSummary: result.scoringSummary
                };
                
                // Update PLAYOFF stats from per-game stats
                result.homePlayerStats.forEach(playerGameStats => {
                    const player = gameState.players.find(p => p.id === playerGameStats.player.id);
                    if (player) {
                        if (player.position === 'G') {
                            if (playerGameStats.shotsAgainst > 0) {
                                player.playoffStats.gamesPlayed++;
                                player.playoffStats.timeOnIce += playerGameStats.toi;
                                player.playoffStats.saves = (player.playoffStats.saves || 0) + playerGameStats.saves;
                                player.playoffStats.goalsAgainst = (player.playoffStats.goalsAgainst || 0) + playerGameStats.goalsAgainst;
                                player.playoffStats.shotsAgainst = (player.playoffStats.shotsAgainst || 0) + playerGameStats.shotsAgainst;
                                
                                if (result.winner === 'home') {
                                    player.playoffStats.wins = (player.playoffStats.wins || 0) + 1;
                                } else {
                                    player.playoffStats.losses = (player.playoffStats.losses || 0) + 1;
                                }
                                
                                if (playerGameStats.goalsAgainst === 0) {
                                    player.playoffStats.shutouts = (player.playoffStats.shutouts || 0) + 1;
                                }
                                
                                player.playoffStats.savePercentage = player.playoffStats.saves / (player.playoffStats.shotsAgainst || 1);
                                player.playoffStats.gaa = (player.playoffStats.goalsAgainst / (player.playoffStats.gamesPlayed || 1)) * 1.0;
                            }
                        } else {
                            player.playoffStats.gamesPlayed++;
                            player.playoffStats.goals += playerGameStats.goals;
                            player.playoffStats.assists += playerGameStats.assists;
                            player.playoffStats.points += playerGameStats.points;
                            player.playoffStats.plusMinus += playerGameStats.plusMinus;
                            player.playoffStats.pim += playerGameStats.pim;
                            player.playoffStats.shots += playerGameStats.shots;
                            player.playoffStats.timeOnIce += playerGameStats.toi;
                        }
                    }
                });
                
                result.awayPlayerStats.forEach(playerGameStats => {
                    const player = gameState.players.find(p => p.id === playerGameStats.player.id);
                    if (player) {
                        if (player.position === 'G') {
                            if (playerGameStats.shotsAgainst > 0) {
                                player.playoffStats.gamesPlayed++;
                                player.playoffStats.timeOnIce += playerGameStats.toi;
                                player.playoffStats.saves = (player.playoffStats.saves || 0) + playerGameStats.saves;
                                player.playoffStats.goalsAgainst = (player.playoffStats.goalsAgainst || 0) + playerGameStats.goalsAgainst;
                                player.playoffStats.shotsAgainst = (player.playoffStats.shotsAgainst || 0) + playerGameStats.shotsAgainst;
                                
                                if (result.winner === 'away') {
                                    player.playoffStats.wins = (player.playoffStats.wins || 0) + 1;
                                } else {
                                    player.playoffStats.losses = (player.playoffStats.losses || 0) + 1;
                                }
                                
                                if (playerGameStats.goalsAgainst === 0) {
                                    player.playoffStats.shutouts = (player.playoffStats.shutouts || 0) + 1;
                                }
                                
                                player.playoffStats.savePercentage = player.playoffStats.saves / (player.playoffStats.shotsAgainst || 1);
                                player.playoffStats.gaa = (player.playoffStats.goalsAgainst / (player.playoffStats.gamesPlayed || 1)) * 1.0;
                            }
                        } else {
                            player.playoffStats.gamesPlayed++;
                            player.playoffStats.goals += playerGameStats.goals;
                            player.playoffStats.assists += playerGameStats.assists;
                            player.playoffStats.points += playerGameStats.points;
                            player.playoffStats.plusMinus += playerGameStats.plusMinus;
                            player.playoffStats.pim += playerGameStats.pim;
                            player.playoffStats.shots += playerGameStats.shots;
                            player.playoffStats.timeOnIce += playerGameStats.toi;
                        }
                    }
                });
                
                return {
                    homeTeam: isHomeGame ? matchup.home : matchup.away,
                    awayTeam: isHomeGame ? matchup.away : matchup.home,
                    homeScore: result.homeGoals,
                    awayScore: result.awayGoals,
                    winner: result.winner === 'home' ? (isHomeGame ? matchup.home : matchup.away) : (isHomeGame ? matchup.away : matchup.home),
                    details: gameDetails
                };
            };
            
            const simulatePlayoffSeries = () => {
                if (!playoffState || playoffState.completed) return;
                
                let newState = { ...playoffState };
                
                // Handle Stanley Cup Finals (Round 4) separately
                if (newState.round === 4 && newState.finalMatchup) {
                    if (newState.finalMatchup.homeWins < 4 && newState.finalMatchup.awayWins < 4) {
                        const homeGamePattern = [true, true, false, false, true, false, true];
                        while (newState.finalMatchup.homeWins < 4 && newState.finalMatchup.awayWins < 4) {
                            const gameNum = newState.finalMatchup.homeWins + newState.finalMatchup.awayWins;
                            const isHomeGame = homeGamePattern[gameNum];
                            const game = simulatePlayoffGame(newState.finalMatchup, isHomeGame);
                            newState.finalMatchup.games.push(game);
                            
                            if (game.winner === newState.finalMatchup.home) {
                                newState.finalMatchup.homeWins++;
                            } else {
                                newState.finalMatchup.awayWins++;
                            }
                        }
                        
                        // Save to history
                        if (!newState.history) newState.history = {};
                        newState.history.final = { ...newState.finalMatchup };
                        
                        // Finals complete - calculate Playoff MVP
                        const mvp = calculatePlayoffMVP(gameState.players);
                        setPlayoffMVP(mvp);
                        
                        // Show champion
                        const champion = newState.finalMatchup.homeWins >= 4 ? newState.finalMatchup.home : newState.finalMatchup.away;
                        const championTeam = TEAMS.find(t => t.id === champion);
                        newState.completed = true;
                        newState.champion = champion;
                        
                        // Navigate to playoff MVP view
                        setCurrentView('playoffMVP');
                    }
                    
                    setPlayoffState(newState);
                    setGameState({ ...gameState });
                    return;
                }
                
                // Simulate conference rounds (Rounds 1-3)
                const simulateSeries = (matchups) => {
                    return matchups.map(matchup => {
                        if (matchup.homeWins >= 4 || matchup.awayWins >= 4) return matchup; // Already finished
                        
                        const newMatchup = { ...matchup, games: [...matchup.games] };
                        const gamesPlayed = newMatchup.homeWins + newMatchup.awayWins;
                        
                        // Simulate remaining games (2-2-1-1-1 format: HH-AA-H-A-H)
                        const homeGamePattern = [true, true, false, false, true, false, true];
                        
                        while (newMatchup.homeWins < 4 && newMatchup.awayWins < 4) {
                            const gameNum = newMatchup.homeWins + newMatchup.awayWins;
                            const isHomeGame = homeGamePattern[gameNum];
                            
                            const game = simulatePlayoffGame(newMatchup, isHomeGame);
                            newMatchup.games.push(game);
                            
                            if (game.winner === newMatchup.home) {
                                newMatchup.homeWins++;
                            } else {
                                newMatchup.awayWins++;
                            }
                        }
                        
                        return newMatchup;
                    });
                };
                
                newState.eastMatchups = simulateSeries(newState.eastMatchups);
                newState.westMatchups = simulateSeries(newState.westMatchups);
                
                // Check if round is complete
                const allComplete = [...newState.eastMatchups, ...newState.westMatchups].every(m => 
                    m.homeWins >= 4 || m.awayWins >= 4
                );
                
                if (allComplete) {
                    if (newState.round < 4) {
                        // Advance to next round
                        const getWinners = (matchups) => matchups.map(m => m.homeWins >= 4 ? m.home : m.away);
                        const eastWinners = getWinners(newState.eastMatchups);
                        const westWinners = getWinners(newState.westMatchups);
                        
                        // Save completed round to history
                        if (!newState.history) newState.history = {};
                        if (newState.round === 1) {
                            newState.history.eastRound1 = [...newState.eastMatchups];
                            newState.history.westRound1 = [...newState.westMatchups];
                        } else if (newState.round === 2) {
                            newState.history.eastRound2 = [...newState.eastMatchups];
                            newState.history.westRound2 = [...newState.westMatchups];
                        } else if (newState.round === 3) {
                            newState.history.eastRound3 = [...newState.eastMatchups];
                            newState.history.westRound3 = [...newState.westMatchups];
                        }
                        
                        if (newState.round === 3) {
                            // Stanley Cup Final
                            newState.round = 4;
                            newState.finalMatchup = {
                                home: eastWinners[0],
                                away: westWinners[0],
                                homeWins: 0,
                                awayWins: 0,
                                games: []
                            };
                            newState.eastMatchups = [];
                            newState.westMatchups = [];
                        } else {
                            // Next conference round
                            newState.round++;
                            const createNextRound = (winners) => {
                                if (winners.length === 4) {
                                    return [
                                        { home: winners[0], away: winners[3], homeWins: 0, awayWins: 0, games: [] },
                                        { home: winners[1], away: winners[2], homeWins: 0, awayWins: 0, games: [] }
                                    ];
                                } else {
                                    return [
                                        { home: winners[0], away: winners[1], homeWins: 0, awayWins: 0, games: [] }
                                    ];
                                }
                            };
                            newState.eastMatchups = createNextRound(eastWinners);
                            newState.westMatchups = createNextRound(westWinners);
                        }
                        
                        alert(`Round ${newState.round === 2 ? '2 (Conference Semifinals)' : newState.round === 3 ? '3 (Conference Finals)' : '4 (Stanley Cup Finals)'} begins!`);
                    }
                }
                
                setPlayoffState(newState);
                // Force gameState update to persist playoff stats changes
                setGameState({ ...gameState });
            };

            const simulateOnePlayoffDay = () => {
                if (!playoffState || playoffState.completed) return;
                
                let newState = { ...playoffState };
                const homeGamePattern = [true, true, false, false, true, false, true];
                
                // Initialize playoff day tracker
                if (!newState.currentDay) newState.currentDay = 1;
                newState.lastDaySummary = null;
                
                // STANLEY CUP FINALS (Round 4) - one game per day
                if (newState.round === 4 && newState.finalMatchup) {
                    if (newState.finalMatchup.homeWins < 4 && newState.finalMatchup.awayWins < 4) {
                        const gameNum = newState.finalMatchup.homeWins + newState.finalMatchup.awayWins;
                        const isHomeGame = homeGamePattern[gameNum];
                        const game = simulatePlayoffGame(newState.finalMatchup, isHomeGame);
                        newState.finalMatchup.games.push(game);
                        
                        if (game.winner === newState.finalMatchup.home) {
                            newState.finalMatchup.homeWins++;
                        } else {
                            newState.finalMatchup.awayWins++;
                        }
                        
                        const homeTeam = TEAMS.find(t => t.id === newState.finalMatchup.home);
                        const awayTeam = TEAMS.find(t => t.id === newState.finalMatchup.away);
                        const winner = game.winner === newState.finalMatchup.home ? homeTeam : awayTeam;
                        const loser = game.winner === newState.finalMatchup.home ? awayTeam : homeTeam;
                        
                        // Check if finals complete
                        if (newState.finalMatchup.homeWins >= 4 || newState.finalMatchup.awayWins >= 4) {
                            if (!newState.history) newState.history = {};
                            newState.history.final = { ...newState.finalMatchup };
                            const champion = newState.finalMatchup.homeWins >= 4 ? homeTeam : awayTeam;
                            newState.completed = true;
                            
                            newState.lastDaySummary = {
                                title: ` Stanley Cup Finals - Game ${gameNum + 1} `,
                                conference: 'Finals',
                                results: [{
                                    homeTeam, awayTeam,
                                    homeScore: game.homeScore,
                                    awayScore: game.awayScore,
                                    winner, loser,
                                    homeWins: newState.finalMatchup.homeWins,
                                    awayWins: newState.finalMatchup.awayWins,
                                    seriesComplete: true,
                                    champion: champion.city + ' ' + champion.name
                                }]
                            };
                        } else {
                            newState.lastDaySummary = {
                                title: ` Stanley Cup Finals - Game ${gameNum + 1} `,
                                conference: 'Finals',
                                results: [{
                                    homeTeam, awayTeam,
                                    homeScore: game.homeScore,
                                    awayScore: game.awayScore,
                                    winner, loser,
                                    homeWins: newState.finalMatchup.homeWins,
                                    awayWins: newState.finalMatchup.awayWins,
                                    seriesComplete: false
                                }]
                            };
                        }
                        
                        newState.currentDay++;
                    }
                    
                    setPlayoffState(newState);
                    setGameState({ ...gameState });
                    return;
                }
                
                // CONFERENCE ROUNDS - alternate East/West by day
                const isEastDay = newState.currentDay % 2 === 1;
                const conference = isEastDay ? 'East' : 'West';
                const matchups = isEastDay ? newState.eastMatchups : newState.westMatchups;
                const incompleteSeries = matchups.filter(m => m.homeWins < 4 && m.awayWins < 4);
                
                if (incompleteSeries.length === 0) {
                    // This conference has no games
                    const otherMatchups = isEastDay ? newState.westMatchups : newState.eastMatchups;
                    const otherIncompleteSeries = otherMatchups.filter(m => m.homeWins < 4 && m.awayWins < 4);
                    
                    if (otherIncompleteSeries.length === 0) {
                        // BOTH conferences done - advance round
                        const getWinners = (matchups) => matchups.map(m => m.homeWins >= 4 ? m.home : m.away);
                        const eastWinners = getWinners(newState.eastMatchups);
                        const westWinners = getWinners(newState.westMatchups);
                        
                        // Save to history
                        if (!newState.history) newState.history = {};
                        if (newState.round === 1) {
                            newState.history.eastRound1 = [...newState.eastMatchups];
                            newState.history.westRound1 = [...newState.westMatchups];
                        } else if (newState.round === 2) {
                            newState.history.eastRound2 = [...newState.eastMatchups];
                            newState.history.westRound2 = [...newState.westMatchups];
                        } else if (newState.round === 3) {
                            newState.history.eastRound3 = [...newState.eastMatchups];
                            newState.history.westRound3 = [...newState.westMatchups];
                        }
                        
                        if (newState.round === 3) {
                            // Create Stanley Cup Finals
                            newState.round = 4;
                            newState.finalMatchup = {
                                home: eastWinners[0],
                                away: westWinners[0],
                                homeWins: 0,
                                awayWins: 0,
                                games: []
                            };
                            newState.eastMatchups = [];
                            newState.westMatchups = [];
                            newState.currentDay = 1;
                            
                            const homeTeam = TEAMS.find(t => t.id === newState.finalMatchup.home);
                            const awayTeam = TEAMS.find(t => t.id === newState.finalMatchup.away);
                            newState.lastDaySummary = {
                                title: ' Conference Finals Complete! ',
                                conference: 'Finals Setup',
                                message: `Stanley Cup Finals: ${awayTeam.city} @ ${homeTeam.city}`,
                                restDays: 2
                            };
                        } else {
                            // Advance to next round
                            newState.round++;
                            const createNextRound = (winners) => {
                                if (winners.length === 4) {
                                    return [
                                        { home: winners[0], away: winners[3], homeWins: 0, awayWins: 0, games: [] },
                                        { home: winners[1], away: winners[2], homeWins: 0, awayWins: 0, games: [] }
                                    ];
                                } else {
                                    return [{ home: winners[0], away: winners[1], homeWins: 0, awayWins: 0, games: [] }];
                                }
                            };
                            newState.eastMatchups = createNextRound(eastWinners);
                            newState.westMatchups = createNextRound(westWinners);
                            newState.currentDay = 1;
                            
                            newState.lastDaySummary = {
                                title: `Round ${newState.round - 1} Complete!`,
                                conference: 'Round Transition',
                                message: `Round ${newState.round} (${newState.round === 2 ? 'Conference Semifinals' : 'Conference Finals'}) begins in 2 days`,
                                restDays: 2
                            };
                        }
                    } else {
                        // This conference done, waiting for other
                        newState.currentDay++;
                        newState.lastDaySummary = {
                            title: `${conference}ern Conference - Day ${newState.currentDay - 1}`,
                            conference,
                            message: `No games today (all series completed). Waiting for ${isEastDay ? 'Western' : 'Eastern'} Conference.`
                        };
                    }
                    
                    setPlayoffState(newState);
                    setGameState({ ...gameState });
                    return;
                }
                
                // SIMULATE ONE GAME for each incomplete series
                const results = [];
                
                incompleteSeries.forEach(matchup => {
                    const gameNum = matchup.homeWins + matchup.awayWins;
                    const isHomeGame = homeGamePattern[gameNum];
                    const game = simulatePlayoffGame(matchup, isHomeGame);
                    matchup.games.push(game);
                    
                    if (game.winner === matchup.home) {
                        matchup.homeWins++;
                    } else {
                        matchup.awayWins++;
                    }
                    
                    const homeTeam = TEAMS.find(t => t.id === matchup.home);
                    const awayTeam = TEAMS.find(t => t.id === matchup.away);
                    const winner = game.winner === matchup.home ? homeTeam : awayTeam;
                    const loser = game.winner === matchup.home ? awayTeam : homeTeam;
                    const seriesComplete = matchup.homeWins >= 4 || matchup.awayWins >= 4;
                    
                    results.push({
                        homeTeam, awayTeam,
                        homeScore: game.homeScore,
                        awayScore: game.awayScore,
                        winner, loser,
                        homeWins: matchup.homeWins,
                        awayWins: matchup.awayWins,
                        seriesComplete
                    });
                });
                
                // Store summary
                newState.lastDaySummary = {
                    title: `${conference}ern Conference - Day ${newState.currentDay}`,
                    subtitle: `Round ${newState.round} ${newState.round === 1 ? '(First Round)' : newState.round === 2 ? '(Conference Semifinals)' : '(Conference Finals)'}`,
                    conference,
                    results
                };
                
                newState.currentDay++;
                setPlayoffState(newState);
                setGameState({ ...gameState });
            };

            const simulateSeason = () => {
                if (!gameState) return;
                
                // Simulate until all teams have played 82 games
                let currentState = { ...gameState };
                let daysSimulated = 0;
                const maxDays = 300; // Safety limit
                
                for (let day = 0; day < maxDays; day++) {
                    const teamGames = {};
                    TEAMS.forEach(t => teamGames[t.id] = 0);
                    
                    currentState.schedule.filter(g => g.played).forEach(g => {
                        teamGames[g.homeTeam]++;
                        teamGames[g.awayTeam]++;
                    });
                    
                    const minGames = Math.min(...Object.values(teamGames));
                    
                    if (minGames >= 82) {
                        setGameState(currentState);
                        // Calculate end-of-season awards
                        const awards = calculateAwards(currentState.players, currentState.standings);
                        setSeasonAwards(awards);
                        setCurrentView('awards');
                        return;
                    }
                    
                    // Simulate one day (using same logic as simulateMultipleDays)
                    const teamsPlayedToday = new Set();
                    let gamesSimulated = 0;
                    
                    const dayOfWeek = currentState.currentDate.getDay();
                    let maxGamesPerDay;
                    const gameChance = Math.random();
                    
                    if (dayOfWeek === 0 || dayOfWeek === 6) {
                        if (gameChance < 0.80) {
                            maxGamesPerDay = 8 + Math.floor(Math.random() * 5);
                        } else {
                            maxGamesPerDay = 0;
                        }
                    } else {
                        if (gameChance < 0.60) {
                            maxGamesPerDay = 4 + Math.floor(Math.random() * 5);
                        } else {
                            maxGamesPerDay = 0;
                        }
                    }
                    
                    const recentlyPlayed = new Set();
                    if (currentState.lastGameDay) {
                        const daysSinceLastGame = Math.floor((currentState.currentDate - currentState.lastGameDay) / (1000 * 60 * 60 * 24));
                        if (daysSinceLastGame === 1) {
                            currentState.lastGameTeams?.forEach(t => recentlyPlayed.add(t));
                        }
                    }
                    
                    const newStandings = [...currentState.standings];
                    const newPlayers = [...currentState.players];
                    const newSchedule = [...currentState.schedule];
                    
                    while (teamsPlayedToday.size < 32 && gamesSimulated < maxGamesPerDay) {
                        const nextGameIndex = newSchedule.findIndex(g => {
                            if (g.played) return false;
                            
                            const homeGames = newSchedule.filter(sg => sg.played && (sg.homeTeam === g.homeTeam || sg.awayTeam === g.homeTeam)).length;
                            const awayGames = newSchedule.filter(sg => sg.played && (sg.homeTeam === g.awayTeam || sg.awayTeam === g.awayTeam)).length;
                            
                            const homeBackToBack = recentlyPlayed.has(g.homeTeam);
                            const awayBackToBack = recentlyPlayed.has(g.awayTeam);
                            const allowBackToBack = Math.random() < 0.20;
                            
                            return homeGames < 82 && awayGames < 82 && 
                                   !teamsPlayedToday.has(g.homeTeam) && 
                                   !teamsPlayedToday.has(g.awayTeam) &&
                                   (allowBackToBack || (!homeBackToBack && !awayBackToBack));
                        });
                        
                        if (nextGameIndex === -1) break;
                        
                        const game = newSchedule[nextGameIndex];
                        
                        // Only include active (non-scratched) and non-injured NHL players
                        const homePlayers = newPlayers.filter(p => 
                            p.teamId === game.homeTeam &&
                            p.roster === 'nhl' &&
                            !p.injury.injured &&
                            (p.position === 'G' ? p.dressed : p.lineNumber > 0)
                        );
                        const awayPlayers = newPlayers.filter(p => 
                            p.teamId === game.awayTeam &&
                            p.roster === 'nhl' &&
                            !p.injury.injured &&
                            (p.position === 'G' ? p.dressed : p.lineNumber > 0)
                        );
                        
                        const result = simulateGameResult(homePlayers, awayPlayers);
                        
                        const homeStanding = newStandings.find(s => s.teamId === game.homeTeam);
                        const awayStanding = newStandings.find(s => s.teamId === game.awayTeam);
                        
                        homeStanding.goalsFor += result.homeGoals;
                        homeStanding.goalsAgainst += result.awayGoals;
                        awayStanding.goalsFor += result.awayGoals;
                        awayStanding.goalsAgainst += result.homeGoals;
                        
                        // Update team stats
                        if (result.teamStats) {
                            homeStanding.teamStats.gamesPlayed++;
                            awayStanding.teamStats.gamesPlayed++;
                            
                            homeStanding.teamStats.shots += result.teamStats.homeShots;
                            homeStanding.teamStats.shotsAgainst += result.teamStats.awayShots;
                            awayStanding.teamStats.shots += result.teamStats.awayShots;
                            awayStanding.teamStats.shotsAgainst += result.teamStats.homeShots;
                            
                            homeStanding.teamStats.ppOpportunities += result.teamStats.homePPOpportunities;
                            homeStanding.teamStats.ppGoals += result.teamStats.homePPGoals;
                            awayStanding.teamStats.ppOpportunities += result.teamStats.awayPPOpportunities;
                            awayStanding.teamStats.ppGoals += result.teamStats.awayPPGoals;
                            
                            homeStanding.teamStats.pkOpportunities += result.teamStats.awayPPOpportunities;
                            homeStanding.teamStats.pkGoalsAgainst += result.teamStats.awayPPGoals;
                            awayStanding.teamStats.pkOpportunities += result.teamStats.homePPOpportunities;
                            awayStanding.teamStats.pkGoalsAgainst += result.teamStats.homePPGoals;
                        }
                        
                        // Update head-to-head record
                        const h2hKey = game.homeTeam < game.awayTeam ? 
                            `${game.homeTeam}vs${game.awayTeam}` : 
                            `${game.awayTeam}vs${game.homeTeam}`;
                        
                        if (!currentState.headToHead) currentState.headToHead = {};
                        
                        if (!currentState.headToHead[h2hKey]) {
                            const team1 = game.homeTeam < game.awayTeam ? game.homeTeam : game.awayTeam;
                            const team2 = game.homeTeam < game.awayTeam ? game.awayTeam : game.homeTeam;
                            currentState.headToHead[h2hKey] = {
                                team1: team1,
                                team2: team2,
                                team1Wins: 0,
                                team2Wins: 0,
                                ties: 0
                            };
                        }
                        
                        if (result.winner === 'home') {
                            if (game.homeTeam === currentState.headToHead[h2hKey].team1) {
                                currentState.headToHead[h2hKey].team1Wins++;
                            } else {
                                currentState.headToHead[h2hKey].team2Wins++;
                            }
                        } else {
                            if (game.awayTeam === currentState.headToHead[h2hKey].team1) {
                                currentState.headToHead[h2hKey].team1Wins++;
                            } else {
                                currentState.headToHead[h2hKey].team2Wins++;
                            }
                        }
                        
                        if (result.winner === 'home') {
                            homeStanding.wins++;
                            homeStanding.home.wins++;
                            homeStanding.points += 2;
                            awayStanding.losses++;
                            awayStanding.away.losses++;
                        } else {
                            awayStanding.wins++;
                            awayStanding.away.wins++;
                            awayStanding.points += 2;
                            homeStanding.losses++;
                            homeStanding.home.losses++;
                        }
                        
                        game.played = true;
                        game.homeScore = result.homeGoals;
                        game.awayScore = result.awayGoals;
                        game.date = new Date(currentState.currentDate);
                        
                        // Store comprehensive game details including per-player stats
                        const gameDetails = {
                            homeGoals: result.homeGoals,
                            awayGoals: result.awayGoals,
                            winner: result.winner,
                            homeTeam: game.homeTeam,
                            awayTeam: game.awayTeam,
                            homePlayerStats: result.homePlayerStats,
                            awayPlayerStats: result.awayPlayerStats,
                            homeScratched: result.homeScratched.map(p => ({ id: p.id, name: `${p.firstName} ${p.lastName}`, reason: 'Healthy Scratch' })),
                            awayScratched: result.awayScratched.map(p => ({ id: p.id, name: `${p.firstName} ${p.lastName}`, reason: 'Healthy Scratch' })),
                            homeNewInjuries: [],
                            awayNewInjuries: [],
                            scoringSummary: result.scoringSummary
                        };
                        game.details = gameDetails;
                        
                        // Update player season stats from per-game stats
                        result.homePlayerStats.forEach(playerGameStats => {
                            const player = newPlayers.find(p => p.id === playerGameStats.player.id);
                            if (player) {
                                if (player.position === 'G') {
                                    if (playerGameStats.shotsAgainst > 0) {
                                        player.stats.gamesPlayed++;
                                        player.stats.timeOnIce += playerGameStats.toi;
                                        player.stats.saves = (player.stats.saves || 0) + playerGameStats.saves;
                                        player.stats.goalsAgainst = (player.stats.goalsAgainst || 0) + playerGameStats.goalsAgainst;
                                        player.stats.shotsAgainst = (player.stats.shotsAgainst || 0) + playerGameStats.shotsAgainst;
                                        
                                        if (result.winner === 'home') {
                                            player.stats.wins = (player.stats.wins || 0) + 1;
                                        } else {
                                            player.stats.losses = (player.stats.losses || 0) + 1;
                                        }
                                        
                                        if (playerGameStats.goalsAgainst === 0) {
                                            player.stats.shutouts = (player.stats.shutouts || 0) + 1;
                                        }
                                        
                                        player.stats.savePercentage = player.stats.saves / (player.stats.shotsAgainst || 1);
                                        player.stats.gaa = (player.stats.goalsAgainst / (player.stats.gamesPlayed || 1)) * 1.0;
                                    }
                                } else {
                                    player.stats.gamesPlayed++;
                                    player.stats.goals += playerGameStats.goals;
                                    player.stats.assists += playerGameStats.assists;
                                    player.stats.points += playerGameStats.points;
                                    player.stats.plusMinus += playerGameStats.plusMinus;
                                    player.stats.pim += playerGameStats.pim;
                                    player.stats.shots += playerGameStats.shots;
                                    player.stats.timeOnIce += playerGameStats.toi;
                                }
                                
                                // Check for injury
                                const injury = checkForInjury(player, playerGameStats.toi);
                                if (injury) {
                                    player.injury = injury;
                                    autoCallUpReplacement(newPlayers, player);
                                }
                                
                                // Check for milestones after stat update
                                checkMilestones(player, currentState);
                            }
                        });
                        
                        result.awayPlayerStats.forEach(playerGameStats => {
                            const player = newPlayers.find(p => p.id === playerGameStats.player.id);
                            if (player) {
                                if (player.position === 'G') {
                                    if (playerGameStats.shotsAgainst > 0) {
                                        player.stats.gamesPlayed++;
                                        player.stats.timeOnIce += playerGameStats.toi;
                                        player.stats.saves = (player.stats.saves || 0) + playerGameStats.saves;
                                        player.stats.goalsAgainst = (player.stats.goalsAgainst || 0) + playerGameStats.goalsAgainst;
                                        player.stats.shotsAgainst = (player.stats.shotsAgainst || 0) + playerGameStats.shotsAgainst;
                                        
                                        if (result.winner === 'away') {
                                            player.stats.wins = (player.stats.wins || 0) + 1;
                                        } else {
                                            player.stats.losses = (player.stats.losses || 0) + 1;
                                        }
                                        
                                        if (playerGameStats.goalsAgainst === 0) {
                                            player.stats.shutouts = (player.stats.shutouts || 0) + 1;
                                        }
                                        
                                        player.stats.savePercentage = player.stats.saves / (player.stats.shotsAgainst || 1);
                                        player.stats.gaa = (player.stats.goalsAgainst / (player.stats.gamesPlayed || 1)) * 1.0;
                                    }
                                } else {
                                    player.stats.gamesPlayed++;
                                    player.stats.goals += playerGameStats.goals;
                                    player.stats.assists += playerGameStats.assists;
                                    player.stats.points += playerGameStats.points;
                                    player.stats.plusMinus += playerGameStats.plusMinus;
                                    player.stats.pim += playerGameStats.pim;
                                    player.stats.shots += playerGameStats.shots;
                                    player.stats.timeOnIce += playerGameStats.toi;
                                }
                                
                                // Check for injury
                                const injury = checkForInjury(player, playerGameStats.toi);
                                if (injury) {
                                    player.injury = injury;
                                    autoCallUpReplacement(newPlayers, player);
                                }
                                
                                // Check for milestones after stat update
                                checkMilestones(player, currentState);
                            }
                        });
                        
                        teamsPlayedToday.add(game.homeTeam);
                        teamsPlayedToday.add(game.awayTeam);
                        gamesSimulated++;
                            
                        
                    }
                    
                    const newDate = new Date(currentState.currentDate);
                    newDate.setDate(newDate.getDate() + 1);
                    
                    updateInjuries(newPlayers);
                    
                    // Process AI trades (same as simulateDay)
                    const aiTrade = processAITrades({...currentState, players: newPlayers, schedule: newSchedule, standings: newStandings});
                    
                    if (aiTrade) {
                        console.log(`[AI TRADES] Executing trade between teams ${aiTrade.team1} and ${aiTrade.team2}`);
                        // Execute the AI trade
                        aiTrade.team1Gives.forEach(player => {
                            const p = newPlayers.find(np => np.id === player.id);
                            p.teamId = aiTrade.team2;
                            p.lineNumber = 0;
                            p.linePosition = null;
                            p.ppUnit = null;
                            p.pkUnit = null;
                            if (p.position === 'G') p.dressed = false;
                            
                            if (!p.tradeHistory) p.tradeHistory = [];
                            p.tradeHistory.push({
                                date: new Date(currentState.currentDate),
                                from: aiTrade.team1,
                                to: aiTrade.team2,
                                year: currentState.year,
                                tradedWith: aiTrade.team1Gives.filter(tp => tp.id !== p.id).map(tp => ({ 
                                    id: tp.id, 
                                    name: `${tp.firstName} ${tp.lastName}`, 
                                    position: tp.position 
                                })),
                                tradedFor: aiTrade.team2Gives.map(tp => ({ 
                                    id: tp.id, 
                                    name: `${tp.firstName} ${tp.lastName}`, 
                                    position: tp.position 
                                }))
                            });
                        });
                        
                        aiTrade.team2Gives.forEach(player => {
                            const p = newPlayers.find(np => np.id === player.id);
                            p.teamId = aiTrade.team1;
                            p.lineNumber = 0;
                            p.linePosition = null;
                            p.ppUnit = null;
                            p.pkUnit = null;
                            if (p.position === 'G') p.dressed = false;
                            
                            if (!p.tradeHistory) p.tradeHistory = [];
                            p.tradeHistory.push({
                                date: new Date(currentState.currentDate),
                                from: aiTrade.team2,
                                to: aiTrade.team1,
                                year: currentState.year,
                                tradedWith: aiTrade.team2Gives.filter(tp => tp.id !== p.id).map(tp => ({ 
                                    id: tp.id, 
                                    name: `${tp.firstName} ${tp.lastName}`, 
                                    position: tp.position 
                                })),
                                tradedFor: aiTrade.team1Gives.map(tp => ({ 
                                    id: tp.id, 
                                    name: `${tp.firstName} ${tp.lastName}`, 
                                    position: tp.position 
                                }))
                            });
                        });
                        
                        // Update global trade history
                        if (!currentState.tradeHistory) currentState.tradeHistory = [];
                        currentState.tradeHistory.push({
                            date: new Date(currentState.currentDate),
                            year: currentState.year,
                            team1: aiTrade.team1,
                            team2: aiTrade.team2,
                            team1Gives: aiTrade.team1Gives.map(p => ({ 
                                id: p.id, 
                                name: `${p.firstName} ${p.lastName}`, 
                                position: p.position, 
                                ovr: p.ratings.overall 
                            })),
                            team2Gives: aiTrade.team2Gives.map(p => ({ 
                                id: p.id, 
                                name: `${p.firstName} ${p.lastName}`, 
                                position: p.position, 
                                ovr: p.ratings.overall 
                            })),
                            isAITrade: true
                        });
                        
                        // Update team trade counts
                        if (!currentState.teamTradeCount) currentState.teamTradeCount = {};
                        currentState.teamTradeCount[aiTrade.team1] = (currentState.teamTradeCount[aiTrade.team1] || 0) + 1;
                        currentState.teamTradeCount[aiTrade.team2] = (currentState.teamTradeCount[aiTrade.team2] || 0) + 1;
                        
                        // Auto-assign lines for both teams
                        autoSetAllLines(newPlayers, aiTrade.team1);
                        autoSetAllLines(newPlayers, aiTrade.team2);
                    }
                    
                    currentState = {
                        ...currentState,
                        standings: newStandings,
                        players: newPlayers,
                        schedule: newSchedule,
                        currentGame: currentState.currentGame + gamesSimulated,
                        currentDate: newDate,
                        lastGameDay: gamesSimulated > 0 ? new Date(currentState.currentDate) : currentState.lastGameDay,
                        lastGameTeams: gamesSimulated > 0 ? Array.from(teamsPlayedToday) : currentState.lastGameTeams,
                        tradeHistory: aiTrade ? currentState.tradeHistory : (currentState.tradeHistory || []),
                        teamTradeCount: aiTrade ? currentState.teamTradeCount : (currentState.teamTradeCount || {})
                    };
                    
                    daysSimulated++;
                }
                
                setGameState(currentState);
            };

            const simulateMultipleDays = (maxDays) => {
                if (!gameState) return;
                
                let currentState = { ...gameState };
                let daysSimulated = 0;
                
                for (let day = 0; day < maxDays; day++) {
                    // Check if season is complete BEFORE simulating this day
                    const teamGames = {};
                    TEAMS.forEach(t => teamGames[t.id] = 0);
                    
                    currentState.schedule.filter(g => g.played).forEach(g => {
                        teamGames[g.homeTeam]++;
                        teamGames[g.awayTeam]++;
                    });
                    
                    const minGames = Math.min(...Object.values(teamGames));
                    
                    if (minGames >= 82) {
                        // Season complete - stop here
                        alert(`Regular season complete! All teams have played 82 games. (Simulated ${daysSimulated} days)`);
                        setGameState(currentState);
                        return;
                    }
                    
                    // Simulate one day with realistic NHL scheduling
                    const teamsPlayedToday = new Set();
                    let gamesSimulated = 0;
                    
                    // Determine if today is a "game day" and how many games
                    const dayOfWeek = currentState.currentDate.getDay();
                    
                    let maxGamesPerDay;
                    const gameChance = Math.random();
                    
                    // Weekend has more games
                    if (dayOfWeek === 0 || dayOfWeek === 6) {
                        if (gameChance < 0.80) {
                            maxGamesPerDay = 8 + Math.floor(Math.random() * 5); // 8-12 games
                        } else {
                            maxGamesPerDay = 0; // Off day
                        }
                    } else {
                        if (gameChance < 0.60) {
                            maxGamesPerDay = 4 + Math.floor(Math.random() * 5); // 4-8 games
                        } else {
                            maxGamesPerDay = 0; // Off day
                        }
                    }
                    
                    // Track back-to-backs
                    const recentlyPlayed = new Set();
                    if (currentState.lastGameDay) {
                        const daysSinceLastGame = Math.floor((currentState.currentDate - currentState.lastGameDay) / (1000 * 60 * 60 * 24));
                        if (daysSinceLastGame === 1) {
                            currentState.lastGameTeams?.forEach(t => recentlyPlayed.add(t));
                        }
                    }
                    
                    const newStandings = [...currentState.standings];
                    const newPlayers = [...currentState.players];
                    const newSchedule = [...currentState.schedule];
                    
                    let hasGamesToPlay = false;
                    
                    while (teamsPlayedToday.size < 30 && gamesSimulated < maxGamesPerDay) {
                        const nextGameIndex = newSchedule.findIndex(g => {
                            if (g.played) return false;
                            
                            const homeGames = newSchedule.filter(sg => sg.played && (sg.homeTeam === g.homeTeam || sg.awayTeam === g.homeTeam)).length;
                            const awayGames = newSchedule.filter(sg => sg.played && (sg.homeTeam === g.awayTeam || sg.awayTeam === g.awayTeam)).length;
                            
                            // Avoid back-to-backs
                            const homeBackToBack = recentlyPlayed.has(g.homeTeam);
                            const awayBackToBack = recentlyPlayed.has(g.awayTeam);
                            const allowBackToBack = Math.random() < 0.20;
                            
                            return homeGames < 82 && awayGames < 82 && 
                                   !teamsPlayedToday.has(g.homeTeam) && 
                                   !teamsPlayedToday.has(g.awayTeam) &&
                                   (allowBackToBack || (!homeBackToBack && !awayBackToBack));
                        });
                        
                        if (nextGameIndex === -1) break;
                        
                        hasGamesToPlay = true;
                        const game = newSchedule[nextGameIndex];
                        
                        // Only include active (non-scratched) and non-injured NHL players
                        const homePlayers = newPlayers.filter(p => 
                            p.teamId === game.homeTeam &&
                            p.roster === 'nhl' &&
                            !p.injury.injured &&
                            (p.position === 'G' ? p.dressed : p.lineNumber > 0)
                        );
                        const awayPlayers = newPlayers.filter(p => 
                            p.teamId === game.awayTeam &&
                            p.roster === 'nhl' &&
                            !p.injury.injured &&
                            (p.position === 'G' ? p.dressed : p.lineNumber > 0)
                        );
                        
                        const result = simulateGameResult(homePlayers, awayPlayers);
                        
                        const homeStanding = newStandings.find(s => s.teamId === game.homeTeam);
                        const awayStanding = newStandings.find(s => s.teamId === game.awayTeam);
                        
                        homeStanding.goalsFor += result.homeGoals;
                        homeStanding.goalsAgainst += result.awayGoals;
                        awayStanding.goalsFor += result.awayGoals;
                        awayStanding.goalsAgainst += result.homeGoals;
                        
                        // Update team stats
                        if (result.teamStats) {
                            homeStanding.teamStats.gamesPlayed++;
                            awayStanding.teamStats.gamesPlayed++;
                            
                            homeStanding.teamStats.shots += result.teamStats.homeShots;
                            homeStanding.teamStats.shotsAgainst += result.teamStats.awayShots;
                            awayStanding.teamStats.shots += result.teamStats.awayShots;
                            awayStanding.teamStats.shotsAgainst += result.teamStats.homeShots;
                            
                            homeStanding.teamStats.ppOpportunities += result.teamStats.homePPOpportunities;
                            homeStanding.teamStats.ppGoals += result.teamStats.homePPGoals;
                            awayStanding.teamStats.ppOpportunities += result.teamStats.awayPPOpportunities;
                            awayStanding.teamStats.ppGoals += result.teamStats.awayPPGoals;
                            
                            homeStanding.teamStats.pkOpportunities += result.teamStats.awayPPOpportunities;
                            homeStanding.teamStats.pkGoalsAgainst += result.teamStats.awayPPGoals;
                            awayStanding.teamStats.pkOpportunities += result.teamStats.homePPOpportunities;
                            awayStanding.teamStats.pkGoalsAgainst += result.teamStats.homePPGoals;
                        }
                        
                        if (result.winner === 'home') {
                            homeStanding.wins++;
                            homeStanding.home.wins++;
                            homeStanding.points += 2;
                            awayStanding.losses++;
                            awayStanding.away.losses++;
                        } else {
                            awayStanding.wins++;
                            awayStanding.away.wins++;
                            awayStanding.points += 2;
                            homeStanding.losses++;
                            homeStanding.home.losses++;
                        }
                        
                        newSchedule[nextGameIndex].played = true;
                        newSchedule[nextGameIndex].homeScore = result.homeGoals;
                        newSchedule[nextGameIndex].awayScore = result.awayGoals;
                        newSchedule[nextGameIndex].date = new Date(currentState.currentDate);
                        
                        const allHomePlayers = [...result.homePlayers, ...result.homeDefense];
                        const allAwayPlayers = [...result.awayPlayers, ...result.awayDefense];
                        
                        // Assign goals and assists using the same weighted system as simulateDay
                        const assignGoalsAndAssists = (players, totalGoals) => {
                            const goalData = [];
                            
                            // Weight players for GOALS
                            const goalWeights = players
                                .filter(p => p.position !== 'G')
                                .map(p => {
                                    const ratingFactor = Math.pow(p.ratings.overall / 100, 2.5);
                                    const lineMultiplier = p.lineNumber === 1 ? 1.3 : p.lineNumber === 2 ? 0.95 : p.lineNumber === 3 ? 0.7 : 0.5;
                                    const eliteBonus = p.ratings.overall >= 90 ? 1.2 : 1.0;
                                    const positionMultiplier = p.position === 'D' ? 0.2 : 1.0;
                                    return { player: p, weight: ratingFactor * lineMultiplier * eliteBonus * positionMultiplier };
                                });
                            
                            // Weight players for ASSISTS
                            const assistWeights = players
                                .filter(p => p.position !== 'G')
                                .map(p => {
                                    const ratingFactor = Math.pow(p.ratings.overall / 100, 2.5);
                                    const lineMultiplier = p.lineNumber === 1 ? 1.3 : p.lineNumber === 2 ? 0.95 : p.lineNumber === 3 ? 0.7 : 0.5;
                                    const eliteBonus = p.ratings.overall >= 90 ? 1.2 : 1.0;
                                    const positionMultiplier = p.position === 'D' ? 1.1 : 1.0;
                                    return { player: p, weight: ratingFactor * lineMultiplier * eliteBonus * positionMultiplier };
                                });
                            
                            for (let i = 0; i < totalGoals; i++) {
                                const totalWeight = goalWeights.reduce((sum, w) => sum + w.weight, 0);
                                let rand = Math.random() * totalWeight;
                                let cumulative = 0;
                                let scorer = goalWeights[0].player;
                                
                                for (const w of goalWeights) {
                                    cumulative += w.weight;
                                    if (rand <= cumulative) {
                                        scorer = w.player;
                                        break;
                                    }
                                }
                                
                                // Pick 0-2 assists - NHL average: ~1.85 assists per goal
                                // Distribution: 3% no assists, 12% one assist, 85% two assists
                                const assistRoll = Math.random();
                                const numAssists = assistRoll < 0.03 ? 0 : assistRoll < 0.15 ? 1 : 2;
                                const assisters = [];
                                const eligibleAssisters = assistWeights.filter(w => w.player.id !== scorer.id);
                                
                                for (let a = 0; a < numAssists && eligibleAssisters.length > 0; a++) {
                                    const assistWeight = eligibleAssisters.reduce((sum, w) => sum + w.weight, 0);
                                    rand = Math.random() * assistWeight;
                                    cumulative = 0;
                                    
                                    for (let j = 0; j < eligibleAssisters.length; j++) {
                                        cumulative += eligibleAssisters[j].weight;
                                        if (rand <= cumulative) {
                                            assisters.push(eligibleAssisters[j].player);
                                            eligibleAssisters.splice(j, 1);
                                            break;
                                        }
                                    }
                                }
                                
                                goalData.push({ scorer, assisters });
                            }
                            return goalData;
                        };
                        
                        const homeGoalData = assignGoalsAndAssists(allHomePlayers, result.homeGoals);
                        const awayGoalData = assignGoalsAndAssists(allAwayPlayers, result.awayGoals);
                        
                        // Assign penalties
                        const homePenalties = assignPenalties(allHomePlayers);
                        const awayPenalties = assignPenalties(allAwayPlayers);
                        
                        // Update player stats with goals and assists
                        allHomePlayers.forEach(p => {
                            const goals = homeGoalData.filter(g => g.scorer.id === p.id).length;
                            const assists = homeGoalData.reduce((count, g) => count + g.assisters.filter(a => a.id === p.id).length, 0);
                            const toi = getIceTime(p);
                            
                            // Calculate PIM
                            const playerPenalties = homePenalties.filter(pen => pen.player.id === p.id);
                            const pim = playerPenalties.reduce((sum, pen) => sum + pen.penalty.minutes, 0);
                            
                            p.stats.gamesPlayed++;
                            p.stats.goals += goals;
                            p.stats.assists += assists;
                            p.stats.points += (goals + assists);
                            p.stats.plusMinus += (result.winner === 'home' ? 1 : -1) * (Math.random() < 0.3 ? 1 : 0);
                            p.stats.pim += pim;
                            p.stats.shots += Math.floor(Math.random() * 3) + goals * 2;
                            p.stats.timeOnIce += toi;
                            
                            // Check for injury
                            const injury = checkForInjury(p, toi);
                            if (injury) {
                                p.injury = injury;
                                // Auto-call-up: activate a scratched player of same position
                                autoCallUpReplacement(newPlayers, p);
                            }
                        });
                        
                        allAwayPlayers.forEach(p => {
                            const goals = awayGoalData.filter(g => g.scorer.id === p.id).length;
                            const assists = awayGoalData.reduce((count, g) => count + g.assisters.filter(a => a.id === p.id).length, 0);
                            const toi = getIceTime(p);
                            
                            // Calculate PIM
                            const playerPenalties = awayPenalties.filter(pen => pen.player.id === p.id);
                            const pim = playerPenalties.reduce((sum, pen) => sum + pen.penalty.minutes, 0);
                            
                            p.stats.gamesPlayed++;
                            p.stats.goals += goals;
                            p.stats.assists += assists;
                            p.stats.points += (goals + assists);
                            p.stats.plusMinus += (result.winner === 'away' ? 1 : -1) * (Math.random() < 0.3 ? 1 : 0);
                            p.stats.pim += pim;
                            p.stats.shots += Math.floor(Math.random() * 3) + goals * 2;
                            p.stats.timeOnIce += toi;
                            
                            // Check for injury
                            const injury = checkForInjury(p, toi);
                            if (injury) {
                                p.injury = injury;
                                // Auto-call-up: activate a scratched player of same position
                                autoCallUpReplacement(newPlayers, p);
                            }
                        });
                        
                        
                        // Simplified game stats for display
                        newSchedule[nextGameIndex].homeStats = allHomePlayers.map(p => {
                            const goals = homeGoalData.filter(g => g.scorer.id === p.id).length;
                            const assists = homeGoalData.reduce((count, g) => count + g.assisters.filter(a => a.id === p.id).length, 0);
                            return {
                                playerId: p.id,
                                name: `${p.firstName} ${p.lastName}`,
                                position: p.position,
                                goals: goals,
                                assists: assists,
                                points: goals + assists,
                                plusMinus: 0,
                                pim: 0,
                                shots: 0,
                                toi: getIceTime(p),
                                hits: 0
                            };
                        });
                        
                        newSchedule[nextGameIndex].awayStats = allAwayPlayers.map(p => {
                            const goals = awayGoalData.filter(g => g.scorer.id === p.id).length;
                            const assists = awayGoalData.reduce((count, g) => count + g.assisters.filter(a => a.id === p.id).length, 0);
                            return {
                                playerId: p.id,
                                name: `${p.firstName} ${p.lastName}`,
                                position: p.position,
                                goals: goals,
                                assists: assists,
                                points: goals + assists,
                                plusMinus: 0,
                                pim: 0,
                                shots: 0,
                                toi: getIceTime(p),
                                hits: 0
                            };
                        });
                        
                        newSchedule[nextGameIndex].periodScoring = [];
                        
                        teamsPlayedToday.add(game.homeTeam);
                        teamsPlayedToday.add(game.awayTeam);
                        gamesSimulated++;
                    }
                    
                    // If no games were played today and we still have games to play, 
                    // it means we're stuck - break out
                    if (!hasGamesToPlay && gamesSimulated === 0) {
                        const unplayedGames = newSchedule.filter(g => !g.played).length;
                        if (unplayedGames > 0) {
                            console.log(`Warning: ${unplayedGames} unplayed games remaining but no valid matchups found`);
                        }
                        break;
                    }
                    
                    // Advance date
                    const newDate = new Date(currentState.currentDate);
                    newDate.setDate(newDate.getDate() + 1);
                    
                    // Update injuries for all players
                    updateInjuries(newPlayers);
                    
                    // Process AI trades (same as simulateDay)
                    const aiTrade = processAITrades({...currentState, players: newPlayers, schedule: newSchedule, standings: newStandings});
                    
                    if (aiTrade) {
                        console.log(`[AI TRADES] Executing trade between teams ${aiTrade.team1} and ${aiTrade.team2}`);
                        // Execute the AI trade
                        aiTrade.team1Gives.forEach(player => {
                            const p = newPlayers.find(np => np.id === player.id);
                            p.teamId = aiTrade.team2;
                            p.lineNumber = 0;
                            p.linePosition = null;
                            p.ppUnit = null;
                            p.pkUnit = null;
                            if (p.position === 'G') p.dressed = false;
                            
                            if (!p.tradeHistory) p.tradeHistory = [];
                            p.tradeHistory.push({
                                date: new Date(currentState.currentDate),
                                from: aiTrade.team1,
                                to: aiTrade.team2,
                                year: currentState.year,
                                tradedWith: aiTrade.team1Gives.filter(tp => tp.id !== p.id).map(tp => ({ 
                                    id: tp.id, 
                                    name: `${tp.firstName} ${tp.lastName}`, 
                                    position: tp.position 
                                })),
                                tradedFor: aiTrade.team2Gives.map(tp => ({ 
                                    id: tp.id, 
                                    name: `${tp.firstName} ${tp.lastName}`, 
                                    position: tp.position 
                                }))
                            });
                        });
                        
                        aiTrade.team2Gives.forEach(player => {
                            const p = newPlayers.find(np => np.id === player.id);
                            p.teamId = aiTrade.team1;
                            p.lineNumber = 0;
                            p.linePosition = null;
                            p.ppUnit = null;
                            p.pkUnit = null;
                            if (p.position === 'G') p.dressed = false;
                            
                            if (!p.tradeHistory) p.tradeHistory = [];
                            p.tradeHistory.push({
                                date: new Date(currentState.currentDate),
                                from: aiTrade.team2,
                                to: aiTrade.team1,
                                year: currentState.year,
                                tradedWith: aiTrade.team2Gives.filter(tp => tp.id !== p.id).map(tp => ({ 
                                    id: tp.id, 
                                    name: `${tp.firstName} ${tp.lastName}`, 
                                    position: tp.position 
                                })),
                                tradedFor: aiTrade.team1Gives.map(tp => ({ 
                                    id: tp.id, 
                                    name: `${tp.firstName} ${tp.lastName}`, 
                                    position: tp.position 
                                }))
                            });
                        });
                        
                        // Update global trade history
                        if (!currentState.tradeHistory) currentState.tradeHistory = [];
                        currentState.tradeHistory.push({
                            date: new Date(currentState.currentDate),
                            year: currentState.year,
                            team1: aiTrade.team1,
                            team2: aiTrade.team2,
                            team1Gives: aiTrade.team1Gives.map(p => ({ 
                                id: p.id, 
                                name: `${p.firstName} ${p.lastName}`, 
                                position: p.position, 
                                ovr: p.ratings.overall 
                            })),
                            team2Gives: aiTrade.team2Gives.map(p => ({ 
                                id: p.id, 
                                name: `${p.firstName} ${p.lastName}`, 
                                position: p.position, 
                                ovr: p.ratings.overall 
                            })),
                            isAITrade: true
                        });
                        
                        // Update team trade counts
                        if (!currentState.teamTradeCount) currentState.teamTradeCount = {};
                        currentState.teamTradeCount[aiTrade.team1] = (currentState.teamTradeCount[aiTrade.team1] || 0) + 1;
                        currentState.teamTradeCount[aiTrade.team2] = (currentState.teamTradeCount[aiTrade.team2] || 0) + 1;
                        
                        // Auto-assign lines for both teams
                        autoSetAllLines(newPlayers, aiTrade.team1);
                        autoSetAllLines(newPlayers, aiTrade.team2);
                    }
                    
                    currentState = {
                        ...currentState,
                        standings: newStandings,
                        players: newPlayers,
                        schedule: newSchedule,
                        currentGame: currentState.currentGame + gamesSimulated,
                        currentDate: newDate,
                        lastGameDay: gamesSimulated > 0 ? new Date(currentState.currentDate) : currentState.lastGameDay,
                        lastGameTeams: gamesSimulated > 0 ? Array.from(teamsPlayedToday) : currentState.lastGameTeams,
                        tradeHistory: aiTrade ? currentState.tradeHistory : (currentState.tradeHistory || []),
                        teamTradeCount: aiTrade ? currentState.teamTradeCount : (currentState.teamTradeCount || {})
                    };
                    
                    daysSimulated++;
                }
                
                setGameState(currentState);
            };

            const proposeTrade = (yourPlayer, theirPlayer) => {
                if (!gameState) return;
                
                const ratingDiff = Math.abs(yourPlayer.ratings.overall - theirPlayer.ratings.overall);
                const accepted = ratingDiff < 10 && Math.random() > 0.3;
                
                if (accepted) {
                    const newPlayers = gameState.players.map(p => {
                        if (p.id === yourPlayer.id) return { ...p, teamId: theirPlayer.teamId };
                        if (p.id === theirPlayer.id) return { ...p, teamId: yourPlayer.teamId };
                        return p;
                    });
                    
                    setGameState({ ...gameState, players: newPlayers });
                    alert('Trade accepted!');
                } else {
                    alert('Trade rejected.');
                }
                
                setSelectedPlayer(null);
                setSelectedTeam(null);
            };

            const formatTOI = (minutes) => {
                const mins = Math.floor(minutes);
                const secs = Math.round((minutes - mins) * 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            const renderStandings = () => {
                if (!gameState) return null;

                const sortedStandings = [...gameState.standings].sort((a, b) => b.points - a.points);

                if (standingsView === 'division') {
                    return ['Atlantic', 'Metropolitan', 'Central', 'Pacific'].map(division => {
                        const divTeams = TEAMS.filter(t => t.division === division);
                        const divStandings = sortedStandings.filter(s => divTeams.some(t => t.id === s.teamId));
                        
                        return (
                            <div key={division} className="card">
                                <h2>{division} Division</h2>
                                <table className="standings-table">
                                    <thead>
                                        <tr>
                                            <th className="rank">#</th>
                                            <th>Team</th>
                                            <th className="text-center">GP</th>
                                            <th className="text-center">W</th>
                                            <th className="text-center">L</th>
                                            <th className="text-center">OTL</th>
                                            <th className="text-center">PTS</th>
                                            <th className="text-center">GF</th>
                                            <th className="text-center">GA</th>
                                            <th className="text-center">DIFF</th>
                                            <th className="text-center">HOME</th>
                                            <th className="text-center">AWAY</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {divStandings.map((standing, idx) => {
                                            const team = TEAMS.find(t => t.id === standing.teamId);
                                            const isUserTeam = team.id === userTeamId;
                                            const isPlayoff = idx < 3;
                                            const gp = standing.wins + standing.losses + standing.otLosses;
                                            const diff = standing.goalsFor - standing.goalsAgainst;
                                            return (
                                                <tr key={team.id} className={`${isUserTeam ? 'highlight' : ''} ${isPlayoff ? 'playoff' : ''}`}>
                                                    <td className="rank">{idx + 1}</td>
                                                    <td className="team-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('teamProfile', team.id)}>
                                                        {team.city} {team.name}
                                                    </td>
                                                    <td className="text-center">{gp}</td>
                                                    <td className="text-center">{standing.wins}</td>
                                                    <td className="text-center">{standing.losses}</td>
                                                    <td className="text-center">{standing.otLosses}</td>
                                                    <td className="text-center">{standing.points}</td>
                                                    <td className="text-center">{standing.goalsFor}</td>
                                                    <td className="text-center">{standing.goalsAgainst}</td>
                                                    <td className="text-center">{diff > 0 ? '+' : ''}{diff}</td>
                                                    <td className="text-center">{standing.home.wins}-{standing.home.losses}</td>
                                                    <td className="text-center">{standing.away.wins}-{standing.away.losses}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        );
                    });
                }

                if (standingsView === 'conference') {
                    return ['East', 'West'].map(conference => {
                        const confTeams = TEAMS.filter(t => t.conference === conference);
                        const confStandings = sortedStandings.filter(s => confTeams.some(t => t.id === s.teamId));
                        
                        return (
                            <div key={conference} className="card">
                                <h2>{conference}ern Conference</h2>
                                <table className="standings-table">
                                    <thead>
                                        <tr>
                                            <th className="rank">#</th>
                                            <th>Team</th>
                                            <th className="text-center">GP</th>
                                            <th className="text-center">W</th>
                                            <th className="text-center">L</th>
                                            <th className="text-center">OTL</th>
                                            <th className="text-center">PTS</th>
                                            <th className="text-center">GF</th>
                                            <th className="text-center">GA</th>
                                            <th className="text-center">DIFF</th>
                                            <th className="text-center">HOME</th>
                                            <th className="text-center">AWAY</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {confStandings.map((standing, idx) => {
                                            const team = TEAMS.find(t => t.id === standing.teamId);
                                            const isUserTeam = team.id === userTeamId;
                                            const isPlayoff = idx < 8;
                                            const gp = standing.wins + standing.losses + standing.otLosses;
                                            const diff = standing.goalsFor - standing.goalsAgainst;
                                            return (
                                                <tr key={team.id} className={`${isUserTeam ? 'highlight' : ''} ${isPlayoff ? 'playoff' : ''}`}>
                                                    <td className="rank">{idx + 1}</td>
                                                    <td className="team-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('teamProfile', team.id)}>{team.city} {team.name} ({team.division})</td>
                                                    <td className="text-center">{gp}</td>
                                                    <td className="text-center">{standing.wins}</td>
                                                    <td className="text-center">{standing.losses}</td>
                                                    <td className="text-center">{standing.otLosses}</td>
                                                    <td className="text-center">{standing.points}</td>
                                                    <td className="text-center">{standing.goalsFor}</td>
                                                    <td className="text-center">{standing.goalsAgainst}</td>
                                                    <td className="text-center">{diff > 0 ? '+' : ''}{diff}</td>
                                                    <td className="text-center">{standing.home.wins}-{standing.home.losses}</td>
                                                    <td className="text-center">{standing.away.wins}-{standing.away.losses}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        );
                    });
                }

                if (standingsView === 'wildcard') {
                    return ['East', 'West'].map(conference => {
                        const confTeams = TEAMS.filter(t => t.conference === conference);
                        const confStandings = sortedStandings.filter(s => confTeams.some(t => t.id === s.teamId));
                        
                        const divisions = conference === 'East' ? ['Atlantic', 'Metropolitan'] : ['Central', 'Pacific'];
                        const divisionLeaders = [];
                        
                        divisions.forEach(division => {
                            const divTeams = TEAMS.filter(t => t.division === division);
                            const divStandings = confStandings.filter(s => divTeams.some(t => t.id === s.teamId));
                            divisionLeaders.push(...divStandings.slice(0, 3));
                        });
                        
                        const wildcardTeams = confStandings.filter(s => !divisionLeaders.some(dl => dl.teamId === s.teamId)).slice(0, 2);
                        
                        return (
                            <div key={conference} className="card">
                                <h2>{conference}ern Conference</h2>
                                {divisions.map(division => {
                                    const divTeams = TEAMS.filter(t => t.division === division);
                                    const divStandings = confStandings.filter(s => divTeams.some(t => t.id === s.teamId)).slice(0, 3);
                                    
                                    return (
                                        <div key={division}>
                                            <h3>{division} Division</h3>
                                            <table className="standings-table">
                                                <thead>
                                                    <tr>
                                                        <th className="rank">#</th>
                                                        <th>Team</th>
                                                        <th className="text-center">GP</th>
                                                        <th className="text-center">W</th>
                                                        <th className="text-center">L</th>
                                                        <th className="text-center">OTL</th>
                                                        <th className="text-center">PTS</th>
                                                        <th className="text-center">DIFF</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {divStandings.map((standing, idx) => {
                                                        const team = TEAMS.find(t => t.id === standing.teamId);
                                                        const isUserTeam = team.id === userTeamId;
                                                        const gp = standing.wins + standing.losses + standing.otLosses;
                                                        const diff = standing.goalsFor - standing.goalsAgainst;
                                                        return (
                                                            <tr key={team.id} className={`${isUserTeam ? 'highlight' : ''} playoff`}>
                                                                <td className="rank">{idx + 1}</td>
                                                                <td className="team-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('teamProfile', team.id)}>{team.city} {team.name}</td>
                                                                <td className="text-center">{gp}</td>
                                                                <td className="text-center">{standing.wins}</td>
                                                                <td className="text-center">{standing.losses}</td>
                                                                <td className="text-center">{standing.otLosses}</td>
                                                                <td className="text-center">{standing.points}</td>
                                                                <td className="text-center">{diff > 0 ? '+' : ''}{diff}</td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    );
                                })}
                                <h3>Wild Card</h3>
                                <table className="standings-table">
                                    <thead>
                                        <tr>
                                            <th className="rank">#</th>
                                            <th>Team</th>
                                            <th className="text-center">GP</th>
                                            <th className="text-center">W</th>
                                            <th className="text-center">L</th>
                                            <th className="text-center">OTL</th>
                                            <th className="text-center">PTS</th>
                                            <th className="text-center">DIFF</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {wildcardTeams.map((standing, idx) => {
                                            const team = TEAMS.find(t => t.id === standing.teamId);
                                            const isUserTeam = team.id === userTeamId;
                                            const gp = standing.wins + standing.losses + standing.otLosses;
                                            const diff = standing.goalsFor - standing.goalsAgainst;
                                            return (
                                                <tr key={team.id} className={`${isUserTeam ? 'highlight' : ''} wildcard`}>
                                                    <td className="rank">WC{idx + 1}</td>
                                                    <td className="team-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('teamProfile', team.id)}>{team.city} {team.name} ({team.division})</td>
                                                    <td className="text-center">{gp}</td>
                                                    <td className="text-center">{standing.wins}</td>
                                                    <td className="text-center">{standing.losses}</td>
                                                    <td className="text-center">{standing.otLosses}</td>
                                                    <td className="text-center">{standing.points}</td>
                                                    <td className="text-center">{diff > 0 ? '+' : ''}{diff}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        );
                    });
                }

                if (standingsView === 'league') {
                    const sortedLeagueStandings = sortData(sortedStandings, standingsSortConfig.key, standingsSortConfig.direction);
                    
                    return (
                        <div className="card">
                            <h2>League Standings</h2>
                            <table className="standings-table">
                                <thead>
                                    <tr>
                                        <th className="rank">#</th>
                                        <th style={{ cursor: 'pointer' }} onClick={() => { 
                                            const dir = standingsSortConfig.key === 'teamName' && standingsSortConfig.direction === 'desc' ? 'asc' : 'desc';
                                            setStandingsSortConfig({ key: 'teamName', direction: dir });
                                        }}>
                                            Team {standingsSortConfig.key === 'teamName' && (standingsSortConfig.direction === 'desc' ? '' : '')}
                                        </th>
                                        <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => { 
                                            const dir = standingsSortConfig.key === 'gamesPlayed' && standingsSortConfig.direction === 'desc' ? 'asc' : 'desc';
                                            setStandingsSortConfig({ key: 'gamesPlayed', direction: dir });
                                        }}>
                                            GP {standingsSortConfig.key === 'gamesPlayed' && (standingsSortConfig.direction === 'desc' ? '' : '')}
                                        </th>
                                        <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => { 
                                            const dir = standingsSortConfig.key === 'wins' && standingsSortConfig.direction === 'desc' ? 'asc' : 'desc';
                                            setStandingsSortConfig({ key: 'wins', direction: dir });
                                        }}>
                                            W {standingsSortConfig.key === 'wins' && (standingsSortConfig.direction === 'desc' ? '' : '')}
                                        </th>
                                        <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => { 
                                            const dir = standingsSortConfig.key === 'losses' && standingsSortConfig.direction === 'desc' ? 'asc' : 'desc';
                                            setStandingsSortConfig({ key: 'losses', direction: dir });
                                        }}>
                                            L {standingsSortConfig.key === 'losses' && (standingsSortConfig.direction === 'desc' ? '' : '')}
                                        </th>
                                        <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => { 
                                            const dir = standingsSortConfig.key === 'otLosses' && standingsSortConfig.direction === 'desc' ? 'asc' : 'desc';
                                            setStandingsSortConfig({ key: 'otLosses', direction: dir });
                                        }}>
                                            OTL {standingsSortConfig.key === 'otLosses' && (standingsSortConfig.direction === 'desc' ? '' : '')}
                                        </th>
                                        <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => { 
                                            const dir = standingsSortConfig.key === 'points' && standingsSortConfig.direction === 'desc' ? 'asc' : 'desc';
                                            setStandingsSortConfig({ key: 'points', direction: dir });
                                        }}>
                                            PTS {standingsSortConfig.key === 'points' && (standingsSortConfig.direction === 'desc' ? '' : '')}
                                        </th>
                                        <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => { 
                                            const dir = standingsSortConfig.key === 'goalsFor' && standingsSortConfig.direction === 'desc' ? 'asc' : 'desc';
                                            setStandingsSortConfig({ key: 'goalsFor', direction: dir });
                                        }}>
                                            GF {standingsSortConfig.key === 'goalsFor' && (standingsSortConfig.direction === 'desc' ? '' : '')}
                                        </th>
                                        <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => { 
                                            const dir = standingsSortConfig.key === 'goalsAgainst' && standingsSortConfig.direction === 'desc' ? 'asc' : 'desc';
                                            setStandingsSortConfig({ key: 'goalsAgainst', direction: dir });
                                        }}>
                                            GA {standingsSortConfig.key === 'goalsAgainst' && (standingsSortConfig.direction === 'desc' ? '' : '')}
                                        </th>
                                        <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => { 
                                            const dir = standingsSortConfig.key === 'diff' && standingsSortConfig.direction === 'desc' ? 'asc' : 'desc';
                                            setStandingsSortConfig({ key: 'diff', direction: dir });
                                        }}>
                                            DIFF {standingsSortConfig.key === 'diff' && (standingsSortConfig.direction === 'desc' ? '' : '')}
                                        </th>
                                        <th className="text-center">HOME</th>
                                        <th className="text-center">AWAY</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {sortedLeagueStandings.map((standing, idx) => {
                                        const team = TEAMS.find(t => t.id === standing.teamId);
                                        const isUserTeam = team.id === userTeamId;
                                        const gp = standing.wins + standing.losses + standing.otLosses;
                                        const diff = standing.goalsFor - standing.goalsAgainst;
                                        
                                        // Add sortable fields to standing object
                                        const standingWithSort = { ...standing, teamName: `${team.city} ${team.name}`, gamesPlayed: gp, diff };
                                        
                                        return (
                                            <tr key={team.id} className={`${isUserTeam ? 'highlight' : ''}`}>
                                                <td className="rank">{idx + 1}</td>
                                                <td className="team-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('teamProfile', team.id)}>{team.city} {team.name} ({team.conference} - {team.division})</td>
                                                <td className="text-center">{gp}</td>
                                                <td className="text-center">{standing.wins}</td>
                                                <td className="text-center">{standing.losses}</td>
                                                <td className="text-center">{standing.otLosses}</td>
                                                <td className="text-center">{standing.points}</td>
                                                <td className="text-center">{standing.goalsFor}</td>
                                                <td className="text-center">{standing.goalsAgainst}</td>
                                                <td className="text-center">{diff > 0 ? '+' : ''}{diff}</td>
                                                <td className="text-center">{standing.home.wins}-{standing.home.losses}</td>
                                                <td className="text-center">{standing.away.wins}-{standing.away.losses}</td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    );
                }
            };

            if (!gameState) {
                // Check if save exists
                const hasSave = localStorage.getItem('hockeyGmSave') !== null;
                
                return (
                    <div className="container">
                        <h1>HOCKEY GM SIMULATOR</h1>
                        <p className="subtitle">Select Your Team to Begin</p>
                        
                        {hasSave && (
                            <div style={{ textAlign: 'center', marginBottom: '2rem' }}>
                                <button 
                                    onClick={() => {
                                        if (loadGameFromLocalStorage()) {
                                            console.log('Save loaded successfully');
                                        } else {
                                            alert('Failed to load save');
                                        }
                                    }}
                                    style={{
                                        padding: '1rem 3rem',
                                        fontSize: '1.2rem',
                                        fontWeight: 'bold',
                                        background: '#22c55e',
                                        color: '#fff',
                                        border: '2px solid #22c55e',
                                        borderRadius: '0.5rem',
                                        cursor: 'pointer',
                                        marginBottom: '1rem'
                                    }}
                                >
                                     Continue Saved Game
                                </button>
                                <p style={{ color: '#93c5fd', fontSize: '0.875rem' }}>
                                    or start a new game below
                                </p>
                            </div>
                        )}
                        
                        <div className="grid">
                            {TEAMS.map(team => (
                                <button key={team.id} onClick={() => initGame(team.id)} className="team-button">
                                    {team.city} {team.name}
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }

            const userTeam = getTeam(userTeamId);
            const userStanding = gameState.standings.find(s => s.teamId === userTeamId);
            // userRoster already declared with useMemo above
            const gamesPlayed = userStanding.wins + userStanding.losses + userStanding.otLosses;
            
            // Calculate league-wide games played
            const teamGameCounts = {};
            TEAMS.forEach(t => teamGameCounts[t.id] = 0);
            gameState.schedule.filter(g => g.played).forEach(g => {
                teamGameCounts[g.homeTeam]++;
                teamGameCounts[g.awayTeam]++;
            });
            const allGameCounts = Object.values(teamGameCounts);
            const minGamesPlayed = Math.min(...allGameCounts);
            const maxGamesPlayed = Math.max(...allGameCounts);
            const avgGamesPlayed = Math.round(allGameCounts.reduce((a, b) => a + b, 0) / allGameCounts.length);
            const seasonComplete = minGamesPlayed >= 82;

            return (
                <div>
                    <div className="header">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                            <div>
                                <h1>HOCKEY GM SIMULATOR</h1>
                                <p className="header-info">Managing: {userTeam.city} {userTeam.name} | Season {gameState.season} (Oct-Apr) | {gameState.currentDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</p>
                                <p className="header-info">
                                    Record: {userStanding.wins}-{userStanding.losses}-{userStanding.otLosses} ({userStanding.points} pts) | 
                                    Games: {gamesPlayed}/82 | 
                                    Home: {userStanding.home.wins}-{userStanding.home.losses} | 
                                    Away: {userStanding.away.wins}-{userStanding.away.losses} | 
                                    Goal Diff: {userStanding.goalsFor - userStanding.goalsAgainst > 0 ? '+' : ''}{userStanding.goalsFor - userStanding.goalsAgainst}
                                </p>
                                <p className="header-info" style={{ color: minGamesPlayed === maxGamesPlayed && maxGamesPlayed === 82 ? '#22c55e' : '#93c5fd' }}>
                                    League Progress: {minGamesPlayed === maxGamesPlayed ? `All teams: ${minGamesPlayed}/82` : `${minGamesPlayed}-${maxGamesPlayed}/82 (avg: ${avgGamesPlayed})`}
                                    {minGamesPlayed === maxGamesPlayed && maxGamesPlayed === 82 && '  COMPLETE'}
                                </p>
                            </div>
                            <div style={{ display: 'flex', gap: '0.5rem', flexDirection: 'column', alignItems: 'flex-end' }}>
                                <button 
                                    onClick={() => setCurrentView('roadmap')}
                                    className="action-button"
                                    style={{ 
                                        background: currentView === 'roadmap' ? '#22d3ee' : '#1e40af',
                                        padding: '0.5rem 1rem',
                                        fontSize: '0.875rem',
                                        whiteSpace: 'nowrap'
                                    }}
                                >
                                     Future Roadmap
                                </button>
                                <div style={{ display: 'flex', gap: '0.5rem' }}>
                                    <button 
                                        onClick={() => {
                                            if (gameState && userTeamId) {
                                                saveGameToLocalStorage(gameState, userTeamId, playoffState, seasonMode);
                                                alert(' Game saved!');
                                            }
                                        }}
                                        className="action-button"
                                        style={{ 
                                            background: '#22c55e',
                                            padding: '0.4rem 0.8rem',
                                            fontSize: '0.75rem'
                                        }}
                                        disabled={!gameState}
                                    >
                                         Save
                                    </button>
                                    <button 
                                        onClick={() => {
                                            if (loadGameFromLocalStorage()) {
                                                alert(' Game loaded!');
                                            } else {
                                                alert(' No save found');
                                            }
                                        }}
                                        className="action-button"
                                        style={{ 
                                            background: '#3b82f6',
                                            padding: '0.4rem 0.8rem',
                                            fontSize: '0.75rem'
                                        }}
                                    >
                                         Load
                                    </button>
                                    <button 
                                        onClick={deleteSave}
                                        className="action-button"
                                        style={{ 
                                            background: '#ef4444',
                                            padding: '0.4rem 0.8rem',
                                            fontSize: '0.75rem'
                                        }}
                                    >
                                         Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Season Mode Toggle - Regular Season vs Playoffs */}
                    <div style={{ 
                        background: 'rgba(30, 58, 138, 0.3)', 
                        padding: '0.75rem 2rem',
                        display: 'flex',
                        gap: '1rem',
                        justifyContent: 'center',
                        borderBottom: '2px solid rgba(59, 130, 246, 0.3)'
                    }}>
                        <button
                            onClick={() => setSeasonMode('regular')}
                            style={{
                                padding: '0.5rem 2rem',
                                background: seasonMode === 'regular' ? '#3b82f6' : 'transparent',
                                border: seasonMode === 'regular' ? '2px solid #3b82f6' : '1px solid rgba(100, 116, 139, 0.5)',
                                borderRadius: '0.5rem',
                                color: '#fff',
                                cursor: 'pointer',
                                fontWeight: 'bold',
                                fontSize: '1rem',
                                transition: 'all 0.2s'
                            }}
                        >
                             Regular Season
                        </button>
                        <button
                            onClick={() => setSeasonMode('playoffs')}
                            style={{
                                padding: '0.5rem 2rem',
                                background: seasonMode === 'playoffs' ? '#f59e0b' : 'transparent',
                                border: seasonMode === 'playoffs' ? '2px solid #f59e0b' : '1px solid rgba(100, 116, 139, 0.5)',
                                borderRadius: '0.5rem',
                                color: '#fff',
                                cursor: 'pointer',
                                fontWeight: 'bold',
                                fontSize: '1rem',
                                transition: 'all 0.2s',
                                opacity: playoffState ? 1 : 0.5
                            }}
                            disabled={!playoffState}
                        >
                             Playoffs
                        </button>
                    </div>

                    <div className="nav">
                        <div className="nav-content">
                            {/* Dashboard */}
                            <button
                                onClick={() => setCurrentView('standings')}
                                className={`nav-button ${currentView === 'standings' ? 'active' : ''}`}
                            >
                                 Dashboard
                            </button>

                            {/* Roster Management Dropdown */}
                            <div className="nav-group">
                                <button className={`nav-button has-dropdown ${['roster', 'lines', 'trade', 'injuries', 'freeagents'].includes(currentView) ? 'active' : ''}`}>
                                     Roster Management
                                </button>
                                <div className="nav-dropdown">
                                    <button
                                        onClick={() => setCurrentView('roster')}
                                        className={`nav-dropdown-item ${currentView === 'roster' ? 'active' : ''}`}
                                    >
                                        Roster
                                    </button>
                                    <button
                                        onClick={() => setCurrentView('lines')}
                                        className={`nav-dropdown-item ${currentView === 'lines' ? 'active' : ''}`}
                                    >
                                         Lines & Scratches
                                    </button>
                                    <button
                                        onClick={() => setCurrentView('callups')}
                                        className={`nav-dropdown-item ${currentView === 'callups' ? 'active' : ''}`}
                                    >
                                         Call-Ups / Send-Downs
                                    </button>
                                    <button
                                        onClick={() => setCurrentView('trade')}
                                        className={`nav-dropdown-item ${currentView === 'trade' ? 'active' : ''}`}
                                    >
                                        Trades
                                    </button>
                                    <button
                                        onClick={() => setCurrentView('injuries')}
                                        className={`nav-dropdown-item ${currentView === 'injuries' ? 'active' : ''}`}
                                    >
                                        Injuries
                                    </button>
                                    <button
                                        className="nav-dropdown-item disabled"
                                    >
                                        Free Agents
                                    </button>
                                </div>
                            </div>

                            {/* Stats Dropdown */}
                            <div className="nav-group">
                                <button className={`nav-button has-dropdown ${['stats', 'leaders', 'playerProfile', 'teamProfile'].includes(currentView) ? 'active' : ''}`}>
                                     Stats
                                </button>
                                <div className="nav-dropdown">
                                    <button
                                        onClick={() => setCurrentView('stats')}
                                        className={`nav-dropdown-item ${currentView === 'stats' ? 'active' : ''}`}
                                    >
                                        Player Stats
                                    </button>
                                    <button
                                        onClick={() => setCurrentView('teamProfile')}
                                        className={`nav-dropdown-item ${currentView === 'teamProfile' ? 'active' : ''}`}
                                    >
                                        Team Roster
                                    </button>
                                    <button
                                        onClick={() => setCurrentView('teamStats')}
                                        className={`nav-dropdown-item ${currentView === 'teamStats' ? 'active' : ''}`}
                                    >
                                        Team Stats
                                    </button>
                                    <button
                                        onClick={() => setCurrentView('leaders')}
                                        className={`nav-dropdown-item ${currentView === 'leaders' ? 'active' : ''}`}
                                    >
                                        League Leaders
                                    </button>
                                </div>
                            </div>

                            {/* Season Dropdown */}
                            <div className="nav-group">
                                <button className={`nav-button has-dropdown ${['calendar', 'awards'].includes(currentView) ? 'active' : ''}`}>
                                     Season
                                </button>
                                <div className="nav-dropdown">
                                    <button
                                        onClick={() => setCurrentView('standings')}
                                        className={`nav-dropdown-item ${currentView === 'standings' ? 'active' : ''}`}
                                    >
                                        Standings
                                    </button>
                                    <button
                                        onClick={() => setCurrentView('calendar')}
                                        className={`nav-dropdown-item ${currentView === 'calendar' ? 'active' : ''}`}
                                    >
                                        Calendar
                                    </button>
                                    {seasonAwards && (
                                        <button
                                            onClick={() => setCurrentView('awards')}
                                            className={`nav-dropdown-item ${currentView === 'awards' ? 'active' : ''}`}
                                        >
                                             Awards
                                        </button>
                                    )}
                                </div>
                            </div>

                            {/* League Dropdown */}
                            <div className="nav-group">
                                <button className={`nav-button has-dropdown ${['transactions'].includes(currentView) ? 'active' : ''}`}>
                                     League
                                </button>
                                <div className="nav-dropdown">
                                    <button
                                        onClick={() => setCurrentView('transactions')}
                                        className={`nav-dropdown-item ${currentView === 'transactions' ? 'active' : ''}`}
                                    >
                                         Transactions
                                    </button>
                                </div>
                            </div>

                            {/* Playoffs Dropdown */}
                            {(seasonComplete || playoffState) && (
                                <div className="nav-group">
                                    <button className={`nav-button has-dropdown ${['bracket', 'playoffGames'].includes(currentView) ? 'active' : ''}`}>
                                         Playoffs
                                    </button>
                                    <div className="nav-dropdown">
                                        <button
                                            onClick={() => setCurrentView('bracket')}
                                            className={`nav-dropdown-item ${currentView === 'bracket' ? 'active' : ''}`}
                                        >
                                            Bracket
                                        </button>
                                        <button
                                            onClick={() => setCurrentView('playoffGames')}
                                            className={`nav-dropdown-item ${currentView === 'playoffGames' ? 'active' : ''}`}
                                        >
                                            Games
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* Settings Dropdown */}
                            <div className="nav-group">
                                <button className={`nav-button has-dropdown ${['roadmap'].includes(currentView) ? 'active' : ''}`}>
                                     Settings
                                </button>
                                <div className="nav-dropdown">
                                    <button
                                        onClick={() => setCurrentView('roadmap')}
                                        className={`nav-dropdown-item ${currentView === 'roadmap' ? 'active' : ''}`}
                                    >
                                        Roadmap
                                    </button>
                                    <button
                                        onClick={() => setCurrentView('help')}
                                        className={`nav-dropdown-item ${currentView === 'help' ? 'active' : ''}`}
                                    >
                                         Help & Manual
                                    </button>
                                    <button
                                        onClick={saveGameToLocalStorage}
                                        className="nav-dropdown-item"
                                    >
                                         Save Game
                                    </button>
                                    <button
                                        onClick={deleteSave}
                                        className="nav-dropdown-item"
                                        style={{ color: '#ef4444' }}
                                    >
                                         Delete Save
                                    </button>
                                </div>
                            </div>

                            {/* Action Buttons */}
                            <div style={{ marginLeft: 'auto', display: 'flex', gap: '0.5rem' }}>
                                <button 
                                    onClick={simulateDay} 
                                    className="action-button"
                                    disabled={seasonComplete}
                                    style={{ opacity: seasonComplete ? 0.5 : 1, cursor: seasonComplete ? 'not-allowed' : 'pointer' }}
                                >
                                    Sim Day
                                </button>
                                <button 
                                    onClick={simulateSeason} 
                                    className="action-button secondary"
                                    disabled={seasonComplete}
                                    style={{ opacity: seasonComplete ? 0.5 : 1, cursor: seasonComplete ? 'not-allowed' : 'pointer', background: '#22c55e' }}
                                >
                                     Sim Season
                                </button>
                                {seasonComplete && !playoffState && (
                                    <button 
                                        onClick={startPlayoffs} 
                                        className="action-button"
                                        style={{ background: '#f59e0b', fontWeight: 'bold' }}
                                    >
                                         Start Playoffs
                                    </button>
                                )}
                                {playoffState && !playoffState.completed && (
                                    <>
                                        <button 
                                            onClick={simulateOnePlayoffDay} 
                                            className="action-button"
                                            style={{ background: '#8b5cf6', fontWeight: 'bold' }}
                                        >
                                             Sim Playoff Day
                                        </button>
                                        <button 
                                            onClick={simulatePlayoffSeries} 
                                            className="action-button"
                                            style={{ background: '#f59e0b', fontWeight: 'bold' }}
                                        >
                                             Sim Playoff Round
                                        </button>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="content">
                        {currentView === 'standings' && gameState && (
                            <div>
                                <div className="standings-nav">
                                    {['division', 'conference', 'wildcard', 'league'].map(view => (
                                        <button
                                            key={view}
                                            onClick={() => setStandingsView(view)}
                                            className={standingsView === view ? 'active' : ''}
                                        >
                                            {view === 'wildcard' ? 'Wild Card' : view.charAt(0).toUpperCase() + view.slice(1)}
                                        </button>
                                    ))}
                                </div>
                                {renderStandings()}
                            </div>
                        )}

                        {currentView === 'roster' && gameState && (() => {
                            const teamOverallData = getTeamOverall(userTeamId);
                            const ovr = teamOverallData?.overall || 0;
                            const rank = teamOverallData?.rank || 32;
                            
                            // Color based on league rank
                            let ovrColor = '#fff';
                            if (rank <= 5) ovrColor = '#4ade80';      // Top 5: Green
                            else if (rank <= 10) ovrColor = '#60a5fa'; // Top 10: Blue
                            else if (rank <= 20) ovrColor = '#fbbf24'; // Middle: Yellow
                            else ovrColor = '#f87171';                 // Bottom: Red
                            
                            return (
                            <div className="card">
                                {/* Team Overall Header */}
                                <div style={{ 
                                    display: 'flex', 
                                    justifyContent: 'space-between', 
                                    alignItems: 'center',
                                    marginBottom: '2rem',
                                    padding: '1.5rem',
                                    background: 'rgba(30, 58, 138, 0.3)',
                                    borderRadius: '0.5rem',
                                    border: '2px solid rgba(59, 130, 246, 0.3)'
                                }}>
                                    <h2 style={{ margin: 0 }}>Your Roster ({userRoster.length} players)</h2>
                                    <div style={{ textAlign: 'right' }}>
                                        <div style={{ 
                                            fontSize: '2.5rem', 
                                            fontWeight: 'bold',
                                            color: ovrColor,
                                            lineHeight: 1
                                        }}>
                                            {ovr} OVR
                                        </div>
                                        <div style={{ 
                                            fontSize: '1rem',
                                            color: '#93c5fd',
                                            marginTop: '0.25rem'
                                        }}>
                                            Rank: {rank} / 32
                                        </div>
                                    </div>
                                </div>
                                
                                {['F', 'D', 'G'].map(pos => (
                                    <div key={pos}>
                                        <h3>
                                            {pos === 'F' ? 'Forwards (13)' : pos === 'D' ? 'Defensemen (7)' : 'Goalies (3)'}
                                        </h3>
                                        {userRoster.filter(p => p.position === pos).map(player => (
                                            <div 
                                                key={player.id} 
                                                className="list-item"
                                                onClick={() => navigateTo('playerProfile', player)}
                                                style={{ cursor: 'pointer' }}
                                            >
                                                <div>
                                                    <span className="player-name clickable-player">{player.firstName} {player.lastName}</span>
                                                    <span className="player-pos">{player.position}</span>
                                                    {player.preferredPosition && player.position !== 'G' && (
                                                        <span style={{ 
                                                            padding: '0.25rem 0.5rem',
                                                            marginLeft: '0.5rem',
                                                            borderRadius: '0.25rem',
                                                            fontSize: '0.7rem',
                                                            fontWeight: 'bold',
                                                            background: 'rgba(59, 130, 246, 0.2)',
                                                            color: '#3b82f6',
                                                            border: '1px solid rgba(59, 130, 246, 0.3)'
                                                        }}>
                                                            Pref: {player.preferredPosition}
                                                        </span>
                                                    )}
                                                    {player.ratings.overall >= 85 && <span className="badge badge-green">Elite</span>}
                                                    {player.ratings.overall >= 75 && player.ratings.overall < 85 && <span className="badge badge-yellow">Good</span>}
                                                    {player.injury.injured && (
                                                        <span style={{ 
                                                            padding: '0.25rem 0.5rem', 
                                                            borderRadius: '0.25rem', 
                                                            fontSize: '0.75rem', 
                                                            fontWeight: 'bold',
                                                            marginLeft: '0.5rem',
                                                            background: player.injury.isCareerEnding ? '#ef4444' : 
                                                                       player.injury.severity === 'Season-Ending' ? '#f59e0b' : 
                                                                       player.injury.severity === 'Month-to-Month' ? '#f97316' : '#fbbf24',
                                                            color: '#fff'
                                                        }}>
                                                            {getPlayerStatus(player)}
                                                        </span>
                                                    )}
                                                </div>
                                                <span style={{ color: '#22d3ee', fontSize: '0.875rem' }}>
                                                    Age: {player.age} | OVR: {player.ratings.overall} | POT: {player.ratings.potential}
                                                    {player.injury.injured && !player.injury.isCareerEnding && (
                                                        <span style={{ color: '#f59e0b', marginLeft: '0.5rem' }}>
                                                            | {player.injury.type} ({player.injury.daysUntilReturn}d)
                                                        </span>
                                                    )}
                                                </span>
                                            </div>
                                        ))}
                                    </div>
                                ))}
                            </div>
                            );
                        })()}

                        {/* LINES & SCRATCHES VIEW */}
                        {currentView === 'lines' && gameState && (
                            <div>
                                {/* Header Card */}
                                <div className="card" style={{ background: 'rgba(34, 197, 94, 0.1)', border: '2px solid #22c55e' }}>
                                    <h2 style={{ color: '#22c55e' }}> Advanced Line Management</h2>
                                    <p style={{ color: '#93c5fd', marginBottom: '0.5rem' }}>
                                        Set forward lines (C, LW, RW), defense pairs (LD, RD), and special teams (PP/PK)
                                    </p>
                                    
                                    {/* LIVE OVERALL DISPLAY */}
                                    {(() => {
                                        const teamOverallData = getTeamOverall(userTeamId);
                                        const currentOverall = teamOverallData?.overall || 0;
                                        const currentRank = teamOverallData?.rank || 32;
                                        
                                        // Calculate individual line overalls
                                        const calculateLineOverall = (players) => {
                                            if (players.length === 0) return 0;
                                            const sum = players.reduce((acc, p) => acc + p.ratings.overall, 0);
                                            return Math.round(sum / players.length);
                                        };
                                        
                                        const forwards = userRoster.filter(p => p.position === 'F' && p.lineNumber > 0);
                                        const defense = userRoster.filter(p => p.position === 'D' && p.lineNumber > 0);
                                        const goalies = userRoster.filter(p => p.position === 'G' && p.dressed);
                                        
                                        const line1 = forwards.filter(p => p.lineNumber === 1);
                                        const line2 = forwards.filter(p => p.lineNumber === 2);
                                        const line3 = forwards.filter(p => p.lineNumber === 3);
                                        const line4 = forwards.filter(p => p.lineNumber === 4);
                                        
                                        const pair1 = defense.filter(p => p.lineNumber === 1);
                                        const pair2 = defense.filter(p => p.lineNumber === 2);
                                        const pair3 = defense.filter(p => p.lineNumber === 3);
                                        
                                        const pp1 = userRoster.filter(p => p.ppUnit === 1 && p.lineNumber > 0);
                                        const pp2 = userRoster.filter(p => p.ppUnit === 2 && p.lineNumber > 0);
                                        const pk1 = userRoster.filter(p => p.pkUnit === 1 && p.lineNumber > 0);
                                        const pk2 = userRoster.filter(p => p.pkUnit === 2 && p.lineNumber > 0);
                                        
                                        return (
                                            <div style={{
                                                padding: '1.5rem',
                                                background: 'rgba(59, 130, 246, 0.15)',
                                                borderRadius: '0.5rem',
                                                border: '2px solid rgba(59, 130, 246, 0.4)',
                                                marginBottom: '1rem'
                                            }}>
                                                {/* Team Overall */}
                                                <div style={{ 
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center',
                                                    marginBottom: '1.5rem',
                                                    paddingBottom: '1rem',
                                                    borderBottom: '2px solid rgba(59, 130, 246, 0.3)'
                                                }}>
                                                    <div>
                                                        <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.25rem' }}>
                                                            TEAM OVERALL
                                                        </div>
                                                        <div style={{ 
                                                            fontSize: '3rem', 
                                                            fontWeight: 'bold', 
                                                            color: currentRank <= 5 ? '#4ade80' : currentRank <= 10 ? '#60a5fa' : currentRank <= 20 ? '#fbbf24' : '#f87171',
                                                            lineHeight: 1
                                                        }}>
                                                            {currentOverall}
                                                        </div>
                                                    </div>
                                                    <div style={{ textAlign: 'right' }}>
                                                        <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.25rem' }}>
                                                            LEAGUE RANK
                                                        </div>
                                                        <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#fff' }}>
                                                            {currentRank} / 32
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {/* Line Overalls Grid */}
                                                <div style={{ 
                                                    display: 'grid',
                                                    gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))',
                                                    gap: '0.75rem'
                                                }}>
                                                    {/* Forward Lines */}
                                                    <div style={{ 
                                                        padding: '0.75rem',
                                                        background: 'rgba(0, 0, 0, 0.2)',
                                                        borderRadius: '0.375rem'
                                                    }}>
                                                        <div style={{ fontSize: '0.75rem', color: '#93c5fd', marginBottom: '0.25rem' }}>Line 1</div>
                                                        <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#fff' }}>
                                                            {calculateLineOverall(line1) || '--'}
                                                        </div>
                                                    </div>
                                                    <div style={{ 
                                                        padding: '0.75rem',
                                                        background: 'rgba(0, 0, 0, 0.2)',
                                                        borderRadius: '0.375rem'
                                                    }}>
                                                        <div style={{ fontSize: '0.75rem', color: '#93c5fd', marginBottom: '0.25rem' }}>Line 2</div>
                                                        <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#fff' }}>
                                                            {calculateLineOverall(line2) || '--'}
                                                        </div>
                                                    </div>
                                                    <div style={{ 
                                                        padding: '0.75rem',
                                                        background: 'rgba(0, 0, 0, 0.2)',
                                                        borderRadius: '0.375rem'
                                                    }}>
                                                        <div style={{ fontSize: '0.75rem', color: '#93c5fd', marginBottom: '0.25rem' }}>Line 3</div>
                                                        <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#fff' }}>
                                                            {calculateLineOverall(line3) || '--'}
                                                        </div>
                                                    </div>
                                                    <div style={{ 
                                                        padding: '0.75rem',
                                                        background: 'rgba(0, 0, 0, 0.2)',
                                                        borderRadius: '0.375rem'
                                                    }}>
                                                        <div style={{ fontSize: '0.75rem', color: '#93c5fd', marginBottom: '0.25rem' }}>Line 4</div>
                                                        <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#fff' }}>
                                                            {calculateLineOverall(line4) || '--'}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Defense Pairs */}
                                                    <div style={{ 
                                                        padding: '0.75rem',
                                                        background: 'rgba(0, 0, 0, 0.2)',
                                                        borderRadius: '0.375rem'
                                                    }}>
                                                        <div style={{ fontSize: '0.75rem', color: '#93c5fd', marginBottom: '0.25rem' }}>D Pair 1</div>
                                                        <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#fff' }}>
                                                            {calculateLineOverall(pair1) || '--'}
                                                        </div>
                                                    </div>
                                                    <div style={{ 
                                                        padding: '0.75rem',
                                                        background: 'rgba(0, 0, 0, 0.2)',
                                                        borderRadius: '0.375rem'
                                                    }}>
                                                        <div style={{ fontSize: '0.75rem', color: '#93c5fd', marginBottom: '0.25rem' }}>D Pair 2</div>
                                                        <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#fff' }}>
                                                            {calculateLineOverall(pair2) || '--'}
                                                        </div>
                                                    </div>
                                                    <div style={{ 
                                                        padding: '0.75rem',
                                                        background: 'rgba(0, 0, 0, 0.2)',
                                                        borderRadius: '0.375rem'
                                                    }}>
                                                        <div style={{ fontSize: '0.75rem', color: '#93c5fd', marginBottom: '0.25rem' }}>D Pair 3</div>
                                                        <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#fff' }}>
                                                            {calculateLineOverall(pair3) || '--'}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Goalies */}
                                                    <div style={{ 
                                                        padding: '0.75rem',
                                                        background: 'rgba(0, 0, 0, 0.2)',
                                                        borderRadius: '0.375rem'
                                                    }}>
                                                        <div style={{ fontSize: '0.75rem', color: '#93c5fd', marginBottom: '0.25rem' }}>Goalies</div>
                                                        <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#fff' }}>
                                                            {calculateLineOverall(goalies) || '--'}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Special Teams */}
                                                    <div style={{ 
                                                        padding: '0.75rem',
                                                        background: 'rgba(251, 191, 36, 0.15)',
                                                        borderRadius: '0.375rem',
                                                        border: '1px solid rgba(251, 191, 36, 0.3)'
                                                    }}>
                                                        <div style={{ fontSize: '0.75rem', color: '#fbbf24', marginBottom: '0.25rem' }}>PP1</div>
                                                        <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#fff' }}>
                                                            {calculateLineOverall(pp1) || '--'}
                                                        </div>
                                                    </div>
                                                    <div style={{ 
                                                        padding: '0.75rem',
                                                        background: 'rgba(251, 191, 36, 0.15)',
                                                        borderRadius: '0.375rem',
                                                        border: '1px solid rgba(251, 191, 36, 0.3)'
                                                    }}>
                                                        <div style={{ fontSize: '0.75rem', color: '#fbbf24', marginBottom: '0.25rem' }}>PP2</div>
                                                        <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#fff' }}>
                                                            {calculateLineOverall(pp2) || '--'}
                                                        </div>
                                                    </div>
                                                    <div style={{ 
                                                        padding: '0.75rem',
                                                        background: 'rgba(239, 68, 68, 0.15)',
                                                        borderRadius: '0.375rem',
                                                        border: '1px solid rgba(239, 68, 68, 0.3)'
                                                    }}>
                                                        <div style={{ fontSize: '0.75rem', color: '#ef4444', marginBottom: '0.25rem' }}>PK1</div>
                                                        <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#fff' }}>
                                                            {calculateLineOverall(pk1) || '--'}
                                                        </div>
                                                    </div>
                                                    <div style={{ 
                                                        padding: '0.75rem',
                                                        background: 'rgba(239, 68, 68, 0.15)',
                                                        borderRadius: '0.375rem',
                                                        border: '1px solid rgba(239, 68, 68, 0.3)'
                                                    }}>
                                                        <div style={{ fontSize: '0.75rem', color: '#ef4444', marginBottom: '0.25rem' }}>PK2</div>
                                                        <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#fff' }}>
                                                            {calculateLineOverall(pk2) || '--'}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div style={{ 
                                                    marginTop: '1rem',
                                                    padding: '0.75rem',
                                                    background: 'rgba(147, 197, 253, 0.1)',
                                                    borderRadius: '0.375rem',
                                                    fontSize: '0.875rem',
                                                    color: '#93c5fd'
                                                }}>
                                                     <strong>Formula:</strong> Team OVR uses weighted average (Top lines/pairs count more). Line OVR is simple average of players.
                                                </div>
                                            </div>
                                        );
                                    })()}
                                    
                                    {/* Roster Summary */}
                                    <div style={{ 
                                        display: 'flex', 
                                        gap: '2rem',
                                        padding: '0.75rem',
                                        background: 'rgba(0, 0, 0, 0.2)',
                                        borderRadius: '0.5rem',
                                        marginBottom: '0.5rem'
                                    }}>
                                        <div>
                                            <div style={{ color: '#22c55e', fontSize: '0.75rem', marginBottom: '0.25rem' }}>ACTIVE (20)</div>
                                            <div style={{ color: '#fff', fontSize: '0.9rem' }}>
                                                {userRoster.filter(p => p.position === 'F' && p.lineNumber > 0).length} F + 
                                                {' '}{userRoster.filter(p => p.position === 'D' && p.lineNumber > 0).length} D + 
                                                {' '}{userRoster.filter(p => p.position === 'G' && p.dressed).length} G
                                            </div>
                                        </div>
                                        <div>
                                            <div style={{ color: '#ef4444', fontSize: '0.75rem', marginBottom: '0.25rem' }}>SCRATCHED (3)</div>
                                            <div style={{ color: '#fff', fontSize: '0.9rem' }}>
                                                {userRoster.filter(p => p.position === 'F' && p.lineNumber === 0).length} F + 
                                                {' '}{userRoster.filter(p => p.position === 'D' && p.lineNumber === 0).length} D + 
                                                {' '}{userRoster.filter(p => p.position === 'G' && !p.dressed).length} G
                                            </div>
                                        </div>
                                        <div style={{ marginLeft: 'auto' }}>
                                            <div style={{ color: '#93c5fd', fontSize: '0.75rem', marginBottom: '0.25rem' }}>TOTAL ROSTER</div>
                                            <div style={{ color: '#fff', fontSize: '0.9rem', fontWeight: 'bold' }}>
                                                23 Players
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <p style={{ color: '#fbbf24', fontSize: '0.85rem' }}>
                                         Out-of-position penalty: Forwards -3 OVR | Defense -5 OVR
                                    </p>
                                    
                                    {/* Save/Load Controls */}
                                    <div style={{ 
                                        display: 'flex', 
                                        gap: '1rem', 
                                        marginTop: '1rem',
                                        flexWrap: 'wrap',
                                        alignItems: 'center'
                                    }}>
                                        <button
                                            onClick={() => {
                                                if (confirm('Auto-set best lineup? This will replace your current lineup based on player OVR and position preference.')) {
                                                    const newPlayers = [...gameState.players];
                                                    // Only auto-set for user's team players
                                                    const userTeamPlayers = newPlayers.filter(p => p.teamId === userTeamId);
                                                    autoSetLineup(userTeamPlayers);
                                                    setGameState({ ...gameState, players: newPlayers });
                                                }
                                            }}
                                            style={{
                                                padding: '0.5rem 1rem',
                                                background: '#8b5cf6',
                                                color: '#fff',
                                                border: 'none',
                                                borderRadius: '0.375rem',
                                                cursor: 'pointer',
                                                fontWeight: 'bold'
                                            }}
                                        >
                                             Auto-Set Best Lineup
                                        </button>
                                        
                                        <button
                                            onClick={() => {
                                                const name = prompt('Enter a name for this lineup:');
                                                if (name) saveCurrentLineup(name);
                                            }}
                                            style={{
                                                padding: '0.5rem 1rem',
                                                background: '#22c55e',
                                                color: '#fff',
                                                border: 'none',
                                                borderRadius: '0.375rem',
                                                cursor: 'pointer',
                                                fontWeight: 'bold'
                                            }}
                                        >
                                             Save Lineup
                                        </button>
                                        
                                        {savedLineups.length > 0 && (
                                            <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                                                <span style={{ color: '#93c5fd' }}>Saved:</span>
                                                {savedLineups.map(lineup => (
                                                    <div key={lineup.id} style={{
                                                        display: 'flex',
                                                        gap: '0.25rem',
                                                        padding: '0.25rem 0.5rem',
                                                        background: 'rgba(59, 130, 246, 0.2)',
                                                        borderRadius: '0.25rem',
                                                        border: '1px solid rgba(59, 130, 246, 0.3)',
                                                        fontSize: '0.85rem'
                                                    }}>
                                                        <span style={{ color: '#fff' }}>{lineup.name}</span>
                                                        <button onClick={() => loadLineup(lineup)} style={{padding: '0 0.25rem', background: '#3b82f6', color: '#fff', border: 'none', borderRadius: '0.2rem', cursor: 'pointer', fontSize: '0.75rem'}}>Load</button>
                                                        <button onClick={() => deleteLineup(lineup.id)} style={{padding: '0 0.25rem', background: '#ef4444', color: '#fff', border: 'none', borderRadius: '0.2rem', cursor: 'pointer', fontSize: '0.75rem'}}></button>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* FORWARD LINES */}
                                <div className="card">
                                    <h2 style={{ color: '#22d3ee' }}> Forward Lines (12 Active / 13 Total)</h2>
                                    {[1, 2, 3, 4].map(line => {
                                        const positions = ['C', 'LW', 'RW'];
                                        return (
                                            <div key={line} style={{ marginBottom: '1.5rem' }}>
                                                <h3 style={{ color: '#93c5fd', fontSize: '1rem', marginBottom: '0.75rem' }}>
                                                    Line {line}
                                                </h3>
                                                <div style={{ display: 'flex', gap: '0.75rem', flexWrap: 'wrap' }}>
                                                    {positions.map(pos => {
                                                        const player = userRoster.find(p => p.position === 'F' && p.lineNumber === line && p.linePosition === pos && !p.injury.injured);
                                                        const availablePlayers = userRoster.filter(p => p.position === 'F' && !p.injury.injured);
                                                        
                                                        return (
                                                            <div key={pos} style={{ flex: '1', minWidth: '200px' }}>
                                                                <div style={{ 
                                                                    padding: '0.75rem',
                                                                    background: player ? 'rgba(59, 130, 246, 0.1)' : 'rgba(100, 116, 139, 0.1)',
                                                                    borderRadius: '0.375rem',
                                                                    border: player ? '1px solid rgba(59, 130, 246, 0.3)' : '1px dashed rgba(100, 116, 139, 0.3)'
                                                                }}>
                                                                    <div style={{ color: '#93c5fd', fontSize: '0.75rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                                                        {pos}
                                                                    </div>
                                                                    {player ? (
                                                                        <div>
                                                                            <div style={{ color: '#fff', fontWeight: 'bold', fontSize: '0.95rem', marginBottom: '0.25rem' }}>
                                                                                {player.firstName.charAt(0)}. {player.lastName}
                                                                                {player.preferredPosition === pos && <span style={{color: '#22c55e', marginLeft: '0.25rem', fontSize: '0.75rem'}} title="In preferred position"></span>}
                                                                                {player.preferredPosition !== pos && <span style={{color: '#f59e0b', marginLeft: '0.25rem', fontSize: '0.75rem'}} title="Out of position (-3 OVR)"></span>}
                                                                            </div>
                                                                            <div style={{ fontSize: '0.75rem', color: '#64748b', marginBottom: '0.5rem' }}>
                                                                                OVR: {getEffectiveOverall(player)} 
                                                                                {player.preferredPosition !== pos && ` (was ${player.ratings.overall})`}
                                                                                {' '}| Pref: {player.preferredPosition}
                                                                            </div>
                                                                            <select
                                                                                value={player.id}
                                                                                onChange={(e) => {
                                                                                    if (e.target.value === 'empty') {
                                                                                        assignPlayerToLine(player.id, 0, null);
                                                                                    } else if (e.target.value !== player.id) {
                                                                                        const newPlayer = availablePlayers.find(p => p.id === e.target.value);
                                                                                        if (newPlayer) {
                                                                                            assignPlayerToLine(player.id, newPlayer.lineNumber, newPlayer.linePosition);
                                                                                            assignPlayerToLine(newPlayer.id, line, pos);
                                                                                        }
                                                                                    }
                                                                                }}
                                                                                style={{
                                                                                    width: '100%',
                                                                                    padding: '0.25rem',
                                                                                    background: '#1e3a8a',
                                                                                    border: '1px solid #3b82f6',
                                                                                    borderRadius: '0.25rem',
                                                                                    color: '#fff',
                                                                                    fontSize: '0.75rem'
                                                                                }}
                                                                            >
                                                                                <option value={player.id}>{player.lastName}</option>
                                                                                <option value="empty">-- Empty Slot --</option>
                                                                                <optgroup label="Swap With:">
                                                                                    {availablePlayers
                                                                                        .filter(p => p.id !== player.id)
                                                                                        .sort((a, b) => b.ratings.overall - a.ratings.overall)
                                                                                        .map(p => (
                                                                                            <option key={p.id} value={p.id}>
                                                                                                {p.lastName} (OVR {p.ratings.overall}, {p.preferredPosition})
                                                                                            </option>
                                                                                        ))}
                                                                                </optgroup>
                                                                            </select>
                                                                        </div>
                                                                    ) : (
                                                                        <div>
                                                                            <div style={{ color: '#64748b', fontSize: '0.85rem', marginBottom: '0.5rem' }}>
                                                                                Empty
                                                                            </div>
                                                                            <select
                                                                                onChange={(e) => {
                                                                                    if (e.target.value) {
                                                                                        assignPlayerToLine(e.target.value, line, pos);
                                                                                    }
                                                                                }}
                                                                                value=""
                                                                                style={{
                                                                                    width: '100%',
                                                                                    padding: '0.25rem',
                                                                                    background: '#1e3a8a',
                                                                                    border: '1px solid #3b82f6',
                                                                                    borderRadius: '0.25rem',
                                                                                    color: '#fff',
                                                                                    fontSize: '0.75rem'
                                                                                }}
                                                                            >
                                                                                <option value="">-- Select Player --</option>
                                                                                {availablePlayers
                                                                                    .filter(p => p.lineNumber === 0 || !p.linePosition)
                                                                                    .sort((a, b) => b.ratings.overall - a.ratings.overall)
                                                                                    .map(p => (
                                                                                        <option key={p.id} value={p.id}>
                                                                                            {p.lastName} (OVR {p.ratings.overall}, {p.preferredPosition})
                                                                                        </option>
                                                                                    ))}
                                                                            </select>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>

                                {/* DEFENSE PAIRS */}
                                <div className="card">
                                    <h2 style={{ color: '#8b5cf6' }}> Defense Pairs (6 Active / 7 Total)</h2>
                                    {[1, 2, 3].map(pair => {
                                        const positions = ['LD', 'RD'];
                                        return (
                                            <div key={pair} style={{ marginBottom: '1.5rem' }}>
                                                <h3 style={{ color: '#a78bfa', fontSize: '1rem', marginBottom: '0.75rem' }}>
                                                    Pair {pair}
                                                </h3>
                                                <div style={{ display: 'flex', gap: '0.75rem', flexWrap: 'wrap' }}>
                                                    {positions.map(pos => {
                                                        const player = userRoster.find(p => p.position === 'D' && p.lineNumber === pair && p.linePosition === pos && !p.injury.injured);
                                                        const availablePlayers = userRoster.filter(p => p.position === 'D' && !p.injury.injured);
                                                        
                                                        return (
                                                            <div key={pos} style={{ flex: '1', minWidth: '200px' }}>
                                                                <div style={{ 
                                                                    padding: '0.75rem',
                                                                    background: player ? 'rgba(139, 92, 246, 0.1)' : 'rgba(100, 116, 139, 0.1)',
                                                                    borderRadius: '0.375rem',
                                                                    border: player ? '1px solid rgba(139, 92, 246, 0.3)' : '1px dashed rgba(100, 116, 139, 0.3)'
                                                                }}>
                                                                    <div style={{ color: '#a78bfa', fontSize: '0.75rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                                                        {pos}
                                                                    </div>
                                                                    {player ? (
                                                                        <div>
                                                                            <div style={{ color: '#fff', fontWeight: 'bold', fontSize: '0.95rem', marginBottom: '0.25rem' }}>
                                                                                {player.firstName.charAt(0)}. {player.lastName}
                                                                                {player.preferredPosition === pos && <span style={{color: '#22c55e', marginLeft: '0.25rem', fontSize: '0.75rem'}} title="In preferred position"></span>}
                                                                                {player.preferredPosition !== pos && <span style={{color: '#f59e0b', marginLeft: '0.25rem', fontSize: '0.75rem'}} title="Out of position (-5 OVR)"></span>}
                                                                            </div>
                                                                            <div style={{ fontSize: '0.75rem', color: '#64748b', marginBottom: '0.5rem' }}>
                                                                                OVR: {getEffectiveOverall(player)}
                                                                                {player.preferredPosition !== pos && ` (was ${player.ratings.overall})`}
                                                                                {' '}| Pref: {player.preferredPosition}
                                                                            </div>
                                                                            <select
                                                                                value={player.id}
                                                                                onChange={(e) => {
                                                                                    if (e.target.value === 'empty') {
                                                                                        assignPlayerToLine(player.id, 0, null);
                                                                                    } else if (e.target.value !== player.id) {
                                                                                        const newPlayer = availablePlayers.find(p => p.id === e.target.value);
                                                                                        if (newPlayer) {
                                                                                            assignPlayerToLine(player.id, newPlayer.lineNumber, newPlayer.linePosition);
                                                                                            assignPlayerToLine(newPlayer.id, pair, pos);
                                                                                        }
                                                                                    }
                                                                                }}
                                                                                style={{
                                                                                    width: '100%',
                                                                                    padding: '0.25rem',
                                                                                    background: '#1e3a8a',
                                                                                    border: '1px solid #3b82f6',
                                                                                    borderRadius: '0.25rem',
                                                                                    color: '#fff',
                                                                                    fontSize: '0.75rem'
                                                                                }}
                                                                            >
                                                                                <option value={player.id}>{player.lastName}</option>
                                                                                <option value="empty">-- Empty Slot --</option>
                                                                                <optgroup label="Swap With:">
                                                                                    {availablePlayers
                                                                                        .filter(p => p.id !== player.id)
                                                                                        .sort((a, b) => b.ratings.overall - a.ratings.overall)
                                                                                        .map(p => (
                                                                                            <option key={p.id} value={p.id}>
                                                                                                {p.lastName} (OVR {p.ratings.overall}, {p.preferredPosition})
                                                                                            </option>
                                                                                        ))}
                                                                                </optgroup>
                                                                            </select>
                                                                        </div>
                                                                    ) : (
                                                                        <div>
                                                                            <div style={{ color: '#64748b', fontSize: '0.85rem', marginBottom: '0.5rem' }}>
                                                                                Empty
                                                                            </div>
                                                                            <select
                                                                                onChange={(e) => {
                                                                                    if (e.target.value) {
                                                                                        assignPlayerToLine(e.target.value, pair, pos);
                                                                                    }
                                                                                }}
                                                                                value=""
                                                                                style={{
                                                                                    width: '100%',
                                                                                    padding: '0.25rem',
                                                                                    background: '#1e3a8a',
                                                                                    border: '1px solid #3b82f6',
                                                                                    borderRadius: '0.25rem',
                                                                                    color: '#fff',
                                                                                    fontSize: '0.75rem'
                                                                                }}
                                                                            >
                                                                                <option value="">-- Select Player --</option>
                                                                                {availablePlayers
                                                                                    .filter(p => p.lineNumber === 0 || !p.linePosition)
                                                                                    .sort((a, b) => b.ratings.overall - a.ratings.overall)
                                                                                    .map(p => (
                                                                                        <option key={p.id} value={p.id}>
                                                                                            {p.lastName} (OVR {p.ratings.overall}, {p.preferredPosition})
                                                                                        </option>
                                                                                    ))}
                                                                            </select>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>

                                {/* GOALIES */}
                                <div className="card">
                                    <h2 style={{ color: '#22c55e' }}> Goalies (2 Dress Per Game)</h2>
                                    <div style={{ display: 'flex', gap: '1rem', flexWrap: 'wrap' }}>
                                        {userRoster.filter(p => p.position === 'G').sort((a, b) => a.lineNumber - b.lineNumber).map(player => (
                                            <div key={player.id} style={{
                                                flex: '1',
                                                minWidth: '250px',
                                                padding: '1rem',
                                                background: player.dressed ? 'rgba(34, 197, 94, 0.1)' : 'rgba(100, 116, 139, 0.1)',
                                                borderRadius: '0.5rem',
                                                border: player.dressed ? '2px solid #22c55e' : '1px dashed rgba(100, 116, 139, 0.3)',
                                                opacity: player.injury.injured ? 0.5 : 1
                                            }}>
                                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.75rem' }}>
                                                    <div>
                                                        <div style={{ color: player.dressed ? '#22c55e' : '#64748b', fontSize: '0.75rem', marginBottom: '0.25rem' }}>
                                                            {player.lineNumber === 1 ? 'STARTER' : player.lineNumber === 2 ? 'BACKUP' : 'THIRD'}
                                                        </div>
                                                        <div style={{ color: '#fff', fontWeight: 'bold', fontSize: '1.1rem' }}>
                                                            {player.firstName} {player.lastName}
                                                        </div>
                                                        <div style={{ color: '#93c5fd', fontSize: '0.85rem' }}>
                                                            OVR: {player.ratings.overall} | Age: {player.age}
                                                        </div>
                                                    </div>
                                                </div>
                                                <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.75rem' }}>
                                                    <button
                                                        onClick={() => toggleGoalieDressed(player.id)}
                                                        disabled={player.injury.injured}
                                                        style={{
                                                            flex: 1,
                                                            padding: '0.375rem',
                                                            background: player.dressed ? '#ef4444' : '#22c55e',
                                                            color: '#fff',
                                                            border: 'none',
                                                            borderRadius: '0.25rem',
                                                            cursor: player.injury.injured ? 'not-allowed' : 'pointer',
                                                            fontSize: '0.75rem',
                                                            fontWeight: 'bold'
                                                        }}
                                                    >
                                                        {player.dressed ? ' Scratch' : ' Dress'}
                                                    </button>
                                                </div>
                                                <div style={{ fontSize: '0.85rem', color: '#e2e8f0' }}>
                                                    {player.stats.wins}-{player.stats.losses} | {player.stats.savePercentage.toFixed(3)} SV% | {player.stats.gaa.toFixed(2)} GAA
                                                </div>
                                                {player.injury.injured && (
                                                    <div style={{ color: '#f59e0b', fontSize: '0.75rem', marginTop: '0.5rem' }}>
                                                        INJURED: {player.injury.type} ({player.injury.daysUntilReturn}d)
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* POWER PLAY UNITS - Coming in next update */}
                                <div className="card" style={{ background: 'rgba(245, 158, 11, 0.05)', border: '1px solid rgba(245, 158, 11, 0.3)' }}>
                                    <h2 style={{ color: '#f59e0b' }}> Power Play Units (Coming Soon)</h2>
                                    <p style={{ color: '#93c5fd' }}>
                                        PP1 & PP2: 3 Forwards + 2 Defense each (Feature in development)
                                    </p>
                                </div>

                                {/* PENALTY KILL UNITS - Coming in next update */}
                                <div className="card" style={{ background: 'rgba(239, 68, 68, 0.05)', border: '1px solid rgba(239, 68, 68, 0.3)' }}>
                                    <h2 style={{ color: '#ef4444' }}> Penalty Kill Units (Coming Soon)</h2>
                                    <p style={{ color: '#93c5fd' }}>
                                        PK1 & PK2: 2 Forwards + 2 Defense each (Feature in development)
                                    </p>
                                </div>

                                {/* HEALTHY SCRATCHES */}
                                <div className="card" style={{ background: 'rgba(100, 116, 139, 0.05)', border: '1px solid rgba(100, 116, 139, 0.3)' }}>
                                    <h2 style={{ color: '#64748b' }}> Healthy Scratches</h2>
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(180px, 1fr))', gap: '0.75rem' }}>
                                        {userRoster.filter(p => p.position !== 'G' && (p.lineNumber === 0 || !p.linePosition) && !p.injury.injured).map(player => (
                                            <div key={player.id} style={{
                                                padding: '0.75rem',
                                                background: 'rgba(100, 116, 139, 0.1)',
                                                borderRadius: '0.375rem',
                                                border: '1px solid rgba(100, 116, 139, 0.3)'
                                            }}>
                                                <div style={{ color: '#fff', fontWeight: 'bold', fontSize: '0.9rem', marginBottom: '0.25rem' }}>
                                                    {player.firstName.charAt(0)}. {player.lastName}
                                                </div>
                                                <div style={{ color: '#93c5fd', fontSize: '0.75rem', marginBottom: '0.5rem' }}>
                                                    {player.position} | {player.preferredPosition} | OVR {player.ratings.overall}
                                                </div>
                                                <button
                                                    onClick={() => {
                                                        // Find first empty slot for this player
                                                        if (player.position === 'F') {
                                                            for (let line = 4; line >= 1; line--) {
                                                                const positions = ['C', 'LW', 'RW'];
                                                                for (let pos of positions) {
                                                                    const occupied = userRoster.find(p => p.lineNumber === line && p.linePosition === pos && p.position === 'F');
                                                                    if (!occupied) {
                                                                        assignPlayerToLine(player.id, line, pos);
                                                                        return;
                                                                    }
                                                                }
                                                            }
                                                        } else if (player.position === 'D') {
                                                            for (let pair = 3; pair >= 1; pair--) {
                                                                const positions = ['LD', 'RD'];
                                                                for (let pos of positions) {
                                                                    const occupied = userRoster.find(p => p.lineNumber === pair && p.linePosition === pos && p.position === 'D');
                                                                    if (!occupied) {
                                                                        assignPlayerToLine(player.id, pair, pos);
                                                                        return;
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }}
                                                    style={{
                                                        width: '100%',
                                                        padding: '0.375rem',
                                                        background: '#22c55e',
                                                        color: '#fff',
                                                        border: 'none',
                                                        borderRadius: '0.25rem',
                                                        cursor: 'pointer',
                                                        fontSize: '0.75rem',
                                                        fontWeight: 'bold'
                                                    }}
                                                >
                                                    Activate
                                                </button>
                                            </div>
                                        ))}
                                        {userRoster.filter(p => p.position !== 'G' && (p.lineNumber === 0 || !p.linePosition) && !p.injury.injured).length === 0 && (
                                            <div style={{ gridColumn: '1 / -1', padding: '2rem', textAlign: 'center', color: '#64748b' }}>
                                                All players are active
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                        {currentView === 'stats' && gameState && (
                            <div className="card">
                                <h2>
                                    Player Statistics 
                                    <span style={{ 
                                        marginLeft: '1rem', 
                                        fontSize: '1rem', 
                                        color: seasonMode === 'playoffs' ? '#f59e0b' : '#3b82f6',
                                        padding: '0.25rem 0.75rem',
                                        background: seasonMode === 'playoffs' ? 'rgba(245, 158, 11, 0.2)' : 'rgba(59, 130, 246, 0.2)',
                                        borderRadius: '0.25rem'
                                    }}>
                                        {seasonMode === 'playoffs' ? ' Playoffs' : ' Regular Season'}
                                    </span>
                                </h2>
                                {seasonMode === 'playoffs' && !playoffState && (
                                    <p style={{ color: '#f59e0b', marginBottom: '1rem' }}>
                                        Complete the regular season to view playoff stats
                                    </p>
                                )}
                                <table className="stats-table">
                                    <thead>
                                        <tr>
                                            <th className="rank">#</th>
                                            <th style={{ cursor: 'pointer' }} onClick={() => handleSort('lastName')}>
                                                Player {sortConfig.key === 'lastName' && (sortConfig.direction === 'desc' ? '' : '')}
                                            </th>
                                            <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => handleSort('stats.gamesPlayed')}>
                                                GP {sortConfig.key === 'stats.gamesPlayed' && (sortConfig.direction === 'desc' ? '' : '')}
                                            </th>
                                            <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => handleSort('stats.goals')}>
                                                G {sortConfig.key === 'stats.goals' && (sortConfig.direction === 'desc' ? '' : '')}
                                            </th>
                                            <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => handleSort('stats.assists')}>
                                                A {sortConfig.key === 'stats.assists' && (sortConfig.direction === 'desc' ? '' : '')}
                                            </th>
                                            <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => handleSort('stats.points')}>
                                                PTS {sortConfig.key === 'stats.points' && (sortConfig.direction === 'desc' ? '' : '')}
                                            </th>
                                            <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => handleSort('stats.plusMinus')}>
                                                +/- {sortConfig.key === 'stats.plusMinus' && (sortConfig.direction === 'desc' ? '' : '')}
                                            </th>
                                            <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => handleSort('stats.pim')}>
                                                PIM {sortConfig.key === 'stats.pim' && (sortConfig.direction === 'desc' ? '' : '')}
                                            </th>
                                            <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => handleSort('stats.shots')}>
                                                SOG {sortConfig.key === 'stats.shots' && (sortConfig.direction === 'desc' ? '' : '')}
                                            </th>
                                            <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => handleSort('stats.timeOnIce')}>
                                                TOI/G {sortConfig.key === 'stats.timeOnIce' && (sortConfig.direction === 'desc' ? '' : '')}
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {sortData(userRoster.filter(p => p.position !== 'G'), sortConfig.key, sortConfig.direction)
                                            .map((player, idx) => {
                                                // Use playoff stats if in playoff mode, otherwise regular season stats
                                                const statsToShow = seasonMode === 'playoffs' ? player.playoffStats : player.stats;
                                                const avgTOI = statsToShow.gamesPlayed > 0 ? statsToShow.timeOnIce / statsToShow.gamesPlayed : 0;
                                                return (
                                                    <tr key={player.id}>
                                                        <td className="rank">{idx + 1}</td>
                                                        <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                            {player.firstName} {player.lastName}
                                                            <span className="player-pos">{player.position}</span>
                                                        </td>
                                                        <td className="text-center">{statsToShow.gamesPlayed}</td>
                                                        <td className="text-center">{statsToShow.goals}</td>
                                                        <td className="text-center">{statsToShow.assists}</td>
                                                        <td className="text-center">{statsToShow.points}</td>
                                                        <td className="text-center">{statsToShow.plusMinus > 0 ? '+' : ''}{statsToShow.plusMinus}</td>
                                                        <td className="text-center">{statsToShow.pim}</td>
                                                        <td className="text-center">{statsToShow.shots}</td>
                                                        <td className="text-center">{formatTOI(avgTOI)}</td>
                                                    </tr>
                                                );
                                            })}
                                    </tbody>
                                </table>
                                
                                <h2 style={{ marginTop: '2rem' }}>Goalie Statistics</h2>
                                <table className="stats-table">
                                    <thead>
                                        <tr>
                                            <th className="rank">#</th>
                                            <th>Player</th>
                                            <th className="text-center">GP</th>
                                            <th className="text-center">W</th>
                                            <th className="text-center">L</th>
                                            <th className="text-center">SV%</th>
                                            <th className="text-center">GAA</th>
                                            <th className="text-center">SO</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {userRoster
                                            .filter(p => p.position === 'G')
                                            .sort((a, b) => (b.stats.savePercentage || 0) - (a.stats.savePercentage || 0))
                                            .map((player, idx) => (
                                                <tr key={player.id}>
                                                    <td className="rank">{idx + 1}</td>
                                                    <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                        {player.firstName} {player.lastName}
                                                    </td>
                                                    <td className="text-center">{player.stats.gamesPlayed}</td>
                                                    <td className="text-center">{player.stats.wins || 0}</td>
                                                    <td className="text-center">{player.stats.losses || 0}</td>
                                                    <td className="text-center">{player.stats.gamesPlayed > 0 ? (player.stats.savePercentage || 0).toFixed(3) : '.000'}</td>
                                                    <td className="text-center">{player.stats.gamesPlayed > 0 ? (player.stats.gaa || 0).toFixed(2) : '0.00'}</td>
                                                    <td className="text-center">{player.stats.shutouts || 0}</td>
                                                </tr>
                                            ))}
                                    </tbody>
                                </table>
                            </div>
                        )}

                        {currentView === 'leaders' && gameState && (
                            <div>
                                <div className="card">
                                    <h2>
                                        League Leaders 
                                        <span style={{ 
                                            marginLeft: '1rem', 
                                            fontSize: '1rem', 
                                            color: seasonMode === 'playoffs' ? '#f59e0b' : '#3b82f6',
                                            padding: '0.25rem 0.75rem',
                                            background: seasonMode === 'playoffs' ? 'rgba(245, 158, 11, 0.2)' : 'rgba(59, 130, 246, 0.2)',
                                            borderRadius: '0.25rem'
                                        }}>
                                            {seasonMode === 'playoffs' ? ' Playoffs' : ' Regular Season'}
                                        </span>
                                    </h2>
                                    {seasonMode === 'playoffs' && !playoffState && (
                                        <p style={{ color: '#f59e0b', marginBottom: '1rem' }}>
                                            Complete the regular season to view playoff leaders
                                        </p>
                                    )}
                                    
                                    <h3>Points</h3>
                                    <table className="stats-table">
                                        <thead>
                                            <tr>
                                                <th className="rank">#</th>
                                                <th>Player</th>
                                                <th>Team</th>
                                                <th className="text-center">GP</th>
                                                <th className="text-center">G</th>
                                                <th className="text-center">A</th>
                                                <th className="text-center">PTS</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {gameState.players
                                                .filter(p => {
                                                    const statsToCheck = seasonMode === 'playoffs' ? p.playoffStats : p.stats;
                                                    return p.position !== 'G' && p.roster === 'nhl' && statsToCheck.gamesPlayed > 0;
                                                })
                                                .sort((a, b) => {
                                                    const aStats = seasonMode === 'playoffs' ? a.playoffStats : a.stats;
                                                    const bStats = seasonMode === 'playoffs' ? b.playoffStats : b.stats;
                                                    return bStats.points - aStats.points;
                                                })
                                                .slice(0, 10)
                                                .map((player, idx) => {
                                                    const team = TEAMS.find(t => t.id === player.teamId);
                                                    const statsToShow = seasonMode === 'playoffs' ? player.playoffStats : player.stats;
                                                    return (
                                                        <tr key={player.id}>
                                                            <td className="rank">{idx + 1}</td>
                                                            <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                                {player.firstName} {player.lastName}
                                                                <span className="player-pos">{player.position}</span>
                                                            </td>
                                                            <td>{team?.city || 'N/A'}</td>
                                                            <td className="text-center">{statsToShow.gamesPlayed}</td>
                                                            <td className="text-center">{statsToShow.goals}</td>
                                                            <td className="text-center">{statsToShow.assists}</td>
                                                            <td className="text-center">{statsToShow.points}</td>
                                                        </tr>
                                                    );
                                                })}
                                        </tbody>
                                    </table>

                                    <h3>Goals</h3>
                                    <table className="stats-table">
                                        <thead>
                                            <tr>
                                                <th className="rank">#</th>
                                                <th>Player</th>
                                                <th>Team</th>
                                                <th className="text-center">GP</th>
                                                <th className="text-center">G</th>
                                                <th className="text-center">PTS</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {gameState.players
                                                .filter(p => p.position !== 'G' && p.roster === 'nhl')
                                                .sort((a, b) => {
                                                    const aStats = seasonMode === 'playoffs' ? a.playoffStats : a.stats;
                                                    const bStats = seasonMode === 'playoffs' ? b.playoffStats : b.stats;
                                                    return bStats.goals - aStats.goals;
                                                })
                                                .slice(0, 10)
                                                .map((player, idx) => {
                                                    const team = TEAMS.find(t => t.id === player.teamId);
                                                    const statsToShow = seasonMode === 'playoffs' ? player.playoffStats : player.stats;
                                                    return (
                                                        <tr key={player.id}>
                                                            <td className="rank">{idx + 1}</td>
                                                            <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                                {player.firstName} {player.lastName}
                                                                <span className="player-pos">{player.position}</span>
                                                            </td>
                                                            <td>{team?.city || 'N/A'}</td>
                                                            <td className="text-center">{statsToShow.gamesPlayed}</td>
                                                            <td className="text-center">{statsToShow.goals}</td>
                                                            <td className="text-center">{statsToShow.points}</td>
                                                        </tr>
                                                    );
                                                })}
                                        </tbody>
                                    </table>

                                    <h3>Assists</h3>
                                    <table className="stats-table">
                                        <thead>
                                            <tr>
                                                <th className="rank">#</th>
                                                <th>Player</th>
                                                <th>Team</th>
                                                <th className="text-center">GP</th>
                                                <th className="text-center">A</th>
                                                <th className="text-center">PTS</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {gameState.players
                                                .filter(p => p.position !== 'G' && p.roster === 'nhl')
                                                .sort((a, b) => {
                                                    const aStats = seasonMode === 'playoffs' ? a.playoffStats : a.stats;
                                                    const bStats = seasonMode === 'playoffs' ? b.playoffStats : b.stats;
                                                    return bStats.assists - aStats.assists;
                                                })
                                                .slice(0, 10)
                                                .map((player, idx) => {
                                                    const team = TEAMS.find(t => t.id === player.teamId);
                                                    const statsToShow = seasonMode === 'playoffs' ? player.playoffStats : player.stats;
                                                    return (
                                                        <tr key={player.id}>
                                                            <td className="rank">{idx + 1}</td>
                                                            <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                                {player.firstName} {player.lastName}
                                                                <span className="player-pos">{player.position}</span>
                                                            </td>
                                                            <td>{team?.city || 'N/A'}</td>
                                                            <td className="text-center">{statsToShow.gamesPlayed}</td>
                                                            <td className="text-center">{statsToShow.assists}</td>
                                                            <td className="text-center">{statsToShow.points}</td>
                                                        </tr>
                                                    );
                                                })}
                                        </tbody>
                                    </table>

                                    <h3>Plus/Minus</h3>
                                    <table className="stats-table">
                                        <thead>
                                            <tr>
                                                <th className="rank">#</th>
                                                <th>Player</th>
                                                <th>Team</th>
                                                <th className="text-center">GP</th>
                                                <th className="text-center">+/-</th>
                                                <th className="text-center">PTS</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {gameState.players
                                                .filter(p => p.position !== 'G' && p.roster === 'nhl')
                                                .sort((a, b) => {
                                                    const aStats = seasonMode === 'playoffs' ? a.playoffStats : a.stats;
                                                    const bStats = seasonMode === 'playoffs' ? b.playoffStats : b.stats;
                                                    return bStats.plusMinus - aStats.plusMinus;
                                                })
                                                .slice(0, 10)
                                                .map((player, idx) => {
                                                    const team = TEAMS.find(t => t.id === player.teamId);
                                                    const statsToShow = seasonMode === 'playoffs' ? player.playoffStats : player.stats;
                                                    return (
                                                        <tr key={player.id}>
                                                            <td className="rank">{idx + 1}</td>
                                                            <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                                {player.firstName} {player.lastName}
                                                                <span className="player-pos">{player.position}</span>
                                                            </td>
                                                            <td>{team?.city || 'N/A'}</td>
                                                            <td className="text-center">{statsToShow.gamesPlayed}</td>
                                                            <td className="text-center">{statsToShow.plusMinus > 0 ? '+' : ''}{statsToShow.plusMinus}</td>
                                                            <td className="text-center">{statsToShow.points}</td>
                                                        </tr>
                                                    );
                                                })}
                                        </tbody>
                                    </table>

                                    <h3>Penalty Minutes</h3>
                                    <table className="stats-table">
                                        <thead>
                                            <tr>
                                                <th className="rank">#</th>
                                                <th>Player</th>
                                                <th>Team</th>
                                                <th className="text-center">GP</th>
                                                <th className="text-center">PIM</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {gameState.players
                                                .filter(p => {
                                                    const statsToCheck = seasonMode === 'playoffs' ? p.playoffStats : p.stats;
                                                    return p.position !== 'G' && p.roster === 'nhl' && statsToCheck.gamesPlayed > 0;
                                                })
                                                .sort((a, b) => {
                                                    const aStats = seasonMode === 'playoffs' ? a.playoffStats : a.stats;
                                                    const bStats = seasonMode === 'playoffs' ? b.playoffStats : b.stats;
                                                    return bStats.pim - aStats.pim;
                                                })
                                                .slice(0, 10)
                                                .map((player, idx) => {
                                                    const team = TEAMS.find(t => t.id === player.teamId);
                                                    const statsToShow = seasonMode === 'playoffs' ? player.playoffStats : player.stats;
                                                    return (
                                                        <tr key={player.id}>
                                                            <td className="rank">{idx + 1}</td>
                                                            <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                                {player.firstName} {player.lastName}
                                                                <span className="player-pos">{player.position}</span>
                                                            </td>
                                                            <td>{team?.city || 'N/A'}</td>
                                                            <td className="text-center">{statsToShow.gamesPlayed}</td>
                                                            <td className="text-center">{statsToShow.pim}</td>
                                                        </tr>
                                                    );
                                                })}
                                        </tbody>
                                    </table>

                                    <h3>Shots on Goal</h3>
                                    <table className="stats-table">
                                        <thead>
                                            <tr>
                                                <th className="rank">#</th>
                                                <th>Player</th>
                                                <th>Team</th>
                                                <th className="text-center">GP</th>
                                                <th className="text-center">SOG</th>
                                                <th className="text-center">G</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {gameState.players
                                                .filter(p => p.position !== 'G' && p.roster === 'nhl')
                                                .sort((a, b) => {
                                                    const aStats = seasonMode === 'playoffs' ? a.playoffStats : a.stats;
                                                    const bStats = seasonMode === 'playoffs' ? b.playoffStats : b.stats;
                                                    return bStats.shots - aStats.shots;
                                                })
                                                .slice(0, 10)
                                                .map((player, idx) => {
                                                    const team = TEAMS.find(t => t.id === player.teamId);
                                                    const statsToShow = seasonMode === 'playoffs' ? player.playoffStats : player.stats;
                                                    return (
                                                        <tr key={player.id}>
                                                            <td className="rank">{idx + 1}</td>
                                                            <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                                {player.firstName} {player.lastName}
                                                                <span className="player-pos">{player.position}</span>
                                                            </td>
                                                            <td>{team?.city || 'N/A'}</td>
                                                            <td className="text-center">{statsToShow.gamesPlayed}</td>
                                                            <td className="text-center">{statsToShow.shots}</td>
                                                            <td className="text-center">{statsToShow.goals}</td>
                                                        </tr>
                                                    );
                                                })}
                                        </tbody>
                                    </table>

                                    <h3>Time on Ice Per Game</h3>
                                    <table className="stats-table">
                                        <thead>
                                            <tr>
                                                <th className="rank">#</th>
                                                <th>Player</th>
                                                <th>Team</th>
                                                <th className="text-center">GP</th>
                                                <th className="text-center">TOI/G</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {gameState.players
                                                .filter(p => {
                                                    const statsToCheck = seasonMode === 'playoffs' ? p.playoffStats : p.stats;
                                                    return p.position !== 'G' && statsToCheck.gamesPlayed > 0;
                                                })
                                                .sort((a, b) => {
                                                    const aStats = seasonMode === 'playoffs' ? a.playoffStats : a.stats;
                                                    const bStats = seasonMode === 'playoffs' ? b.playoffStats : b.stats;
                                                    return (bStats.timeOnIce / bStats.gamesPlayed) - (aStats.timeOnIce / aStats.gamesPlayed);
                                                })
                                                .slice(0, 10)
                                                .map((player, idx) => {
                                                    const team = TEAMS.find(t => t.id === player.teamId);
                                                    const statsToShow = seasonMode === 'playoffs' ? player.playoffStats : player.stats;
                                                    const avgTOI = statsToShow.timeOnIce / statsToShow.gamesPlayed;
                                                    return (
                                                        <tr key={player.id}>
                                                            <td className="rank">{idx + 1}</td>
                                                            <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                                {player.firstName} {player.lastName}
                                                                <span className="player-pos">{player.position}</span>
                                                            </td>
                                                            <td>{team.city}</td>
                                                            <td className="text-center">{statsToShow.gamesPlayed}</td>
                                                            <td className="text-center">{formatTOI(avgTOI)}</td>
                                                        </tr>
                                                    );
                                                })}
                                        </tbody>
                                    </table>
                                    
                                    {/* Goalie Stats */}
                                    <h3 style={{ marginTop: '3rem', paddingTop: '2rem', borderTop: '2px solid rgba(100, 116, 139, 0.3)' }}> Goalie Leaders</h3>
                                    
                                    <h3 style={{ fontSize: '1.1rem', color: '#93c5fd', marginTop: '2rem' }}>Wins</h3>
                                    <table className="stats-table">
                                        <thead>
                                            <tr>
                                                <th className="rank">#</th>
                                                <th>Player</th>
                                                <th>Team</th>
                                                <th className="text-center">GP</th>
                                                <th className="text-center">W</th>
                                                <th className="text-center">L</th>
                                                <th className="text-center">SV%</th>
                                                <th className="text-center">GAA</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {gameState.players
                                                .filter(p => {
                                                    const statsToCheck = seasonMode === 'playoffs' ? p.playoffStats : p.stats;
                                                    return p.position === 'G' && p.roster === 'nhl' && statsToCheck.gamesPlayed > 0;
                                                })
                                                .sort((a, b) => {
                                                    const aStats = seasonMode === 'playoffs' ? a.playoffStats : a.stats;
                                                    const bStats = seasonMode === 'playoffs' ? b.playoffStats : b.stats;
                                                    return (bStats.wins || 0) - (aStats.wins || 0);
                                                })
                                                .slice(0, 10)
                                                .map((player, idx) => {
                                                    const team = TEAMS.find(t => t.id === player.teamId);
                                                    const statsToShow = seasonMode === 'playoffs' ? player.playoffStats : player.stats;
                                                    return (
                                                        <tr key={player.id}>
                                                            <td className="rank">{idx + 1}</td>
                                                            <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                                {player.firstName} {player.lastName}
                                                                <span className="player-pos">{player.position}</span>
                                                            </td>
                                                            <td>{team?.city || 'N/A'}</td>
                                                            <td className="text-center">{statsToShow.gamesPlayed}</td>
                                                            <td className="text-center">{statsToShow.wins || 0}</td>
                                                            <td className="text-center">{statsToShow.losses || 0}</td>
                                                            <td className="text-center">{statsToShow.savePercentage ? statsToShow.savePercentage.toFixed(3) : '.000'}</td>
                                                            <td className="text-center">{statsToShow.gaa ? statsToShow.gaa.toFixed(2) : '0.00'}</td>
                                                        </tr>
                                                    );
                                                })}
                                        </tbody>
                                    </table>
                                    
                                    <h3 style={{ fontSize: '1.1rem', color: '#93c5fd', marginTop: '2rem' }}>Save Percentage</h3>
                                    <table className="stats-table">
                                        <thead>
                                            <tr>
                                                <th className="rank">#</th>
                                                <th>Player</th>
                                                <th>Team</th>
                                                <th className="text-center">GP</th>
                                                <th className="text-center">SV%</th>
                                                <th className="text-center">GAA</th>
                                                <th className="text-center">W</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {gameState.players
                                                .filter(p => {
                                                    const statsToCheck = seasonMode === 'playoffs' ? p.playoffStats : p.stats;
                                                    return p.position === 'G' && p.roster === 'nhl' && statsToCheck.gamesPlayed >= 27; // NHL minimum: 27 GP
                                                })
                                                .sort((a, b) => {
                                                    const aStats = seasonMode === 'playoffs' ? a.playoffStats : a.stats;
                                                    const bStats = seasonMode === 'playoffs' ? b.playoffStats : b.stats;
                                                    return (bStats.savePercentage || 0) - (aStats.savePercentage || 0);
                                                })
                                                .slice(0, 10)
                                                .map((player, idx) => {
                                                    const team = TEAMS.find(t => t.id === player.teamId);
                                                    const statsToShow = seasonMode === 'playoffs' ? player.playoffStats : player.stats;
                                                    return (
                                                        <tr key={player.id}>
                                                            <td className="rank">{idx + 1}</td>
                                                            <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                                {player.firstName} {player.lastName}
                                                                <span className="player-pos">{player.position}</span>
                                                            </td>
                                                            <td>{team?.city || 'N/A'}</td>
                                                            <td className="text-center">{statsToShow.gamesPlayed}</td>
                                                            <td className="text-center">{statsToShow.savePercentage ? statsToShow.savePercentage.toFixed(3) : '.000'}</td>
                                                            <td className="text-center">{statsToShow.gaa ? statsToShow.gaa.toFixed(2) : '0.00'}</td>
                                                            <td className="text-center">{statsToShow.wins || 0}</td>
                                                        </tr>
                                                    );
                                                })}
                                        </tbody>
                                    </table>
                                    
                                    <h3 style={{ fontSize: '1.1rem', color: '#93c5fd', marginTop: '2rem' }}>Goals Against Average</h3>
                                    <table className="stats-table">
                                        <thead>
                                            <tr>
                                                <th className="rank">#</th>
                                                <th>Player</th>
                                                <th>Team</th>
                                                <th className="text-center">GP</th>
                                                <th className="text-center">GAA</th>
                                                <th className="text-center">SV%</th>
                                                <th className="text-center">W</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {gameState.players
                                                .filter(p => {
                                                    const statsToCheck = seasonMode === 'playoffs' ? p.playoffStats : p.stats;
                                                    return p.position === 'G' && p.roster === 'nhl' && statsToCheck.gamesPlayed >= 27; // NHL minimum: 27 GP
                                                })
                                                .sort((a, b) => {
                                                    const aStats = seasonMode === 'playoffs' ? a.playoffStats : a.stats;
                                                    const bStats = seasonMode === 'playoffs' ? b.playoffStats : b.stats;
                                                    return (aStats.gaa || 999) - (bStats.gaa || 999); // Lower is better
                                                })
                                                .slice(0, 10)
                                                .map((player, idx) => {
                                                    const team = TEAMS.find(t => t.id === player.teamId);
                                                    const statsToShow = seasonMode === 'playoffs' ? player.playoffStats : player.stats;
                                                    return (
                                                        <tr key={player.id}>
                                                            <td className="rank">{idx + 1}</td>
                                                            <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                                {player.firstName} {player.lastName}
                                                                <span className="player-pos">{player.position}</span>
                                                            </td>
                                                            <td>{team.city}</td>
                                                            <td className="text-center">{statsToShow.gamesPlayed}</td>
                                                            <td className="text-center">{statsToShow.gaa ? statsToShow.gaa.toFixed(2) : '0.00'}</td>
                                                            <td className="text-center">{statsToShow.savePercentage ? statsToShow.savePercentage.toFixed(3) : '.000'}</td>
                                                            <td className="text-center">{statsToShow.wins || 0}</td>
                                                        </tr>
                                                    );
                                                })}
                                        </tbody>
                                    </table>
                                    
                                    <h3 style={{ fontSize: '1.1rem', color: '#93c5fd', marginTop: '2rem' }}>Shutouts</h3>
                                    <table className="stats-table">
                                        <thead>
                                            <tr>
                                                <th className="rank">#</th>
                                                <th>Player</th>
                                                <th>Team</th>
                                                <th className="text-center">GP</th>
                                                <th className="text-center">SO</th>
                                                <th className="text-center">W</th>
                                                <th className="text-center">SV%</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {gameState.players
                                                .filter(p => {
                                                    const statsToCheck = seasonMode === 'playoffs' ? p.playoffStats : p.stats;
                                                    return p.position === 'G' && p.roster === 'nhl' && statsToCheck.gamesPlayed > 0;
                                                })
                                                .sort((a, b) => {
                                                    const aStats = seasonMode === 'playoffs' ? a.playoffStats : a.stats;
                                                    const bStats = seasonMode === 'playoffs' ? b.playoffStats : b.stats;
                                                    return (bStats.shutouts || 0) - (aStats.shutouts || 0);
                                                })
                                                .slice(0, 10)
                                                .map((player, idx) => {
                                                    const team = TEAMS.find(t => t.id === player.teamId);
                                                    const statsToShow = seasonMode === 'playoffs' ? player.playoffStats : player.stats;
                                                    return (
                                                        <tr key={player.id}>
                                                            <td className="rank">{idx + 1}</td>
                                                            <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                                {player.firstName} {player.lastName}
                                                                <span className="player-pos">{player.position}</span>
                                                            </td>
                                                            <td>{team.city}</td>
                                                            <td className="text-center">{statsToShow.gamesPlayed}</td>
                                                            <td className="text-center">{statsToShow.shutouts || 0}</td>
                                                            <td className="text-center">{statsToShow.wins || 0}</td>
                                                            <td className="text-center">{statsToShow.savePercentage ? statsToShow.savePercentage.toFixed(3) : '.000'}</td>
                                                        </tr>
                                                    );
                                                })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {currentView === 'teamStats' && gameState && (
                            <div className="card">
                                <h2>Team Statistics</h2>
                                
                                <table className="stats-table">
                                    <thead>
                                        <tr>
                                            <th>Team</th>
                                            <th className="text-center">GP</th>
                                            <th className="text-center">GF/G</th>
                                            <th className="text-center">GA/G</th>
                                            <th className="text-center">Diff</th>
                                            <th className="text-center">SF/G</th>
                                            <th className="text-center">SA/G</th>
                                            <th className="text-center">S%</th>
                                            <th className="text-center">PP%</th>
                                            <th className="text-center">PK%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {gameState.standings
                                            .sort((a, b) => {
                                                // Sort by points first
                                                return b.points - a.points;
                                            })
                                            .map(standing => {
                                                const team = getTeam(standing.teamId);
                                                const stats = standing.teamStats;
                                                const gp = stats.gamesPlayed || 1; // Avoid division by zero
                                                
                                                // Calculate per-game averages
                                                const gfPerGame = (standing.goalsFor / gp).toFixed(2);
                                                const gaPerGame = (standing.goalsAgainst / gp).toFixed(2);
                                                const goalDiff = (standing.goalsFor - standing.goalsAgainst) / gp;
                                                const shotsPerGame = (stats.shots / gp).toFixed(1);
                                                const shotsAgainstPerGame = (stats.shotsAgainst / gp).toFixed(1);
                                                const shootingPct = stats.shots > 0 ? ((standing.goalsFor / stats.shots) * 100).toFixed(1) : '0.0';
                                                const ppPct = stats.ppOpportunities > 0 ? ((stats.ppGoals / stats.ppOpportunities) * 100).toFixed(1) : '0.0';
                                                const pkPct = stats.pkOpportunities > 0 ? (((stats.pkOpportunities - stats.pkGoalsAgainst) / stats.pkOpportunities) * 100).toFixed(1) : '0.0';
                                                
                                                return (
                                                    <tr key={standing.teamId}>
                                                        <td>
                                                            <span 
                                                                style={{ cursor: 'pointer', textDecoration: 'underline' }}
                                                                onClick={() => {
                                                                    setSelectedTeamId(standing.teamId);
                                                                    setCurrentView('teamProfile');
                                                                }}
                                                            >
                                                                {team.city}
                                                            </span>
                                                        </td>
                                                        <td className="text-center">{gp}</td>
                                                        <td className="text-center">{gfPerGame}</td>
                                                        <td className="text-center">{gaPerGame}</td>
                                                        <td className="text-center" style={{ color: goalDiff > 0 ? '#4ade80' : goalDiff < 0 ? '#f87171' : '#fff' }}>
                                                            {goalDiff > 0 ? '+' : ''}{goalDiff.toFixed(2)}
                                                        </td>
                                                        <td className="text-center">{shotsPerGame}</td>
                                                        <td className="text-center">{shotsAgainstPerGame}</td>
                                                        <td className="text-center">{shootingPct}%</td>
                                                        <td className="text-center" style={{ color: parseFloat(ppPct) >= 20 ? '#4ade80' : parseFloat(ppPct) < 15 ? '#f87171' : '#fff' }}>
                                                            {ppPct}%
                                                        </td>
                                                        <td className="text-center" style={{ color: parseFloat(pkPct) >= 82 ? '#4ade80' : parseFloat(pkPct) < 78 ? '#f87171' : '#fff' }}>
                                                            {pkPct}%
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                    </tbody>
                                </table>
                                
                                <div style={{ marginTop: '2rem', padding: '1rem', background: 'rgba(30, 58, 138, 0.2)', borderRadius: '0.5rem' }}>
                                    <h3 style={{ marginBottom: '1rem', color: '#93c5fd' }}>Legend</h3>
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '0.5rem', fontSize: '0.9rem' }}>
                                        <div><strong>GF/G:</strong> Goals For per Game</div>
                                        <div><strong>GA/G:</strong> Goals Against per Game</div>
                                        <div><strong>Diff:</strong> Goal Differential per Game</div>
                                        <div><strong>SF/G:</strong> Shots For per Game</div>
                                        <div><strong>SA/G:</strong> Shots Against per Game</div>
                                        <div><strong>S%:</strong> Shooting Percentage</div>
                                        <div><strong>PP%:</strong> Power Play Success Rate</div>
                                        <div><strong>PK%:</strong> Penalty Kill Success Rate</div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {currentView === 'playerProfile' && selectedPlayerProfile && (() => {
                            const team = getTeam(selectedPlayerProfile.teamId);
                            return (
                            <div>
                                <button 
                                    onClick={goBack}
                                    style={{
                                        padding: '0.5rem 1rem',
                                        background: '#2563eb',
                                        color: '#fff',
                                        border: 'none',
                                        borderRadius: '0.375rem',
                                        cursor: 'pointer',
                                        marginBottom: '1rem',
                                        fontWeight: 'bold'
                                    }}
                                >
                                     Back
                                </button>
                                
                            <div className="card">
                                <h2>{selectedPlayerProfile.firstName} {selectedPlayerProfile.lastName}</h2>
                                <div style={{ marginBottom: '1.5rem', padding: '1rem', background: 'rgba(30, 58, 138, 0.3)', borderRadius: '0.5rem' }}>
                                    <p style={{ marginBottom: '0.5rem' }}><strong>Position:</strong> {selectedPlayerProfile.position}</p>
                                    <p style={{ marginBottom: '0.5rem' }}><strong>Age:</strong> {selectedPlayerProfile.age}</p>
                                    <p style={{ marginBottom: '0.5rem' }}><strong>Team:</strong> {team?.city} {team?.name}</p>
                                    <p style={{ marginBottom: '0.5rem' }}><strong>Overall Rating:</strong> {selectedPlayerProfile.ratings.overall}</p>
                                    <p><strong>Potential:</strong> {selectedPlayerProfile.ratings.potential}</p>
                                </div>

                                {/* Achievements Section */}
                                {selectedPlayerProfile.achievements && selectedPlayerProfile.achievements.length > 0 && (
                                    <div style={{ marginBottom: '2rem', padding: '1.5rem', background: 'rgba(251, 191, 36, 0.1)', border: '2px solid rgba(251, 191, 36, 0.3)', borderRadius: '0.5rem' }}>
                                        <h3 style={{ marginBottom: '1rem', color: '#fbbf24', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                             Achievements
                                        </h3>
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                            {selectedPlayerProfile.achievements
                                                .sort((a, b) => b.year - a.year) // Most recent first
                                                .map((achievement, idx) => (
                                                    <div key={idx} style={{ 
                                                        padding: '0.75rem', 
                                                        background: 'rgba(30, 58, 138, 0.3)', 
                                                        borderRadius: '0.375rem',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '0.75rem'
                                                    }}>
                                                        <span style={{ fontSize: '1.5rem' }}>{achievement.icon}</span>
                                                        <div>
                                                            <strong style={{ color: '#fbbf24' }}>{achievement.year}</strong>
                                                            {achievement.type === 'award' && (
                                                                <span style={{ marginLeft: '0.5rem' }}>{achievement.award}</span>
                                                            )}
                                                            {achievement.type === 'allstar' && (
                                                                <span style={{ marginLeft: '0.5rem' }}>{achievement.conference} Conference All-Star</span>
                                                            )}
                                                            {achievement.type === 'leagueLeader' && (
                                                                <span style={{ marginLeft: '0.5rem' }}>
                                                                    League Leader - {achievement.stat} ({achievement.value})
                                                                </span>
                                                            )}
                                                        </div>
                                                    </div>
                                                ))}
                                        </div>
                                    </div>
                                )}

                                {/* Stats Type Dropdown (Regular Season / Playoffs) */}
                                <div style={{ marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '1rem' }}>
                                    <label style={{ fontWeight: 'bold', color: '#93c5fd' }}>Stats Type:</label>
                                    <select 
                                        value={playerStatMode}
                                        onChange={(e) => setPlayerStatMode(e.target.value)}
                                        style={{
                                            padding: '0.5rem 1rem',
                                            background: '#1e3a8a',
                                            border: '1px solid #3b82f6',
                                            borderRadius: '0.375rem',
                                            color: '#fff',
                                            fontSize: '1rem',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        <option value="regular">Regular Season</option>
                                        <option value="playoffs" disabled={!playoffState}>Playoffs {!playoffState && '(Not Started)'}</option>
                                    </select>
                                </div>

                                <h3>
                                    {playerStatMode === 'playoffs' ? 'Playoff' : 'Regular Season'} Stats 
                                    <span style={{ color: '#93c5fd', marginLeft: '0.5rem', fontSize: '0.9rem' }}>
                                        ({gameState.year}-{(gameState.year + 1).toString().slice(-2)})
                                    </span>
                                </h3>
                                
                                {playerStatMode === 'playoffs' && !playoffState && (
                                    <p style={{ color: '#f59e0b', marginBottom: '1rem' }}>
                                        Playoffs have not started yet. Complete the regular season first.
                                    </p>
                                )}
                                
                                {/* Different stats table for goalies vs skaters */}
                                {selectedPlayerProfile.position === 'G' ? (
                                    // GOALIE STATS
                                    <table className="stats-table">
                                        <thead>
                                            <tr>
                                                <th className="text-center">GP</th>
                                                <th className="text-center">W</th>
                                                <th className="text-center">L</th>
                                                <th className="text-center">SV%</th>
                                                <th className="text-center">GAA</th>
                                                <th className="text-center">SO</th>
                                                <th className="text-center">SA</th>
                                                <th className="text-center">SV</th>
                                                <th className="text-center">GA</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {(() => {
                                                const statsToShow = playerStatMode === 'playoffs' ? selectedPlayerProfile.playoffStats : selectedPlayerProfile.stats;
                                                return (
                                                    <tr>
                                                        <td className="text-center">{statsToShow.gamesPlayed || 0}</td>
                                                        <td className="text-center">{statsToShow.wins || 0}</td>
                                                        <td className="text-center">{statsToShow.losses || 0}</td>
                                                        <td className="text-center">
                                                            {statsToShow.savePercentage ? statsToShow.savePercentage.toFixed(3) : '.000'}
                                                        </td>
                                                        <td className="text-center">
                                                            {statsToShow.gaa ? statsToShow.gaa.toFixed(2) : '0.00'}
                                                        </td>
                                                        <td className="text-center">{statsToShow.shutouts || 0}</td>
                                                        <td className="text-center">{statsToShow.shotsAgainst || 0}</td>
                                                        <td className="text-center">{statsToShow.saves || 0}</td>
                                                        <td className="text-center">{statsToShow.goalsAgainst || 0}</td>
                                                    </tr>
                                                );
                                            })()}
                                        </tbody>
                                    </table>
                                ) : (
                                    // SKATER STATS
                                    <table className="stats-table">
                                        <thead>
                                            <tr>
                                                <th className="text-center">GP</th>
                                                <th className="text-center">G</th>
                                                <th className="text-center">A</th>
                                                <th className="text-center">PTS</th>
                                                <th className="text-center">+/-</th>
                                                <th className="text-center">PIM</th>
                                                <th className="text-center">SOG</th>
                                                <th className="text-center">TOI/G</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {(() => {
                                                const statsToShow = playerStatMode === 'playoffs' ? selectedPlayerProfile.playoffStats : selectedPlayerProfile.stats;
                                                return (
                                                    <tr>
                                                        <td className="text-center">{statsToShow.gamesPlayed}</td>
                                                        <td className="text-center">{statsToShow.goals}</td>
                                                        <td className="text-center">{statsToShow.assists}</td>
                                                        <td className="text-center">{statsToShow.points}</td>
                                                        <td className="text-center">{statsToShow.plusMinus > 0 ? '+' : ''}{statsToShow.plusMinus}</td>
                                                        <td className="text-center">{statsToShow.pim}</td>
                                                        <td className="text-center">{statsToShow.shots}</td>
                                                        <td className="text-center">
                                                            {statsToShow.gamesPlayed > 0 
                                                                ? formatTOI(statsToShow.timeOnIce / statsToShow.gamesPlayed)
                                                                : '0:00'}
                                                        </td>
                                                    </tr>
                                                );
                                            })()}
                                        </tbody>
                                    </table>
                                )}

                                {selectedPlayerProfile.careerStats && selectedPlayerProfile.careerStats.length > 0 && (
                                    <>
                                        <h3 style={{ marginTop: '2rem' }}>
                                            Career {playerStatMode === 'playoffs' ? 'Playoff' : 'Regular Season'} Stats by Season
                                        </h3>
                                        
                                        {selectedPlayerProfile.position === 'G' ? (
                                            // GOALIE CAREER STATS BY SEASON
                                            <table className="stats-table">
                                                <thead>
                                                    <tr>
                                                        <th>Year</th>
                                                        <th>Type</th>
                                                        <th>Team</th>
                                                        <th className="text-center">GP</th>
                                                        <th className="text-center">W</th>
                                                        <th className="text-center">L</th>
                                                        <th className="text-center">SV%</th>
                                                        <th className="text-center">GAA</th>
                                                        <th className="text-center">SO</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {selectedPlayerProfile.careerStats.map((seasonStats, idx) => {
                                                        return (
                                                            <tr key={idx}>
                                                                <td>{seasonStats.year || seasonStats.season}</td>
                                                                <td>{seasonStats.type || 'Regular'}</td>
                                                                <td>{seasonStats.teamName}</td>
                                                                <td className="text-center">{seasonStats.gamesPlayed || 0}</td>
                                                                <td className="text-center">{seasonStats.wins || 0}</td>
                                                                <td className="text-center">{seasonStats.losses || 0}</td>
                                                                <td className="text-center">
                                                                    {seasonStats.savePercentage ? seasonStats.savePercentage.toFixed(3) : '.000'}
                                                                </td>
                                                                <td className="text-center">
                                                                    {seasonStats.gaa ? seasonStats.gaa.toFixed(2) : '0.00'}
                                                                </td>
                                                                <td className="text-center">{seasonStats.shutouts || 0}</td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        ) : (
                                            // SKATER CAREER STATS BY SEASON
                                            <table className="stats-table">
                                                <thead>
                                                    <tr>
                                                        <th>Year</th>
                                                        <th>Type</th>
                                                        <th>Team</th>
                                                        <th className="text-center">GP</th>
                                                        <th className="text-center">G</th>
                                                        <th className="text-center">A</th>
                                                        <th className="text-center">PTS</th>
                                                        <th className="text-center">+/-</th>
                                                        <th className="text-center">PIM</th>
                                                        <th className="text-center">SOG</th>
                                                        <th className="text-center">TOI/G</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {selectedPlayerProfile.careerStats.map((seasonStats, idx) => {
                                                        const avgTOI = seasonStats.gamesPlayed > 0 ? seasonStats.timeOnIce / seasonStats.gamesPlayed : 0;
                                                        return (
                                                            <tr key={idx}>
                                                                <td>{seasonStats.year || seasonStats.season}</td>
                                                                <td>{seasonStats.type || 'Regular'}</td>
                                                                <td>{seasonStats.teamName}</td>
                                                                <td className="text-center">{seasonStats.gamesPlayed}</td>
                                                                <td className="text-center">{seasonStats.goals}</td>
                                                                <td className="text-center">{seasonStats.assists}</td>
                                                                <td className="text-center">{seasonStats.points}</td>
                                                                <td className="text-center">{seasonStats.plusMinus > 0 ? '+' : ''}{seasonStats.plusMinus}</td>
                                                                <td className="text-center">{seasonStats.pim}</td>
                                                                <td className="text-center">{seasonStats.shots}</td>
                                                                <td className="text-center">{formatTOI(avgTOI)}</td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        )}
                                    </>
                                )}

                                <h3 style={{ marginTop: '2rem' }}>
                                    Career {playerStatMode === 'playoffs' ? 'Playoff' : 'Regular Season'} Totals
                                </h3>
                                
                                {selectedPlayerProfile.position === 'G' ? (
                                    // GOALIE CAREER TOTALS
                                    <table className="stats-table">
                                        <thead>
                                            <tr>
                                                <th className="text-center">GP</th>
                                                <th className="text-center">W</th>
                                                <th className="text-center">L</th>
                                                <th className="text-center">SV%</th>
                                                <th className="text-center">GAA</th>
                                                <th className="text-center">SO</th>
                                                <th className="text-center">SA</th>
                                                <th className="text-center">SV</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {(() => {
                                                const currentStats = playerStatMode === 'playoffs' ? selectedPlayerProfile.playoffStats : selectedPlayerProfile.stats;
                                                const careerTotal = (stat) => {
                                                    return (currentStats[stat] || 0) + 
                                                        (selectedPlayerProfile.careerStats?.reduce((sum, s) => sum + (s[stat] || 0), 0) || 0);
                                                };
                                                
                                                // Calculate career averages for percentage stats
                                                const totalSaves = careerTotal('saves');
                                                const totalShotsAgainst = careerTotal('shotsAgainst');
                                                const careerSavePercentage = totalShotsAgainst > 0 ? totalSaves / totalShotsAgainst : 0;
                                                
                                                const totalGP = careerTotal('gamesPlayed');
                                                const totalGA = careerTotal('goalsAgainst');
                                                const careerGAA = totalGP > 0 ? totalGA / totalGP : 0;
                                                
                                                return (
                                                    <tr>
                                                        <td className="text-center">{totalGP}</td>
                                                        <td className="text-center">{careerTotal('wins')}</td>
                                                        <td className="text-center">{careerTotal('losses')}</td>
                                                        <td className="text-center">{careerSavePercentage.toFixed(3)}</td>
                                                        <td className="text-center">{careerGAA.toFixed(2)}</td>
                                                        <td className="text-center">{careerTotal('shutouts')}</td>
                                                        <td className="text-center">{totalShotsAgainst}</td>
                                                        <td className="text-center">{totalSaves}</td>
                                                    </tr>
                                                );
                                            })()}
                                        </tbody>
                                    </table>
                                ) : (
                                    // SKATER CAREER TOTALS
                                    <table className="stats-table">
                                        <thead>
                                            <tr>
                                                <th className="text-center">GP</th>
                                                <th className="text-center">G</th>
                                                <th className="text-center">A</th>
                                                <th className="text-center">PTS</th>
                                                <th className="text-center">+/-</th>
                                                <th className="text-center">PIM</th>
                                                <th className="text-center">SOG</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {(() => {
                                                const currentStats = playerStatMode === 'playoffs' ? selectedPlayerProfile.playoffStats : selectedPlayerProfile.stats;
                                                const careerTotal = (stat) => {
                                                    return currentStats[stat] + 
                                                        (selectedPlayerProfile.careerStats?.reduce((sum, s) => sum + (s[stat] || 0), 0) || 0);
                                                };
                                                
                                                return (
                                                    <tr>
                                                        <td className="text-center">{careerTotal('gamesPlayed')}</td>
                                                        <td className="text-center">{careerTotal('goals')}</td>
                                                        <td className="text-center">{careerTotal('assists')}</td>
                                                        <td className="text-center">{careerTotal('points')}</td>
                                                        <td className="text-center">
                                                            {careerTotal('plusMinus') > 0 ? '+' : ''}{careerTotal('plusMinus')}
                                                        </td>
                                                        <td className="text-center">{careerTotal('pim')}</td>
                                                        <td className="text-center">{careerTotal('shots')}</td>
                                                    </tr>
                                                );
                                            })()}
                                        </tbody>
                                    </table>
                                )}
                                
                                {/* Milestones Section */}
                                {selectedPlayerProfile.milestones && selectedPlayerProfile.milestones.length > 0 && (
                                    <>
                                        <h3 style={{ marginTop: '2rem', color: '#f59e0b' }}> Career Milestones</h3>
                                        <div style={{ 
                                            display: 'grid', 
                                            gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))', 
                                            gap: '1rem',
                                            marginTop: '1rem'
                                        }}>
                                            {selectedPlayerProfile.milestones
                                                .sort((a, b) => new Date(b.date) - new Date(a.date))
                                                .map((milestone, idx) => (
                                                    <div key={idx} style={{
                                                        padding: '1rem',
                                                        background: 'rgba(245, 158, 11, 0.1)',
                                                        borderRadius: '0.5rem',
                                                        border: '1px solid rgba(245, 158, 11, 0.3)'
                                                    }}>
                                                        <div style={{ 
                                                            fontWeight: 'bold', 
                                                            color: '#fbbf24',
                                                            marginBottom: '0.5rem',
                                                            fontSize: '1rem'
                                                        }}>
                                                            {milestone.description}
                                                        </div>
                                                        <div style={{ 
                                                            fontSize: '0.875rem', 
                                                            color: '#94a3b8' 
                                                        }}>
                                                            {new Date(milestone.date).toLocaleDateString('en-US', { 
                                                                month: 'short', 
                                                                day: 'numeric', 
                                                                year: 'numeric' 
                                                            })}
                                                        </div>
                                                    </div>
                                                ))}
                                        </div>
                                    </>
                                )}
                                
                                {/* Transactions Section */}
                                {selectedPlayerProfile.tradeHistory && selectedPlayerProfile.tradeHistory.length > 0 && (
                                    <>
                                        <h3 style={{ marginTop: '2rem', color: '#3b82f6' }}> Transaction History</h3>
                                        <div style={{ 
                                            display: 'flex', 
                                            flexDirection: 'column', 
                                            gap: '1rem',
                                            marginTop: '1rem'
                                        }}>
                                            {selectedPlayerProfile.tradeHistory
                                                .sort((a, b) => new Date(b.date) - new Date(a.date))
                                                .map((trade, idx) => {
                                                    const fromTeam = getTeam(trade.from);
                                                    const toTeam = getTeam(trade.to);
                                                    const tradeDate = new Date(trade.date);
                                                    
                                                    return (
                                                        <div key={idx} style={{
                                                            padding: '1.25rem',
                                                            background: 'rgba(59, 130, 246, 0.1)',
                                                            borderRadius: '0.5rem',
                                                            border: '1px solid rgba(59, 130, 246, 0.3)'
                                                        }}>
                                                            <div style={{ 
                                                                fontWeight: 'bold', 
                                                                color: '#60a5fa',
                                                                marginBottom: '0.75rem',
                                                                display: 'flex',
                                                                justifyContent: 'space-between',
                                                                alignItems: 'center'
                                                            }}>
                                                                <span>
                                                                    {fromTeam?.city} {fromTeam?.name}  {toTeam?.city} {toTeam?.name}
                                                                </span>
                                                                <span style={{ 
                                                                    fontSize: '0.875rem',
                                                                    color: '#93c5fd',
                                                                    fontWeight: 'normal'
                                                                }}>
                                                                    {tradeDate.toLocaleDateString('en-US', { 
                                                                        month: 'short', 
                                                                        day: 'numeric', 
                                                                        year: 'numeric' 
                                                                    })}
                                                                </span>
                                                            </div>
                                                            
                                                            <div style={{ 
                                                                color: '#e2e8f0',
                                                                lineHeight: '1.6'
                                                            }}>
                                                                {/* Show who was traded together */}
                                                                {trade.tradedWith && trade.tradedWith.length > 0 && (
                                                                    <div style={{ marginBottom: '0.5rem' }}>
                                                                        <span style={{ color: '#93c5fd' }}>Traded with: </span>
                                                                        {trade.tradedWith.map((player, i) => {
                                                                            const fullPlayer = gameState.players.find(p => p.id === player.id);
                                                                            return (
                                                                                <span key={i}>
                                                                                    {fullPlayer ? (
                                                                                        <span 
                                                                                            className="clickable-player"
                                                                                            onClick={() => navigateTo('playerProfile', fullPlayer)}
                                                                                        >
                                                                                            {player.name}
                                                                                        </span>
                                                                                    ) : (
                                                                                        <span>{player.name}</span>
                                                                                    )}
                                                                                    <span style={{ color: '#93c5fd' }}> ({player.position})</span>
                                                                                    {i < trade.tradedWith.length - 1 ? ', ' : ''}
                                                                                </span>
                                                                            );
                                                                        })}
                                                                    </div>
                                                                )}
                                                                
                                                                {/* Show who they were traded for */}
                                                                {trade.tradedFor && trade.tradedFor.length > 0 && (
                                                                    <div>
                                                                        <span style={{ color: '#93c5fd' }}>In exchange for: </span>
                                                                        {trade.tradedFor.map((player, i) => {
                                                                            const fullPlayer = gameState.players.find(p => p.id === player.id);
                                                                            return (
                                                                                <span key={i}>
                                                                                    {fullPlayer ? (
                                                                                        <span 
                                                                                            className="clickable-player"
                                                                                            onClick={() => navigateTo('playerProfile', fullPlayer)}
                                                                                        >
                                                                                            {player.name}
                                                                                        </span>
                                                                                    ) : (
                                                                                        <span>{player.name}</span>
                                                                                    )}
                                                                                    <span style={{ color: '#93c5fd' }}> ({player.position})</span>
                                                                                    {i < trade.tradedFor.length - 1 ? ', ' : ''}
                                                                                </span>
                                                                            );
                                                                        })}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                        </div>
                                    </>
                                )}
                            </div>
                            </div>
                            );
                        })()}

                        {currentView === 'teamProfile' && selectedTeamProfile && (
                            <div>
                                <button 
                                    onClick={goBack}
                                    style={{
                                        padding: '0.5rem 1rem',
                                        background: '#2563eb',
                                        color: '#fff',
                                        border: 'none',
                                        borderRadius: '0.375rem',
                                        cursor: 'pointer',
                                        marginBottom: '1rem',
                                        fontWeight: 'bold'
                                    }}
                                >
                                     Back
                                </button>
                                {(() => {
                                    const team = TEAMS.find(t => t.id === selectedTeamProfile);
                                    const teamStanding = gameState.standings.find(s => s.teamId === selectedTeamProfile);
                                    const teamRoster = gameState.players.filter(p => p.teamId === selectedTeamProfile);
                                    const teamSchedule = gameState.schedule.filter(g => 
                                        g.homeTeam === selectedTeamProfile || g.awayTeam === selectedTeamProfile
                                    );
                                    const gp = teamStanding.wins + teamStanding.losses + teamStanding.otLosses;
                                    const diff = teamStanding.goalsFor - teamStanding.goalsAgainst;

                                    return (
                                        <>
                                            <div className="card">
                                                <h2>{team.city} {team.name}</h2>
                                                <div style={{ marginBottom: '1.5rem', padding: '1rem', background: 'rgba(30, 58, 138, 0.3)', borderRadius: '0.5rem' }}>
                                                    <p style={{ marginBottom: '0.5rem' }}><strong>Conference:</strong> {team.conference}</p>
                                                    <p style={{ marginBottom: '0.5rem' }}><strong>Division:</strong> {team.division}</p>
                                                    <p style={{ marginBottom: '0.5rem' }}><strong>Record:</strong> {teamStanding.wins}-{teamStanding.losses}-{teamStanding.otLosses} ({teamStanding.points} pts)</p>
                                                    <p style={{ marginBottom: '0.5rem' }}><strong>Games Played:</strong> {gp}/82</p>
                                                    <p style={{ marginBottom: '0.5rem' }}><strong>Home:</strong> {teamStanding.home.wins}-{teamStanding.home.losses} | <strong>Away:</strong> {teamStanding.away.wins}-{teamStanding.away.losses}</p>
                                                    <p><strong>Goal Differential:</strong> {diff > 0 ? '+' : ''}{diff} ({teamStanding.goalsFor} GF, {teamStanding.goalsAgainst} GA)</p>
                                                </div>
                                            </div>

                                            <div className="card">
                                                <h2>Roster</h2>
                                                <h3>Forwards ({teamRoster.filter(p => p.position === 'F').length})</h3>
                                                <table className="stats-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Player</th>
                                                            <th className="text-center">Age</th>
                                                            <th className="text-center">OVR</th>
                                                            <th className="text-center">GP</th>
                                                            <th className="text-center">G</th>
                                                            <th className="text-center">A</th>
                                                            <th className="text-center">PTS</th>
                                                            <th className="text-center">+/-</th>
                                                            <th className="text-center">PIM</th>
                                                            <th className="text-center">TOI/G</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {teamRoster
                                                            .filter(p => p.position === 'F')
                                                            .sort((a, b) => b.stats.points - a.stats.points)
                                                            .map(player => {
                                                                const avgTOI = player.stats.gamesPlayed > 0 ? player.stats.timeOnIce / player.stats.gamesPlayed : 0;
                                                                return (
                                                                    <tr key={player.id}>
                                                                        <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                                            {player.firstName} {player.lastName}
                                                                        </td>
                                                                        <td className="text-center">{player.age}</td>
                                                                        <td className="text-center">{player.ratings.overall}</td>
                                                                        <td className="text-center">{player.stats.gamesPlayed}</td>
                                                                        <td className="text-center">{player.stats.goals}</td>
                                                                        <td className="text-center">{player.stats.assists}</td>
                                                                        <td className="text-center">{player.stats.points}</td>
                                                                        <td className="text-center">{player.stats.plusMinus > 0 ? '+' : ''}{player.stats.plusMinus}</td>
                                                                        <td className="text-center">{player.stats.pim}</td>
                                                                        <td className="text-center">{formatTOI(avgTOI)}</td>
                                                                    </tr>
                                                                );
                                                            })}
                                                    </tbody>
                                                </table>

                                                <h3>Defensemen ({teamRoster.filter(p => p.position === 'D').length})</h3>
                                                <table className="stats-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Player</th>
                                                            <th className="text-center">Age</th>
                                                            <th className="text-center">OVR</th>
                                                            <th className="text-center">GP</th>
                                                            <th className="text-center">G</th>
                                                            <th className="text-center">A</th>
                                                            <th className="text-center">PTS</th>
                                                            <th className="text-center">+/-</th>
                                                            <th className="text-center">PIM</th>
                                                            <th className="text-center">TOI/G</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {teamRoster
                                                            .filter(p => p.position === 'D')
                                                            .sort((a, b) => b.stats.points - a.stats.points)
                                                            .map(player => {
                                                                const avgTOI = player.stats.gamesPlayed > 0 ? player.stats.timeOnIce / player.stats.gamesPlayed : 0;
                                                                return (
                                                                    <tr key={player.id}>
                                                                        <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                                            {player.firstName} {player.lastName}
                                                                        </td>
                                                                        <td className="text-center">{player.age}</td>
                                                                        <td className="text-center">{player.ratings.overall}</td>
                                                                        <td className="text-center">{player.stats.gamesPlayed}</td>
                                                                        <td className="text-center">{player.stats.goals}</td>
                                                                        <td className="text-center">{player.stats.assists}</td>
                                                                        <td className="text-center">{player.stats.points}</td>
                                                                        <td className="text-center">{player.stats.plusMinus > 0 ? '+' : ''}{player.stats.plusMinus}</td>
                                                                        <td className="text-center">{player.stats.pim}</td>
                                                                        <td className="text-center">{formatTOI(avgTOI)}</td>
                                                                    </tr>
                                                                );
                                                            })}
                                                    </tbody>
                                                </table>

                                                <h3>Goalies ({teamRoster.filter(p => p.position === 'G').length})</h3>
                                                <table className="stats-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Player</th>
                                                            <th className="text-center">Age</th>
                                                            <th className="text-center">OVR</th>
                                                            <th className="text-center">GP</th>
                                                            <th className="text-center">W</th>
                                                            <th className="text-center">L</th>
                                                            <th className="text-center">SV%</th>
                                                            <th className="text-center">GAA</th>
                                                            <th className="text-center">SO</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {teamRoster
                                                            .filter(p => p.position === 'G')
                                                            .sort((a, b) => b.ratings.overall - a.ratings.overall)
                                                            .map(player => {
                                                                return (
                                                                    <tr key={player.id}>
                                                                        <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                                            {player.firstName} {player.lastName}
                                                                        </td>
                                                                        <td className="text-center">{player.age}</td>
                                                                        <td className="text-center">{player.ratings.overall}</td>
                                                                        <td className="text-center">{player.stats.gamesPlayed}</td>
                                                                        <td className="text-center">{player.stats.wins || 0}</td>
                                                                        <td className="text-center">{player.stats.losses || 0}</td>
                                                                        <td className="text-center">{player.stats.gamesPlayed > 0 ? (player.stats.savePercentage || 0).toFixed(3) : '.000'}</td>
                                                                        <td className="text-center">{player.stats.gamesPlayed > 0 ? (player.stats.gaa || 0).toFixed(2) : '0.00'}</td>
                                                                        <td className="text-center">{player.stats.shutouts || 0}</td>
                                                                    </tr>
                                                                );
                                                            })}
                                                    </tbody>
                                                </table>
                                            </div>

                                            <div className="card">
                                                <h2>Head-to-Head Records</h2>
                                                <p style={{ color: '#93c5fd', marginBottom: '1rem' }}>
                                                    Season series records against all opponents
                                                </p>
                                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '1rem' }}>
                                                    {TEAMS
                                                        .filter(t => t.id !== selectedTeamProfile)
                                                        .sort((a, b) => a.city.localeCompare(b.city))
                                                        .map(opponent => {
                                                            const h2hKey = selectedTeamProfile < opponent.id ? 
                                                                `${selectedTeamProfile}vs${opponent.id}` : 
                                                                `${opponent.id}vs${selectedTeamProfile}`;
                                                            
                                                            const h2h = gameState.headToHead?.[h2hKey];
                                                            
                                                            if (!h2h) {
                                                                return (
                                                                    <div key={opponent.id} style={{ 
                                                                        padding: '0.75rem',
                                                                        background: 'rgba(30, 58, 138, 0.2)',
                                                                        borderRadius: '0.375rem',
                                                                        border: '1px solid rgba(59, 130, 246, 0.3)'
                                                                    }}>
                                                                        <div style={{ fontWeight: 'bold', marginBottom: '0.25rem', color: '#93c5fd' }}>
                                                                            vs {opponent.city} {opponent.name}
                                                                        </div>
                                                                        <div style={{ fontSize: '0.875rem', color: '#94a3b8' }}>
                                                                            No games played yet
                                                                        </div>
                                                                    </div>
                                                                );
                                                            }
                                                            
                                                            const myWins = h2h.team1 === selectedTeamProfile ? h2h.team1Wins : h2h.team2Wins;
                                                            const theirWins = h2h.team1 === selectedTeamProfile ? h2h.team2Wins : h2h.team1Wins;
                                                            const totalGames = myWins + theirWins;
                                                            
                                                            return (
                                                                <div key={opponent.id} style={{ 
                                                                    padding: '0.75rem',
                                                                    background: myWins > theirWins ? 'rgba(34, 197, 94, 0.1)' : 
                                                                               myWins < theirWins ? 'rgba(239, 68, 68, 0.1)' : 
                                                                               'rgba(100, 116, 139, 0.1)',
                                                                    borderRadius: '0.375rem',
                                                                    border: `1px solid ${myWins > theirWins ? 'rgba(34, 197, 94, 0.3)' : 
                                                                                       myWins < theirWins ? 'rgba(239, 68, 68, 0.3)' : 
                                                                                       'rgba(100, 116, 139, 0.3)'}`
                                                                }}>
                                                                    <div style={{ fontWeight: 'bold', marginBottom: '0.25rem', color: '#e2e8f0' }}>
                                                                        vs {opponent.city} {opponent.name}
                                                                    </div>
                                                                    <div style={{ fontSize: '1.25rem', fontWeight: 'bold', marginBottom: '0.25rem' }}>
                                                                        <span style={{ color: myWins > theirWins ? '#22c55e' : '#fff' }}>{myWins}</span>
                                                                        <span style={{ color: '#64748b', margin: '0 0.5rem' }}>-</span>
                                                                        <span style={{ color: theirWins > myWins ? '#ef4444' : '#fff' }}>{theirWins}</span>
                                                                    </div>
                                                                    <div style={{ fontSize: '0.75rem', color: '#94a3b8' }}>
                                                                        {totalGames} {totalGames === 1 ? 'game' : 'games'} played
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                </div>
                                            </div>

                                            <div className="card">
                                                <h2>Schedule & Results</h2>
                                                <p style={{ color: '#93c5fd', marginBottom: '1rem' }}>
                                                    Games Played: {teamSchedule.filter(g => g.played).length} | 
                                                    Remaining: {teamSchedule.filter(g => !g.played).length} | 
                                                    Total: 82
                                                </p>
                                                <table className="stats-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Date</th>
                                                            <th>Opponent</th>
                                                            <th className="text-center">Home/Away</th>
                                                            <th className="text-center">Result</th>
                                                            <th className="text-center">Score</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {teamSchedule.map((game, idx) => {
                                                            const isHome = game.homeTeam === selectedTeamProfile;
                                                            const opponent = TEAMS.find(t => t.id === (isHome ? game.awayTeam : game.homeTeam));
                                                            const teamScore = isHome ? game.homeScore : game.awayScore;
                                                            const oppScore = isHome ? game.awayScore : game.homeScore;
                                                            let result = '';
                                                            if (game.played) {
                                                                if (teamScore > oppScore) result = 'W';
                                                                else if (teamScore < oppScore) result = 'L';
                                                                else result = 'T';
                                                            }

                                                            return (
                                                                <tr key={idx} style={game.played ? { cursor: 'pointer' } : {}} 
                                                                    onClick={() => game.played && navigateTo('gameDetail', game)}>
                                                                    <td>{game.date ? game.date.toLocaleDateString() : 'TBD'}</td>
                                                                    <td>{opponent.city} {opponent.name}</td>
                                                                    <td className="text-center">{isHome ? 'HOME' : 'AWAY'}</td>
                                                                    <td className="text-center" style={{ 
                                                                        fontWeight: 'bold',
                                                                        color: result === 'W' ? '#22c55e' : result === 'L' ? '#ef4444' : '#93c5fd'
                                                                    }}>
                                                                        {game.played ? result : '-'}
                                                                    </td>
                                                                    <td className="text-center" style={{ fontWeight: game.played ? 'bold' : 'normal' }}>
                                                                        {game.played ? `${teamScore} - ${oppScore}` : '-'}
                                                                    </td>
                                                                </tr>
                                                            );
                                                        })}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </>
                                    );
                                })()}
                            </div>
                        )}

                        {currentView === 'injuries' && gameState && (
                            <div>
                                <div className="card">
                                    <h2> Injury Report</h2>
                                    <p style={{ color: '#93c5fd', marginBottom: '1.5rem' }}>
                                        Current injuries across the league. Injured players cannot play and are replaced by backups in the lineup.
                                    </p>
                                    
                                    {gameState.players.filter(p => p.injury.injured).length === 0 ? (
                                        <p style={{ color: '#22c55e', textAlign: 'center', padding: '2rem' }}>
                                             No players currently injured! Everyone is healthy.
                                        </p>
                                    ) : (
                                        TEAMS.map(team => {
                                            const teamInjuries = gameState.players.filter(p => p.teamId === team.id && p.injury.injured);
                                            if (teamInjuries.length === 0) return null;
                                            
                                            return (
                                                <div key={team.id} style={{ marginBottom: '2rem' }}>
                                                    <h3 style={{ color: '#22d3ee', marginBottom: '1rem' }}>
                                                        {team.city} {team.name} ({teamInjuries.length} injured)
                                                    </h3>
                                                    <table className="stats-table">
                                                        <thead>
                                                            <tr>
                                                                <th>Player</th>
                                                                <th className="text-center">Pos</th>
                                                                <th className="text-center">Status</th>
                                                                <th>Injury Type</th>
                                                                <th className="text-center">Days Out</th>
                                                                <th className="text-center">GP</th>
                                                                <th className="text-center">PTS</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {teamInjuries
                                                                .sort((a, b) => {
                                                                    const order = { 'Retired': 0, 'Out': 1, 'IR': 2, 'DTD': 3 };
                                                                    return (order[getPlayerStatus(a)] || 4) - (order[getPlayerStatus(b)] || 4);
                                                                })
                                                                .map(player => {
                                                                    const status = getPlayerStatus(player);
                                                                    const statusColor = status === 'Retired' ? '#ef4444' : 
                                                                                      status === 'Out' ? '#f59e0b' : 
                                                                                      status === 'IR' ? '#f97316' : '#fbbf24';
                                                                    return (
                                                                        <tr key={player.id}>
                                                                            <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                                                {player.firstName} {player.lastName}
                                                                            </td>
                                                                            <td className="text-center">{player.position}</td>
                                                                            <td className="text-center">
                                                                                <span style={{ color: statusColor, fontWeight: 'bold' }}>
                                                                                    {status}
                                                                                </span>
                                                                            </td>
                                                                            <td>
                                                                                {player.injury.type}
                                                                                {player.injury.severity !== 'Day-to-Day' && (
                                                                                    <span style={{ color: '#64748b', fontSize: '0.875rem', marginLeft: '0.5rem' }}>
                                                                                        ({player.injury.severity})
                                                                                    </span>
                                                                                )}
                                                                            </td>
                                                                            <td className="text-center">
                                                                                {player.injury.isCareerEnding ? '' : 
                                                                                 player.injury.severity === 'Season-Ending' ? 'Season' :
                                                                                 player.injury.daysUntilReturn}
                                                                            </td>
                                                                            <td className="text-center">{player.stats.gamesPlayed}</td>
                                                                            <td className="text-center">{player.stats.points || 0}</td>
                                                                        </tr>
                                                                    );
                                                                })}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            );
                                        }).filter(Boolean)
                                    )}
                                </div>
                                
                                <div className="card" style={{ background: 'rgba(30, 58, 138, 0.3)' }}>
                                    <h3 style={{ color: '#22d3ee' }}>Injury Information</h3>
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '1rem', marginTop: '1rem' }}>
                                        <div>
                                            <h4 style={{ color: '#fbbf24' }}>Day-to-Day (DTD)</h4>
                                            <p style={{ color: '#e2e8f0', fontSize: '0.875rem' }}>1-7 days. Player will return soon.</p>
                                        </div>
                                        <div>
                                            <h4 style={{ color: '#f97316' }}>Week-to-Week / Out</h4>
                                            <p style={{ color: '#e2e8f0', fontSize: '0.875rem' }}>7-14 days. Short-term absence.</p>
                                        </div>
                                        <div>
                                            <h4 style={{ color: '#f59e0b' }}>Month-to-Month (IR)</h4>
                                            <p style={{ color: '#e2e8f0', fontSize: '0.875rem' }}>15-60 days. Medium-term injury.</p>
                                        </div>
                                        <div>
                                            <h4 style={{ color: '#f59e0b' }}>Season-Ending</h4>
                                            <p style={{ color: '#e2e8f0', fontSize: '0.875rem' }}>Out for remainder of season.</p>
                                        </div>
                                        <div>
                                            <h4 style={{ color: '#ef4444' }}>Career-Ending (Retired)</h4>
                                            <p style={{ color: '#e2e8f0', fontSize: '0.875rem' }}>Player has retired due to injury. Very rare.</p>
                                        </div>
                                    </div>
                                    <p style={{ color: '#93c5fd', marginTop: '1rem', fontSize: '0.875rem' }}>
                                        <strong>Injury System:</strong> ~0.15% chance per game (1 in ~7 games). Higher for forwards, older players, and high TOI.<br/>
                                        <strong>Load Management:</strong> Healthy players may be rested (~1% chance) to prevent fatigue. Stars rest less.<br/>
                                        <strong>Injured players cannot play</strong> - backups fill in until they return.<br/>
                                        <strong>Result:</strong> Most starters play 70-80 games, not all 82. Elite stars may reach 82.
                                    </p>
                                </div>
                            </div>
                        )}

                        {currentView === 'callups' && gameState && (() => {
                            const userNHLRoster = gameState.players.filter(p => 
                                p.teamId === userTeamId && 
                                p.roster === 'nhl'
                            ).sort((a, b) => b.ratings.overall - a.ratings.overall);
                            
                            const farmTeam = FARM_TEAMS.find(t => t.nhlAffiliation === userTeamId);
                            const userFarmRoster = farmTeam ? gameState.players.filter(p => 
                                p.teamId === farmTeam.id && 
                                p.roster === 'farm'
                            ).sort((a, b) => b.ratings.overall - a.ratings.overall) : [];
                            
                            return (
                            <div className="card">
                                <h2> Call-Ups & Send-Downs</h2>
                                <p style={{ color: '#93c5fd', marginBottom: '2rem' }}>
                                    Manage your roster between NHL and farm team. Call up prospects or send down players.
                                </p>
                                
                                {/* NHL Roster */}
                                <div style={{ marginBottom: '3rem' }}>
                                    <h3 style={{ color: '#22c55e', marginBottom: '1rem' }}>
                                        NHL Roster ({userNHLRoster.length} / 23)
                                    </h3>
                                    
                                    {['F', 'D', 'G'].map(pos => {
                                        const players = userNHLRoster.filter(p => p.position === pos);
                                        const posName = pos === 'F' ? 'Forwards' : pos === 'D' ? 'Defensemen' : 'Goalies';
                                        const maxCount = pos === 'F' ? 13 : pos === 'D' ? 7 : 3;
                                        
                                        return (
                                            <div key={pos} style={{ marginBottom: '2rem' }}>
                                                <h4 style={{ color: '#93c5fd' }}>
                                                    {posName} ({players.length} / {maxCount})
                                                </h4>
                                                <div style={{ display: 'grid', gap: '0.75rem' }}>
                                                    {players.map(player => (
                                                        <div key={player.id} style={{
                                                            display: 'flex',
                                                            justifyContent: 'space-between',
                                                            alignItems: 'center',
                                                            padding: '1rem',
                                                            background: 'rgba(30, 58, 138, 0.3)',
                                                            borderRadius: '0.375rem',
                                                            border: '1px solid rgba(59, 130, 246, 0.3)'
                                                        }}>
                                                            <div style={{ flex: 1 }}>
                                                                <div style={{ fontWeight: 'bold' }}>
                                                                    {player.firstName} {player.lastName}
                                                                    <span style={{ 
                                                                        marginLeft: '0.5rem',
                                                                        padding: '0.25rem 0.5rem',
                                                                        background: 'rgba(59, 130, 246, 0.2)',
                                                                        borderRadius: '0.25rem',
                                                                        fontSize: '0.75rem'
                                                                    }}>
                                                                        {player.position}
                                                                    </span>
                                                                    {player.linePosition && (
                                                                        <span style={{ 
                                                                            marginLeft: '0.5rem',
                                                                            fontSize: '0.75rem',
                                                                            color: '#93c5fd'
                                                                        }}>
                                                                            {player.position === 'G' ? (player.dressed ? 'Dressed' : 'Scratch') : 
                                                                             player.lineNumber > 0 ? `Line ${player.lineNumber}` : 'Scratch'}
                                                                        </span>
                                                                    )}
                                                                </div>
                                                                <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginTop: '0.25rem' }}>
                                                                    OVR: {player.ratings.overall} | Age: {player.age}
                                                                    {player.injury.injured && (
                                                                        <span style={{ 
                                                                            marginLeft: '0.5rem',
                                                                            color: '#f87171',
                                                                            fontWeight: 'bold'
                                                                        }}>
                                                                            (Injured - {player.injury.type})
                                                                        </span>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            <button
                                                                onClick={() => sendDownPlayer(player.id)}
                                                                disabled={player.injury.injured}
                                                                style={{
                                                                    padding: '0.5rem 1rem',
                                                                    background: player.injury.injured ? '#374151' : '#ef4444',
                                                                    color: 'white',
                                                                    border: 'none',
                                                                    borderRadius: '0.375rem',
                                                                    cursor: player.injury.injured ? 'not-allowed' : 'pointer',
                                                                    fontSize: '0.875rem',
                                                                    fontWeight: 'bold',
                                                                    opacity: player.injury.injured ? 0.5 : 1
                                                                }}
                                                            >
                                                                 Send Down
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                
                                {/* Farm Team Roster */}
                                <div style={{ 
                                    borderTop: '2px solid rgba(59, 130, 246, 0.3)',
                                    paddingTop: '2rem'
                                }}>
                                    <h3 style={{ color: '#fbbf24', marginBottom: '1rem' }}>
                                        Farm Team ({farmTeam?.city} {farmTeam?.name}) - {userFarmRoster.length} / 23
                                    </h3>
                                    
                                    {['F', 'D', 'G'].map(pos => {
                                        const players = userFarmRoster.filter(p => p.position === pos);
                                        const posName = pos === 'F' ? 'Forwards' : pos === 'D' ? 'Defensemen' : 'Goalies';
                                        
                                        return (
                                            <div key={pos} style={{ marginBottom: '2rem' }}>
                                                <h4 style={{ color: '#93c5fd' }}>
                                                    {posName} ({players.length})
                                                </h4>
                                                <div style={{ display: 'grid', gap: '0.75rem' }}>
                                                    {players.map(player => (
                                                        <div key={player.id} style={{
                                                            display: 'flex',
                                                            justifyContent: 'space-between',
                                                            alignItems: 'center',
                                                            padding: '1rem',
                                                            background: 'rgba(251, 191, 36, 0.1)',
                                                            borderRadius: '0.375rem',
                                                            border: '1px solid rgba(251, 191, 36, 0.3)'
                                                        }}>
                                                            <div style={{ flex: 1 }}>
                                                                <div style={{ fontWeight: 'bold' }}>
                                                                    {player.firstName} {player.lastName}
                                                                    <span style={{ 
                                                                        marginLeft: '0.5rem',
                                                                        padding: '0.25rem 0.5rem',
                                                                        background: 'rgba(251, 191, 36, 0.2)',
                                                                        borderRadius: '0.25rem',
                                                                        fontSize: '0.75rem'
                                                                    }}>
                                                                        {player.position}
                                                                    </span>
                                                                </div>
                                                                <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginTop: '0.25rem' }}>
                                                                    OVR: {player.ratings.overall} | Age: {player.age} | POT: {player.ratings.potential}
                                                                </div>
                                                            </div>
                                                            <button
                                                                onClick={() => callUpPlayer(player.id)}
                                                                style={{
                                                                    padding: '0.5rem 1rem',
                                                                    background: '#22c55e',
                                                                    color: 'white',
                                                                    border: 'none',
                                                                    borderRadius: '0.375rem',
                                                                    cursor: 'pointer',
                                                                    fontSize: '0.875rem',
                                                                    fontWeight: 'bold'
                                                                }}
                                                            >
                                                                 Call Up
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                
                                {/* Info Box */}
                                <div style={{ 
                                    marginTop: '2rem',
                                    padding: '1rem',
                                    background: 'rgba(59, 130, 246, 0.1)',
                                    borderRadius: '0.5rem',
                                    border: '1px solid rgba(59, 130, 246, 0.3)'
                                }}>
                                    <h4 style={{ color: '#60a5fa', marginBottom: '0.5rem' }}> Roster Rules</h4>
                                    <ul style={{ marginLeft: '1.5rem', color: '#93c5fd', fontSize: '0.875rem' }}>
                                        <li>NHL roster: 13 forwards + 7 defensemen + 3 goalies = 23 players</li>
                                        <li>Farm roster: Same structure (23 players)</li>
                                        <li>Cannot send down injured players (must wait until healthy)</li>
                                        <li>Called-up players start as scratches - assign them to lines</li>
                                        <li>Injured players auto-call-up replacements from farm</li>
                                        <li>When injured players heal, farm call-ups auto-return</li>
                                    </ul>
                                </div>
                            </div>
                            );
                        })()}

                        {currentView === 'calendar' && gameState && (
                            <div>
                                <div className="card">
                                    <h2> Game Calendar</h2>
                                    <p style={{ color: '#93c5fd', marginBottom: '1.5rem' }}>
                                        Browse games by month and date
                                    </p>
                                    
                                    {(() => {
                                        // Get all unique dates with games, organized by month
                                        const gamesByMonth = {};
                                        gameState.schedule.filter(g => g.played && g.date).forEach(game => {
                                            const monthYear = game.date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                                            const dateStr = game.date.toLocaleDateString();
                                            
                                            if (!gamesByMonth[monthYear]) {
                                                gamesByMonth[monthYear] = {
                                                    sortDate: game.date,
                                                    dates: {}
                                                };
                                            }
                                            
                                            if (!gamesByMonth[monthYear].dates[dateStr]) {
                                                gamesByMonth[monthYear].dates[dateStr] = {
                                                    date: game.date,
                                                    games: []
                                                };
                                            }
                                            
                                            gamesByMonth[monthYear].dates[dateStr].games.push(game);
                                        });
                                        
                                        const sortedMonths = Object.keys(gamesByMonth).sort((a, b) => 
                                            gamesByMonth[b].sortDate - gamesByMonth[a].sortDate
                                        );
                                        
                                        return (
                                            <>
                                                {sortedMonths.map(monthYear => {
                                                    const monthData = gamesByMonth[monthYear];
                                                    const sortedDates = Object.keys(monthData.dates).sort((a, b) => 
                                                        monthData.dates[b].date - monthData.dates[a].date
                                                    );
                                                    const totalGames = sortedDates.reduce((sum, date) => sum + monthData.dates[date].games.length, 0);
                                                    
                                                    return (
                                                        <div key={monthYear} style={{ marginBottom: '2rem' }}>
                                                            <h3 style={{ 
                                                                color: '#22d3ee', 
                                                                marginBottom: '1rem',
                                                                paddingBottom: '0.5rem',
                                                                borderBottom: '2px solid rgba(34, 211, 238, 0.3)'
                                                            }}>
                                                                {monthYear} ({sortedDates.length} game days, {totalGames} games)
                                                            </h3>
                                                            
                                                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(180px, 1fr))', gap: '0.5rem', marginBottom: '1.5rem' }}>
                                                                {sortedDates.map(dateStr => {
                                                                    const dateInfo = monthData.dates[dateStr];
                                                                    const isSelected = selectedDate === dateStr;
                                                                    
                                                                    return (
                                                                        <button
                                                                            key={dateStr}
                                                                            onClick={() => setSelectedDate(dateStr)}
                                                                            style={{
                                                                                padding: '0.75rem',
                                                                                background: isSelected ? '#22d3ee' : 'rgba(30, 58, 138, 0.3)',
                                                                                border: isSelected ? '2px solid #22d3ee' : '1px solid rgba(100, 116, 139, 0.3)',
                                                                                borderRadius: '0.5rem',
                                                                                color: isSelected ? '#0f172a' : '#fff',
                                                                                cursor: 'pointer',
                                                                                textAlign: 'left',
                                                                                transition: 'all 0.2s',
                                                                                fontWeight: isSelected ? 'bold' : 'normal'
                                                                            }}
                                                                            onMouseEnter={(e) => { 
                                                                                if (!isSelected) {
                                                                                    e.target.style.background = 'rgba(30, 58, 138, 0.5)';
                                                                                    e.target.style.borderColor = 'rgba(34, 211, 238, 0.5)';
                                                                                }
                                                                            }}
                                                                            onMouseLeave={(e) => { 
                                                                                if (!isSelected) {
                                                                                    e.target.style.background = 'rgba(30, 58, 138, 0.3)';
                                                                                    e.target.style.borderColor = 'rgba(100, 116, 139, 0.3)';
                                                                                }
                                                                            }}
                                                                        >
                                                                            <div style={{ fontWeight: 'bold', marginBottom: '0.25rem', color: isSelected ? '#0f172a' : '#fff' }}>
                                                                                {dateInfo.date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
                                                                            </div>
                                                                            <div style={{ fontSize: '0.875rem', color: isSelected ? '#0f172a' : '#93c5fd' }}>
                                                                                {dateInfo.games.length} game{dateInfo.games.length !== 1 ? 's' : ''}
                                                                            </div>
                                                                        </button>
                                                                    );
                                                                })}
                                                            </div>
                                                            
                                                            {selectedDate && monthData.dates[selectedDate] && (
                                                                <div style={{ 
                                                                    padding: '1.5rem', 
                                                                    background: 'rgba(34, 211, 238, 0.1)', 
                                                                    borderRadius: '0.5rem',
                                                                    border: '2px solid #22d3ee',
                                                                    marginTop: '1rem'
                                                                }}>
                                                                    <h4 style={{ color: '#22d3ee', marginBottom: '1rem', fontSize: '1.2rem' }}>
                                                                         Games on {selectedDate} ({monthData.dates[selectedDate].games.length} games)
                                                                    </h4>
                                                                    <table className="stats-table">
                                                                        <thead>
                                                                            <tr>
                                                                                <th>Away Team</th>
                                                                                <th className="text-center">Score</th>
                                                                                <th>Home Team</th>
                                                                                <th className="text-center">Result</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            {monthData.dates[selectedDate].games.map((game, idx) => {
                                                                                const homeTeam = TEAMS.find(t => t.id === game.homeTeam);
                                                                                const awayTeam = TEAMS.find(t => t.id === game.awayTeam);
                                                                                const homeWon = game.homeScore > game.awayScore;
                                                                                
                                                                                return (
                                                                                    <tr 
                                                                                        key={idx} 
                                                                                        style={{ cursor: 'pointer' }}
                                                                                        onClick={() => navigateTo('gameDetail', game)}
                                                                                    >
                                                                                        <td style={{ fontWeight: homeWon ? 'normal' : 'bold' }}>
                                                                                            {awayTeam.city} {awayTeam.name}
                                                                                        </td>
                                                                                        <td className="text-center" style={{ fontWeight: 'bold', fontSize: '1.1rem' }}>
                                                                                            <span style={{ color: homeWon ? '#e2e8f0' : '#22c55e' }}>{game.awayScore}</span>
                                                                                            {' - '}
                                                                                            <span style={{ color: homeWon ? '#22c55e' : '#e2e8f0' }}>{game.homeScore}</span>
                                                                                        </td>
                                                                                        <td style={{ fontWeight: homeWon ? 'bold' : 'normal' }}>
                                                                                            {homeTeam.city} {homeTeam.name}
                                                                                        </td>
                                                                                        <td className="text-center">
                                                                                            <span style={{ 
                                                                                                padding: '0.25rem 0.5rem',
                                                                                                borderRadius: '0.25rem',
                                                                                                fontSize: '0.75rem',
                                                                                                background: homeWon ? '#22c55e' : '#ef4444',
                                                                                                fontWeight: 'bold'
                                                                                            }}>
                                                                                                {homeWon ? 'HOME WIN' : 'AWAY WIN'}
                                                                                            </span>
                                                                                        </td>
                                                                                    </tr>
                                                                                );
                                                                            })}
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                            </>
                                        );
                                    })()}
                                </div>
                            </div>
                        )}

                        {currentView === 'gameDetail' && selectedGame && (
                            <div>
                                <button 
                                    onClick={goBack}
                                    style={{
                                        padding: '0.5rem 1rem',
                                        background: '#2563eb',
                                        color: '#fff',
                                        border: 'none',
                                        borderRadius: '0.375rem',
                                        cursor: 'pointer',
                                        marginBottom: '1rem',
                                        fontWeight: 'bold'
                                    }}
                                >
                                     Back
                                </button>
                                
                                <div className="card">
                                    <h2>Game Summary</h2>
                                    <p style={{ color: '#93c5fd', marginBottom: '1rem' }}>
                                        {selectedGame.date ? selectedGame.date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) : 'Regular Season Game'}
                                    </p>
                                    
                                    <div style={{ 
                                        display: 'flex', 
                                        justifyContent: 'space-between', 
                                        alignItems: 'center',
                                        padding: '2rem',
                                        background: 'rgba(30, 58, 138, 0.3)',
                                        borderRadius: '0.5rem',
                                        marginBottom: '2rem'
                                    }}>
                                        {(() => {
                                            const homeTeam = TEAMS.find(t => t.id === selectedGame.homeTeam);
                                            const awayTeam = TEAMS.find(t => t.id === selectedGame.awayTeam);
                                            const homeWon = selectedGame.homeScore > selectedGame.awayScore;
                                            
                                            return (
                                                <>
                                                    <div style={{ textAlign: 'center', flex: 1 }}>
                                                        <div style={{ fontSize: '1.5rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                                            {awayTeam.city} {awayTeam.name}
                                                        </div>
                                                        <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.5rem' }}>
                                                            AWAY
                                                        </div>
                                                        <div style={{ 
                                                            fontSize: '4rem', 
                                                            fontWeight: 'bold',
                                                            color: !homeWon ? '#22c55e' : '#fff'
                                                        }}>
                                                            {selectedGame.awayScore}
                                                        </div>
                                                    </div>
                                                    <div style={{ fontSize: '3rem', color: '#93c5fd', padding: '0 2rem' }}>
                                                        @
                                                    </div>
                                                    <div style={{ textAlign: 'center', flex: 1 }}>
                                                        <div style={{ fontSize: '1.5rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                                            {homeTeam.city} {homeTeam.name}
                                                        </div>
                                                        <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.5rem' }}>
                                                            HOME
                                                        </div>
                                                        <div style={{ 
                                                            fontSize: '4rem', 
                                                            fontWeight: 'bold',
                                                            color: homeWon ? '#22c55e' : '#fff'
                                                        }}>
                                                            {selectedGame.homeScore}
                                                        </div>
                                                    </div>
                                                </>
                                            );
                                        })()}
                                    </div>
                                    
                                    {/* Winner Badge */}
                                    {(() => {
                                        const homeTeam = TEAMS.find(t => t.id === selectedGame.homeTeam);
                                        const awayTeam = TEAMS.find(t => t.id === selectedGame.awayTeam);
                                        const homeWon = selectedGame.homeScore > selectedGame.awayScore;
                                        const winner = homeWon ? homeTeam : awayTeam;
                                        
                                        return (
                                            <div style={{ 
                                                padding: '1rem',
                                                background: 'rgba(34, 197, 94, 0.15)',
                                                borderRadius: '0.5rem',
                                                marginBottom: '2rem',
                                                textAlign: 'center',
                                                border: '2px solid #22c55e'
                                            }}>
                                                <div style={{ color: '#22c55e', fontSize: '1.2rem', fontWeight: 'bold' }}>
                                                     WINNER: {winner.city} {winner.name}
                                                </div>
                                            </div>
                                        );
                                    })()}
                                    
                                    {/* Period-by-Period Scoring Summary */}
                                    {selectedGame.details && selectedGame.details.scoringSummary && selectedGame.details.scoringSummary.some(p => p.goals.length > 0) && (
                                        (() => {
                                            const homeTeam = TEAMS.find(t => t.id === selectedGame.homeTeam);
                                            const awayTeam = TEAMS.find(t => t.id === selectedGame.awayTeam);
                                            
                                            // Calculate pre-game stats for running totals
                                            const getPreGameStats = (playerId) => {
                                                const allGames = gameState.schedule.filter(g => g.played && g.date < selectedGame.date);
                                                let goals = 0;
                                                let assists = 0;
                                                
                                                allGames.forEach(game => {
                                                    if (game.details) {
                                                        const homeStats = game.details.homePlayerStats?.find(ps => ps.player.id === playerId);
                                                        const awayStats = game.details.awayPlayerStats?.find(ps => ps.player.id === playerId);
                                                        if (homeStats) {
                                                            goals += homeStats.goals;
                                                            assists += homeStats.assists;
                                                        }
                                                        if (awayStats) {
                                                            goals += awayStats.goals;
                                                            assists += awayStats.assists;
                                                        }
                                                    }
                                                });
                                                
                                                return { goals, assists };
                                            };
                                            
                                            return (
                                                <div style={{ marginBottom: '2rem' }}>
                                                    <h3 style={{ color: '#22d3ee', marginBottom: '1.5rem' }}> Scoring Summary</h3>
                                                    {selectedGame.details.scoringSummary.map((period, idx) => {
                                                        if (period.goals.length === 0) return null;
                                                        
                                                        // Track running totals within this game
                                                        const gameRunningTotals = {};
                                                        
                                                        return (
                                                            <div key={period.period} style={{ 
                                                                marginBottom: '1.5rem',
                                                                padding: '1rem',
                                                                background: 'rgba(30, 58, 138, 0.2)',
                                                                borderRadius: '0.5rem',
                                                                border: '1px solid rgba(59, 130, 246, 0.3)'
                                                            }}>
                                                                <h4 style={{ color: '#93c5fd', marginBottom: '1rem', fontSize: '1rem' }}>
                                                                    {period.period === 1 ? '1st' : period.period === 2 ? '2nd' : '3rd'} Period
                                                                </h4>
                                                                {period.goals.map((goal, goalIdx) => {
                                                                    const team = goal.team === 'home' ? homeTeam : awayTeam;
                                                                    const preGameStats = getPreGameStats(goal.scorer.id);
                                                                    
                                                                    // Initialize running total for this player if not exists
                                                                    if (!gameRunningTotals[goal.scorer.id]) {
                                                                        gameRunningTotals[goal.scorer.id] = { goals: 0, assists: 0 };
                                                                    }
                                                                    gameRunningTotals[goal.scorer.id].goals++;
                                                                    
                                                                    const seasonGoalTotal = preGameStats.goals + gameRunningTotals[goal.scorer.id].goals;
                                                                    
                                                                    return (
                                                                        <div key={goalIdx} style={{ 
                                                                            marginBottom: goalIdx < period.goals.length - 1 ? '0.75rem' : '0',
                                                                            paddingBottom: goalIdx < period.goals.length - 1 ? '0.75rem' : '0',
                                                                            borderBottom: goalIdx < period.goals.length - 1 ? '1px solid rgba(100, 116, 139, 0.3)' : 'none'
                                                                        }}>
                                                                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '0.25rem' }}>
                                                                                <span style={{ 
                                                                                    padding: '0.25rem 0.5rem',
                                                                                    background: goal.team === 'home' ? 'rgba(34, 197, 94, 0.2)' : 'rgba(59, 130, 246, 0.2)',
                                                                                    borderRadius: '0.25rem',
                                                                                    fontSize: '0.75rem',
                                                                                    fontWeight: 'bold',
                                                                                    color: goal.team === 'home' ? '#22c55e' : '#3b82f6'
                                                                                }}>
                                                                                    {team.abbreviation}
                                                                                </span>
                                                                                <span style={{ fontWeight: 'bold', color: '#fff' }}>
                                                                                    {goal.scorer.name}
                                                                                </span>
                                                                                <span style={{ 
                                                                                    fontSize: '0.85rem',
                                                                                    color: '#22c55e',
                                                                                    fontWeight: 'bold'
                                                                                }}>
                                                                                    ({seasonGoalTotal})
                                                                                </span>
                                                                            </div>
                                                                            {goal.assists.length > 0 && (
                                                                                <div style={{ 
                                                                                    fontSize: '0.875rem', 
                                                                                    color: '#94a3b8',
                                                                                    marginLeft: '2.5rem'
                                                                                }}>
                                                                                    Assists: {goal.assists.map((assist, aIdx) => {
                                                                                        const assistPreGameStats = getPreGameStats(assist.id);
                                                                                        
                                                                                        if (!gameRunningTotals[assist.id]) {
                                                                                            gameRunningTotals[assist.id] = { goals: 0, assists: 0 };
                                                                                        }
                                                                                        gameRunningTotals[assist.id].assists++;
                                                                                        
                                                                                        const seasonAssistTotal = assistPreGameStats.assists + gameRunningTotals[assist.id].assists;
                                                                                        
                                                                                        return (
                                                                                            <span key={assist.id}>
                                                                                                {assist.name} <span style={{ color: '#22c55e', fontWeight: 'bold' }}>({seasonAssistTotal})</span>
                                                                                                {aIdx < goal.assists.length - 1 ? ', ' : ''}
                                                                                            </span>
                                                                                        );
                                                                                    })}
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    );
                                                                })}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            );
                                        })()
                                    )}
                                    
                                    {/* Game Stats - Check if we have per-game stats */}
                                    {selectedGame.details && selectedGame.details.homePlayerStats ? (
                                        // Show per-game stats with tabs
                                        (() => {
                                            const homeTeam = TEAMS.find(t => t.id === selectedGame.homeTeam);
                                            const awayTeam = TEAMS.find(t => t.id === selectedGame.awayTeam);
                                            
                                            return (
                                                <>
                                                    {/* Team Tabs */}
                                                    <div style={{ 
                                                        display: 'flex', 
                                                        gap: '0.5rem',
                                                        marginBottom: '1.5rem',
                                                        borderBottom: '2px solid rgba(100, 116, 139, 0.3)'
                                                    }}>
                                                        <button
                                                            onClick={() => setGameDetailTeamTab('away')}
                                                            style={{
                                                                padding: '0.75rem 1.5rem',
                                                                background: gameDetailTeamTab === 'away' ? 'rgba(34, 211, 238, 0.2)' : 'transparent',
                                                                border: 'none',
                                                                borderBottom: gameDetailTeamTab === 'away' ? '3px solid #22d3ee' : '3px solid transparent',
                                                                color: gameDetailTeamTab === 'away' ? '#22d3ee' : '#94a3b8',
                                                                cursor: 'pointer',
                                                                fontWeight: gameDetailTeamTab === 'away' ? 'bold' : 'normal',
                                                                fontSize: '1rem',
                                                                transition: 'all 0.2s'
                                                            }}
                                                        >
                                                            {awayTeam.city} {awayTeam.name} (Away)
                                                        </button>
                                                        <button
                                                            onClick={() => setGameDetailTeamTab('home')}
                                                            style={{
                                                                padding: '0.75rem 1.5rem',
                                                                background: gameDetailTeamTab === 'home' ? 'rgba(34, 211, 238, 0.2)' : 'transparent',
                                                                border: 'none',
                                                                borderBottom: gameDetailTeamTab === 'home' ? '3px solid #22d3ee' : '3px solid transparent',
                                                                color: gameDetailTeamTab === 'home' ? '#22d3ee' : '#94a3b8',
                                                                cursor: 'pointer',
                                                                fontWeight: gameDetailTeamTab === 'home' ? 'bold' : 'normal',
                                                                fontSize: '1rem',
                                                                transition: 'all 0.2s'
                                                            }}
                                                        >
                                                            {homeTeam.city} {homeTeam.name} (Home)
                                                        </button>
                                                    </div>
                                                    
                                                    {/* Away Team Stats */}
                                                    {gameDetailTeamTab === 'away' && (
                                                        <div>
                                                            {/* Skaters */}
                                                            <h4 style={{ color: '#93c5fd', marginTop: '1rem', marginBottom: '0.75rem' }}>Skaters</h4>
                                                            <table className="stats-table">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Player</th>
                                                                        <th className="text-center">G</th>
                                                                        <th className="text-center">A</th>
                                                                        <th className="text-center">PTS</th>
                                                                        <th className="text-center">+/-</th>
                                                                        <th className="text-center">SOG</th>
                                                                        <th className="text-center">TOI</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {selectedGame.details.awayPlayerStats.filter(ps => ps.player.position !== 'G').sort((a, b) => b.points - a.points).map(ps => (
                                                                        <tr key={ps.player.id} style={{ background: ps.points > 0 ? 'rgba(34, 197, 94, 0.1)' : 'transparent' }}>
                                                                            <td>
                                                                                <span style={{ cursor: 'pointer', color: '#22d3ee' }} onClick={() => navigateTo('playerProfile', ps.player)}>
                                                                                    {ps.player.firstName} {ps.player.lastName}
                                                                                </span>
                                                                                <span style={{ color: '#64748b', marginLeft: '0.5rem', fontSize: '0.85em' }}>
                                                                                    {ps.player.position}
                                                                                </span>
                                                                            </td>
                                                                            <td className="text-center" style={{ fontWeight: ps.goals > 0 ? 'bold' : 'normal', color: ps.goals > 0 ? '#22c55e' : 'inherit' }}>{ps.goals}</td>
                                                                            <td className="text-center" style={{ fontWeight: ps.assists > 0 ? 'bold' : 'normal', color: ps.assists > 0 ? '#22c55e' : 'inherit' }}>{ps.assists}</td>
                                                                            <td className="text-center" style={{ fontWeight: ps.points > 0 ? 'bold' : 'normal', color: ps.points > 0 ? '#22c55e' : 'inherit' }}>{ps.points}</td>
                                                                            <td className="text-center">{ps.plusMinus > 0 ? '+' : ''}{ps.plusMinus}</td>
                                                                            <td className="text-center">{ps.shots}</td>
                                                                            <td className="text-center">{formatTOI(ps.toi)}</td>
                                                                        </tr>
                                                                    ))}
                                                                </tbody>
                                                            </table>
                                                            
                                                            {/* Goalies */}
                                                            <h4 style={{ color: '#93c5fd', marginTop: '1.5rem', marginBottom: '0.75rem' }}>Goalies</h4>
                                                            <table className="stats-table">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Player</th>
                                                                        <th className="text-center">SA</th>
                                                                        <th className="text-center">SV</th>
                                                                        <th className="text-center">GA</th>
                                                                        <th className="text-center">SV%</th>
                                                                        <th className="text-center">Result</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {selectedGame.details.awayPlayerStats.filter(ps => ps.player.position === 'G' && ps.shotsAgainst > 0).map(ps => {
                                                                        const svPct = ps.shotsAgainst > 0 ? (ps.saves / ps.shotsAgainst).toFixed(3) : '.000';
                                                                        const isWinner = selectedGame.awayScore > selectedGame.homeScore;
                                                                        return (
                                                                            <tr key={ps.player.id}>
                                                                                <td>
                                                                                    <span style={{ cursor: 'pointer', color: '#22d3ee' }} onClick={() => navigateTo('playerProfile', ps.player)}>
                                                                                        {ps.player.firstName} {ps.player.lastName}
                                                                                    </span>
                                                                                </td>
                                                                                <td className="text-center">{ps.shotsAgainst}</td>
                                                                                <td className="text-center">{ps.saves}</td>
                                                                                <td className="text-center">{ps.goalsAgainst}</td>
                                                                                <td className="text-center">{svPct}</td>
                                                                                <td className="text-center">
                                                                                    <span style={{ 
                                                                                        padding: '0.25rem 0.5rem',
                                                                                        borderRadius: '0.25rem',
                                                                                        fontSize: '0.75rem',
                                                                                        fontWeight: 'bold',
                                                                                        background: isWinner ? '#22c55e' : '#ef4444'
                                                                                    }}>
                                                                                        {isWinner ? 'W' : 'L'}
                                                                                    </span>
                                                                                </td>
                                                                            </tr>
                                                                        );
                                                                    })}
                                                                </tbody>
                                                            </table>
                                                            
                                                            {/* DNP Players */}
                                                            {selectedGame.details.awayScratched?.length > 0 && (
                                                                <div style={{ marginTop: '1.5rem', padding: '0.75rem', background: 'rgba(100, 116, 139, 0.1)', borderRadius: '0.375rem' }}>
                                                                    <h5 style={{ color: '#64748b', fontSize: '0.875rem', marginBottom: '0.5rem' }}>Healthy Scratches:</h5>
                                                                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                                                                        {selectedGame.details.awayScratched.map(p => (
                                                                            <span key={p.id} style={{ 
                                                                                padding: '0.25rem 0.5rem',
                                                                                background: 'rgba(100, 116, 139, 0.2)',
                                                                                borderRadius: '0.25rem',
                                                                                fontSize: '0.75rem',
                                                                                color: '#94a3b8'
                                                                            }}>
                                                                                {p.name}
                                                                            </span>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                    
                                                    {/* Home Team Stats */}
                                                    {gameDetailTeamTab === 'home' && (
                                                        <div>
                                                            {/* Skaters */}
                                                            <h4 style={{ color: '#93c5fd', marginTop: '1rem', marginBottom: '0.75rem' }}>Skaters</h4>
                                                            <table className="stats-table">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Player</th>
                                                                        <th className="text-center">G</th>
                                                                        <th className="text-center">A</th>
                                                                        <th className="text-center">PTS</th>
                                                                        <th className="text-center">+/-</th>
                                                                        <th className="text-center">SOG</th>
                                                                        <th className="text-center">TOI</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {selectedGame.details.homePlayerStats.filter(ps => ps.player.position !== 'G').sort((a, b) => b.points - a.points).map(ps => (
                                                                        <tr key={ps.player.id} style={{ background: ps.points > 0 ? 'rgba(34, 197, 94, 0.1)' : 'transparent' }}>
                                                                            <td>
                                                                                <span style={{ cursor: 'pointer', color: '#22d3ee' }} onClick={() => navigateTo('playerProfile', ps.player)}>
                                                                                    {ps.player.firstName} {ps.player.lastName}
                                                                                </span>
                                                                                <span style={{ color: '#64748b', marginLeft: '0.5rem', fontSize: '0.85em' }}>
                                                                                    {ps.player.position}
                                                                                </span>
                                                                            </td>
                                                                            <td className="text-center" style={{ fontWeight: ps.goals > 0 ? 'bold' : 'normal', color: ps.goals > 0 ? '#22c55e' : 'inherit' }}>{ps.goals}</td>
                                                                            <td className="text-center" style={{ fontWeight: ps.assists > 0 ? 'bold' : 'normal', color: ps.assists > 0 ? '#22c55e' : 'inherit' }}>{ps.assists}</td>
                                                                            <td className="text-center" style={{ fontWeight: ps.points > 0 ? 'bold' : 'normal', color: ps.points > 0 ? '#22c55e' : 'inherit' }}>{ps.points}</td>
                                                                            <td className="text-center">{ps.plusMinus > 0 ? '+' : ''}{ps.plusMinus}</td>
                                                                            <td className="text-center">{ps.shots}</td>
                                                                            <td className="text-center">{formatTOI(ps.toi)}</td>
                                                                        </tr>
                                                                    ))}
                                                                </tbody>
                                                            </table>
                                                            
                                                            {/* Goalies */}
                                                            <h4 style={{ color: '#93c5fd', marginTop: '1.5rem', marginBottom: '0.75rem' }}>Goalies</h4>
                                                            <table className="stats-table">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Player</th>
                                                                        <th className="text-center">SA</th>
                                                                        <th className="text-center">SV</th>
                                                                        <th className="text-center">GA</th>
                                                                        <th className="text-center">SV%</th>
                                                                        <th className="text-center">Result</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {selectedGame.details.homePlayerStats.filter(ps => ps.player.position === 'G' && ps.shotsAgainst > 0).map(ps => {
                                                                        const svPct = ps.shotsAgainst > 0 ? (ps.saves / ps.shotsAgainst).toFixed(3) : '.000';
                                                                        const isWinner = selectedGame.homeScore > selectedGame.awayScore;
                                                                        return (
                                                                            <tr key={ps.player.id}>
                                                                                <td>
                                                                                    <span style={{ cursor: 'pointer', color: '#22d3ee' }} onClick={() => navigateTo('playerProfile', ps.player)}>
                                                                                        {ps.player.firstName} {ps.player.lastName}
                                                                                    </span>
                                                                                </td>
                                                                                <td className="text-center">{ps.shotsAgainst}</td>
                                                                                <td className="text-center">{ps.saves}</td>
                                                                                <td className="text-center">{ps.goalsAgainst}</td>
                                                                                <td className="text-center">{svPct}</td>
                                                                                <td className="text-center">
                                                                                    <span style={{ 
                                                                                        padding: '0.25rem 0.5rem',
                                                                                        borderRadius: '0.25rem',
                                                                                        fontSize: '0.75rem',
                                                                                        fontWeight: 'bold',
                                                                                        background: isWinner ? '#22c55e' : '#ef4444'
                                                                                    }}>
                                                                                        {isWinner ? 'W' : 'L'}
                                                                                    </span>
                                                                                </td>
                                                                            </tr>
                                                                        );
                                                                    })}
                                                                </tbody>
                                                            </table>
                                                            
                                                            {/* DNP Players */}
                                                            {selectedGame.details.homeScratched?.length > 0 && (
                                                                <div style={{ marginTop: '1.5rem', padding: '0.75rem', background: 'rgba(100, 116, 139, 0.1)', borderRadius: '0.375rem' }}>
                                                                    <h5 style={{ color: '#64748b', fontSize: '0.875rem', marginBottom: '0.5rem' }}>Healthy Scratches:</h5>
                                                                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                                                                        {selectedGame.details.homeScratched.map(p => (
                                                                            <span key={p.id} style={{ 
                                                                                padding: '0.25rem 0.5rem',
                                                                                background: 'rgba(100, 116, 139, 0.2)',
                                                                                borderRadius: '0.25rem',
                                                                                fontSize: '0.75rem',
                                                                                color: '#94a3b8'
                                                                            }}>
                                                                                {p.name}
                                                                            </span>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </>
                                            );
                                        })()
                                    ) : (
                                        // Old game without per-game stats
                                        <div style={{ 
                                            padding: '2rem',
                                            background: 'rgba(251, 191, 36, 0.1)',
                                            borderRadius: '0.5rem',
                                            border: '1px solid rgba(251, 191, 36, 0.3)',
                                            textAlign: 'center'
                                        }}>
                                            <h3 style={{ color: '#fbbf24', marginBottom: '1rem' }}>
                                                 Per-Game Stats Not Available
                                            </h3>
                                            <p style={{ color: '#e2e8f0', marginBottom: '1rem', lineHeight: '1.6' }}>
                                                This game was simulated before the per-game stat tracking system was implemented.
                                            </p>
                                            <p style={{ color: '#93c5fd', fontSize: '0.9rem' }}>
                                                 <strong>To see per-game stats:</strong> Simulate new games going forward. All future games will track detailed per-player statistics for each game!
                                            </p>
                                        </div>
                                    )}
                                    
                                    {/* Injury Report - Bottom of Page */}
                                    {(() => {
                                        const homeTeam = TEAMS.find(t => t.id === selectedGame.homeTeam);
                                        const awayTeam = TEAMS.find(t => t.id === selectedGame.awayTeam);
                                        const homeInjured = gameState.players.filter(p => p.teamId === selectedGame.homeTeam && p.injury.injured);
                                        const awayInjured = gameState.players.filter(p => p.teamId === selectedGame.awayTeam && p.injury.injured);
                                        
                                        if (homeInjured.length === 0 && awayInjured.length === 0) return null;
                                        
                                        return (
                                            <div style={{ 
                                                marginTop: '3rem',
                                                padding: '1.5rem',
                                                background: 'rgba(239, 68, 68, 0.1)',
                                                borderRadius: '0.5rem',
                                                border: '1px solid rgba(239, 68, 68, 0.3)'
                                            }}>
                                                <h3 style={{ color: '#ef4444', marginBottom: '1.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                     Injury Report
                                                </h3>
                                                
                                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem' }}>
                                                    {/* Away Team Injuries */}
                                                    <div>
                                                        <h4 style={{ color: '#93c5fd', marginBottom: '1rem', fontSize: '1rem' }}>
                                                            {awayTeam.city} {awayTeam.name}
                                                        </h4>
                                                        {awayInjured.length > 0 ? (
                                                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                                                {awayInjured.map(player => (
                                                                    <div key={player.id} style={{
                                                                        padding: '0.75rem',
                                                                        background: 'rgba(239, 68, 68, 0.15)',
                                                                        borderRadius: '0.375rem',
                                                                        border: '1px solid rgba(239, 68, 68, 0.3)'
                                                                    }}>
                                                                        <div style={{ fontWeight: 'bold', color: '#fff', marginBottom: '0.25rem' }}>
                                                                            {player.firstName} {player.lastName}
                                                                            <span style={{ marginLeft: '0.5rem', fontSize: '0.85em', color: '#94a3b8' }}>
                                                                                {player.position}
                                                                            </span>
                                                                        </div>
                                                                        <div style={{ fontSize: '0.875rem', color: '#fca5a5' }}>
                                                                            {player.injury.type} - {player.injury.severity}
                                                                        </div>
                                                                        {player.injury.daysUntilReturn < 999 && (
                                                                            <div style={{ fontSize: '0.75rem', color: '#94a3b8', marginTop: '0.25rem' }}>
                                                                                ~{player.injury.daysUntilReturn} days until return
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        ) : (
                                                            <p style={{ color: '#64748b', fontSize: '0.875rem', fontStyle: 'italic' }}>
                                                                No injuries
                                                            </p>
                                                        )}
                                                    </div>
                                                    
                                                    {/* Home Team Injuries */}
                                                    <div>
                                                        <h4 style={{ color: '#93c5fd', marginBottom: '1rem', fontSize: '1rem' }}>
                                                            {homeTeam.city} {homeTeam.name}
                                                        </h4>
                                                        {homeInjured.length > 0 ? (
                                                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                                                {homeInjured.map(player => (
                                                                    <div key={player.id} style={{
                                                                        padding: '0.75rem',
                                                                        background: 'rgba(239, 68, 68, 0.15)',
                                                                        borderRadius: '0.375rem',
                                                                        border: '1px solid rgba(239, 68, 68, 0.3)'
                                                                    }}>
                                                                        <div style={{ fontWeight: 'bold', color: '#fff', marginBottom: '0.25rem' }}>
                                                                            {player.firstName} {player.lastName}
                                                                            <span style={{ marginLeft: '0.5rem', fontSize: '0.85em', color: '#94a3b8' }}>
                                                                                {player.position}
                                                                            </span>
                                                                        </div>
                                                                        <div style={{ fontSize: '0.875rem', color: '#fca5a5' }}>
                                                                            {player.injury.type} - {player.injury.severity}
                                                                        </div>
                                                                        {player.injury.daysUntilReturn < 999 && (
                                                                            <div style={{ fontSize: '0.75rem', color: '#94a3b8', marginTop: '0.25rem' }}>
                                                                                ~{player.injury.daysUntilReturn} days until return
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        ) : (
                                                            <p style={{ color: '#64748b', fontSize: '0.875rem', fontStyle: 'italic' }}>
                                                                No injuries
                                                            </p>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })()}
                                </div>
                            </div>
                        )}

                        {currentView === 'bracket' && (
                            <div className="card">
                                <h2> Stanley Cup Playoffs Bracket</h2>
                                
                                {!playoffState && (
                                    <div style={{ padding: '2rem', textAlign: 'center' }}>
                                        <p style={{ fontSize: '1.2rem', color: '#93c5fd', marginBottom: '1rem' }}>
                                            Complete the regular season to start the playoffs!
                                        </p>
                                        <p style={{ color: '#64748b' }}>
                                            Top 8 teams from each conference will compete in best-of-7 series
                                        </p>
                                    </div>
                                )}
                                
                                {playoffState && (
                                    <>
                                        <BracketView playoffState={playoffState} TEAMS={TEAMS} />
                                        
                                        {playoffState.lastDaySummary && (
                                            <div style={{ marginTop: '2rem', padding: '1.5rem', background: 'rgba(34, 211, 238, 0.1)', borderRadius: '0.5rem', border: '2px solid rgba(34, 211, 238, 0.3)' }}>
                                                <h3 style={{ color: '#22d3ee', marginBottom: '1rem', textAlign: 'center' }}>
                                                    {playoffState.lastDaySummary.title}
                                                </h3>
                                                
                                                {playoffState.lastDaySummary.subtitle && (
                                                    <p style={{ textAlign: 'center', color: '#93c5fd', marginBottom: '1rem', fontSize: '0.9rem' }}>
                                                        {playoffState.lastDaySummary.subtitle}
                                                    </p>
                                                )}
                                                
                                                {playoffState.lastDaySummary.message && (
                                                    <p style={{ textAlign: 'center', color: '#fff', fontSize: '1.1rem', padding: '1rem' }}>
                                                        {playoffState.lastDaySummary.message}
                                                    </p>
                                                )}
                                                
                                                {playoffState.lastDaySummary.restDays && (
                                                    <p style={{ textAlign: 'center', color: '#fbbf24', fontWeight: 'bold', marginTop: '0.5rem' }}>
                                                         {playoffState.lastDaySummary.restDays} days rest before next games
                                                    </p>
                                                )}
                                                
                                                {playoffState.lastDaySummary.results && playoffState.lastDaySummary.results.length > 0 && (
                                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '0.75rem', marginTop: '1rem' }}>
                                                        {playoffState.lastDaySummary.results.map((result, idx) => (
                                                            <div key={idx} style={{ 
                                                                padding: '0.75rem', 
                                                                background: result.seriesComplete ? 'rgba(34, 197, 94, 0.15)' : 'rgba(30, 58, 138, 0.3)',
                                                                borderRadius: '0.375rem',
                                                                border: result.seriesComplete ? '2px solid #22c55e' : '1px solid rgba(59, 130, 246, 0.3)',
                                                                cursor: 'pointer',
                                                                transition: 'all 0.2s'
                                                            }}
                                                            onMouseOver={(e) => e.currentTarget.style.transform = 'scale(1.02)'}
                                                            onMouseOut={(e) => e.currentTarget.style.transform = 'scale(1)'}
                                                            onClick={() => {
                                                                setSelectedPlayoffGame(result);
                                                                setCurrentView('playoffGameStats');
                                                            }}
                                                            >
                                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }}>
                                                                    <div style={{ flex: 1 }}>
                                                                        <div style={{ 
                                                                            fontWeight: result.winner.id === result.homeTeam.id ? 'bold' : 'normal',
                                                                            color: result.winner.id === result.homeTeam.id ? '#22c55e' : '#fff',
                                                                            fontSize: '0.95rem'
                                                                        }}>
                                                                            {result.homeTeam.city}
                                                                        </div>
                                                                        <div style={{ 
                                                                            fontWeight: result.winner.id === result.awayTeam.id ? 'bold' : 'normal',
                                                                            color: result.winner.id === result.awayTeam.id ? '#22c55e' : '#fff',
                                                                            fontSize: '0.95rem',
                                                                            marginTop: '0.25rem'
                                                                        }}>
                                                                            {result.awayTeam.city}
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    <div style={{ textAlign: 'center', padding: '0 0.75rem' }}>
                                                                        <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: result.winner.id === result.homeTeam.id ? '#22c55e' : '#fff' }}>
                                                                            {result.homeScore}
                                                                        </div>
                                                                        <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: result.winner.id === result.awayTeam.id ? '#22c55e' : '#fff', marginTop: '0.25rem' }}>
                                                                            {result.awayScore}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div style={{ color: '#93c5fd', fontSize: '0.75rem', textAlign: 'center' }}>
                                                                    Series: {result.homeWins}-{result.awayWins}
                                                                </div>
                                                                {result.seriesComplete && !result.champion && (
                                                                    <div style={{ color: '#22c55e', fontWeight: 'bold', marginTop: '0.5rem', fontSize: '0.8rem', textAlign: 'center' }}>
                                                                         {result.winner.city} wins!
                                                                    </div>
                                                                )}
                                                                {result.champion && (
                                                                    <div style={{ color: '#fbbf24', fontWeight: 'bold', fontSize: '0.85rem', marginTop: '0.5rem', textAlign: 'center' }}>
                                                                         CHAMPIONS! 
                                                                    </div>
                                                                )}
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </>
                                )}
                            </div>
                        )}

                        {currentView === 'playoffGames' && playoffState && (
                            <div className="card">
                                <h2>Playoff Games</h2>
                                <p style={{ color: '#93c5fd', marginBottom: '1.5rem' }}>
                                    Click on any game to view detailed stats
                                </p>
                                
                                {(() => {
                                    const allGames = [];
                                    
                                    // Collect all games from history
                                    if (playoffState.history) {
                                        const rounds = [
                                            { key: 'eastRound1', name: 'Eastern Conference - Round 1', matchups: playoffState.history.eastRound1 },
                                            { key: 'westRound1', name: 'Western Conference - Round 1', matchups: playoffState.history.westRound1 },
                                            { key: 'eastRound2', name: 'Eastern Conference - Round 2', matchups: playoffState.history.eastRound2 },
                                            { key: 'westRound2', name: 'Western Conference - Round 2', matchups: playoffState.history.westRound2 },
                                            { key: 'eastRound3', name: 'Eastern Conference Finals', matchups: playoffState.history.eastRound3 },
                                            { key: 'westRound3', name: 'Western Conference Finals', matchups: playoffState.history.westRound3 },
                                            { key: 'final', name: 'Stanley Cup Finals', matchups: playoffState.history.final ? [playoffState.history.final] : [] }
                                        ];
                                        
                                        rounds.forEach(round => {
                                            if (round.matchups && round.matchups.length > 0) {
                                                round.matchups.forEach((matchup, matchupIdx) => {
                                                    if (matchup.games && matchup.games.length > 0) {
                                                        matchup.games.forEach((game, gameIdx) => {
                                                            const homeTeam = TEAMS.find(t => t.id === game.homeTeam);
                                                            const awayTeam = TEAMS.find(t => t.id === game.awayTeam);
                                                            allGames.push({
                                                                ...game,
                                                                round: round.name,
                                                                gameNumber: gameIdx + 1,
                                                                homeTeam,
                                                                awayTeam,
                                                                matchup
                                                            });
                                                        });
                                                    }
                                                });
                                            }
                                        });
                                    }
                                    
                                    if (allGames.length === 0) {
                                        return <p style={{ color: '#93c5fd' }}>No playoff games have been played yet.</p>;
                                    }
                                    
                                    // Group games by round
                                    const gamesByRound = {};
                                    allGames.forEach(game => {
                                        if (!gamesByRound[game.round]) gamesByRound[game.round] = [];
                                        gamesByRound[game.round].push(game);
                                    });
                                    
                                    return Object.keys(gamesByRound).map(roundName => (
                                        <div key={roundName} style={{ marginBottom: '2rem' }}>
                                            <h3 style={{ color: '#22d3ee', marginBottom: '1rem' }}>{roundName}</h3>
                                            <div style={{ display: 'grid', gap: '0.75rem' }}>
                                                {gamesByRound[roundName].map((game, idx) => (
                                                    <div 
                                                        key={idx}
                                                        onClick={() => {
                                                            setSelectedPlayoffGame(game);
                                                            setCurrentView('playoffGameStats');
                                                        }}
                                                        style={{
                                                            padding: '1rem',
                                                            background: 'rgba(30, 58, 138, 0.3)',
                                                            borderRadius: '0.5rem',
                                                            border: '1px solid rgba(59, 130, 246, 0.3)',
                                                            cursor: 'pointer',
                                                            transition: 'all 0.2s',
                                                            display: 'flex',
                                                            justifyContent: 'space-between',
                                                            alignItems: 'center'
                                                        }}
                                                        onMouseOver={(e) => e.currentTarget.style.background = 'rgba(30, 64, 175, 0.4)'}
                                                        onMouseOut={(e) => e.currentTarget.style.background = 'rgba(30, 58, 138, 0.3)'}
                                                    >
                                                        <div style={{ flex: 1 }}>
                                                            <div style={{ color: '#93c5fd', fontSize: '0.875rem', marginBottom: '0.5rem' }}>
                                                                Game {game.gameNumber}
                                                            </div>
                                                            <div style={{ fontSize: '1.1rem' }}>
                                                                <span style={{ 
                                                                    fontWeight: game.winner === game.homeTeam.id ? 'bold' : 'normal',
                                                                    color: game.winner === game.homeTeam.id ? '#22c55e' : '#fff'
                                                                }}>
                                                                    {game.homeTeam.city} {game.homeTeam.name}
                                                                </span>
                                                                <span style={{ margin: '0 0.5rem', color: '#93c5fd' }}>vs</span>
                                                                <span style={{ 
                                                                    fontWeight: game.winner === game.awayTeam.id ? 'bold' : 'normal',
                                                                    color: game.winner === game.awayTeam.id ? '#22c55e' : '#fff'
                                                                }}>
                                                                    {game.awayTeam.city} {game.awayTeam.name}
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <div style={{ 
                                                            fontSize: '1.5rem', 
                                                            fontWeight: 'bold',
                                                            color: '#22d3ee',
                                                            minWidth: '80px',
                                                            textAlign: 'center'
                                                        }}>
                                                            {game.homeScore} - {game.awayScore}
                                                        </div>
                                                        <div style={{ color: '#93c5fd', fontSize: '0.875rem' }}>
                                                            View Stats 
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ));
                                })()}
                            </div>
                        )}

                        {currentView === 'playoffGameStats' && selectedPlayoffGame && (
                            <div>
                                <button 
                                    onClick={() => setCurrentView('playoffGames')}
                                    style={{
                                        padding: '0.5rem 1rem',
                                        background: '#2563eb',
                                        color: '#fff',
                                        border: 'none',
                                        borderRadius: '0.375rem',
                                        cursor: 'pointer',
                                        marginBottom: '1rem',
                                        fontWeight: 'bold'
                                    }}
                                >
                                     Back to Games List
                                </button>
                                
                                <div className="card">
                                    <h2>{selectedPlayoffGame.round} - Game {selectedPlayoffGame.gameNumber}</h2>
                                    <p style={{ color: '#f59e0b', marginBottom: '1rem', fontSize: '1.1rem', fontWeight: 'bold' }}>
                                         Stanley Cup Playoffs
                                    </p>
                                    
                                    <div style={{ 
                                        display: 'flex', 
                                        justifyContent: 'space-between', 
                                        alignItems: 'center',
                                        padding: '2rem',
                                        background: 'rgba(30, 58, 138, 0.3)',
                                        borderRadius: '0.5rem',
                                        marginBottom: '2rem'
                                    }}>
                                        <div style={{ textAlign: 'center', flex: 1 }}>
                                            <div style={{ fontSize: '1.5rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                                {selectedPlayoffGame.awayTeam.city} {selectedPlayoffGame.awayTeam.name}
                                            </div>
                                            <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.5rem' }}>
                                                AWAY
                                            </div>
                                            <div style={{ 
                                                fontSize: '4rem', 
                                                fontWeight: 'bold',
                                                color: selectedPlayoffGame.winner === selectedPlayoffGame.awayTeam.id ? '#22c55e' : '#fff'
                                            }}>
                                                {selectedPlayoffGame.awayScore}
                                            </div>
                                        </div>
                                        <div style={{ fontSize: '3rem', color: '#93c5fd', padding: '0 2rem' }}>
                                            @
                                        </div>
                                        <div style={{ textAlign: 'center', flex: 1 }}>
                                            <div style={{ fontSize: '1.5rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                                {selectedPlayoffGame.homeTeam.city} {selectedPlayoffGame.homeTeam.name}
                                            </div>
                                            <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.5rem' }}>
                                                HOME
                                            </div>
                                            <div style={{ 
                                                fontSize: '4rem', 
                                                fontWeight: 'bold',
                                                color: selectedPlayoffGame.winner === selectedPlayoffGame.homeTeam.id ? '#22c55e' : '#fff'
                                            }}>
                                                {selectedPlayoffGame.homeScore}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Winner Badge */}
                                    {(() => {
                                        const winner = selectedPlayoffGame.winner === selectedPlayoffGame.homeTeam.id ? 
                                            selectedPlayoffGame.homeTeam : selectedPlayoffGame.awayTeam;
                                        
                                        return (
                                            <div style={{ 
                                                padding: '1rem',
                                                background: 'rgba(34, 197, 94, 0.15)',
                                                borderRadius: '0.5rem',
                                                marginBottom: '2rem',
                                                textAlign: 'center',
                                                border: '2px solid #22c55e'
                                            }}>
                                                <div style={{ color: '#22c55e', fontSize: '1.2rem', fontWeight: 'bold' }}>
                                                     WINNER: {winner.city} {winner.name}
                                                </div>
                                            </div>
                                        );
                                    })()}
                                    
                                    {/* Series Status */}
                                    <div style={{ 
                                        padding: '1rem',
                                        background: 'rgba(245, 158, 11, 0.1)',
                                        borderRadius: '0.5rem',
                                        marginBottom: '2rem',
                                        textAlign: 'center',
                                        border: '1px solid rgba(245, 158, 11, 0.3)'
                                    }}>
                                        <div style={{ color: '#f59e0b', fontSize: '1.1rem', fontWeight: 'bold' }}>
                                            Series: {selectedPlayoffGame.homeTeam.city} leads {selectedPlayoffGame.matchup.homeWins}-{selectedPlayoffGame.matchup.awayWins}
                                        </div>
                                    </div>
                                    
                                    {/* Detailed Stats - Same as regular season */}
                                    {selectedPlayoffGame.details && selectedPlayoffGame.details.homePlayerStats ? (
                                        (() => {
                                            // Use same rendering as regular season games but with playoff stats
                                            return (
                                                <>
                                                    {/* Period-by-Period Scoring Summary */}
                                                    {selectedPlayoffGame.details.scoringSummary && selectedPlayoffGame.details.scoringSummary.some(p => p.goals.length > 0) && (
                                                        <div style={{ marginBottom: '2rem' }}>
                                                            <h3 style={{ color: '#f59e0b', marginBottom: '1.5rem' }}> Scoring Summary</h3>
                                                            {selectedPlayoffGame.details.scoringSummary.map((period, idx) => {
                                                                if (period.goals.length === 0) return null;
                                                                
                                                                // Track running totals for THIS PLAYOFF RUN
                                                                const gameRunningTotals = {};
                                                                
                                                                // Get pre-game PLAYOFF stats (not regular season)
                                                                const getPreGamePlayoffStats = (playerId) => {
                                                                    // Find all playoff games before this one
                                                                    const allPlayoffGames = [];
                                                                    
                                                                    // Collect games from playoff state
                                                                    if (playoffState) {
                                                                        // Would need to iterate through all matchups/games before this one
                                                                        // For now, just use player's current playoff stats minus this game
                                                                        const player = gameState.players.find(p => p.id === playerId);
                                                                        if (player) {
                                                                            const thisGameStats = selectedPlayoffGame.details.homePlayerStats?.find(ps => ps.player.id === playerId) ||
                                                                                                selectedPlayoffGame.details.awayPlayerStats?.find(ps => ps.player.id === playerId);
                                                                            return {
                                                                                goals: (player.playoffStats.goals || 0) - (thisGameStats?.goals || 0),
                                                                                assists: (player.playoffStats.assists || 0) - (thisGameStats?.assists || 0)
                                                                            };
                                                                        }
                                                                    }
                                                                    return { goals: 0, assists: 0 };
                                                                };
                                                                
                                                                return (
                                                                    <div key={period.period} style={{ 
                                                                        marginBottom: '1.5rem',
                                                                        padding: '1rem',
                                                                        background: 'rgba(245, 158, 11, 0.1)',
                                                                        borderRadius: '0.5rem',
                                                                        border: '1px solid rgba(245, 158, 11, 0.3)'
                                                                    }}>
                                                                        <h4 style={{ color: '#fbbf24', marginBottom: '1rem', fontSize: '1rem' }}>
                                                                            {period.period === 1 ? '1st' : period.period === 2 ? '2nd' : '3rd'} Period
                                                                        </h4>
                                                                        {period.goals.map((goal, goalIdx) => {
                                                                            const team = goal.team === 'home' ? selectedPlayoffGame.homeTeam : selectedPlayoffGame.awayTeam;
                                                                            const preGameStats = getPreGamePlayoffStats(goal.scorer.id);
                                                                            
                                                                            if (!gameRunningTotals[goal.scorer.id]) {
                                                                                gameRunningTotals[goal.scorer.id] = { goals: 0, assists: 0 };
                                                                            }
                                                                            gameRunningTotals[goal.scorer.id].goals++;
                                                                            
                                                                            const playoffGoalTotal = preGameStats.goals + gameRunningTotals[goal.scorer.id].goals;
                                                                            
                                                                            return (
                                                                                <div key={goalIdx} style={{ 
                                                                                    marginBottom: goalIdx < period.goals.length - 1 ? '0.75rem' : '0',
                                                                                    paddingBottom: goalIdx < period.goals.length - 1 ? '0.75rem' : '0',
                                                                                    borderBottom: goalIdx < period.goals.length - 1 ? '1px solid rgba(100, 116, 139, 0.3)' : 'none'
                                                                                }}>
                                                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '0.25rem' }}>
                                                                                        <span style={{ 
                                                                                            padding: '0.25rem 0.5rem',
                                                                                            background: goal.team === 'home' ? 'rgba(34, 197, 94, 0.2)' : 'rgba(59, 130, 246, 0.2)',
                                                                                            borderRadius: '0.25rem',
                                                                                            fontSize: '0.75rem',
                                                                                            fontWeight: 'bold',
                                                                                            color: goal.team === 'home' ? '#22c55e' : '#3b82f6'
                                                                                        }}>
                                                                                            {team.abbreviation}
                                                                                        </span>
                                                                                        <span style={{ fontWeight: 'bold', color: '#fff' }}>
                                                                                            {goal.scorer.name}
                                                                                        </span>
                                                                                        <span style={{ 
                                                                                            fontSize: '0.85rem',
                                                                                            color: '#f59e0b',
                                                                                            fontWeight: 'bold'
                                                                                        }}>
                                                                                            ({playoffGoalTotal})
                                                                                        </span>
                                                                                    </div>
                                                                                    {goal.assists.length > 0 && (
                                                                                        <div style={{ 
                                                                                            fontSize: '0.875rem', 
                                                                                            color: '#94a3b8',
                                                                                            marginLeft: '2.5rem'
                                                                                        }}>
                                                                                            Assists: {goal.assists.map((assist, aIdx) => {
                                                                                                const assistPreGameStats = getPreGamePlayoffStats(assist.id);
                                                                                                
                                                                                                if (!gameRunningTotals[assist.id]) {
                                                                                                    gameRunningTotals[assist.id] = { goals: 0, assists: 0 };
                                                                                                }
                                                                                                gameRunningTotals[assist.id].assists++;
                                                                                                
                                                                                                const playoffAssistTotal = assistPreGameStats.assists + gameRunningTotals[assist.id].assists;
                                                                                                
                                                                                                return (
                                                                                                    <span key={assist.id}>
                                                                                                        {assist.name} <span style={{ color: '#f59e0b', fontWeight: 'bold' }}>({playoffAssistTotal})</span>
                                                                                                        {aIdx < goal.assists.length - 1 ? ', ' : ''}
                                                                                                    </span>
                                                                                                );
                                                                                            })}
                                                                                        </div>
                                                                                    )}
                                                                                </div>
                                                                            );
                                                                        })}
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    )}
                                                    
                                                    {/* Team Tabs */}
                                                    <div style={{ 
                                                        display: 'flex', 
                                                        gap: '0.5rem',
                                                        marginBottom: '1.5rem',
                                                        borderBottom: '2px solid rgba(245, 158, 11, 0.3)'
                                                    }}>
                                                        <button
                                                            onClick={() => setGameDetailTeamTab('away')}
                                                            style={{
                                                                padding: '0.75rem 1.5rem',
                                                                background: gameDetailTeamTab === 'away' ? 'rgba(245, 158, 11, 0.2)' : 'transparent',
                                                                border: 'none',
                                                                borderBottom: gameDetailTeamTab === 'away' ? '3px solid #f59e0b' : '3px solid transparent',
                                                                color: gameDetailTeamTab === 'away' ? '#f59e0b' : '#94a3b8',
                                                                cursor: 'pointer',
                                                                fontWeight: gameDetailTeamTab === 'away' ? 'bold' : 'normal',
                                                                fontSize: '1rem',
                                                                transition: 'all 0.2s'
                                                            }}
                                                        >
                                                            {selectedPlayoffGame.awayTeam.city} {selectedPlayoffGame.awayTeam.name} (Away)
                                                        </button>
                                                        <button
                                                            onClick={() => setGameDetailTeamTab('home')}
                                                            style={{
                                                                padding: '0.75rem 1.5rem',
                                                                background: gameDetailTeamTab === 'home' ? 'rgba(245, 158, 11, 0.2)' : 'transparent',
                                                                border: 'none',
                                                                borderBottom: gameDetailTeamTab === 'home' ? '3px solid #f59e0b' : '3px solid transparent',
                                                                color: gameDetailTeamTab === 'home' ? '#f59e0b' : '#94a3b8',
                                                                cursor: 'pointer',
                                                                fontWeight: gameDetailTeamTab === 'home' ? 'bold' : 'normal',
                                                                fontSize: '1rem',
                                                                transition: 'all 0.2s'
                                                            }}
                                                        >
                                                            {selectedPlayoffGame.homeTeam.city} {selectedPlayoffGame.homeTeam.name} (Home)
                                                        </button>
                                                    </div>
                                                    
                                                    {/* Show stats for selected team */}
                                                    {gameDetailTeamTab === 'away' && (
                                                        <div>
                                                            <h4 style={{ color: '#fbbf24', marginTop: '1rem', marginBottom: '0.75rem' }}>Skaters</h4>
                                                            <table className="stats-table">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Player</th>
                                                                        <th className="text-center">G</th>
                                                                        <th className="text-center">A</th>
                                                                        <th className="text-center">PTS</th>
                                                                        <th className="text-center">+/-</th>
                                                                        <th className="text-center">SOG</th>
                                                                        <th className="text-center">TOI</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {selectedPlayoffGame.details.awayPlayerStats.filter(ps => ps.player.position !== 'G').sort((a, b) => b.points - a.points).map(ps => (
                                                                        <tr key={ps.player.id} style={{ background: ps.points > 0 ? 'rgba(245, 158, 11, 0.1)' : 'transparent' }}>
                                                                            <td>
                                                                                <span style={{ cursor: 'pointer', color: '#f59e0b' }} onClick={() => navigateTo('playerProfile', ps.player)}>
                                                                                    {ps.player.firstName} {ps.player.lastName}
                                                                                </span>
                                                                                <span style={{ color: '#64748b', marginLeft: '0.5rem', fontSize: '0.85em' }}>
                                                                                    {ps.player.position}
                                                                                </span>
                                                                            </td>
                                                                            <td className="text-center" style={{ fontWeight: ps.goals > 0 ? 'bold' : 'normal', color: ps.goals > 0 ? '#f59e0b' : 'inherit' }}>{ps.goals}</td>
                                                                            <td className="text-center" style={{ fontWeight: ps.assists > 0 ? 'bold' : 'normal', color: ps.assists > 0 ? '#f59e0b' : 'inherit' }}>{ps.assists}</td>
                                                                            <td className="text-center" style={{ fontWeight: ps.points > 0 ? 'bold' : 'normal', color: ps.points > 0 ? '#f59e0b' : 'inherit' }}>{ps.points}</td>
                                                                            <td className="text-center">{ps.plusMinus > 0 ? '+' : ''}{ps.plusMinus}</td>
                                                                            <td className="text-center">{ps.shots}</td>
                                                                            <td className="text-center">{formatTOI(ps.toi)}</td>
                                                                        </tr>
                                                                    ))}
                                                                </tbody>
                                                            </table>
                                                            
                                                            <h4 style={{ color: '#fbbf24', marginTop: '1.5rem', marginBottom: '0.75rem' }}>Goalies</h4>
                                                            <table className="stats-table">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Player</th>
                                                                        <th className="text-center">SA</th>
                                                                        <th className="text-center">SV</th>
                                                                        <th className="text-center">GA</th>
                                                                        <th className="text-center">SV%</th>
                                                                        <th className="text-center">Result</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {selectedPlayoffGame.details.awayPlayerStats.filter(ps => ps.player.position === 'G' && ps.shotsAgainst > 0).map(ps => {
                                                                        const svPct = ps.shotsAgainst > 0 ? (ps.saves / ps.shotsAgainst).toFixed(3) : '.000';
                                                                        const isWinner = selectedPlayoffGame.winner === selectedPlayoffGame.awayTeam.id;
                                                                        return (
                                                                            <tr key={ps.player.id}>
                                                                                <td>
                                                                                    <span style={{ cursor: 'pointer', color: '#f59e0b' }} onClick={() => navigateTo('playerProfile', ps.player)}>
                                                                                        {ps.player.firstName} {ps.player.lastName}
                                                                                    </span>
                                                                                </td>
                                                                                <td className="text-center">{ps.shotsAgainst}</td>
                                                                                <td className="text-center">{ps.saves}</td>
                                                                                <td className="text-center">{ps.goalsAgainst}</td>
                                                                                <td className="text-center">{svPct}</td>
                                                                                <td className="text-center">
                                                                                    <span style={{ 
                                                                                        padding: '0.25rem 0.5rem',
                                                                                        borderRadius: '0.25rem',
                                                                                        fontSize: '0.75rem',
                                                                                        fontWeight: 'bold',
                                                                                        background: isWinner ? '#22c55e' : '#ef4444'
                                                                                    }}>
                                                                                        {isWinner ? 'W' : 'L'}
                                                                                    </span>
                                                                                </td>
                                                                            </tr>
                                                                        );
                                                                    })}
                                                                </tbody>
                                                            </table>
                                                            
                                                            {selectedPlayoffGame.details.awayScratched?.length > 0 && (
                                                                <div style={{ marginTop: '1.5rem', padding: '0.75rem', background: 'rgba(100, 116, 139, 0.1)', borderRadius: '0.375rem' }}>
                                                                    <h5 style={{ color: '#64748b', fontSize: '0.875rem', marginBottom: '0.5rem' }}>Healthy Scratches:</h5>
                                                                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                                                                        {selectedPlayoffGame.details.awayScratched.map(p => (
                                                                            <span key={p.id} style={{ 
                                                                                padding: '0.25rem 0.5rem',
                                                                                background: 'rgba(100, 116, 139, 0.2)',
                                                                                borderRadius: '0.25rem',
                                                                                fontSize: '0.75rem',
                                                                                color: '#94a3b8'
                                                                            }}>
                                                                                {p.name}
                                                                            </span>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                    
                                                    {gameDetailTeamTab === 'home' && (
                                                        <div>
                                                            <h4 style={{ color: '#fbbf24', marginTop: '1rem', marginBottom: '0.75rem' }}>Skaters</h4>
                                                            <table className="stats-table">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Player</th>
                                                                        <th className="text-center">G</th>
                                                                        <th className="text-center">A</th>
                                                                        <th className="text-center">PTS</th>
                                                                        <th className="text-center">+/-</th>
                                                                        <th className="text-center">SOG</th>
                                                                        <th className="text-center">TOI</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {selectedPlayoffGame.details.homePlayerStats.filter(ps => ps.player.position !== 'G').sort((a, b) => b.points - a.points).map(ps => (
                                                                        <tr key={ps.player.id} style={{ background: ps.points > 0 ? 'rgba(245, 158, 11, 0.1)' : 'transparent' }}>
                                                                            <td>
                                                                                <span style={{ cursor: 'pointer', color: '#f59e0b' }} onClick={() => navigateTo('playerProfile', ps.player)}>
                                                                                    {ps.player.firstName} {ps.player.lastName}
                                                                                </span>
                                                                                <span style={{ color: '#64748b', marginLeft: '0.5rem', fontSize: '0.85em' }}>
                                                                                    {ps.player.position}
                                                                                </span>
                                                                            </td>
                                                                            <td className="text-center" style={{ fontWeight: ps.goals > 0 ? 'bold' : 'normal', color: ps.goals > 0 ? '#f59e0b' : 'inherit' }}>{ps.goals}</td>
                                                                            <td className="text-center" style={{ fontWeight: ps.assists > 0 ? 'bold' : 'normal', color: ps.assists > 0 ? '#f59e0b' : 'inherit' }}>{ps.assists}</td>
                                                                            <td className="text-center" style={{ fontWeight: ps.points > 0 ? 'bold' : 'normal', color: ps.points > 0 ? '#f59e0b' : 'inherit' }}>{ps.points}</td>
                                                                            <td className="text-center">{ps.plusMinus > 0 ? '+' : ''}{ps.plusMinus}</td>
                                                                            <td className="text-center">{ps.shots}</td>
                                                                            <td className="text-center">{formatTOI(ps.toi)}</td>
                                                                        </tr>
                                                                    ))}
                                                                </tbody>
                                                            </table>
                                                            
                                                            <h4 style={{ color: '#fbbf24', marginTop: '1.5rem', marginBottom: '0.75rem' }}>Goalies</h4>
                                                            <table className="stats-table">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Player</th>
                                                                        <th className="text-center">SA</th>
                                                                        <th className="text-center">SV</th>
                                                                        <th className="text-center">GA</th>
                                                                        <th className="text-center">SV%</th>
                                                                        <th className="text-center">Result</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {selectedPlayoffGame.details.homePlayerStats.filter(ps => ps.player.position === 'G' && ps.shotsAgainst > 0).map(ps => {
                                                                        const svPct = ps.shotsAgainst > 0 ? (ps.saves / ps.shotsAgainst).toFixed(3) : '.000';
                                                                        const isWinner = selectedPlayoffGame.winner === selectedPlayoffGame.homeTeam.id;
                                                                        return (
                                                                            <tr key={ps.player.id}>
                                                                                <td>
                                                                                    <span style={{ cursor: 'pointer', color: '#f59e0b' }} onClick={() => navigateTo('playerProfile', ps.player)}>
                                                                                        {ps.player.firstName} {ps.player.lastName}
                                                                                    </span>
                                                                                </td>
                                                                                <td className="text-center">{ps.shotsAgainst}</td>
                                                                                <td className="text-center">{ps.saves}</td>
                                                                                <td className="text-center">{ps.goalsAgainst}</td>
                                                                                <td className="text-center">{svPct}</td>
                                                                                <td className="text-center">
                                                                                    <span style={{ 
                                                                                        padding: '0.25rem 0.5rem',
                                                                                        borderRadius: '0.25rem',
                                                                                        fontSize: '0.75rem',
                                                                                        fontWeight: 'bold',
                                                                                        background: isWinner ? '#22c55e' : '#ef4444'
                                                                                    }}>
                                                                                        {isWinner ? 'W' : 'L'}
                                                                                    </span>
                                                                                </td>
                                                                            </tr>
                                                                        );
                                                                    })}
                                                                </tbody>
                                                            </table>
                                                            
                                                            {selectedPlayoffGame.details.homeScratched?.length > 0 && (
                                                                <div style={{ marginTop: '1.5rem', padding: '0.75rem', background: 'rgba(100, 116, 139, 0.1)', borderRadius: '0.375rem' }}>
                                                                    <h5 style={{ color: '#64748b', fontSize: '0.875rem', marginBottom: '0.5rem' }}>Healthy Scratches:</h5>
                                                                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                                                                        {selectedPlayoffGame.details.homeScratched.map(p => (
                                                                            <span key={p.id} style={{ 
                                                                                padding: '0.25rem 0.5rem',
                                                                                background: 'rgba(100, 116, 139, 0.2)',
                                                                                borderRadius: '0.25rem',
                                                                                fontSize: '0.75rem',
                                                                                color: '#94a3b8'
                                                                            }}>
                                                                                {p.name}
                                                                            </span>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </>
                                            );
                                        })()
                                    ) : (
                                        <div style={{ 
                                            padding: '2rem',
                                            background: 'rgba(251, 191, 36, 0.1)',
                                            borderRadius: '0.5rem',
                                            border: '1px solid rgba(251, 191, 36, 0.3)',
                                            textAlign: 'center'
                                        }}>
                                            <p style={{ color: '#fbbf24', fontSize: '1.1rem' }}>
                                                Per-game stats not available for this playoff game.
                                            </p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {currentView === 'trade' && gameState && (() => {

                            const handleTradeSort = (key) => {
                                const direction = tradeSortConfig.key === key && tradeSortConfig.direction === 'desc' ? 'asc' : 'desc';
                                setTradeSortConfig({ key, direction });
                            };

                            const sortPlayers = (players, config) => {
                                return [...players].sort((a, b) => {
                                    let aVal, bVal;
                                    
                                    if (config.key.includes('.')) {
                                        const keys = config.key.split('.');
                                        aVal = keys.reduce((obj, k) => obj?.[k], a);
                                        bVal = keys.reduce((obj, k) => obj?.[k], b);
                                    } else {
                                        aVal = a[config.key];
                                        bVal = b[config.key];
                                    }
                                    
                                    if (aVal < bVal) return config.direction === 'asc' ? -1 : 1;
                                    if (aVal > bVal) return config.direction === 'asc' ? 1 : -1;
                                    return 0;
                                });
                            };

                            const togglePlayerSelection = (playerId, isMyTeam) => {
                                if (isMyTeam) {
                                    setMySelectedPlayers(prev => 
                                        prev.includes(playerId) 
                                            ? prev.filter(id => id !== playerId)
                                            : [...prev, playerId]
                                    );
                                } else {
                                    setTheirSelectedPlayers(prev => 
                                        prev.includes(playerId) 
                                            ? prev.filter(id => id !== playerId)
                                            : [...prev, playerId]
                                    );
                                }
                            };

                            const myTeamPlayers = sortPlayers(
                                gameState.players.filter(p => p.teamId === userTeamId && p.roster === 'nhl'),
                                tradeSortConfig
                            );

                            const theirTeamPlayers = tradePartnerTeamId ? sortPlayers(
                                gameState.players.filter(p => p.teamId === tradePartnerTeamId && p.roster === 'nhl'),
                                tradeSortConfig
                            ) : [];

                            const canProposeTrade = mySelectedPlayers.length > 0 && theirSelectedPlayers.length > 0;

                            const calculateTradeValue = (playerIds) => {
                                const players = playerIds.map(id => gameState.players.find(p => p.id === id));
                                return {
                                    totalOVR: players.reduce((sum, p) => sum + p.ratings.overall, 0),
                                    avgOVR: players.reduce((sum, p) => sum + p.ratings.overall, 0) / players.length,
                                    totalPOT: players.reduce((sum, p) => sum + p.ratings.potential, 0),
                                    avgAge: players.reduce((sum, p) => sum + p.age, 0) / players.length,
                                    totalPts: players.reduce((sum, p) => sum + (p.stats?.points || 0), 0)
                                };
                            };

                            const evaluateTrade = () => {
                                const myValue = calculateTradeValue(mySelectedPlayers);
                                const theirValue = calculateTradeValue(theirSelectedPlayers);
                                
                                const ovrDiff = Math.abs(myValue.totalOVR - theirValue.totalOVR);
                                const ovrDiffPercent = (ovrDiff / Math.max(myValue.totalOVR, theirValue.totalOVR)) * 100;
                                
                                return {
                                    myValue,
                                    theirValue,
                                    ovrDiff,
                                    ovrDiffPercent,
                                    isLopsided: ovrDiffPercent > 15
                                };
                            };

                            const proposeTrade = () => {
                                const evaluation = evaluateTrade();
                                const myPlayers = mySelectedPlayers.map(id => gameState.players.find(p => p.id === id));
                                const theirPlayers = theirSelectedPlayers.map(id => gameState.players.find(p => p.id === id));
                                
                                // Check for injured players
                                const myInjured = myPlayers.filter(p => p.injury.injured);
                                const theirInjured = theirPlayers.filter(p => p.injury.injured);
                                
                                if (myInjured.length > 0 || theirInjured.length > 0) {
                                    setTradeMessage({
                                        type: 'error',
                                        text: ' Cannot trade injured players!'
                                    });
                                    return;
                                }
                                
                                // AI Trade Logic (Complex)
                                const theirTeam = getTeam(tradePartnerTeamId);
                                const theirStanding = gameState.standings.find(s => s.teamId === tradePartnerTeamId);
                                
                                // Determine if they're rebuilding or competing
                                const gamesPlayed = theirStanding.wins + theirStanding.losses + theirStanding.otLosses;
                                const winPct = gamesPlayed > 0 ? theirStanding.wins / gamesPlayed : 0;
                                const isCompeting = winPct > 0.55; // Over .550 = playoff team
                                const isRebuilding = winPct < 0.40; // Under .400 = rebuild
                                
                                let acceptanceScore = 0;
                                
                                // 1. Base OVR comparison
                                if (evaluation.ovrDiffPercent <= 5) acceptanceScore += 50; // Fair
                                else if (evaluation.ovrDiffPercent <= 10) acceptanceScore += 30; // Acceptable
                                else if (evaluation.ovrDiffPercent <= 15) acceptanceScore += 10; // Questionable
                                else acceptanceScore -= 30; // Lopsided - major penalty
                                
                                // 2. Age factor
                                if (isCompeting) {
                                    // Competing teams want win-now players (lower age)
                                    if (evaluation.theirValue.avgAge < evaluation.myValue.avgAge) {
                                        acceptanceScore += 20; // Getting younger = good for future
                                    } else if (evaluation.theirValue.avgAge > evaluation.myValue.avgAge) {
                                        acceptanceScore += 30; // Getting older but better now
                                    }
                                } else if (isRebuilding) {
                                    // Rebuilding teams want youth
                                    if (evaluation.theirValue.avgAge < evaluation.myValue.avgAge) {
                                        acceptanceScore += 40; // Getting younger = great
                                    } else {
                                        acceptanceScore -= 20; // Getting older = bad
                                    }
                                }
                                
                                // 3. Potential factor
                                const potDiff = evaluation.theirValue.totalPOT - evaluation.myValue.totalPOT;
                                if (isRebuilding && potDiff > 0) {
                                    acceptanceScore += 30; // High POT = valuable for rebuild
                                } else if (isCompeting && evaluation.theirValue.avgOVR > evaluation.myValue.avgOVR) {
                                    acceptanceScore += 20; // High OVR now = valuable for contender
                                }
                                
                                // 4. Stats/Performance
                                const ptsDiff = evaluation.theirValue.totalPts - evaluation.myValue.totalPts;
                                if (ptsDiff > 10) acceptanceScore += 15; // Getting better performers
                                
                                // 5. Random variance (some trades just don't work out)
                                const randomFactor = (Math.random() - 0.5) * 20; // +/- 10 points
                                acceptanceScore += randomFactor;
                                
                                const tradeAccepted = acceptanceScore >= 50;
                                
                                if (tradeAccepted) {
                                    // Execute trade
                                    const newPlayers = [...gameState.players];
                                    
                                    // Swap teams
                                    myPlayers.forEach(p => {
                                        const player = newPlayers.find(np => np.id === p.id);
                                        player.teamId = tradePartnerTeamId;
                                        // Reset lineup assignments
                                        player.lineNumber = 0;
                                        player.linePosition = null;
                                        player.ppUnit = null;
                                        player.pkUnit = null;
                                        if (player.position === 'G') player.dressed = false;
                                        
                                        // Add to player's trade history with full transaction details
                                        if (!player.tradeHistory) player.tradeHistory = [];
                                        player.tradeHistory.push({
                                            date: new Date(gameState.currentDate),
                                            from: userTeamId,
                                            to: tradePartnerTeamId,
                                            year: gameState.year,
                                            // Include who they were traded with and for
                                            tradedWith: myPlayers.filter(mp => mp.id !== p.id).map(mp => ({ 
                                                id: mp.id, 
                                                name: `${mp.firstName} ${mp.lastName}`, 
                                                position: mp.position 
                                            })),
                                            tradedFor: theirPlayers.map(tp => ({ 
                                                id: tp.id, 
                                                name: `${tp.firstName} ${tp.lastName}`, 
                                                position: tp.position 
                                            }))
                                        });
                                    });
                                    
                                    theirPlayers.forEach(p => {
                                        const player = newPlayers.find(np => np.id === p.id);
                                        player.teamId = userTeamId;
                                        // Reset lineup assignments
                                        player.lineNumber = 0;
                                        player.linePosition = null;
                                        player.ppUnit = null;
                                        player.pkUnit = null;
                                        if (player.position === 'G') player.dressed = false;
                                        
                                        // Add to player's trade history with full transaction details
                                        if (!player.tradeHistory) player.tradeHistory = [];
                                        player.tradeHistory.push({
                                            date: new Date(gameState.currentDate),
                                            from: tradePartnerTeamId,
                                            to: userTeamId,
                                            year: gameState.year,
                                            // Include who they were traded with and for
                                            tradedWith: theirPlayers.filter(tp => tp.id !== p.id).map(tp => ({ 
                                                id: tp.id, 
                                                name: `${tp.firstName} ${tp.lastName}`, 
                                                position: tp.position 
                                            })),
                                            tradedFor: myPlayers.map(mp => ({ 
                                                id: mp.id, 
                                                name: `${mp.firstName} ${mp.lastName}`, 
                                                position: mp.position 
                                            }))
                                        });
                                    });
                                    
                                    // Add to team trade history
                                    if (!gameState.tradeHistory) gameState.tradeHistory = [];
                                    gameState.tradeHistory.push({
                                        date: new Date(gameState.currentDate),
                                        year: gameState.year,
                                        team1: userTeamId,
                                        team2: tradePartnerTeamId,
                                        team1Gives: myPlayers.map(p => ({ id: p.id, name: `${p.firstName} ${p.lastName}`, position: p.position, ovr: p.ratings.overall })),
                                        team2Gives: theirPlayers.map(p => ({ id: p.id, name: `${p.firstName} ${p.lastName}`, position: p.position, ovr: p.ratings.overall }))
                                    });
                                    
                                    // Auto-assign lines
                                    autoSetAllLines(newPlayers, userTeamId);
                                    autoSetAllLines(newPlayers, tradePartnerTeamId);
                                    
                                    // Create the updated game state
                                    const updatedGameState = { ...gameState, players: newPlayers };
                                    setGameState(updatedGameState);
                                    
                                    setTradeMessage({
                                        type: 'success',
                                        text: ` Trade Accepted! ${myPlayers.length} player(s) for ${theirPlayers.length} player(s). Check your roster!`
                                    });
                                    
                                    // Clear selections
                                    setMySelectedPlayers([]);
                                    setTheirSelectedPlayers([]);
                                    
                                    // Save game with the UPDATED state
                                    saveGameToLocalStorage(updatedGameState, userTeamId, playoffState, seasonMode);
                                } else {
                                    setTradeMessage({
                                        type: 'error',
                                        text: ` Trade Rejected! ${theirTeam.city} declined the offer. Try adjusting the trade value. (Score: ${Math.round(acceptanceScore)}/50)`
                                    });
                                }
                            };

                            const renderPlayerTable = (players, selectedIds, isMyTeam) => (
                                <div style={{ overflowX: 'auto' }}>
                                    <table className="stats-table">
                                        <thead>
                                            <tr>
                                                <th style={{ width: '40px' }}></th>
                                                <th onClick={() => handleTradeSort('firstName')} style={{ cursor: 'pointer' }}>
                                                    Name {tradeSortConfig.key === 'firstName' && (tradeSortConfig.direction === 'desc' ? '' : '')}
                                                </th>
                                                <th onClick={() => handleTradeSort('position')} style={{ cursor: 'pointer' }}>
                                                    Pos {tradeSortConfig.key === 'position' && (tradeSortConfig.direction === 'desc' ? '' : '')}
                                                </th>
                                                <th onClick={() => handleTradeSort('age')} style={{ cursor: 'pointer' }}>
                                                    Age {tradeSortConfig.key === 'age' && (tradeSortConfig.direction === 'desc' ? '' : '')}
                                                </th>
                                                <th onClick={() => handleTradeSort('ratings.overall')} style={{ cursor: 'pointer' }}>
                                                    OVR {tradeSortConfig.key === 'ratings.overall' && (tradeSortConfig.direction === 'desc' ? '' : '')}
                                                </th>
                                                <th onClick={() => handleTradeSort('ratings.potential')} style={{ cursor: 'pointer' }}>
                                                    POT {tradeSortConfig.key === 'ratings.potential' && (tradeSortConfig.direction === 'desc' ? '' : '')}
                                                </th>
                                                <th onClick={() => handleTradeSort('stats.gamesPlayed')} style={{ cursor: 'pointer' }}>
                                                    GP {tradeSortConfig.key === 'stats.gamesPlayed' && (tradeSortConfig.direction === 'desc' ? '' : '')}
                                                </th>
                                                <th onClick={() => handleTradeSort('stats.points')} style={{ cursor: 'pointer' }}>
                                                    PTS {tradeSortConfig.key === 'stats.points' && (tradeSortConfig.direction === 'desc' ? '' : '')}
                                                </th>
                                                <th>Line/Role</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {players.map(player => {
                                                const isSelected = selectedIds.includes(player.id);
                                                const isInjured = player.injury.injured;
                                                
                                                return (
                                                    <tr 
                                                        key={player.id}
                                                        style={{ 
                                                            background: isSelected ? 'rgba(59, 130, 246, 0.2)' : 'transparent',
                                                            cursor: isInjured ? 'not-allowed' : 'pointer',
                                                            opacity: isInjured ? 0.5 : 1
                                                        }}
                                                        onClick={() => !isInjured && togglePlayerSelection(player.id, isMyTeam)}
                                                    >
                                                        <td>
                                                            <input 
                                                                type="checkbox" 
                                                                checked={isSelected}
                                                                disabled={isInjured}
                                                                onChange={() => {}}
                                                                style={{ cursor: isInjured ? 'not-allowed' : 'pointer' }}
                                                            />
                                                        </td>
                                                        <td>{player.firstName} {player.lastName}</td>
                                                        <td>{player.position}</td>
                                                        <td className="text-center">{player.age}</td>
                                                        <td className="text-center">{player.ratings.overall}</td>
                                                        <td className="text-center">{player.ratings.potential}</td>
                                                        <td className="text-center">{player.stats.gamesPlayed}</td>
                                                        <td className="text-center">{player.stats.points}</td>
                                                        <td className="text-center">
                                                            {player.position === 'G' 
                                                                ? (player.dressed ? 'Dressed' : 'Scratch')
                                                                : (player.lineNumber > 0 ? `Line ${player.lineNumber}` : 'Scratch')
                                                            }
                                                        </td>
                                                        <td className="text-center">
                                                            {isInjured ? (
                                                                <span style={{ color: '#f87171', fontWeight: 'bold' }}>
                                                                    Injured
                                                                </span>
                                                            ) : (
                                                                <span style={{ color: '#4ade80' }}>
                                                                    Healthy
                                                                </span>
                                                            )}
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            );

                            const evaluation = canProposeTrade ? evaluateTrade() : null;

                            return (
                                <div className="card">
                                    <h2> Trade Center</h2>
                                    <p style={{ color: '#93c5fd', marginBottom: '2rem' }}>
                                        Select players from both teams to propose a trade. Click column headers to sort.
                                    </p>

                                    {/* Trade Message */}
                                    {tradeMessage && (
                                        <div style={{
                                            padding: '1rem',
                                            marginBottom: '2rem',
                                            borderRadius: '0.5rem',
                                            background: tradeMessage.type === 'success' ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)',
                                            border: `2px solid ${tradeMessage.type === 'success' ? '#22c55e' : '#ef4444'}`,
                                            color: tradeMessage.type === 'success' ? '#22c55e' : '#f87171',
                                            fontWeight: 'bold'
                                        }}>
                                            {tradeMessage.text}
                                        </div>
                                    )}

                                    {/* Your Team */}
                                    <div style={{ marginBottom: '3rem' }}>
                                        <h3 style={{ color: '#22c55e', marginBottom: '1rem' }}>
                                            Your Team ({getTeam(userTeamId)?.city} {getTeam(userTeamId)?.name})
                                            {mySelectedPlayers.length > 0 && (
                                                <span style={{ marginLeft: '1rem', color: '#93c5fd', fontSize: '0.9rem' }}>
                                                    - {mySelectedPlayers.length} player(s) selected
                                                </span>
                                            )}
                                        </h3>
                                        {renderPlayerTable(myTeamPlayers, mySelectedPlayers, true)}
                                    </div>

                                    {/* Team Selection */}
                                    <div style={{ marginBottom: '2rem' }}>
                                        <label style={{ display: 'block', color: '#93c5fd', marginBottom: '0.5rem', fontWeight: 'bold' }}>
                                            Select Trade Partner:
                                        </label>
                                        <select 
                                            className="select"
                                            value={tradePartnerTeamId || ''}
                                            onChange={(e) => {
                                                setTradePartnerTeamId(e.target.value ? parseInt(e.target.value) : null);
                                                setTheirSelectedPlayers([]);
                                                setTradeMessage(null);
                                            }}
                                            style={{ width: '400px' }}
                                        >
                                            <option value="">-- Choose a team --</option>
                                            {TEAMS.filter(t => t.id !== userTeamId).map(team => (
                                                <option key={team.id} value={team.id}>
                                                    {team.city} {team.name}
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    {/* Their Team */}
                                    {tradePartnerTeamId && (
                                        <div style={{ marginBottom: '2rem' }}>
                                            <h3 style={{ color: '#fbbf24', marginBottom: '1rem' }}>
                                                {getTeam(tradePartnerTeamId)?.city} {getTeam(tradePartnerTeamId)?.name}
                                                {theirSelectedPlayers.length > 0 && (
                                                    <span style={{ marginLeft: '1rem', color: '#93c5fd', fontSize: '0.9rem' }}>
                                                        - {theirSelectedPlayers.length} player(s) selected
                                                    </span>
                                                )}
                                            </h3>
                                            {renderPlayerTable(theirTeamPlayers, theirSelectedPlayers, false)}
                                        </div>
                                    )}

                                    {/* Trade Evaluation & Button */}
                                    {canProposeTrade && (
                                        <div style={{
                                            padding: '1.5rem',
                                            background: 'rgba(59, 130, 246, 0.1)',
                                            borderRadius: '0.5rem',
                                            border: '2px solid rgba(59, 130, 246, 0.3)',
                                            marginTop: '2rem'
                                        }}>
                                            <h3 style={{ color: '#60a5fa', marginBottom: '1rem' }}>Trade Summary</h3>
                                            
                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '2rem', marginBottom: '1.5rem' }}>
                                                <div>
                                                    <h4 style={{ color: '#22c55e', marginBottom: '0.5rem' }}>You Give:</h4>
                                                    <div style={{ color: '#e2e8f0', fontSize: '0.9rem' }}>
                                                        <div>Players: {mySelectedPlayers.length}</div>
                                                        <div>Total OVR: {evaluation.myValue.totalOVR}</div>
                                                        <div>Avg Age: {evaluation.myValue.avgAge.toFixed(1)}</div>
                                                        <div>Total PTS: {evaluation.myValue.totalPts}</div>
                                                    </div>
                                                </div>
                                                <div>
                                                    <h4 style={{ color: '#fbbf24', marginBottom: '0.5rem' }}>You Receive:</h4>
                                                    <div style={{ color: '#e2e8f0', fontSize: '0.9rem' }}>
                                                        <div>Players: {theirSelectedPlayers.length}</div>
                                                        <div>Total OVR: {evaluation.theirValue.totalOVR}</div>
                                                        <div>Avg Age: {evaluation.theirValue.avgAge.toFixed(1)}</div>
                                                        <div>Total PTS: {evaluation.theirValue.totalPts}</div>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Lopsided Warning */}
                                            {evaluation.isLopsided && (
                                                <div style={{
                                                    padding: '1rem',
                                                    marginBottom: '1rem',
                                                    background: 'rgba(245, 158, 11, 0.2)',
                                                    border: '2px solid #f59e0b',
                                                    borderRadius: '0.375rem',
                                                    color: '#fbbf24',
                                                    fontWeight: 'bold'
                                                }}>
                                                     Warning: This trade is lopsided! OVR difference: {evaluation.ovrDiff} ({evaluation.ovrDiffPercent.toFixed(1)}%)
                                                    <br />
                                                    <span style={{ fontSize: '0.85rem', fontWeight: 'normal' }}>
                                                        Trades with large OVR differences are likely to be rejected.
                                                    </span>
                                                </div>
                                            )}

                                            <button
                                                onClick={proposeTrade}
                                                style={{
                                                    width: '100%',
                                                    padding: '1rem',
                                                    background: 'linear-gradient(135deg, #3b82f6, #2563eb)',
                                                    color: 'white',
                                                    border: 'none',
                                                    borderRadius: '0.5rem',
                                                    fontSize: '1.1rem',
                                                    fontWeight: 'bold',
                                                    cursor: 'pointer'
                                                }}
                                            >
                                                 Propose Trade
                                            </button>
                                        </div>
                                    )}

                                    {/* Instructions */}
                                    <div style={{ 
                                        marginTop: '2rem',
                                        padding: '1rem',
                                        background: 'rgba(100, 116, 139, 0.2)',
                                        borderRadius: '0.5rem'
                                    }}>
                                        <h4 style={{ color: '#cbd5e1', marginBottom: '0.5rem' }}> How to Trade</h4>
                                        <ul style={{ color: '#94a3b8', fontSize: '0.9rem', lineHeight: '1.8' }}>
                                            <li>Click checkboxes or rows to select players from your team</li>
                                            <li>Select a trade partner from the dropdown</li>
                                            <li>Click checkboxes or rows to select their players</li>
                                            <li>Click "Propose Trade" when ready</li>
                                            <li>AI evaluates: OVR balance, age, potential, stats, team needs (competing vs rebuilding)</li>
                                            <li>Injured players cannot be traded</li>
                                            <li>Successful trades update rosters and assign lines automatically</li>
                                        </ul>
                                    </div>
                                </div>
                            );
                        })()}

                        {/* TRANSACTIONS VIEW */}
                        {currentView === 'transactions' && gameState && (
                            <div className="card">
                                <h2> League Transactions</h2>
                                <p style={{ color: '#93c5fd', marginBottom: '2rem' }}>
                                    All trades completed during the {gameState.year}-{(gameState.year + 1).toString().slice(-2)} season
                                </p>
                                
                                {gameState.tradeHistory && gameState.tradeHistory.length > 0 ? (
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                        {gameState.tradeHistory
                                            .sort((a, b) => new Date(b.date) - new Date(a.date))
                                            .map((trade, idx) => {
                                                const team1 = getTeam(trade.team1);
                                                const team2 = getTeam(trade.team2);
                                                const tradeDate = new Date(trade.date);
                                                
                                                return (
                                                    <div key={idx} style={{
                                                        padding: '1.5rem',
                                                        background: trade.isAITrade ? 'rgba(59, 130, 246, 0.1)' : 'rgba(34, 197, 94, 0.1)',
                                                        borderRadius: '0.75rem',
                                                        border: `2px solid ${trade.isAITrade ? 'rgba(59, 130, 246, 0.3)' : 'rgba(34, 197, 94, 0.3)'}`
                                                    }}>
                                                        {/* Trade Header */}
                                                        <div style={{ 
                                                            display: 'flex',
                                                            justifyContent: 'space-between',
                                                            alignItems: 'center',
                                                            marginBottom: '1rem',
                                                            paddingBottom: '1rem',
                                                            borderBottom: `2px solid ${trade.isAITrade ? 'rgba(59, 130, 246, 0.2)' : 'rgba(34, 197, 94, 0.2)'}`
                                                        }}>
                                                            <div style={{ 
                                                                fontSize: '1.3rem',
                                                                fontWeight: 'bold',
                                                                color: '#fff'
                                                            }}>
                                                                {team1?.city} {team1?.name}  {team2?.city} {team2?.name}
                                                            </div>
                                                            <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end', gap: '0.25rem' }}>
                                                                <div style={{ 
                                                                    fontSize: '0.875rem',
                                                                    color: '#93c5fd'
                                                                }}>
                                                                    {tradeDate.toLocaleDateString('en-US', { 
                                                                        month: 'short', 
                                                                        day: 'numeric', 
                                                                        year: 'numeric' 
                                                                    })}
                                                                </div>
                                                                {trade.isAITrade && (
                                                                    <div style={{
                                                                        padding: '0.25rem 0.5rem',
                                                                        background: 'rgba(59, 130, 246, 0.3)',
                                                                        borderRadius: '0.25rem',
                                                                        fontSize: '0.75rem',
                                                                        color: '#60a5fa',
                                                                        fontWeight: 'bold'
                                                                    }}>
                                                                        AI TRADE
                                                                    </div>
                                                                )}
                                                                {!trade.isAITrade && (
                                                                    <div style={{
                                                                        padding: '0.25rem 0.5rem',
                                                                        background: 'rgba(34, 197, 94, 0.3)',
                                                                        borderRadius: '0.25rem',
                                                                        fontSize: '0.75rem',
                                                                        color: '#22c55e',
                                                                        fontWeight: 'bold'
                                                                    }}>
                                                                        YOUR TRADE
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Trade Details */}
                                                        <div style={{ 
                                                            display: 'grid',
                                                            gridTemplateColumns: '1fr auto 1fr',
                                                            gap: '2rem',
                                                            alignItems: 'start'
                                                        }}>
                                                            {/* Team 1 Gives */}
                                                            <div>
                                                                <h4 style={{ 
                                                                    color: '#fbbf24',
                                                                    marginBottom: '0.75rem',
                                                                    fontSize: '1rem'
                                                                }}>
                                                                    {team1?.city} Trades:
                                                                </h4>
                                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                                                    {trade.team1Gives.map((player, pIdx) => {
                                                                        const fullPlayer = gameState.players.find(p => p.id === player.id);
                                                                        return (
                                                                            <div key={pIdx} style={{
                                                                                padding: '0.5rem',
                                                                                background: 'rgba(0, 0, 0, 0.2)',
                                                                                borderRadius: '0.375rem',
                                                                                display: 'flex',
                                                                                justifyContent: 'space-between',
                                                                                alignItems: 'center',
                                                                                cursor: fullPlayer ? 'pointer' : 'default'
                                                                            }}
                                                                            onClick={() => fullPlayer && navigateTo('playerProfile', fullPlayer)}
                                                                            >
                                                                                <span 
                                                                                    style={{ color: '#fff' }}
                                                                                    className={fullPlayer ? 'clickable-player' : ''}
                                                                                >
                                                                                    {player.name}
                                                                                </span>
                                                                                <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                                                                                    <span style={{ 
                                                                                        color: '#93c5fd',
                                                                                        fontSize: '0.875rem'
                                                                                    }}>
                                                                                        {player.position}
                                                                                    </span>
                                                                                    <span style={{ 
                                                                                        color: '#fbbf24',
                                                                                        fontWeight: 'bold',
                                                                                        fontSize: '0.875rem'
                                                                                    }}>
                                                                                        {player.ovr} OVR
                                                                                    </span>
                                                                                </div>
                                                                            </div>
                                                                        );
                                                                    })}
                                                                </div>
                                                            </div>
                                                            
                                                            {/* Arrow */}
                                                            <div style={{ 
                                                                fontSize: '2rem',
                                                                color: '#93c5fd',
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                justifyContent: 'center'
                                                            }}>
                                                                
                                                            </div>
                                                            
                                                            {/* Team 2 Gives */}
                                                            <div>
                                                                <h4 style={{ 
                                                                    color: '#fbbf24',
                                                                    marginBottom: '0.75rem',
                                                                    fontSize: '1rem'
                                                                }}>
                                                                    {team2?.city} Trades:
                                                                </h4>
                                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                                                    {trade.team2Gives.map((player, pIdx) => {
                                                                        const fullPlayer = gameState.players.find(p => p.id === player.id);
                                                                        return (
                                                                            <div key={pIdx} style={{
                                                                                padding: '0.5rem',
                                                                                background: 'rgba(0, 0, 0, 0.2)',
                                                                                borderRadius: '0.375rem',
                                                                                display: 'flex',
                                                                                justifyContent: 'space-between',
                                                                                alignItems: 'center',
                                                                                cursor: fullPlayer ? 'pointer' : 'default'
                                                                            }}
                                                                            onClick={() => fullPlayer && navigateTo('playerProfile', fullPlayer)}
                                                                            >
                                                                                <span 
                                                                                    style={{ color: '#fff' }}
                                                                                    className={fullPlayer ? 'clickable-player' : ''}
                                                                                >
                                                                                    {player.name}
                                                                                </span>
                                                                                <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                                                                                    <span style={{ 
                                                                                        color: '#93c5fd',
                                                                                        fontSize: '0.875rem'
                                                                                    }}>
                                                                                        {player.position}
                                                                                    </span>
                                                                                    <span style={{ 
                                                                                        color: '#fbbf24',
                                                                                        fontWeight: 'bold',
                                                                                        fontSize: '0.875rem'
                                                                                    }}>
                                                                                        {player.ovr} OVR
                                                                                    </span>
                                                                                </div>
                                                                            </div>
                                                                        );
                                                                    })}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                    </div>
                                ) : (
                                    <div style={{
                                        padding: '3rem',
                                        textAlign: 'center',
                                        color: '#93c5fd',
                                        background: 'rgba(30, 58, 138, 0.2)',
                                        borderRadius: '0.5rem'
                                    }}>
                                        <div style={{ fontSize: '3rem', marginBottom: '1rem' }}></div>
                                        <p style={{ fontSize: '1.2rem' }}>No trades have been completed this season yet.</p>
                                        <p style={{ marginTop: '0.5rem', fontSize: '0.9rem', color: '#64748b' }}>
                                            Trades typically increase near the trade deadline (around game 60).
                                        </p>
                                    </div>
                                )}
                            </div>
                        )}

                        {currentView === 'roadmap' && (
                            <div>
                                <div className="card">
                                    <h1 style={{ color: '#22d3ee', marginBottom: '1rem' }}> Hockey GM - Development Roadmap</h1>
                                    <p style={{ color: '#93c5fd', marginBottom: '1rem', fontSize: '1.1rem' }}>
                                        Last Updated: December 29, 2024
                                    </p>
                                    <p style={{ color: '#e2e8f0', marginBottom: '2rem' }}>
                                        Building Hockey GM one phase at a time. Focus on completing each phase fully before moving to the next. Current priority: Technical infrastructure for multi-season support.
                                    </p>
                                </div>

                                <div className="card" style={{ border: '2px solid #22c55e' }}>
                                    <h2 style={{ color: '#22c55e' }}> Phase 1: Core Simulation - COMPLETE</h2>
                                    <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                        <li> 30-team NHL structure (Atlantic, Metropolitan, Central, Pacific divisions)</li>
                                        <li> 82-game regular season simulation</li>
                                        <li> Day-by-day and full season simulation</li>
                                        <li> Realistic game engine (team ratings, home advantage, scoring distribution)</li>
                                        <li> Full player stats tracking (G, A, PTS, +/-, PIM, TOI, SOG)</li>
                                        <li> Goalie stats (W, L, SV%, GAA, SO)</li>
                                        <li> Team standings (division, conference, wildcard, league views)</li>
                                        <li> League leaders board (7 categories: Goals, Assists, Points, +/-, PIM, TOI, SOG)</li>
                                        <li> Dynamic player profiles with career stats</li>
                                        <li> Injury system with realistic recovery times</li>
                                        <li> Load management and healthy scratches</li>
                                        <li> Team profiles with roster breakdowns</li>
                                        <li> Game calendar with schedule view</li>
                                        <li> Basic trade system</li>
                                        <li> Save/load game functionality</li>
                                    </ul>
                                </div>

                                <div className="card" style={{ border: '2px solid #22c55e' }}>
                                    <h2 style={{ color: '#22c55e' }}> Phase 2: Playoffs - COMPLETE</h2>
                                    <p style={{ color: '#22d3ee', marginBottom: '1rem' }}>Full NHL-style postseason with detailed stats!</p>
                                    
                                    <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                        <li> 16-team playoff bracket (8 per conference, 1v8, 2v7, 3v6, 4v5)</li>
                                        <li> Best-of-7 series for all 4 rounds</li>
                                        <li> Full tournament bracket visualization (7-column tree view)</li>
                                        <li> Day-by-day playoff simulation (alternating East/West conferences)</li>
                                        <li> Live bracket updates after each day</li>
                                        <li> Game summary display (scores, series status, winner highlights)</li>
                                        <li> <strong>Separate playoff stats tracking (starts from 0 each playoffs)</strong></li>
                                        <li> <strong>Detailed playoff game views with per-game stats</strong></li>
                                        <li> <strong>Period-by-period scoring summaries for playoff games</strong></li>
                                        <li> <strong>Running playoff totals in scoring summary (e.g., McDavid (8) shows 8th playoff goal)</strong></li>
                                        <li> <strong>Home/Away team tabs for playoff game stats</strong></li>
                                        <li> <strong>Full skater stats: G, A, PTS, +/-, SOG, TOI</strong></li>
                                        <li> <strong>Full goalie stats: SA, SV, GA, SV%, W/L</strong></li>
                                        <li> <strong>Healthy scratch tracking for playoff games</strong></li>
                                        <li> 2-2-1-1-1 home game format (realistic NHL schedule)</li>
                                        <li> Stanley Cup Finals with champion crowning</li>
                                        <li> Rest days between rounds</li>
                                        <li> Series history preservation</li>
                                        <li> Playoff leaders board toggle</li>
                                        <li> Goalie leaderboards (Wins, SV%, GAA, Shutouts)</li>
                                    </ul>
                                </div>

                                <div className="card" style={{ border: '2px solid #fbbf24' }}>
                                    <h2 style={{ color: '#fbbf24' }}> Phase 2.5: Technical Infrastructure - IN PROGRESS</h2>
                                    <p style={{ color: '#22d3ee', marginBottom: '1rem' }}>Performance optimization and long-term stability for multi-season play</p>
                                    
                                    <h3 style={{ color: '#22c55e', marginTop: '1rem' }}> Completed:</h3>
                                    <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                        <li> Per-game stat tracking for all games (regular season + playoffs)</li>
                                        <li> Season totals = sum of all game stats (perfect accuracy)</li>
                                        <li> Game detail views with full player stats</li>
                                        <li> Period-by-period scoring summaries</li>
                                        <li> Running season totals in scoring summaries</li>
                                    </ul>
                                    
                                    <h3 style={{ color: '#fbbf24', marginTop: '1rem' }}> Next Priority - Data Management:</h3>
                                    <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                        <li> <strong>Season data compression system (CRITICAL for multi-season play)</strong></li>
                                        <li style={{ marginLeft: '1.5rem', fontSize: '0.95em', color: '#93c5fd' }}> Problem: 1 season = ~10.6 MB, 30 seasons = 318 MB (too large!)</li>
                                        <li style={{ marginLeft: '1.5rem', fontSize: '0.95em', color: '#93c5fd' }}> Solution: Keep last 3 seasons detailed (~32 MB), compress older seasons to summaries</li>
                                        <li style={{ marginLeft: '1.5rem', fontSize: '0.95em', color: '#93c5fd' }}> Result: 30 seasons = ~45 MB (safe for all browsers)</li>
                                        <li style={{ marginLeft: '1.5rem', fontSize: '0.95em', color: '#93c5fd' }}> Compressed seasons keep: standings, player season totals, playoff results, awards</li>
                                        <li style={{ marginLeft: '1.5rem', fontSize: '0.95em', color: '#93c5fd' }}> Compressed seasons remove: per-game details (saves 99% space per season)</li>
                                        <li> <strong>Export/import system for season backups</strong></li>
                                        <li style={{ marginLeft: '1.5rem', fontSize: '0.95em', color: '#93c5fd' }}> Users can export any season as downloadable JSON file</li>
                                        <li style={{ marginLeft: '1.5rem', fontSize: '0.95em', color: '#93c5fd' }}> Import old seasons to view historical details</li>
                                        <li style={{ marginLeft: '1.5rem', fontSize: '0.95em', color: '#93c5fd' }}> Frees up browser storage space</li>
                                        <li> <strong>Storage monitoring & warnings</strong></li>
                                        <li style={{ marginLeft: '1.5rem', fontSize: '0.95em', color: '#93c5fd' }}> Real-time storage usage display</li>
                                        <li style={{ marginLeft: '1.5rem', fontSize: '0.95em', color: '#93c5fd' }}> Warning at 80% capacity</li>
                                        <li style={{ marginLeft: '1.5rem', fontSize: '0.95em', color: '#93c5fd' }}> Recommendations for managing storage</li>
                                    </ul>
                                    
                                    <h3 style={{ color: '#8b5cf6', marginTop: '1rem' }}> Future Technical Features:</h3>
                                    <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                        <li>PWA (Progressive Web App) support - installable on desktop & mobile</li>
                                        <li>Offline mode capability</li>
                                        <li>Cloud save sync (premium feature)</li>
                                        <li>IndexedDB migration (larger storage capacity)</li>
                                        <li>Performance profiling & optimization</li>
                                    </ul>
                                </div>

                                <div className="card">
                                    <h2 style={{ color: '#8b5cf6' }}> Phase 3: Franchise Management - NEXT MAJOR PHASE</h2>
                                    <p style={{ color: '#22d3ee', marginBottom: '1rem' }}>Foundation for long-term gameplay and multiple seasons</p>
                                    
                                    <h3 style={{ color: '#22d3ee', marginTop: '1rem' }}>1. Multi-Season Framework (HIGHEST PRIORITY)</h3>
                                    <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                        <li>Season progression system (advance to next season button)</li>
                                        <li>Offseason phase (draft  free agency  training camp)</li>
                                        <li>Historical records tracking (past champions, award winners)</li>
                                        <li>Career stats accumulation across seasons</li>
                                        <li>Season summary screens (year-end wrap-up)</li>
                                        <li>Season history viewer (browse past seasons)</li>
                                    </ul>
                                    
                                    <h3 style={{ color: '#22d3ee', marginTop: '1rem' }}>2. Player Development & Aging</h3>
                                    <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                        <li>Age-based progression/regression curves</li>
                                        <li>Young players (18-24): +1-5 OVR per season (rapid development)</li>
                                        <li>Prime players (25-30): maintain or slight improvement (+0-1 OVR)</li>
                                        <li>Aging players (31+): -1-3 OVR per season (gradual decline)</li>
                                        <li>Potential rating system (determines growth ceiling)</li>
                                        <li>Playing time affects development (ice time matters)</li>
                                        <li>Retirement logic (age 38-42, or declining performance)</li>
                                    </ul>
                                    
                                    <h3 style={{ color: '#22d3ee', marginTop: '1rem' }}>3. Entry Draft System</h3>
                                    <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                        <li>7-round draft (224 picks total, 32 per round)</li>
                                        <li>Draft lottery for bottom 16 teams (weighted odds)</li>
                                        <li>Prospect generation (18-year-olds with potential ratings)</li>
                                        <li>Draft board with rankings and scouting reports</li>
                                        <li>Auto-pick option for later rounds</li>
                                        <li>Draft pick trading (future picks too)</li>
                                        <li>Draft history tracking</li>
                                    </ul>
                                    
                                    <h3 style={{ color: '#22d3ee', marginTop: '1rem' }}>4. Contracts & Salary Cap</h3>
                                    <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                        <li>Player contracts (1-8 years, $700K-$15M per year)</li>
                                        <li>Salary cap ($83.5M) and floor ($61.7M)</li>
                                        <li>Cap hit calculation (AAV - average annual value)</li>
                                        <li>Contract expiry tracking and RFA/UFA eligibility</li>
                                        <li>Team payroll view with cap space display</li>
                                        <li>Entry-level contracts (ELC) for rookies</li>
                                    </ul>
                                    
                                    <h3 style={{ color: '#22d3ee', marginTop: '1rem' }}>5. Free Agency</h3>
                                    <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                        <li>UFA (Unrestricted Free Agents) - open market</li>
                                        <li>RFA (Restricted Free Agents) - qualifying offers required</li>
                                        <li>Contract negotiation AI (players demand market value)</li>
                                        <li>July 1st free agency frenzy period</li>
                                        <li>Signing bonuses and term preferences</li>
                                        <li>Team needs vs. player asking price</li>
                                    </ul>
                                </div>

                                <div className="card">
                                    <h2 style={{ color: '#3b82f6' }}> Phase 4: Advanced Features</h2>
                                    <p style={{ color: '#22d3ee', marginBottom: '1rem' }}>Polish and depth for dedicated players</p>
                                    
                                    <h3 style={{ color: '#22d3ee', marginTop: '1rem' }}>Awards & Honors</h3>
                                    <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                        <li>Hart Trophy (MVP)</li>
                                        <li>Vezina Trophy (Best Goalie)</li>
                                        <li>Norris Trophy (Best Defenseman)</li>
                                        <li>Calder Trophy (Rookie of the Year)</li>
                                        <li>Conn Smythe Trophy (Playoff MVP)</li>
                                        <li>All-Star Teams (1st, 2nd, 3rd)</li>
                                    </ul>
                                    
                                    <h3 style={{ color: '#22d3ee', marginTop: '1rem' }}>Financial Management</h3>
                                    <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                        <li>Attendance tracking (15,000-21,000 capacity)</li>
                                        <li>Ticket revenue based on performance</li>
                                        <li>Playoff revenue bonuses</li>
                                        <li>Operating expenses and profit/loss</li>
                                        <li>Arena upgrades</li>
                                    </ul>
                                    
                                    <h3 style={{ color: '#22d3ee', marginTop: '1rem' }}>Advanced Stats</h3>
                                    <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                        <li>Corsi & Fenwick (shot attempt metrics)</li>
                                        <li>PDO (shooting % + save %)</li>
                                        <li>Zone starts (offensive/defensive)</li>
                                        <li>Quality of competition metrics</li>
                                        <li>Heat maps and advanced visualizations</li>
                                    </ul>
                                    
                                    <h3 style={{ color: '#22d3ee', marginTop: '1rem' }}> Live Game Viewer</h3>
                                    <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                        <li><strong>Watch games play out in real-time!</strong></li>
                                        <li>Text-based play-by-play commentary</li>
                                        <li>Period-by-period progression</li>
                                        <li>Live score updates and shot counters</li>
                                        <li>Highlight reel of key moments</li>
                                        <li>Option to sim fast or watch live</li>
                                    </ul>
                                    <p style={{ color: '#22d3ee', marginTop: '0.5rem', fontStyle: 'italic', fontSize: '0.9rem' }}>
                                        Example: "14:23 1st - McDavid carries into the zone... shoots... GOAL! McDavid (15) from Draisaitl (22). Oilers lead 2-1!"
                                    </p>
                                </div>

                                <div className="card">
                                    <h2 style={{ color: '#a78bfa' }}> Phase 5: International Expansion (Future Vision)</h2>
                                    <p style={{ color: '#22d3ee', marginBottom: '1rem' }}>A global hockey universe - this is the long-term dream!</p>
                                    
                                    <h3 style={{ color: '#22d3ee' }}>Continental Leagues</h3>
                                    <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                        <li> <strong>North America:</strong> 30 teams, 82-game season (existing)</li>
                                        <li> <strong>Europe:</strong> 30 teams (Russia, Sweden, Finland, Czech), 60-game season</li>
                                        <li> <strong>Asia:</strong> 30 teams (Japan, Korea, China, Kazakhstan), 60-game season</li>
                                        <li> <strong>South America:</strong> 30 teams (Argentina, Brazil, Chile), 60-game season</li>
                                        <li> <strong>Africa:</strong> 30 teams (South Africa, Algeria, Morocco), 60-game season</li>
                                    </ul>
                                    
                                    <h3 style={{ color: '#22d3ee', marginTop: '1.5rem' }}>Inter-Continental Competition</h3>
                                    <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                        <li> <strong>Champions League:</strong> Top 4 from each league (20 teams) - Group stage  Knockout  Final</li>
                                        <li> <strong>World Cup of Hockey:</strong> National teams, every 4 years, 32 nations</li>
                                        <li> <strong>Olympics:</strong> Winter Olympics integration</li>
                                    </ul>
                                    
                                    <p style={{ color: '#93c5fd', marginTop: '1.5rem', fontStyle: 'italic' }}>
                                        Note: This phase requires Phases 1-4 to be fully complete and stable. It's a massive undertaking that will come after the core game is polished.
                                    </p>
                                </div>

                                <div className="card" style={{ background: 'rgba(59, 130, 246, 0.1)', border: '2px solid #3b82f6' }}>
                                    <h2 style={{ color: '#3b82f6' }}> Development Philosophy</h2>
                                    <ul style={{ color: '#e2e8f0', lineHeight: '2', fontSize: '1.05rem' }}>
                                        <li><strong>Quality over Speed:</strong> Each feature must work perfectly before moving on</li>
                                        <li><strong>User Feedback:</strong> Your input shapes priorities and features</li>
                                        <li><strong>Incremental Progress:</strong> Small, tested updates prevent breaking changes</li>
                                        <li><strong>Save Compatibility:</strong> Your saves will work with future updates</li>
                                        <li><strong>Open Development:</strong> Track progress in this roadmap</li>
                                    </ul>
                                    
                                    <p style={{ color: '#22d3ee', marginTop: '1.5rem', fontSize: '1.1rem' }}>
                                         <strong>Current Focus:</strong> Phase 2.5 - Data compression system to enable efficient multi-season play (30+ seasons without performance issues)
                                    </p>
                                    
                                    <p style={{ color: '#93c5fd', marginTop: '1rem' }}>
                                        Have feedback or feature requests? Use the feedback button below any response to share your thoughts!
                                    </p>
                                </div>
                            </div>
                        )}

                        {/* AWARDS VIEW */}
                        {currentView === 'awards' && seasonAwards && (
                            <div>
                                <div className="card" style={{ background: 'linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(251, 191, 36, 0.1))', border: '2px solid #f59e0b' }}>
                                    <h1 style={{ color: '#fbbf24', marginBottom: '0.5rem', fontSize: '2.5rem' }}> End of Season Awards</h1>
                                    <p style={{ color: '#93c5fd', fontSize: '1.2rem' }}>
                                        {gameState.year}-{(gameState.year + 1).toString().slice(-2)} Season
                                    </p>
                                    <button 
                                        onClick={() => {
                                            setSeasonMode('playoffs');
                                            setCurrentView('playoffs');
                                        }}
                                        style={{
                                            marginTop: '1rem',
                                            padding: '0.75rem 1.5rem',
                                            background: '#22c55e',
                                            color: '#fff',
                                            border: 'none',
                                            borderRadius: '0.5rem',
                                            fontSize: '1.1rem',
                                            cursor: 'pointer',
                                            fontWeight: 'bold'
                                        }}
                                    >
                                        Continue to Playoffs 
                                    </button>
                                </div>

                                {/* LEAGUE AWARDS */}
                                <div className="card">
                                    <h2 style={{ color: '#f59e0b', marginBottom: '1.5rem' }}> League Awards</h2>
                                    
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '1.5rem' }}>
                                        {[
                                            { title: 'League MVP', player: seasonAwards.league.mvp, icon: '' },
                                            { title: 'Best Goaltender', player: seasonAwards.league.bestGoalie, icon: '' },
                                            { title: 'Best Defenseman', player: seasonAwards.league.bestDefenseman, icon: '' },
                                            { title: 'Rookie of the Year', player: seasonAwards.league.rookieOfYear, icon: '' },
                                            { title: 'Top Goal Scorer', player: seasonAwards.league.topGoalScorer, icon: '' },
                                            { title: 'Top Point Scorer', player: seasonAwards.league.topPointScorer, icon: '' },
                                            { title: 'Best Defensive Forward', player: seasonAwards.league.bestDefensiveForward, icon: '' },
                                            { title: 'Sportsmanship Award', player: seasonAwards.league.sportsmanship, icon: '' }
                                        ].map((award, idx) => {
                                            if (!award.player) return null;
                                            const team = TEAMS.find(t => t.id === award.player.teamId);
                                            return (
                                                <div key={idx} style={{
                                                    padding: '1.5rem',
                                                    background: 'rgba(245, 158, 11, 0.1)',
                                                    borderRadius: '0.75rem',
                                                    border: '2px solid rgba(245, 158, 11, 0.3)',
                                                    cursor: 'pointer'
                                                }}
                                                onClick={() => {
                                                    setSelectedPlayerProfile(award.player);
                                                    setCurrentView('playerProfile');
                                                }}>
                                                    <div style={{ fontSize: '2rem', marginBottom: '0.5rem' }}>{award.icon}</div>
                                                    <h3 style={{ color: '#fbbf24', marginBottom: '0.75rem', fontSize: '1.1rem' }}>
                                                        {award.title}
                                                    </h3>
                                                    <div style={{ color: '#fff', fontWeight: 'bold', fontSize: '1.2rem', marginBottom: '0.5rem' }}>
                                                        {award.player.firstName} {award.player.lastName}
                                                    </div>
                                                    <div style={{ color: '#93c5fd', marginBottom: '0.75rem' }}>
                                                        {team?.city} {team?.name}
                                                    </div>
                                                    <div style={{ color: '#e2e8f0', fontSize: '0.9rem' }}>
                                                        {award.player.position === 'G' ? (
                                                            <>
                                                                {award.player.stats.wins}-{award.player.stats.losses} | 
                                                                {' '}{award.player.stats.savePercentage.toFixed(3)} SV% | 
                                                                {' '}{award.player.stats.gaa.toFixed(2)} GAA
                                                            </>
                                                        ) : (
                                                            <>
                                                                {award.player.stats.goals}G {award.player.stats.assists}A {award.player.stats.points}PTS | 
                                                                {' '}{award.player.stats.plusMinus > 0 ? '+' : ''}{award.player.stats.plusMinus}
                                                            </>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                {/* ALL-STAR TEAMS */}
                                <div className="card">
                                    <h2 style={{ color: '#22d3ee', marginBottom: '1.5rem' }}> League All-Star Teams</h2>
                                    
                                    {['firstTeam', 'secondTeam', 'thirdTeam'].map((teamType, teamIdx) => {
                                        const teamName = teamType === 'firstTeam' ? '1st Team' : teamType === 'secondTeam' ? '2nd Team' : '3rd Team';
                                        const team = seasonAwards.allStars[teamType];
                                        
                                        return (
                                            <div key={teamIdx} style={{ marginBottom: '2rem' }}>
                                                <h3 style={{ color: '#22d3ee', marginBottom: '1rem' }}>{teamName}</h3>
                                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '1rem' }}>
                                                    {[
                                                        { label: 'Goalie', player: team.goalie },
                                                        { label: 'Left Defense', player: team.leftDefense },
                                                        { label: 'Right Defense', player: team.rightDefense },
                                                        { label: 'Center', player: team.center },
                                                        { label: 'Left Wing', player: team.leftWing },
                                                        { label: 'Right Wing', player: team.rightWing }
                                                    ].map((pos, posIdx) => {
                                                        if (!pos.player) return null;
                                                        const playerTeam = TEAMS.find(t => t.id === pos.player.teamId);
                                                        return (
                                                            <div key={posIdx} style={{
                                                                padding: '1rem',
                                                                background: 'rgba(59, 130, 246, 0.1)',
                                                                borderRadius: '0.5rem',
                                                                border: '1px solid rgba(59, 130, 246, 0.3)',
                                                                cursor: 'pointer'
                                                            }}
                                                            onClick={() => {
                                                                setSelectedPlayerProfile(pos.player);
                                                                setCurrentView('playerProfile');
                                                            }}>
                                                                <div style={{ color: '#93c5fd', fontSize: '0.85rem', marginBottom: '0.25rem' }}>
                                                                    {pos.label}
                                                                </div>
                                                                <div style={{ color: '#fff', fontWeight: 'bold', marginBottom: '0.25rem' }}>
                                                                    {pos.player.firstName} {pos.player.lastName}
                                                                </div>
                                                                <div style={{ color: '#64748b', fontSize: '0.85rem', marginBottom: '0.5rem' }}>
                                                                    {playerTeam?.abbreviation || playerTeam?.city}
                                                                </div>
                                                                <div style={{ color: '#e2e8f0', fontSize: '0.85rem' }}>
                                                                    {pos.player.position === 'G' ? (
                                                                        <>{pos.player.stats.wins}W | {pos.player.stats.savePercentage.toFixed(3)} SV%</>
                                                                    ) : (
                                                                        <>{pos.player.stats.points}PTS ({pos.player.stats.goals}G-{pos.player.stats.assists}A)</>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>

                                {/* DIVISION AWARDS */}
                                {['Atlantic', 'Metropolitan', 'Central', 'Pacific'].map((division, divIdx) => {
                                    const divAwards = seasonAwards.divisions[division];
                                    const divAllStars = seasonAwards.allStars.divisions[division];
                                    
                                    return (
                                        <div key={divIdx} className="card">
                                            <h2 style={{ color: '#8b5cf6', marginBottom: '1.5rem' }}>
                                                 {division} Division Awards
                                            </h2>
                                            
                                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '1.5rem', marginBottom: '2rem' }}>
                                                {[
                                                    { title: 'Division MVP', player: divAwards.mvp, icon: '' },
                                                    { title: 'Best Goaltender', player: divAwards.bestGoalie, icon: '' },
                                                    { title: 'Best Defenseman', player: divAwards.bestDefenseman, icon: '' },
                                                    { title: 'Rookie of the Year', player: divAwards.rookieOfYear, icon: '' },
                                                    { title: 'Top Scorer', player: divAwards.topScorer, icon: '' }
                                                ].map((award, awardIdx) => {
                                                    if (!award.player) return null;
                                                    const team = TEAMS.find(t => t.id === award.player.teamId);
                                                    return (
                                                        <div key={awardIdx} style={{
                                                            padding: '1rem',
                                                            background: 'rgba(139, 92, 246, 0.1)',
                                                            borderRadius: '0.5rem',
                                                            border: '1px solid rgba(139, 92, 246, 0.3)',
                                                            cursor: 'pointer'
                                                        }}
                                                        onClick={() => {
                                                            setSelectedPlayerProfile(award.player);
                                                            setCurrentView('playerProfile');
                                                        }}>
                                                            <div style={{ fontSize: '1.5rem', marginBottom: '0.5rem' }}>{award.icon}</div>
                                                            <h4 style={{ color: '#a78bfa', marginBottom: '0.5rem', fontSize: '0.95rem' }}>
                                                                {award.title}
                                                            </h4>
                                                            <div style={{ color: '#fff', fontWeight: 'bold', marginBottom: '0.25rem' }}>
                                                                {award.player.firstName} {award.player.lastName}
                                                            </div>
                                                            <div style={{ color: '#93c5fd', fontSize: '0.85rem', marginBottom: '0.5rem' }}>
                                                                {team?.city} {team?.name}
                                                            </div>
                                                            <div style={{ color: '#e2e8f0', fontSize: '0.85rem' }}>
                                                                {award.player.position === 'G' ? (
                                                                    <>{award.player.stats.savePercentage.toFixed(3)} SV% | {award.player.stats.gaa.toFixed(2)} GAA</>
                                                                ) : (
                                                                    <>{award.player.stats.points}PTS ({award.player.stats.goals}G-{award.player.stats.assists}A)</>
                                                                )}
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                            
                                            <h3 style={{ color: '#a78bfa', marginBottom: '1rem', marginTop: '1rem' }}>
                                                Division All-Stars
                                            </h3>
                                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem' }}>
                                                {[
                                                    { label: 'G', player: divAllStars.goalie },
                                                    { label: 'LD', player: divAllStars.leftDefense },
                                                    { label: 'RD', player: divAllStars.rightDefense },
                                                    { label: 'C', player: divAllStars.center },
                                                    { label: 'LW', player: divAllStars.leftWing },
                                                    { label: 'RW', player: divAllStars.rightWing }
                                                ].map((pos, posIdx) => {
                                                    if (!pos.player) return null;
                                                    const playerTeam = TEAMS.find(t => t.id === pos.player.teamId);
                                                    return (
                                                        <div key={posIdx} style={{
                                                            padding: '0.75rem',
                                                            background: 'rgba(139, 92, 246, 0.05)',
                                                            borderRadius: '0.375rem',
                                                            border: '1px solid rgba(139, 92, 246, 0.2)',
                                                            cursor: 'pointer'
                                                        }}
                                                        onClick={() => {
                                                            setSelectedPlayerProfile(pos.player);
                                                            setCurrentView('playerProfile');
                                                        }}>
                                                            <div style={{ color: '#a78bfa', fontSize: '0.75rem', marginBottom: '0.25rem', fontWeight: 'bold' }}>
                                                                {pos.label}
                                                            </div>
                                                            <div style={{ color: '#fff', fontSize: '0.9rem', fontWeight: 'bold', marginBottom: '0.25rem' }}>
                                                                {pos.player.firstName.charAt(0)}. {pos.player.lastName}
                                                            </div>
                                                            <div style={{ color: '#64748b', fontSize: '0.75rem' }}>
                                                                {playerTeam?.abbreviation}
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}

                        {/* HELP & USER MANUAL VIEW */}
                        {currentView === 'help' && (
                            <div className="card">
                                <h1 style={{ color: '#60a5fa', marginBottom: '1rem', fontSize: '2.5rem' }}> Hockey GM - User Manual</h1>
                                <p style={{ color: '#93c5fd', fontSize: '1.1rem', marginBottom: '2rem' }}>
                                    Complete guide to managing your hockey franchise
                                </p>

                                {/* GETTING STARTED */}
                                <div className="card" style={{ background: 'rgba(34, 197, 94, 0.1)', border: '2px solid #22c55e' }}>
                                    <h2 style={{ color: '#22c55e' }}> Getting Started</h2>
                                    
                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Creating Your Game</h3>
                                    <ol style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                        <li><strong>Select Your Team:</strong> Choose from 32 NHL teams on the main menu</li>
                                        <li><strong>Your Roster:</strong> Each team starts with 23 NHL players (13F + 7D + 3G)</li>
                                        <li><strong>Farm Team:</strong> You also control 23 farm team players for development</li>
                                        <li><strong>Season Length:</strong> 82-game regular season + playoffs</li>
                                    </ol>

                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Navigation</h3>
                                    <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                        <li><strong>Stats:</strong> Player stats, team stats, league leaders</li>
                                        <li><strong>Roster Management:</strong> Control your lineup, lines, trades, injuries</li>
                                        <li><strong>Season:</strong> Standings, calendar, awards, playoffs</li>
                                        <li><strong>Settings:</strong> Save game, roadmap, help</li>
                                    </ul>
                                </div>

                                {/* SIMULATION */}
                                <div className="card" style={{ background: 'rgba(59, 130, 246, 0.1)', border: '2px solid #3b82f6', marginTop: '2rem' }}>
                                    <h2 style={{ color: '#60a5fa' }}> Simulation Controls</h2>
                                    
                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Sim Day</h3>
                                    <p style={{ color: '#e2e8f0' }}>
                                        Simulates one day of the schedule. Multiple games happen per day, up to 16 games maximum.
                                        This gives you fine control to check results frequently.
                                    </p>

                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}> Sim Season</h3>
                                    <p style={{ color: '#e2e8f0' }}>
                                        Simulates the entire 82-game regular season at once. Fast way to complete a season.
                                        All stats, injuries, and awards are calculated automatically.
                                    </p>

                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Auto-Save</h3>
                                    <p style={{ color: '#e2e8f0' }}>
                                        Your game auto-saves after each day. You can also manually save via Settings   Save Game.
                                        Saves are stored in your browser's local storage.
                                    </p>
                                </div>

                                {/* ROSTER MANAGEMENT */}
                                <div className="card" style={{ background: 'rgba(251, 191, 36, 0.1)', border: '2px solid #fbbf24', marginTop: '2rem' }}>
                                    <h2 style={{ color: '#fbbf24' }}> Roster Management</h2>
                                    
                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Roster (23 Players)</h3>
                                    <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                        <li><strong>13 Forwards:</strong> Make up 4 lines</li>
                                        <li><strong>7 Defensemen:</strong> Make up 3 pairs</li>
                                        <li><strong>3 Goalies:</strong> Starter, backup, emergency</li>
                                        <li><strong>Team Overall:</strong> Shows your team's strength and league rank</li>
                                        <li><strong>Color Coding:</strong> Green (Top 5), Blue (Top 10), Yellow (Middle), Red (Bottom)</li>
                                    </ul>

                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Lines & Scratches</h3>
                                    <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                        <li><strong>Forward Lines:</strong> Assign 12 forwards to Lines 1-4 (3 per line: C, LW, RW)</li>
                                        <li><strong>Defense Pairs:</strong> Assign 6 defensemen to Pairs 1-3 (2 per pair: LD, RD)</li>
                                        <li><strong>Goalies:</strong> Dress 2 goalies (starter & backup)</li>
                                        <li><strong>Scratches:</strong> 3 players (1F, 1D, 1G) are healthy scratches each game</li>
                                        <li><strong>Auto-Set:</strong> Click "Auto-Set All Lines" to optimize by OVR</li>
                                        <li><strong>Out of Position:</strong> Players lose 3 OVR when playing wrong position</li>
                                    </ul>

                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Special Teams</h3>
                                    <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                        <li><strong>Power Play:</strong> 2 units with 5 players each (4F+1D typical)</li>
                                        <li><strong>Penalty Kill:</strong> 2 units with 4 players each (2F+2D typical)</li>
                                        <li><strong>Impact:</strong> PP/PK specialists get bonus weight in Team Overall rating</li>
                                    </ul>

                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}> Call-Ups & Send-Downs</h3>
                                    <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                        <li><strong>Call Up:</strong> Bring prospects from farm team to NHL</li>
                                        <li><strong>Send Down:</strong> Demote NHL players to farm (can't send injured players)</li>
                                        <li><strong>Auto Call-Up:</strong> When NHL player is injured and no scratches available, best farm player is called up automatically</li>
                                        <li><strong>Auto Return:</strong> When injured player heals, farm call-up returns automatically</li>
                                    </ul>
                                </div>

                                {/* INJURIES */}
                                <div className="card" style={{ background: 'rgba(239, 68, 68, 0.1)', border: '2px solid #ef4444', marginTop: '2rem' }}>
                                    <h2 style={{ color: '#f87171' }}> Injury System</h2>
                                    
                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>How Injuries Work</h3>
                                    <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                        <li><strong>Injury Rate:</strong> ~3% per game (realistic NHL rates)</li>
                                        <li><strong>Position Impact:</strong> Forwards get injured more, goalies less</li>
                                        <li><strong>Age Impact:</strong> Older players (32+) more injury-prone</li>
                                        <li><strong>Ice Time:</strong> More TOI = higher injury risk</li>
                                    </ul>

                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Injury Types</h3>
                                    <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                        <li><strong>Day-to-Day (DTD):</strong> 1-7 days - back quickly</li>
                                        <li><strong>Week-to-Week:</strong> 7-14 days - short absence</li>
                                        <li><strong>Month-to-Month (IR):</strong> 15-60 days - medium term</li>
                                        <li><strong>Season-Ending:</strong> Rest of season</li>
                                        <li><strong>Career-Ending:</strong> Player retires (very rare, 0.1%)</li>
                                    </ul>

                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Managing Injuries</h3>
                                    <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                        <li>Check Roster Management  Injuries to see all injured players</li>
                                        <li>Injured players keep their lineup spot but don't play</li>
                                        <li>Replacements (scratches or farm call-ups) fill in temporarily</li>
                                        <li>When healed, injured player returns to their original spot</li>
                                    </ul>
                                </div>

                                {/* STATS & TRACKING */}
                                <div className="card" style={{ background: 'rgba(168, 85, 247, 0.1)', border: '2px solid #a855f7', marginTop: '2rem' }}>
                                    <h2 style={{ color: '#c084fc' }}> Stats & Tracking</h2>
                                    
                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Player Stats</h3>
                                    <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                        <li><strong>Regular Season:</strong> Full stats for 82-game season</li>
                                        <li><strong>Playoffs:</strong> Separate playoff stats tracked</li>
                                        <li><strong>Per-Game Details:</strong> View individual game performances</li>
                                        <li><strong>Career Stats:</strong> Coming soon in future updates</li>
                                    </ul>

                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Team Stats</h3>
                                    <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                        <li><strong>Goals For/Against:</strong> Per game averages</li>
                                        <li><strong>Shots:</strong> Shots for and shots against per game</li>
                                        <li><strong>Power Play %:</strong> Success rate (20%+ is excellent)</li>
                                        <li><strong>Penalty Kill %:</strong> Success rate (82%+ is excellent)</li>
                                        <li><strong>Shooting %:</strong> Goals per 100 shots</li>
                                    </ul>

                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>League Leaders</h3>
                                    <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                        <li><strong>Skater Stats:</strong> Points, goals, assists, +/-, PIM, shots</li>
                                        <li><strong>Goalie Stats:</strong> Wins, save %, GAA, shutouts</li>
                                        <li><strong>Minimum Games:</strong> 27 GP for goalies (save % & GAA)</li>
                                        <li><strong>Click Names:</strong> Click any player to view their full profile</li>
                                    </ul>
                                </div>

                                {/* AWARDS & ACHIEVEMENTS */}
                                <div className="card" style={{ background: 'rgba(245, 158, 11, 0.1)', border: '2px solid #f59e0b', marginTop: '2rem' }}>
                                    <h2 style={{ color: '#fbbf24' }}> Awards & Achievements</h2>
                                    
                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Season Awards (71 Total)</h3>
                                    <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                        <li><strong>Hart Trophy:</strong> League MVP</li>
                                        <li><strong>Vezina Trophy:</strong> Best Goaltender</li>
                                        <li><strong>Norris Trophy:</strong> Best Defenseman</li>
                                        <li><strong>Calder Trophy:</strong> Rookie of the Year</li>
                                        <li><strong>Art Ross Trophy:</strong> Points Leader</li>
                                        <li><strong>Maurice Richard Trophy:</strong> Goals Leader</li>
                                        <li><strong>Division Awards:</strong> MVP, rookie, goalie for each division</li>
                                        <li><strong>All-Star Teams:</strong> First, Second, Third teams + divisional all-stars</li>
                                    </ul>

                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Playoff Awards</h3>
                                    <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                        <li><strong>Stanley Cup:</strong> Playoff champion</li>
                                        <li><strong>Conn Smythe (Playoff MVP):</strong> Best player in playoffs</li>
                                    </ul>

                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Player Achievements</h3>
                                    <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                        <li><strong>Awards:</strong> Trophy wins appear in player profile</li>
                                        <li><strong>All-Star Selections:</strong> 40 players per season (20 per conference)</li>
                                        <li><strong>League Leaders:</strong> Leading any stat category</li>
                                        <li><strong>Milestones:</strong> 500 goals, 1000 points, etc.</li>
                                        <li><strong>View in Profile:</strong> Click player name  see achievements section</li>
                                    </ul>
                                </div>

                                {/* PLAYOFFS */}
                                <div className="card" style={{ background: 'rgba(234, 179, 8, 0.1)', border: '2px solid #eab308', marginTop: '2rem' }}>
                                    <h2 style={{ color: '#facc15' }}> Playoffs</h2>
                                    
                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Playoff Format</h3>
                                    <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                        <li><strong>16 Teams:</strong> Top 8 from each conference qualify</li>
                                        <li><strong>Best-of-7 Series:</strong> First to 4 wins advances</li>
                                        <li><strong>4 Rounds:</strong> First Round  Second Round  Conference Finals  Stanley Cup Finals</li>
                                        <li><strong>Bracket View:</strong> See full tournament tree with all matchups</li>
                                    </ul>

                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Simulation</h3>
                                    <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                        <li><strong>Sim Day:</strong> Play one playoff day at a time</li>
                                        <li><strong>Conference Alternation:</strong> East and West games alternate days</li>
                                        <li><strong>Series Progress:</strong> Track wins needed in bracket</li>
                                        <li><strong>Separate Stats:</strong> Playoff stats tracked separately from regular season</li>
                                    </ul>
                                </div>

                                {/* TIPS & STRATEGIES */}
                                <div className="card" style={{ background: 'rgba(34, 211, 238, 0.1)', border: '2px solid #22d3ee', marginTop: '2rem' }}>
                                    <h2 style={{ color: '#22d3ee' }}> Tips & Strategies</h2>
                                    
                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Building a Winner</h3>
                                    <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                        <li><strong>Balance Depth:</strong> Deep teams handle injuries better than top-heavy teams</li>
                                        <li><strong>Line Chemistry:</strong> Put your best players on Line 1, they get most ice time</li>
                                        <li><strong>Special Teams:</strong> Good PP/PK units can swing games</li>
                                        <li><strong>Goaltending:</strong> Elite goalie (88+ OVR) can carry a team</li>
                                        <li><strong>Youth & Development:</strong> Young players with high potential grow over time</li>
                                    </ul>

                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Smart Roster Moves</h3>
                                    <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                        <li><strong>Call Up Prospects:</strong> Give young players NHL experience to develop faster</li>
                                        <li><strong>Manage Ice Time:</strong> Rest veterans on Line 4 to reduce injury risk</li>
                                        <li><strong>Platoon Goalies:</strong> Use backup 20-25 games to keep starter fresh</li>
                                        <li><strong>In-Position Play:</strong> Avoid -3 OVR penalty by playing natural positions</li>
                                    </ul>

                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Reading the Stats</h3>
                                    <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                        <li><strong>+/- Matters:</strong> High +/- means player is on ice for goals for > against</li>
                                        <li><strong>TOI = Value:</strong> Players with high TOI are trusted by "coach"</li>
                                        <li><strong>Shots = Chances:</strong> High shots usually means offensive zone time</li>
                                        <li><strong>PIM:</strong> Some penalty minutes are fine, too many hurt team</li>
                                    </ul>
                                </div>

                                {/* TECHNICAL INFO */}
                                <div className="card" style={{ background: 'rgba(100, 116, 139, 0.2)', border: '2px solid #64748b', marginTop: '2rem' }}>
                                    <h2 style={{ color: '#cbd5e1' }}> Technical Information</h2>
                                    
                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Save System</h3>
                                    <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                        <li><strong>Auto-Save:</strong> Game saves after every day simulated</li>
                                        <li><strong>Local Storage:</strong> Saves stored in browser (not server)</li>
                                        <li><strong>One Save Slot:</strong> Only one game can be saved at a time</li>
                                        <li><strong>Delete Save:</strong> Settings   Delete Save to start fresh</li>
                                    </ul>

                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Performance</h3>
                                    <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                        <li><strong>Optimized Simulation:</strong> Fast season sim with memoization</li>
                                        <li><strong>O(1) Lookups:</strong> Team and player data uses hash maps</li>
                                        <li><strong>No Console Spam:</strong> Debug logging removed for production</li>
                                    </ul>

                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Browser Compatibility</h3>
                                    <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                        <li><strong>Modern Browsers:</strong> Chrome, Firefox, Safari, Edge (latest versions)</li>
                                        <li><strong>Local Storage Required:</strong> Must allow browser storage for saves</li>
                                        <li><strong>JavaScript Required:</strong> Game runs entirely client-side</li>
                                    </ul>
                                </div>

                                {/* FUTURE FEATURES */}
                                <div className="card" style={{ background: 'rgba(139, 92, 246, 0.1)', border: '2px solid #8b5cf6', marginTop: '2rem' }}>
                                    <h2 style={{ color: '#a78bfa' }}> Coming Soon</h2>
                                    <p style={{ color: '#e2e8f0', marginBottom: '1rem' }}>
                                        Features in development (see Settings  Roadmap for full list):
                                    </p>
                                    <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                        <li>Player career highs tracking</li>
                                        <li>Advanced search & filters</li>
                                        <li>Trade history</li>
                                        <li>Multi-season franchise mode</li>
                                        <li>Entry draft system</li>
                                        <li>Free agency</li>
                                        <li>Contract & salary cap</li>
                                        <li>Player development & aging</li>
                                    </ul>
                                </div>

                                {/* FEEDBACK */}
                                <div className="card" style={{ background: 'rgba(34, 197, 94, 0.1)', border: '2px solid #22c55e', marginTop: '2rem' }}>
                                    <h2 style={{ color: '#22c55e' }}> Questions or Issues?</h2>
                                    <p style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                        This user manual is continuously updated as new features are added. 
                                        If you encounter bugs or have suggestions, the development team is actively improving the game.
                                    </p>
                                    <p style={{ color: '#93c5fd', marginTop: '1rem', fontStyle: 'italic' }}>
                                        Last Updated: December 2025 | Version 1.0
                                    </p>
                                </div>
                            </div>
                        )}

                        {/* PLAYOFF MVP VIEW */}
                        {currentView === 'playoffMVP' && playoffMVP && playoffState && (
                            <div>
                                <div className="card" style={{ 
                                    background: 'linear-gradient(135deg, rgba(245, 158, 11, 0.3), rgba(251, 191, 36, 0.2))', 
                                    border: '3px solid #f59e0b',
                                    textAlign: 'center'
                                }}>
                                    <div style={{ fontSize: '4rem', marginBottom: '1rem' }}></div>
                                    <h1 style={{ color: '#fbbf24', marginBottom: '1rem', fontSize: '2.5rem' }}>
                                        Stanley Cup Champions
                                    </h1>
                                    <h2 style={{ color: '#fff', fontSize: '2rem', marginBottom: '2rem' }}>
                                        {TEAMS.find(t => t.id === playoffState.champion)?.city} {TEAMS.find(t => t.id === playoffState.champion)?.name}
                                    </h2>
                                    
                                    <div style={{ 
                                        marginTop: '2rem', 
                                        padding: '2rem',
                                        background: 'rgba(0, 0, 0, 0.3)',
                                        borderRadius: '1rem'
                                    }}>
                                        <h2 style={{ color: '#fbbf24', marginBottom: '1rem', fontSize: '1.8rem' }}>
                                             Playoff MVP
                                        </h2>
                                        <h3 style={{ color: '#fff', fontSize: '2rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                            {playoffMVP.firstName} {playoffMVP.lastName}
                                        </h3>
                                        <div style={{ color: '#93c5fd', fontSize: '1.2rem', marginBottom: '1.5rem' }}>
                                            {TEAMS.find(t => t.id === playoffMVP.teamId)?.city} {TEAMS.find(t => t.id === playoffMVP.teamId)?.name}
                                        </div>
                                        
                                        <div style={{ 
                                            display: 'flex', 
                                            justifyContent: 'center', 
                                            gap: '3rem',
                                            fontSize: '1.5rem',
                                            color: '#e2e8f0',
                                            marginTop: '1.5rem'
                                        }}>
                                            {playoffMVP.position === 'G' ? (
                                                <>
                                                    <div>
                                                        <div style={{ color: '#93c5fd', fontSize: '1rem' }}>Record</div>
                                                        <div style={{ fontWeight: 'bold' }}>{playoffMVP.playoffStats.wins}-{playoffMVP.playoffStats.losses}</div>
                                                    </div>
                                                    <div>
                                                        <div style={{ color: '#93c5fd', fontSize: '1rem' }}>Save %</div>
                                                        <div style={{ fontWeight: 'bold' }}>{playoffMVP.playoffStats.savePercentage.toFixed(3)}</div>
                                                    </div>
                                                    <div>
                                                        <div style={{ color: '#93c5fd', fontSize: '1rem' }}>GAA</div>
                                                        <div style={{ fontWeight: 'bold' }}>{playoffMVP.playoffStats.gaa.toFixed(2)}</div>
                                                    </div>
                                                    <div>
                                                        <div style={{ color: '#93c5fd', fontSize: '1rem' }}>SO</div>
                                                        <div style={{ fontWeight: 'bold' }}>{playoffMVP.playoffStats.shutouts}</div>
                                                    </div>
                                                </>
                                            ) : (
                                                <>
                                                    <div>
                                                        <div style={{ color: '#93c5fd', fontSize: '1rem' }}>Goals</div>
                                                        <div style={{ fontWeight: 'bold' }}>{playoffMVP.playoffStats.goals}</div>
                                                    </div>
                                                    <div>
                                                        <div style={{ color: '#93c5fd', fontSize: '1rem' }}>Assists</div>
                                                        <div style={{ fontWeight: 'bold' }}>{playoffMVP.playoffStats.assists}</div>
                                                    </div>
                                                    <div>
                                                        <div style={{ color: '#93c5fd', fontSize: '1rem' }}>Points</div>
                                                        <div style={{ fontWeight: 'bold' }}>{playoffMVP.playoffStats.points}</div>
                                                    </div>
                                                    <div>
                                                        <div style={{ color: '#93c5fd', fontSize: '1rem' }}>+/-</div>
                                                        <div style={{ fontWeight: 'bold' }}>
                                                            {playoffMVP.playoffStats.plusMinus > 0 ? '+' : ''}{playoffMVP.playoffStats.plusMinus}
                                                        </div>
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    </div>
                                    
                                    <button 
                                        onClick={() => {
                                            setCurrentView('playoffs');
                                        }}
                                        style={{
                                            marginTop: '2rem',
                                            padding: '0.75rem 1.5rem',
                                            background: '#3b82f6',
                                            color: '#fff',
                                            border: 'none',
                                            borderRadius: '0.5rem',
                                            fontSize: '1.1rem',
                                            cursor: 'pointer',
                                            fontWeight: 'bold'
                                        }}
                                    >
                                        View Playoff Bracket
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<HockeyGM />);
    </script>
</body>
</html>
